"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[2481],{56801:(e,d,r)=>{r.r(d),r.d(d,{assets:()=>l,contentTitle:()=>c,default:()=>j,frontMatter:()=>i,metadata:()=>t,toc:()=>h});var s=r(74848),n=r(28453);const i={sidebar_position:1},c="K230 RVV\u4f18\u5316\u6027\u80fd\u8bf4\u660e",t={id:"CanaanK230/part6/K230RVVoptimizationperformance",title:"K230 RVV\u4f18\u5316\u6027\u80fd\u8bf4\u660e",description:"1. \u6982\u8ff0",source:"@site/docs/CanaanK230/part6/01_K230RVVoptimizationperformance.md",sourceDirName:"CanaanK230/part6",slug:"/CanaanK230/part6/K230RVVoptimizationperformance",permalink:"/docs/CanaanK230/part6/K230RVVoptimizationperformance",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/CanaanK230/part6/01_K230RVVoptimizationperformance.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"canaanK230Sidebar",previous:{title:"6.\u7cfb\u7edf\u5f00\u53d1\u6307\u5357",permalink:"/docs/category/6\u7cfb\u7edf\u5f00\u53d1\u6307\u5357-1"},next:{title:"K230 \u5185\u5b58\u4f18\u5316\u6307\u5357",permalink:"/docs/CanaanK230/part6/K230MemoryOptimizationGuide"}},l={},h=[{value:"1. \u6982\u8ff0",id:"1-\u6982\u8ff0",level:2},{value:"2. RVV\u5e94\u7528\u573a\u666f",id:"2-rvv\u5e94\u7528\u573a\u666f",level:2},{value:"2.1 \u672a\u5f00\u542fRVV\u4f18\u5316",id:"21-\u672a\u5f00\u542frvv\u4f18\u5316",level:3},{value:"2.2 \u5f00\u542fRVV\u4f18\u5316",id:"22-\u5f00\u542frvv\u4f18\u5316",level:3},{value:"2.3 \u6027\u80fd\u5206\u6790\u53ca\u8bf4\u660e",id:"23-\u6027\u80fd\u5206\u6790\u53ca\u8bf4\u660e",level:3},{value:"2.4 RVV\u4f18\u5316\u793a\u4f8b",id:"24-rvv\u4f18\u5316\u793a\u4f8b",level:3},{value:"2.4.1 RVV\u4ee3\u7801",id:"241-rvv\u4ee3\u7801",level:4},{value:"2.4.2 \u6838\u5fc3\u4ee3\u7801\u8bf4\u660e",id:"242-\u6838\u5fc3\u4ee3\u7801\u8bf4\u660e",level:4},{value:"2.4.3 \u6dfb\u52a0RVV\u7b97\u5b50\u6d41\u7a0b",id:"243-\u6dfb\u52a0rvv\u7b97\u5b50\u6d41\u7a0b",level:4},{value:"2.5 tips",id:"25-tips",level:3}];function x(e){const d={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,n.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(d.header,{children:(0,s.jsx)(d.h1,{id:"k230-rvv\u4f18\u5316\u6027\u80fd\u8bf4\u660e",children:"K230 RVV\u4f18\u5316\u6027\u80fd\u8bf4\u660e"})}),"\n",(0,s.jsx)(d.h2,{id:"1-\u6982\u8ff0",children:"1. \u6982\u8ff0"}),"\n",(0,s.jsx)(d.p,{children:"\u8fd1\u4e9b\u5e74AI\u9886\u57df\u7684\u5feb\u901f\u53d1\u5c55\uff0c\u884d\u751f\u51fa\u5404\u79cd\u5404\u6837\u7684\u795e\u7ecf\u7f51\u7edc\u6a21\u578b\uff0c\u4e0d\u65ad\u51fa\u73b0\u65b0\u7684\u7b97\u5b50\u3002\u4f46\u662fAI\u82af\u7247\u7684\u8fed\u4ee3\u5468\u671f\u76f8\u6bd4AI\u6a21\u578b\u4f1a\u957f\u5f88\u591a\uff0c\u8fd9\u4e9b\u65b0\u51fa\u73b0\u7684\u7b97\u5b50\u591a\u6570\u4e0d\u80fd\u76f4\u63a5\u4f7f\u7528AI\u82af\u7247\u8fdb\u884c\u63a8\u7406\u52a0\u901f\uff0c\u540c\u65f6\u65e7\u7684\u7b97\u5b50\u4e2d\u4e5f\u6709\u4e00\u90e8\u5206\u4e0d\u9002\u5408\u4f7f\u7528AI\u82af\u7247\u8fdb\u884c\u63a8\u7406\u52a0\u901f\u3002\u56e0\u6b64CPU\u6210\u4e3a\u8fd9\u90e8\u5206\u7b97\u5b50\u7684\u6267\u884c\u8f7d\u4f53\uff0c\u8fd9\u4e5f\u610f\u5473\u7740CPU\u7684\u6027\u80fd\u4f1a\u6210\u4e3a\u6a21\u578b\u90e8\u7f72\u65f6\u5f71\u54cd\u6700\u7ec8\u6027\u80fd\u7684\u4e00\u4e2a\u56e0\u7d20\uff0c\u800cRVV\u6269\u5c55\u5c31\u662fRISC-V CPU\u63d0\u5347\u6027\u80fd\u7684\u4e00\u4e2a\u91cd\u8981\u624b\u6bb5\u3002K230 \u4e2d\u91c7\u7528\u7684\u7384\u94c1C908\u53cc\u6838\u5904\u7406\u5668\u4e2d\u5927\u6838\u5177\u5907RVV1.0\u6269\u5c55\u7684\u7279\u6027\uff0c\u80fd\u591f\u5927\u5e45\u5ea6\u63d0\u5347CPU\u7b97\u5b50\u63a8\u7406\u65f6\u7684\u8868\u73b0\u3002"}),"\n",(0,s.jsxs)(d.p,{children:["K230\u8fdb\u884c\u6a21\u578b\u63a8\u7406\u65f6\u9700\u8981\u4f7f\u7528 ",(0,s.jsx)(d.code,{children:".kmodel"}),"\u683c\u5f0f\u7684\u6a21\u578b\uff0c",(0,s.jsx)(d.code,{children:".kmodel"}),"\u662f\u7531",(0,s.jsx)(d.a,{href:"https://github.com/kendryte/nncase",children:"nncase"})," \u5bf9 ",(0,s.jsx)(d.code,{children:"ONNX"}),"\u548c ",(0,s.jsx)(d.code,{children:"TFLite"}),"\u6a21\u578b\u8fdb\u884c\u7f16\u8bd1\u540e\u7684\u6a21\u578b\u683c\u5f0f\uff0c\u9002\u7528\u4e8e\u672c\u516c\u53f8\u53ca\u76f8\u5173\u5408\u4f5c\u4f01\u4e1a\u751f\u4ea7\u7684\u5f00\u53d1\u677f\u3002nncase\u652f\u6301\u76ee\u524d\u5e38\u89c1\u7684\u795e\u7ecf\u7f51\u7edc\u7b97\u5b50\uff0c\u4f46\u662f\u90e8\u5206\u7b97\u5b50\u65e0\u6cd5\u901a\u8fc7K230\u8fdb\u884c\u63a8\u7406\u52a0\u901f\uff0c\u8fd9\u90e8\u5206\u7b97\u5b50\u53ea\u80fd\u4f7f\u7528CPU\u8fdb\u884c\u63a8\u7406\u3002"]}),"\n",(0,s.jsx)(d.h2,{id:"2-rvv\u5e94\u7528\u573a\u666f",children:"2. RVV\u5e94\u7528\u573a\u666f"}),"\n",(0,s.jsxs)(d.p,{children:["\u76ee\u524d\u7814\u7a76\u5e94\u7528\u6700\u5e7f\u6cdb\u7684\u795e\u7ecf\u7f51\u7edc ",(0,s.jsx)(d.code,{children:"Transformer"}),"\u4e2d\uff0c\u6a21\u578b\u7ed3\u6784\u4e0e ",(0,s.jsx)(d.code,{children:"CNN"}),"\u5b58\u5728\u8f83\u5927\u5dee\u5f02\uff0c\u5f88\u591a\u57fa\u4e8e ",(0,s.jsx)(d.code,{children:"CNN"}),"\u8bbe\u8ba1\u7684AI\u82af\u7247\u65e0\u6cd5\u5b8c\u5168\u5bf9 ",(0,s.jsx)(d.code,{children:"Transformer"}),"\u8fdb\u884c\u52a0\u901f\u3002\u4ee5\u4e0b\u4e3a ",(0,s.jsx)(d.code,{children:"Transformer"}),"\u4e2d ",(0,s.jsx)(d.code,{children:"Decoder"}),"\u6a21\u578b\u5728\u5f00\u542fRVV\u4f18\u5316\u548c\u4e0d\u5f00\u542fRVV\u4f18\u5316\u7684\u7b97\u5b50\u6267\u884c\u60c5\u51b5\u3002"]}),"\n",(0,s.jsx)(d.h3,{id:"21-\u672a\u5f00\u542frvv\u4f18\u5316",children:"2.1 \u672a\u5f00\u542fRVV\u4f18\u5316"}),"\n",(0,s.jsxs)(d.table,{children:[(0,s.jsx)(d.thead,{children:(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.th,{children:"stackvm tensor op"}),(0,s.jsx)(d.th,{children:"count"}),(0,s.jsx)(d.th,{children:"time consumption(ms)"}),(0,s.jsx)(d.th,{children:"percentage(%)"})]})}),(0,s.jsxs)(d.tbody,{children:[(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"softmax"}),(0,s.jsx)(d.td,{children:"5"}),(0,s.jsx)(d.td,{children:"1749.61"}),(0,s.jsx)(d.td,{children:"88.6574"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"where"}),(0,s.jsx)(d.td,{children:"4"}),(0,s.jsx)(d.td,{children:"199.432"}),(0,s.jsx)(d.td,{children:"10.1058"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"EXTCALL"}),(0,s.jsx)(d.td,{children:"65"}),(0,s.jsx)(d.td,{children:"16.099"}),(0,s.jsx)(d.td,{children:"0.815779"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"layer_norm"}),(0,s.jsx)(d.td,{children:"7"}),(0,s.jsx)(d.td,{children:"5.81"}),(0,s.jsx)(d.td,{children:"0.294408"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"gather"}),(0,s.jsx)(d.td,{children:"2"}),(0,s.jsx)(d.td,{children:"0.393"}),(0,s.jsx)(d.td,{children:"0.0199144"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"STLOCAL"}),(0,s.jsx)(d.td,{children:"212"}),(0,s.jsx)(d.td,{children:"0.391"}),(0,s.jsx)(d.td,{children:"0.019813"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"LDC_I4"}),(0,s.jsx)(d.td,{children:"241"}),(0,s.jsx)(d.td,{children:"0.388"}),(0,s.jsx)(d.td,{children:"0.019661"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"reduce_arg"}),(0,s.jsx)(d.td,{children:"1"}),(0,s.jsx)(d.td,{children:"0.336"}),(0,s.jsx)(d.td,{children:"0.017026"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"reshape"}),(0,s.jsx)(d.td,{children:"26"}),(0,s.jsx)(d.td,{children:"0.281"}),(0,s.jsx)(d.td,{children:"0.014239"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"LDLOCAL"}),(0,s.jsx)(d.td,{children:"149"}),(0,s.jsx)(d.td,{children:"0.26"}),(0,s.jsx)(d.td,{children:"0.0131749"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"LDNULL"}),(0,s.jsx)(d.td,{children:"106"}),(0,s.jsx)(d.td,{children:"0.166"}),(0,s.jsx)(d.td,{children:"0.00841166"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"LDTENSOR"}),(0,s.jsx)(d.td,{children:"29"}),(0,s.jsx)(d.td,{children:"0.103"}),(0,s.jsx)(d.td,{children:"0.00521929"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"LEA_GP"}),(0,s.jsx)(d.td,{children:"58"}),(0,s.jsx)(d.td,{children:"0.097"}),(0,s.jsx)(d.td,{children:"0.00491525"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"LDDATATYPE"}),(0,s.jsx)(d.td,{children:"29"}),(0,s.jsx)(d.td,{children:"0.07"}),(0,s.jsx)(d.td,{children:"0.00354709"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"LDARG"}),(0,s.jsx)(d.td,{children:"5"}),(0,s.jsx)(d.td,{children:"0.008"}),(0,s.jsx)(d.td,{children:"0.000405381"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"RET"}),(0,s.jsx)(d.td,{children:"1"}),(0,s.jsx)(d.td,{children:"0.004"}),(0,s.jsx)(d.td,{children:"0.000202691"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"LDTUPLE"}),(0,s.jsx)(d.td,{children:"1"}),(0,s.jsx)(d.td,{children:"0.003"}),(0,s.jsx)(d.td,{children:"0.000152018"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"total"}),(0,s.jsx)(d.td,{children:"941"}),(0,s.jsx)(d.td,{children:"1973.45"}),(0,s.jsx)(d.td,{children:"100"})]})]})]}),"\n",(0,s.jsx)(d.h3,{id:"22-\u5f00\u542frvv\u4f18\u5316",children:"2.2 \u5f00\u542fRVV\u4f18\u5316"}),"\n",(0,s.jsxs)(d.table,{children:[(0,s.jsx)(d.thead,{children:(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.th,{children:"stackvm tensor op"}),(0,s.jsx)(d.th,{children:"count"}),(0,s.jsx)(d.th,{children:"time consumption(ms)"}),(0,s.jsx)(d.th,{children:"percentage(%)"})]})}),(0,s.jsxs)(d.tbody,{children:[(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"softmax"}),(0,s.jsx)(d.td,{children:"5"}),(0,s.jsx)(d.td,{children:"25.722"}),(0,s.jsx)(d.td,{children:"55.6175"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"EXTCALL"}),(0,s.jsx)(d.td,{children:"65"}),(0,s.jsx)(d.td,{children:"16.179"}),(0,s.jsx)(d.td,{children:"34.9831"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"layer_norm"}),(0,s.jsx)(d.td,{children:"7"}),(0,s.jsx)(d.td,{children:"0.967"}),(0,s.jsx)(d.td,{children:"2.0909"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"where"}),(0,s.jsx)(d.td,{children:"4"}),(0,s.jsx)(d.td,{children:"0.912"}),(0,s.jsx)(d.td,{children:"1.97198"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"gather"}),(0,s.jsx)(d.td,{children:"2"}),(0,s.jsx)(d.td,{children:"0.39"}),(0,s.jsx)(d.td,{children:"0.84328"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"LDC_I4"}),(0,s.jsx)(d.td,{children:"241"}),(0,s.jsx)(d.td,{children:"0.386"}),(0,s.jsx)(d.td,{children:"0.834631"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"STLOCAL"}),(0,s.jsx)(d.td,{children:"212"}),(0,s.jsx)(d.td,{children:"0.379"}),(0,s.jsx)(d.td,{children:"0.819495"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"reduce_arg"}),(0,s.jsx)(d.td,{children:"1"}),(0,s.jsx)(d.td,{children:"0.34"}),(0,s.jsx)(d.td,{children:"0.735167"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"LDLOCAL"}),(0,s.jsx)(d.td,{children:"149"}),(0,s.jsx)(d.td,{children:"0.259"}),(0,s.jsx)(d.td,{children:"0.560024"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"reshape"}),(0,s.jsx)(d.td,{children:"26"}),(0,s.jsx)(d.td,{children:"0.243"}),(0,s.jsx)(d.td,{children:"0.525428"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"LDNULL"}),(0,s.jsx)(d.td,{children:"106"}),(0,s.jsx)(d.td,{children:"0.17"}),(0,s.jsx)(d.td,{children:"0.367583"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"LEA_GP"}),(0,s.jsx)(d.td,{children:"58"}),(0,s.jsx)(d.td,{children:"0.103"}),(0,s.jsx)(d.td,{children:"0.222712"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"LDTENSOR"}),(0,s.jsx)(d.td,{children:"29"}),(0,s.jsx)(d.td,{children:"0.103"}),(0,s.jsx)(d.td,{children:"0.222712"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"LDDATATYPE"}),(0,s.jsx)(d.td,{children:"29"}),(0,s.jsx)(d.td,{children:"0.076"}),(0,s.jsx)(d.td,{children:"0.164331"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"LDARG"}),(0,s.jsx)(d.td,{children:"5"}),(0,s.jsx)(d.td,{children:"0.011"}),(0,s.jsx)(d.td,{children:"0.0237848"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"RET"}),(0,s.jsx)(d.td,{children:"1"}),(0,s.jsx)(d.td,{children:"0.005"}),(0,s.jsx)(d.td,{children:"0.0108113"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"LDTUPLE"}),(0,s.jsx)(d.td,{children:"1"}),(0,s.jsx)(d.td,{children:"0.003"}),(0,s.jsx)(d.td,{children:"0.00648677"})]}),(0,s.jsxs)(d.tr,{children:[(0,s.jsx)(d.td,{children:"total"}),(0,s.jsx)(d.td,{children:"941"}),(0,s.jsx)(d.td,{children:"46.248"}),(0,s.jsx)(d.td,{children:"100"})]})]})]}),"\n",(0,s.jsx)(d.h3,{id:"23-\u6027\u80fd\u5206\u6790\u53ca\u8bf4\u660e",children:"2.3 \u6027\u80fd\u5206\u6790\u53ca\u8bf4\u660e"}),"\n",(0,s.jsxs)(d.p,{children:["\u4e0a\u8ff0\u6a21\u578b\u63a8\u7406\u4e2d\uff0cK230\u7684KPU\u5355\u5143\u4e0d\u652f\u6301\u5bf9 ",(0,s.jsx)(d.code,{children:"softmax"}),"\u3001",(0,s.jsx)(d.code,{children:"layer_norm"}),"\u3001",(0,s.jsx)(d.code,{children:"where"}),"\u3001",(0,s.jsx)(d.code,{children:"gather"}),"\uff0c",(0,s.jsx)(d.code,{children:"reduce_arg"}),"\uff0c",(0,s.jsx)(d.code,{children:"reshape"})," \u8fdb\u884c\u786c\u4ef6\u63a8\u7406\u52a0\u901f\uff0c\u56e0\u6b64\u9700\u8981\u4f7f\u7528C908\u5b9e\u73b0\u63a8\u7406\uff0c\u76ee\u524d\u5df2\u7ecf\u5b8c\u6210\u4e86\u5bf9 ",(0,s.jsx)(d.code,{children:"softmax"}),"\u3001",(0,s.jsx)(d.code,{children:"layer_norm"}),"\u3001",(0,s.jsx)(d.code,{children:"where"}),"\u7684RVV\u4f18\u5316\uff0c\u6027\u80fd\u63d0\u5347\u660e\u663e\u3002"]}),"\n",(0,s.jsx)(d.p,{children:"\u4ee5\u4e0b\u4e3a\u4f7f\u7528RVV\u4f18\u5316\u524d\u540e\u5404\u7b97\u5b50\u5728\u6a21\u578b\u63a8\u7406\u65f6\u95f4\u4e2d\u7684\u5360\u6bd4\u56fe\u3002"}),"\n",(0,s.jsx)(d.p,{children:(0,s.jsx)(d.img,{alt:"image-20240719162322440",src:r(22566).A+"",width:"1028",height:"547"})}),"\n",(0,s.jsx)(d.p,{children:(0,s.jsx)(d.img,{alt:"image-20240719162343905",src:r(79567).A+"",width:"995",height:"556"})}),"\n",(0,s.jsx)(d.p,{children:"\u4ee5\u4e0b\u4e3a\u4f7f\u7528RVV\u4f18\u5316\u524d\u540e\u76f8\u5173\u7b97\u5b50\u7684\u6027\u80fd\u5bf9\u6bd4\u3002"}),"\n",(0,s.jsx)(d.p,{children:(0,s.jsx)(d.img,{alt:"RVV",src:r(6166).A+"",width:"1000",height:"500"})}),"\n",(0,s.jsxs)(d.p,{children:["\u4ece\u4ee5\u4e0a\u7684\u5bf9\u6bd4\u7ed3\u679c\u53ef\u4ee5\u770b\u51fa\uff0c\u5728\u5f00\u542fRVV\u4f18\u5316\u540e\u80fd\u591f\u6781\u5927\u7684\u63d0\u5347CPU\u7b97\u5b50\u7684\u63a8\u7406\u6027\u80fd\uff0c\u7f29\u77ed\u6574\u4e2a\u6a21\u578b\u7684\u63a8\u7406\u65f6\u95f4(1973\u2013> 46)ms\uff0cRVV\u4f18\u5316\u540e\u5360\u636e\u5927\u90e8\u5206\u65f6\u95f4\u7684 ",(0,s.jsx)(d.code,{children:"softmax"}),"\u7b97\u5b50\u65f6\u95f4\u51cf\u5c11\u523025ms\uff0c",(0,s.jsx)(d.code,{children:"layer_norm"}),"\u7b97\u5b50\u65f6\u95f4\u51cf\u5c11\u52300.97ms\uff0c",(0,s.jsx)(d.code,{children:"where"}),"\u7b97\u5b50\u65f6\u95f4\u51cf\u5c11\u52300.91ms\uff0c\u6574\u4e2a\u6a21\u578b\u7684\u63a8\u7406\u65f6\u95f4\u7f29\u77ed\u4e8697.6%\uff0c\u5728\u5b9e\u9645\u6a21\u578b\u90e8\u7f72\u65f6\u5177\u6709\u5f88\u9ad8\u7684\u5e94\u7528\u4ef7\u503c\u3002"]}),"\n",(0,s.jsx)(d.h3,{id:"24-rvv\u4f18\u5316\u793a\u4f8b",children:"2.4 RVV\u4f18\u5316\u793a\u4f8b"}),"\n",(0,s.jsx)(d.h4,{id:"241-rvv\u4ee3\u7801",children:"2.4.1 RVV\u4ee3\u7801"}),"\n",(0,s.jsxs)(d.p,{children:["\u5177\u4f53\u5b9e\u73b0\u8bf7\u53c2\u8003 ",(0,s.jsx)(d.code,{children:"nncase"}),"\u4e2d\u7684",(0,s.jsx)(d.a,{href:"https://github.com/kendryte/nncase/blob/master/src/Native/src/kernels/stackvm/optimized/riscv64/layer_norm.cpp",children:"layer_norm"}),"\uff0c\u9700\u8981\u5177\u5907\u4e00\u5b9aRV\u6307\u4ee4\u548cV\u6269\u5c55\u6307\u4ee4\u77e5\u8bc6\u3002"]}),"\n",(0,s.jsxs)(d.p,{children:[(0,s.jsx)(d.code,{children:"layer_norm"}),"\u7684\u8ba1\u7b97\u516c\u5f0f\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(d.pre,{children:(0,s.jsx)(d.code,{children:"y= (x\u2212E[x])/sqrt(Var[x]+\u03f5)\u2217\u03b3+\u03b2\n"})}),"\n",(0,s.jsxs)(d.p,{children:["\u6574\u4f53\u8ba1\u7b97\u6d41\u7a0b\u8be6\u89c1 ",(0,s.jsx)(d.code,{children:"layernorm_impl"}),"\u51fd\u6570\uff0c\u4e3a\u4e86\u4ee3\u7801\u5177\u5907\u66f4\u9ad8\u7684\u53ef\u8bfb\u6027\uff0c\u8be5\u6d41\u7a0b\u4e2d\u5c06RVV\u4f18\u5316\u4ee3\u7801\u62c6\u5206\u6210\u4e09\u4e2a\u90e8\u5206\uff1a"]}),"\n",(0,s.jsxs)(d.ol,{children:["\n",(0,s.jsxs)(d.li,{children:["\u8ba1\u7b97 ",(0,s.jsx)(d.code,{children:"E[x]"}),"\uff0c\u5177\u4f53\u8bf7\u53c2\u8003 ",(0,s.jsx)(d.code,{children:"get_mean"}),"\u51fd\u6570\u3002"]}),"\n",(0,s.jsxs)(d.li,{children:["\u8ba1\u7b97 ",(0,s.jsx)(d.code,{children:"Var[x]"}),"\uff0c\u5177\u4f53\u8bf7\u53c2\u8003 ",(0,s.jsx)(d.code,{children:"get_var"}),"\u51fd\u6570\u3002"]}),"\n",(0,s.jsxs)(d.li,{children:["\u6309\u7167\u4e0a\u8ff0\u516c\u5f0f\u8fdb\u884clayer_norm\u7684\u8ba1\u7b97\uff0c\u5177\u4f53\u8bf7\u53c2\u8003 ",(0,s.jsx)(d.code,{children:"layer_norm_update1"}),"\u51fd\u6570\u3002"]}),"\n"]}),"\n",(0,s.jsxs)(d.p,{children:["\u7531\u4e8e\u4e58\u6cd5\u76f8\u6bd4\u9664\u6cd5\u8017\u65f6\u66f4\u77ed\uff0c\u7b2c3\u6b65\u7684\u8ba1\u7b97\u4e2d\u8fdb\u884c\u4e86\u516c\u5f0f\u53d8\u6362\uff0c\u4f7f\u7528 ",(0,s.jsx)(d.code,{children:"rsqrt"}),"\u4ee3\u66ff ",(0,s.jsx)(d.code,{children:"sqrt"}),"\uff0c\u518d\u7528\u4e58\u6cd5\u66ff\u4ee3\u9664\u6cd5\u3002"]}),"\n",(0,s.jsx)(d.h4,{id:"242-\u6838\u5fc3\u4ee3\u7801\u8bf4\u660e",children:"2.4.2 \u6838\u5fc3\u4ee3\u7801\u8bf4\u660e"}),"\n",(0,s.jsxs)(d.p,{children:["\u4ee5\u4e0b\u4e3a ",(0,s.jsx)(d.code,{children:"get_mean"}),"\u4e2d\u6838\u5fc3\u4ee3\u7801\u7684\u8bf4\u660e\uff0c\u8fd9\u6bb5\u4ee3\u7801\u5b9e\u73b0\u4e86\u5bf9a1\u5904\u6570\u7ec4\u7684\u5faa\u73af\u52a0\u8f7d\u6c42\u548c,\u6c42\u548c\u7ed3\u679c\u5b58\u50a8\u5728v0,\u6700\u540e\u6c42\u5e73\u5747\u503c\u4fdd\u5b58\u5728ret\u4e2d\u3002\u5b83\u5229\u7528RVV\u7684\u5411\u91cf\u52a0\u8f7d,\u5411\u91cf\u7d2f\u52a0\u6307\u4ee4\u6765\u5b9e\u73b0\u6c42\u548c,\u4ece\u800c\u63d0\u9ad8\u8ba1\u7b97\u6027\u80fd\u3002"]}),"\n",(0,s.jsx)(d.pre,{children:(0,s.jsx)(d.code,{children:'"vle32.v v8, (a1);"   // \u52a0\u8f7da1\u5730\u5740\u5904\u768432bit\u5411\u91cf\u5230v8\u5bc4\u5b58\u5668\n"sub a0,a0, t0;"      // a0 -= t0,\u7528\u4e8e\u5faa\u73af\u63a7\u5236\u8ba1\u6570\n"slli t1, t0, 2;"     // t1 = t0 << 2,\u56e0\u4e3a\u6bcf\u4e2afloat32\u662f4\u5b57\u8282,\u6240\u4ee5\u5730\u5740\u589e\u52a04*t0\n"vfredsum.vs v0,v8,v0;"  // v0 += v8,\u5411\u91cf\u7d2f\u52a0\u6c42\u548c\u5230v0\n\n"add a1, a1, t1;"      // a1 += t1,\u66f4\u65b0\u52a0\u8f7d\u5730\u5740\n"bnez a0, XXXXXX%=;"   // \u5982\u679ca0!=0,\u8df3\u8f6c\u81f3\u5faa\u73af\u5f00\u59cb\u5730\u5740\n"vfmv.f.s f0, v0;"     // \u628av0\u5411\u91cf\u7d2f\u52a0\u7ed3\u679c\u79fb\u52a8\u5230f0\n"fcvt.s.w f1, %[avl];"  // \u5c06avl\u8f6c\u6362\u4e3afloat\u4fdd\u5b58\u5230f1 \n"fdiv.s %[ret], f0, f1;" // ret = f0/f1,\u5373\u6c42\u5e73\u5747\u503c\n'})}),"\n",(0,s.jsx)(d.h4,{id:"243-\u6dfb\u52a0rvv\u7b97\u5b50\u6d41\u7a0b",children:"2.4.3 \u6dfb\u52a0RVV\u7b97\u5b50\u6d41\u7a0b"}),"\n",(0,s.jsxs)(d.p,{children:["\u4ee5\u4e0b\u6d41\u7a0b\u4e2d\u8def\u5f84\u5747\u4ee5",(0,s.jsx)(d.a,{href:"https://github.com/kendryte/nncase",children:"nncase"}),"\u4f5c\u4e3a\u6839\u76ee\u5f55"]}),"\n",(0,s.jsxs)(d.ol,{children:["\n",(0,s.jsx)(d.li,{children:"\u51fd\u6570\u58f0\u660e\uff1asrc/Native/src/kernels/stackvm/optimized/opt_ops.h"}),"\n",(0,s.jsxs)(d.li,{children:["\u7b97\u5b50\u5b9e\u73b0\uff1a","\n",(0,s.jsxs)(d.ul,{children:["\n",(0,s.jsx)(d.li,{children:"\u901a\u7528\u4f18\u5316 src/Native/src/kernels/stackvm/optimized"}),"\n",(0,s.jsx)(d.li,{children:"x86\u4f18\u5316 src/Native/src/kernels/stackvm/optimized/x86_64"}),"\n",(0,s.jsx)(d.li,{children:"RVV\u4f18\u5316 src/Native/src/kernels/stackvm/optimized/riscv64"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(d.li,{children:"\u903b\u8f91\u8c03\u7528\uff1asrc/Native/src/kernels/stackvm/tensor_ops.cpp"}),"\n",(0,s.jsxs)(d.li,{children:["\u4fee\u6539CMakeLists\uff1asrc/Native/src/kernels/stackvm/optimized/CMakeLists.txt","\n",(0,s.jsxs)(d.ul,{children:["\n",(0,s.jsx)(d.li,{children:"\u901a\u7528\u4f18\u5316\uff1a15\u884c\u589e\u52a0\u6e90\u6587\u4ef6\u540d"}),"\n",(0,s.jsx)(d.li,{children:"\u7279\u5b9a\u5e73\u53f0\u4f18\u5316\uff1a44\u884c\u589e\u52a0\u6e90\u6587\u4ef6\u540d"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(d.h3,{id:"25-tips",children:"2.5 tips"}),"\n",(0,s.jsxs)(d.p,{children:["\u5982\u679c\u9047\u5230\u5c1a\u672a\u652f\u6301RVV\u4f18\u5316\u7684\u7b97\u5b50\uff0c\u4e14\u9700\u8981\u8fdb\u884c\u652f\u6301\u7684\uff0c\u6b22\u8fce\u5728",(0,s.jsx)(d.a,{href:"https://github.com/kendryte/nncase/issues",children:"nncase\u63d0issue\u548cPR"}),"\u3002"]})]})}function j(e={}){const{wrapper:d}={...(0,n.R)(),...e.components};return d?(0,s.jsx)(d,{...e,children:(0,s.jsx)(x,{...e})}):x(e)}},6166:(e,d,r)=>{r.d(d,{A:()=>s});const s=r.p+"assets/images/RVV_optimize_performance-09cf4349e6caec527b418a2422a40e93.jpg"},22566:(e,d,r)=>{r.d(d,{A:()=>s});const s=r.p+"assets/images/image-20240719162322440-0e1904350347fa836aab2f71a8b77e66.png"},79567:(e,d,r)=>{r.d(d,{A:()=>s});const s=r.p+"assets/images/image-20240719162343905-7f184b1d7bc4b4846f12e78b6d86e6bf.png"},28453:(e,d,r)=>{r.d(d,{R:()=>c,x:()=>t});var s=r(96540);const n={},i=s.createContext(n);function c(e){const d=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(d):{...d,...e}}),[d,e])}function t(e){let d;return d=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:c(e.components),s.createElement(i.Provider,{value:d},e.children)}}}]);