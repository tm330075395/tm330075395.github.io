<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-CanaanK230/part5/AIDemodocumentation" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">AI Demo说明文档 | 正点原子</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://tm330075395.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://tm330075395.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://tm330075395.github.io/docs/CanaanK230/part5/AIDemodocumentation"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="AI Demo说明文档 | 正点原子"><meta data-rh="true" name="description" content="1. AI Demo开发框架介绍"><meta data-rh="true" property="og:description" content="1. AI Demo开发框架介绍"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://tm330075395.github.io/docs/CanaanK230/part5/AIDemodocumentation"><link data-rh="true" rel="alternate" href="https://tm330075395.github.io/docs/CanaanK230/part5/AIDemodocumentation" hreflang="en"><link data-rh="true" rel="alternate" href="https://tm330075395.github.io/docs/CanaanK230/part5/AIDemodocumentation" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="正点原子 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="正点原子 Atom Feed"><link rel="stylesheet" href="/assets/css/styles.ce37c9a8.css">
<script src="/assets/js/runtime~main.fcaa3de9.js" defer="defer"></script>
<script src="/assets/js/main.252b8acf.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">My Site</b></a><a class="navbar__item navbar__link" href="/docs/intro">Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/CanaanK230/Userdoc">CanMV-K230教程</a><a href="http://www.alientek.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">正点原子官网<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="http://www.openedv.com/forum.php" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">论坛<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tm330075395/tm330075395.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/CanaanK230/Userdoc">文档阅读指南</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/1开发板上手指南-1">1.开发板上手指南</a><button aria-label="Expand sidebar category &#x27;1.开发板上手指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/2开发环境搭建指南-1">2.开发环境搭建指南</a><button aria-label="Expand sidebar category &#x27;2.开发环境搭建指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/3嵌入式应用开发指南-1">3.嵌入式应用开发指南</a><button aria-label="Expand sidebar category &#x27;3.嵌入式应用开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/4ai应用开发指南-1">4.AI应用开发指南</a><button aria-label="Expand sidebar category &#x27;4.AI应用开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/5micropython应用开发指南-1">5.MicroPython应用开发指南</a><button aria-label="Collapse sidebar category &#x27;5.MicroPython应用开发指南&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/CanMV-K230QuickStartGuide">CanMV-K230 快速入门指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/IDEinstructionsforuse">2.IDE使用说明</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/Instructionsforuse">1.使用说明</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/nncase_runtimemodule">3.nncase_runtime模块</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/ramdiskinstructionsforuse">4.ramdisk使用说明</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/CanaanK230/part5/AIDemodocumentation">AI Demo说明文档</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/Facedetection">2.人脸检测</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/PeripheralsRoutineexplanation">3.外设 例程讲解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/MultimediaRoutineExplanation">4.多媒体 例程讲解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/NetworkRoutineExplanation">5.网络 例程讲解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/UcryptolibmoduleAPImanual">1.1 Ucryptolib 模块API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/HashlibmoduleAPImanual">1.2 Hashlib 模块API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/utimetime-dependentfunctionmoduleAPImanual">1.3 utime 时间相关的功能 API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/uctypesmoduleAPImanual">2.1 uctypes 模块API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/newworkModuleAPIManual">2.2 network 模块API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/socketModuleAPIManual">2.3 socket 模块API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/ADCModuleAPImanual">2.4 ADC 模块API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/FFTmoduleAPImanual">2.5 FFT API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/K230CanMVPinModuleAPIManual">2.6 K230 CanMV Pin 模块API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/I2CModuleAPIManual">2.7 I2C 模块API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/K230CanMVFPIOAModuleAPIManual">2.8 K230 CanMV FPIOA 模块API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/PWMModuleAPIManual">2.9 PWM 模块API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/SPIModuleAPIManual">2.10 SPI 模块API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/TimerModuleAPIManual">2.11 Timer 模块API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/WDTModuleAPIManual">2.12 WDT 模块API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/UARTModuleAPIManual">2.13 UART 模块API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/machinemoduleAPImanual">2.14 machine 模块API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/SensorModuleAPIManual">3.1 Sensor 模块API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/DisplayModuleAPIManual">3.2 Display模块API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/AudioModuleAPIManual">3.3 Audio 模块API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/MediaModuleAPIManual">3.8 Media模块API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/PMModuleAPIManual">3.9 PM 模块API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/imageAPImanual">3.9 image 图像处理 API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/LVGLUserManual">3.10 LVGL 使用手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/K230CanMVnncase_runtimeModuleAPIManual">4.1 K230 CanMV nncase_runtime 模块API手册</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/FAQs">常见问题解答</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/Imprint">版本说明</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part5/CorrespondencewithK230_SDKandnncaseversions">与K230_SDK、nncase版本对应关系</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/6系统开发指南-1">6.系统开发指南</a><button aria-label="Expand sidebar category &#x27;6.系统开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/7sdk-api参考指南-1">7.SDK API参考指南</a><button aria-label="Expand sidebar category &#x27;7.SDK API参考指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/8常见问题-1">8.常见问题</a><button aria-label="Expand sidebar category &#x27;8.常见问题&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/5micropython应用开发指南-1"><span itemprop="name">5.MicroPython应用开发指南</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">AI Demo说明文档</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>AI Demo说明文档</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-ai-demo开发框架介绍">1. AI Demo开发框架介绍<a href="#1-ai-demo开发框架介绍" class="hash-link" aria-label="Direct link to 1. AI Demo开发框架介绍" title="Direct link to 1. AI Demo开发框架介绍">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-ai-demo开发框架">1.1. AI Demo开发框架<a href="#11-ai-demo开发框架" class="hash-link" aria-label="Direct link to 1.1. AI Demo开发框架" title="Direct link to 1.1. AI Demo开发框架">​</a></h3>
<p>为了帮助用户简化AI部分的开发，基于K230_CanMV提供的API接口，搭建了配套的AI 开发框架。框架结构如下图所示：</p>
<p><img decoding="async" loading="lazy" alt="开发框架" src="/assets/images/framework-1721614688998-7-6993c6cf5f43b4b94b3cfcf42ae2d34a.png" width="1033" height="495" class="img_ev3q"></p>
<p>Camera默认出两路图像，一路格式为YUV420，直接给到Display显示；另一路格式为RGB888，给到AI部分进行处理。AI主要实现任务的前处理、推理和后处理流程，得到后处理结果后将其绘制在osd image实例上，并送给Display叠加显示。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-接口介绍">1.2. 接口介绍<a href="#12-接口介绍" class="hash-link" aria-label="Direct link to 1.2. 接口介绍" title="Direct link to 1.2. 接口介绍">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="121-pipeline">1.2.1. PipeLine<a href="#121-pipeline" class="hash-link" aria-label="Direct link to 1.2.1. PipeLine" title="Direct link to 1.2.1. PipeLine"> ​</a></h4>
<p>我们将Media部分的代码封装在PipeLine类型中，通过固定的接口实现整个流程操作。</p>
<p>其中PipeLine类提供的接口包括：</p>
<ul>
<li>
<p>初始化参数包括：</p>
<p>（1）rgb888p_size：list类型，预设给到AI部分的图像分辨率；如rgb888p_size=[1920,1080]。</p>
<p>（2）display_size：list类型，显示部分Display的分辨率；如display_size=[1920,1080]。</p>
<p>（3）display_mode：str类型，显示模式，包括”hdmi“和”lcd“；如display_mode=”hdmi“。</p>
<p>（4）debug_mode：int类型，耗时调试模式，如果大于0，打印操作耗时；如debug_mode=0。</p>
</li>
<li>
<p>create(sensor=None,hmirror=None,vfilp=None)：</p>
<p>（1）sensor：参数为可选参数，类型为Sensor对象，可自主配置现有CanMV、01Studio和k230d zero开发板实现了自动探测，可以默认使用create()实现。</p>
<p>（2）hmirror：默认为None，当主动设置时为bool类型（True/False），表示是否实现水平方向镜像显示。</p>
<p>（3）vflip: 默认为None，当主动设置时为bool类型（True/False），表示是否实现垂直方向翻转。</p>
</li>
<li>
<p>get_frame()：返回一帧ulab.numpy.ndarray类型图像数据，分辨率为rgb888p_size，排布为CHW。</p>
</li>
<li>
<p>show_image()：PipeLine实例中预设一帧OSD图像，该接口将成员变量osd_img显示在屏幕上。</p>
</li>
<li>
<p>destroy()：销毁PipeLine实例。</p>
</li>
</ul>
<p>下面给出无AI部分的示例代码：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys,os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__ == &quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，用于图像处理流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl = PipeLine(rgb888p_size=[1920,1080], display_size=display_size, display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()  # 创建PipeLine实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()                      # 检查是否有退出信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img = pl.get_frame()            # 获取当前帧数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                print(img.shape)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()                    # 垃圾回收</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)                  # 打印异常信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()                            # 销毁PipeLine实例</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上述代码中，通过<code>pl.get_frame()</code>接口获取一帧分辨率为rgb888p_size的图像，类型为ulab.numpy.ndarray，排布为CHW。基于上面的代码得到了一帧图像给AI处理，您可以只关注AI推理部分的操作。</p>
<p>图像AI开发过程包括：图像预处理、模型推理、输出后处理的过程，我们将整个过程封装在Ai2d类和AIBase类中。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="122-ai2d">1.2.2. Ai2d<a href="#122-ai2d" class="hash-link" aria-label="Direct link to 1.2.2. Ai2d" title="Direct link to 1.2.2. Ai2d">​</a></h4>
<p>对于Ai2d类，我们给出了常见的几种预处理方法，包括crop/shift/pad/resize/affine。该类别提供的接口包括：</p>
<ul>
<li>初始化参数包括：</li>
</ul>
<p>（1）debug_mode：int类型，耗时调试模式，如果大于0，打印操作耗时；如debug_mode=0。</p>
<ul>
<li>set_ai2d_dtype(input_format,output_format,input_type,output_type)</li>
</ul>
<p>（1）input_format：ai2d预处理输入格式。</p>
<p>（2）output_format：ai2d预处理输出格式。</p>
<p>输入输出格式支持如下所示：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">enum class ai2d_format</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    YUV420_NV12 = 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    YUV420_NV21 = 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    YUV420_I420 = 2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NCHW_FMT = 3,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RGB_packed = 4,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RAW16 = 5,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<table><thead><tr><th>输入格式</th><th>输出格式</th><th>备注</th></tr></thead><tbody><tr><td>YUV420_NV12</td><td>RGB_planar/YUV420_NV12</td><td></td></tr><tr><td>YUV420_NV21</td><td>RGB_planar/YUV420_NV21</td><td></td></tr><tr><td>YUV420_I420</td><td>RGB_planar/YUV420_I420</td><td></td></tr><tr><td>YUV400</td><td>YUV400</td><td></td></tr><tr><td>NCHW(RGB_planar)</td><td>NCHW(RGB_planar)</td><td></td></tr><tr><td>RGB_packed</td><td>RGB_planar/RGB_packed</td><td></td></tr><tr><td>RAW16</td><td>RAW16/8</td><td>深度图，执行shift操作</td></tr></tbody></table>
<p>（3）input_type：输入数据类型。</p>
<p>（4）output_type：输出数据类型。</p>
<p>下面是接口调用示例：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_ai2d=Ai2d(debug_mode=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_ai2d.set_ai2d_type(nn.ai2d_format.NCHW_FMT, nn.ai2d_format.NCHW_FMT, np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_ai2d.set_ai2d_type(nn.ai2d_format.RGB_packed, nn.ai2d_format.NCHW_FMT, np.uint8, np.uint8)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>
<p>crop(start_x,start_y,width,height)：预处理crop函数。</p>
<p>（1）start_x：宽度方向的起始像素,int类型；</p>
<p>（2）start_y: 高度方向的起始像素,int类型；</p>
<p>（3）width: 宽度方向的crop长度,int类型；</p>
<p>（4）height: 高度方向的crop长度,int类型；</p>
</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">my_ai2d.crop(0,0,200,300)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>shift(shift_val)：预处理shift函数。</li>
</ul>
<p>（1）shift_val:右移的比特数,int类型;</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">my_ai2d.shift(2)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>pad(paddings,pad_mode,pad_val)：预处理padding函数。</li>
</ul>
<p>（1）paddings：list类型，各维度两侧padding的大小，对于4维的图像(NCHW)，该参数包含8个值，分别表示N/C/H/W四个维度两侧的padding大小，一般只在后两个维度做padding；</p>
<p>（2）pad_mode：只支持constant padding，直接设为0；</p>
<p>（3）pad_val：list类型，每个像素位置填充的值，比如[114,114,114]、[0,0,0]</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">my_ai2d.pad([0,0,0,0,5,5,15,15],0,[114,114,114])</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>resize(interp_method,interp_mode)：预处理resize函数。</li>
</ul>
<p>（1）interp_method：resize插值方法，ai2d_interp_method类型，包括：nn.interp_method.tf_nearest、nn.interp_method.tf_bilinear、nn.interp_method.cv2_nearest、nn.interp_method.cv2_bilinear；</p>
<p>（2）interp_mode：resize模式，ai2d_interp_mode类型，包括：nn.interp_mode.none、nn.interp_mode.align_corner、nn.interp_mode.half_pixel；</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">my_ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>affine(interp_method,crop_round,bound_ind,bound_val,bound_smooth,M)：预处理affine函数。</li>
</ul>
<p>（1）interp_method：Affine采用的插值方法,ai2d_interp_method类型，包括：nn.interp_method.tf_nearest、nn.interp_method.tf_bilinear、nn.interp_method.cv2_nearest、nn.interp_method.cv2_bilinear；</p>
<p>（2）cord_round:整数边界0或者1,uint32_t类型；</p>
<p>（3）bound_ind:边界像素模式0或者1,uint32_t类型；</p>
<p>（4）bound_val:边界填充值,uint32_t类型；</p>
<p>（5）bound_smooth:边界平滑0或者1,uint32_t类型；</p>
<p>（6）M:仿射变换矩阵对应的vector，仿射变换为Y=[a_0, a_1; a_2, a_3] \cdot X + [b_0, b_1] $, 则 M=[a_0,a_1,b_0,a_2,a_3,b_1 ],list类型。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">affine_matrix=[0.2159457, -0.031286, -59.5312, 0.031286, 0.2159457, -35.30719]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_ai2d.affine(nn.interp_method.cv2_bilinear,0, 0, 127, 1,affine_matrix)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>build(ai2d_input_shape,ai2d_output_shape)：ai2d构造函数，前面配置的预处理方法起作用。</li>
</ul>
<p>（1）ai2d_input_shape：ai2d输入shape，list类型；</p>
<p>（2）ai2d_output_shape：ai2d输出shape，list类型；</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">my_ai2d.build([1,3,224,224],[1,3,512,512])</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>run(input_np)：调用配置好的ai2d进  行预处理的函数，返回一个tensor类型数据，可以直接给模型使用，也可以通过to_numpy()转换成ulab.numpy.ndarray类型的数据。</li>
</ul>
<p>（1）input_np：ulab.numpy.ndarray类型，ai2d预处理的输入数据，shape和build函数中设置的ai2d_input_shape一致。</p>
<blockquote>
<p>注意：</p>
<p>(1) Affine和Resize功能是互斥的，不能同时开启； (2) Shift功能的输入格式只能是Raw16； (3) Pad value是按通道配置的，对应的list元素个数要与channel数相等； (4) 当配置了多个功能时，执行顺序是Crop-&gt;Shift-&gt;Resize/Affine-&gt;Pad, 配置参数时注意要匹配；如果不符合该顺序，需要初始化多个Ai2d实例实现预处理过程；</p>
</blockquote>
<p>下面是一个完整的示例：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys,os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__ == &quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，用于图像处理流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl = PipeLine(rgb888p_size=[512,512], display_size=display_size, display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()  # 创建PipeLine实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my_ai2d=Ai2d(debug_mode=0) #初始化Ai2d实例 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置resize预处理方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my_ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 构建预处理过程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my_ai2d.build([1,3,512,512],[1,3,640,640])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()                      # 检查是否有退出信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img = pl.get_frame()            # 获取当前帧数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                print(img.shape)                # 原图shape为[1,3,512,512]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ai2d_output_tensor=my_ai2d.run(img) # 执行resize预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ai2d_output_np=ai2d_output_tensor.to_numpy() # 类型转换</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                print(ai2d_output_np.shape)        # 预处理后的shape为[1,3,640,640]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()                    # 垃圾回收</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)                  # 打印异常信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()                            # 销毁PipeLine实例</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="123-aibase">1.2.3. AIBase<a href="#123-aibase" class="hash-link" aria-label="Direct link to 1.2.3. AIBase" title="Direct link to 1.2.3. AIBase">​</a></h4>
<p>AIBase部分封装了实现模型推理的主要接口，也是进行AI开发主要关注的部分。用户需要按照自己demo的要求实现前处理和后处理部分。</p>
<p>AIBase提供的接口包括：</p>
<ul>
<li>初始化参数包括：</li>
</ul>
<p>（1）kmodel_path：str类型，kmodel路径，用于初始化kpu对象并加载kmodel；</p>
<p>（2）model_input_size：list类型，可选，模型输入分辨率，在单输入时起作用，格式为[width,height]，如：model_input_size=[512,512];</p>
<p>（3）rgb888p_size：list类型，可选，AI得到的图像的分辨率，在单输入时起作用，格式为[width，height]，如：rgb888p_size=[640,640];</p>
<p>（4）debug_mode：int类型，耗时调试模式，如果大于0，打印操作耗时；如debug_mode=0。</p>
<ul>
<li>get_kmodel_inputs_num()：返回当前模型的输入个数；</li>
<li>get_kmodel_outputs_num()：返回当前模型的输出个数；</li>
<li>preprocess(input_np)：使用ai2d对input_np做预处理，<strong>如果不使用单个ai2d实例做预处理，需要在子类重写该函数</strong>。</li>
</ul>
<p>（1）input_np：ulab.numpy.ndarray类型，ai2d预 处理输入数据；</p>
<p>（2）返回tensor列表；<strong>如果该方法重写，请注意返回类型：tensor类型的列表；</strong></p>
<ul>
<li>inference(tensors)：对预处理后得到的kmodel的输入（类型为tensor）进行推理，得到多个输出（类型为ulab.numpy.ndarray）；</li>
</ul>
<p>（1）tensors：列表类型，模型的输入，可以是一个可以是多个；</p>
<p>（2）返回ulab.numpy.ndarray类型的列表；</p>
<blockquote>
<p><strong>Tips:</strong></p>
<p>Image对象转ulab.numpy.ndarray：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">img.to_rgb888().to_numpy_ref() #返回的array是HWC排布</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ulab.numpy.ndarray转Image对象：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">img_np = np.zeros((height,width,4),dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">img = image.Image(width, height, image.ARGB8888, alloc=image.ALLOC_REF,data =img_np)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ulab.numpy.ndarray转tensor类型：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">img_np = np.zeros((height,width,4),dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tensor = nn.from_numpy(img_np)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>tensor 类型转ulab.numpy.ndarray：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">img_np=tensor.to_numpy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</blockquote>
<ul>
<li>postprocess(results)：模型输出后处理函数，该函数需要用户在任务子类重写，因为不同AI任务的后处理是不同的。</li>
</ul>
<p>（1）results：list类型，list元素是ulab.numpy.ndarray类型，模型的推理输出。</p>
<ul>
<li>run(input_np)：模型的前处理、推理、后处理流程，适用于单ai2d实例能解决的前处理的AI任务，其他任务需要用户在子类重写。</li>
</ul>
<p>（1）input_np：ulab.numpy.ndarray类型，ai2d预处理输入数据；该数据通过ai2d预处理输出1个tensor,tensor通过模型推理得到输出列表results，results经过后处理过程得到AI结果。</p>
<ul>
<li>deinit()：AIBase销毁函数。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="124-scopedtiming">1.2.4. ScopedTiming<a href="#124-scopedtiming" class="hash-link" aria-label="Direct link to 1.2.4. ScopedTiming" title="Direct link to 1.2.4. ScopedTiming">​</a></h4>
<p>ScopedTiming 类在PipeLine.py模块内，是一个用来测量代码块执行时间的上下文管理器。上下文管理器通过定义包含 <code>__enter__</code> 和 <code>__exit__</code> 方法的类来创建。当在 with 语句中使用该类的实例时，<code>__enter__</code> 在进入 with 块时被调用，<code>__exit__</code> 在离开时被调用。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def test_time():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    with ScopedTiming(&quot;test&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #####代码#####</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ##############</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="13-应用方法和示例">1.3. 应用方法和示例<a href="#13-应用方法和示例" class="hash-link" aria-label="Direct link to 1.3. 应用方法和示例" title="Direct link to 1.3. 应用方法和示例">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="131-概述">1.3.1. 概述<a href="#131-概述" class="hash-link" aria-label="Direct link to 1.3.1. 概述" title="Direct link to 1.3.1. 概述">​</a></h4>
<p>用户可根据具体的AI场景自写任务类继承AIBase，可以将任务分为如下四类：单模型任务、多模型任务，自定义预处理任务、无预处理任务。不同任务需要编写不同的代码实现，具体如下图所示：</p>
<p><img decoding="async" loading="lazy" alt="不同任务类型" src="/assets/images/task_diff-1721614741114-10-fd8b2becab43c264215f15e3d211f510.png" width="983" height="602" class="img_ev3q"></p>
<p>关于不同任务的介绍：</p>
<table><thead><tr><th>任务类型</th><th>任务描述</th><th>代码说明</th></tr></thead><tbody><tr><td>单模型任务</td><td>该任务只有一个模型，只需要关注该  模型的前处理、推理、后处理过程，此类任务的前处理使用Ai2d实现，可能使用一个Ai2d实例，也可能使用多个Ai2d实例，后处理基于场景自定义。</td><td>编写自定义任务类，主要关注任务类的config_preprocess、postprocess、以及该任务需要的其他方法如：draw_result等。 如果该任务包含多个Ai2d实例，则需要重写preprocess，按照预处理的顺序设置预处理阶段的计算过程。</td></tr><tr><td>自定义预处理任务</td><td>该任务只有一个模型，只需要关注该模型的前处理、推理、后处理过程，此类任务的前处理不使用Ai2d实现，可以使用ulab.numpy自定义，后处理基于场景自定义。</td><td>编写自定义任务类，主要关注任务类的preprocess、postprocess、以及该任务需要的其他方法如：draw_result等</td></tr><tr><td>无预处理任务</td><td>该任务只有一个模型且不需要预处理，只需要关注该模型的推理和后处理过程，此类任务一般作为多模型任务的一部分，直接对前一个模型的输出做为输入推理，后处理基于需求自定义。</td><td>编写自定义任务类，主要关注任务类的run(模型推理的整个过程，包括preprocess、inference、postprocess中的全部或某一些步骤)、postprocess、以及该任务需要的其他方法如：draw_results等</td></tr><tr><td>多模型任务</td><td>该任务包含多个模型，可能是串联，也可能是其他组合方式。对于每个模型基本上属于前三种模型中的一种，最后通过一个完整的任务类将上述模型子任务统一起来。</td><td>编写多个子模型任务类，不同子模型任务参照前三种任务定义。不同任务关注不同的方法。 编写多模型任务类，将子模型任务类统一起来实现整个场景。</td></tr></tbody></table>
<table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="132-单模型任务">1.3.2. 单模型任务<a href="#132-单模型任务" class="hash-link" aria-label="Direct link to 1.3.2. 单模型任务" title="Direct link to 1.3.2. 单模型任务">​</a></h4>
<p>单模型任务的伪代码结构如下：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义AI任务类，继承自AIBase基类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class MyAIApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, kmodel_path, model_input_size, rgb888p_size=[224,224], display_size=[1920,1080], debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 调用基类的构造函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path, model_input_size, rgb888p_size, debug_mode)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path = kmodel_path  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size = model_input_size  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，并对宽度进行16的对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size = [ALIGN_UP(rgb888p_size[0], 16), rgb888p_size[1]]   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 显示分辨率，并对宽度进行16的对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size = [ALIGN_UP(display_size[0], 16), display_size[1]] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 是否开启调试模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode = debug_mode  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 实例化Ai2d，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d = Ai2d(debug_mode)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT, nn.ai2d_format.NCHW_FMT, np.uint8, np.uint8)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self, input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;, self.debug_mode &gt; 0): </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size = input_image_size if input_image_size else self.rgb888p_size  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 配置resize预处理方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理，results是模型输出array列表，需要根据实际任务重写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self, results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制结果到画面上，需要根据任务自己写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self, pl, dets):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;display_draw&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__ == &quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置模型路径，这里要替换成当前任务模型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_path = &quot;example_test.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size = [1920, 1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ###### 其它参数########</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ######################</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，用于图像处理流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl = PipeLine(rgb888p_size=rgb888p_size, display_size=display_size, display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()  # 创建PipeLine实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化自定义AI任务实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my_ai = MyAIApp(kmodel_path, model_input_size=[320, 320],rgb888p_size=rgb888p_size, display_size=display_size, debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my_ai.config_preprocess()  # 配置预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()                      # 检查是否有退出信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img = pl.get_frame()            # 获取当前帧数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                res = my_ai.run(img)            # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                my_ai.draw_result(pl, res)      # 绘制结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                 # 显示结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()                    # 垃圾回收</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)                  # 打印异常信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        my_ai.deinit()                          # 反初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()                            # 销毁PipeLine实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>下面以人脸检测为例给出示例代码：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import utime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aidemo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义人脸检测类，继承自AIBase基类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FaceDetectionApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, kmodel_path, model_input_size, anchors, confidence_threshold=0.5, nms_threshold=0.2, rgb888p_size=[224,224], display_size=[1920,1080], debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path, model_input_size, rgb888p_size, debug_mode)  # 调用基类的构造函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path = kmodel_path  # 模型文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size = model_input_size  # 模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold = confidence_threshold  # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold = nms_threshold  # NMS（非极大值抑制）阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors = anchors  # 锚点数据，用于目标检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size = [ALIGN_UP(rgb888p_size[0], 16), rgb888p_size[1]]  # sensor给到AI的图像分辨率，并对宽度进行16的对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size = [ALIGN_UP(display_size[0], 16), display_size[1]]  # 显示分辨率，并对宽度进行16的对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode = debug_mode  # 是否开启调试模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d = Ai2d(debug_mode)  # 实例化Ai2d，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT, nn.ai2d_format.NCHW_FMT, np.uint8, np.uint8)  # 设置Ai2d的输入输出格 式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self, input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;, self.debug_mode &gt; 0):  # 计时器，如果debug_mode大于0则开启</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size = input_image_size if input_image_size else self.rgb888p_size  # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            top, bottom, left, right = self.get_padding_param()  # 获取padding参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad([0, 0, 0, 0, top, bottom, left, right], 0, [104, 117, 123])  # 填充边缘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)  # 缩放图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])  # 构建预处理流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理，results是模型输出array列表，这里使用了aidemo库的face_det_post_process接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self, results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            post_ret = aidemo.face_det_post_process(self.confidence_threshold, self.nms_threshold, self.model_input_size[1], self.anchors, self.rgb888p_size, results)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if len(post_ret) == 0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return post_ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return post_ret[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制检测结果到画面上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self, pl, dets):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;display_draw&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if dets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.clear()  # 清除OSD图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for det in dets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # 将检测框的坐标转换为显示分辨率下的坐标</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x, y, w, h = map(lambda x: int(round(x, 0)), det[:4])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x = x * self.display_size[0] // self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    y = y * self.display_size[1] // self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    w = w * self.display_size[0] // self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    h = h * self.display_size[1] // self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_rectangle(x, y, w, h, color=(255, 255, 0, 255), thickness=2)  # 绘制矩形框</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 获取padding参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_padding_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]  # 模型输入宽度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]  # 模型输入高度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / self.rgb888p_size[0]  # 宽度缩放比例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / self.rgb888p_size[1]  # 高度缩放比例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio = min(ratio_w, ratio_h)  # 取较小的缩放比例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = int(ratio * self.rgb888p_size[0])  # 新宽度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = int(ratio * self.rgb888p_size[1])  # 新高度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2  # 宽度差</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2  # 高度差</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = int(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = int(round(dh * 2 + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = int(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = int(round(dw * 2 - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return top, bottom, left, right</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__ == &quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置模型路径和其他参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_path = &quot;/sdcard/app/tests/kmodel/face_detection_320.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其它参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold = 0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold = 0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchor_len = 4200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    det_dim = 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors_path = &quot;/sdcard/app/tests/utils/prior_data_320.bin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = np.fromfile(anchors_path, dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = anchors.reshape((anchor_len, det_dim))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size = [1920, 1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，用于图像处理流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl = PipeLine(rgb888p_size=rgb888p_size, display_size=display_size, display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()  # 创建PipeLine实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化自定义人脸检测实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_det = FaceDetectionApp(kmodel_path, model_input_size=[320, 320], anchors=anchors, confidence_threshold=confidence_threshold, nms_threshold=nms_threshold, rgb888p_size=rgb888p_size, display_size=display_size, debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_det.config_preprocess()  # 配置预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()                      # 检查是否有退出信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img = pl.get_frame()            # 获取当前帧数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                res = face_det.run(img)         # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                face_det.draw_result(pl, res)   # 绘制结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                 # 显示结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()                    # 垃圾回收</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)                  # 打印异常信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        face_det.deinit()                       # 反初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()                            # 销毁PipeLine实例</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>多个Ai2d实例时的伪代码如下：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义AI任务类，继承自AIBase基类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class MyAIApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, kmodel_path, model_input_size, rgb888p_size=[224,224], display_size=[1920,1080], debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 调用基类的构造函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path, model_input_size, rgb888p_size, debug_mode)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path = kmodel_path  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size = model_input_size  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，并对宽度进行16的对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size = [ALIGN_UP(rgb888p_size[0], 16), rgb888p_size[1]]   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 显示分辨率，并对宽度进行16的对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size = [ALIGN_UP(display_size[0], 16), display_size[1]] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 是否开启调试模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode = debug_mode  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 实例化Ai2d，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d_resize = Ai2d(debug_mode)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d_resize.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT, nn.ai2d_format.NCHW_FMT, np.uint8, np.uint8)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 实例化Ai2d，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d_resize = Ai2d(debug_mode)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d_resize.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT, nn.ai2d_format.NCHW_FMT, np.uint8, np.uint8)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 实例化Ai2d，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d_crop = Ai2d(debug_mode)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d_crop.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT, nn.ai2d_format.NCHW_FMT, np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self, input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;, self.debug_mode &gt; 0): </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size = input_image_size if input_image_size else self.rgb888p_size  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 配置resize预处理方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d_resize.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d_resize.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,640,640])  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 配置crop预处理方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d_crop.crop(0,0,320,320)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d_crop.build([1,3,640,640],[1,3,320,320])  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 假设该任务需要crop和resize预处理，顺序是先resize再crop，该顺序不符合ai2d的处理顺序，因此需要设置两个Ai2d实例分别处理       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def preprocess(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resize_tensor=self.ai2d_resize.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resize_np=resize_tensor.to_numpy()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        crop_tensor=self.ai2d_crop.run(resize_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [crop_tensor]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理，results是模型输出array列表，需要根据实际任务重写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self, results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制结果到画面上，需要根据任务自己写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self, pl, dets):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;display_draw&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 重写deinit，释放多个ai2d资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def deinit(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;deinit&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            del self.ai2d_resize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            del self.ai2d_crop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            super().deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__ == &quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置模型路径，这里要替换成当前任务模型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_path = &quot;example_test.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size = [1920, 1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ###### 其它参数########</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ######################</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，用于图像处理流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl = PipeLine(rgb888p_size=rgb888p_size, display_size=display_size, display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()  # 创建PipeLine实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化自定义AI任务实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my_ai = MyAIApp(kmodel_path, model_input_size=[320, 320],rgb888p_size=rgb888p_size, display_size=display_size, debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my_ai.config_preprocess()  # 配置预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()                      # 检查是否有退出信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img = pl.get_frame()            # 获取当前帧数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                res = my_ai.run(img)            # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                my_ai.draw_result(pl, res)      # 绘制结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                 # 显示结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()                    # 垃圾回收</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)                  # 打印异常信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        my_ai.deinit()                          # 反初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()                            # 销毁PipeLine 实例</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="133-自定义预处理任务">1.3.3. 自定义预处理任务<a href="#133-自定义预处理任务" class="hash-link" aria-label="Direct link to 1.3.3. 自定义预处理任务" title="Direct link to 1.3.3. 自定义预处理任务">​</a></h4>
<p>对于需要重写前处理（不使用提供的ai2d类，自己手动写预处理）的AI任务伪代码如下：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义AI任务类，继承自AIBase基类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class MyAIApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, kmodel_path, model_input_size, rgb888p_size=[224,224], display_size=[1920,1080], debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 调用基类的构造函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path, model_input_size, rgb888p_size, debug_mode)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path = kmodel_path  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size = model_input_size  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，并对宽度进行16的对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size = [ALIGN_UP(rgb888p_size[0], 16), rgb888p_size[1]]   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 显示分辨率，并对宽度进行16的对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size = [ALIGN_UP(display_size[0], 16), display_size[1]] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 是否开启调试模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode = debug_mode  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 实例化Ai2d，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d = Ai2d(debug_mode)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT, nn.ai2d_format.NCHW_FMT, np.uint8, np.uint8)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 对于不使用ai2d完成预处理的AI任务，使用封装的接口或者ulab.numpy实现预处理，需要在子类中重写该函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def preprocess(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #############</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #注意自定义预处理过程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #############</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [tensor]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理，results是模型输出array列表，需要根据实际任务重写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self, results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制结果到画面上，需要根据任务自己写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self, pl, dets):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;display_draw&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__ == &quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置模型路径，这里要替换成当前任务模型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_path = &quot;example_test.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size = [1920, 1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ###### 其它参数########</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ######################</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，用于图像处理流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl = PipeLine(rgb888p_size=rgb888p_size, display_size=display_size, display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()  # 创建PipeLine实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化自定义AI任务实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my_ai = MyAIApp(kmodel_path, model_input_size=[320, 320],rgb888p_size=rgb888p_size, display_size=display_size, debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my_ai.config_preprocess()  # 配置预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()                      # 检查是否有退出信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img = pl.get_frame()            # 获取当前帧数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                res = my_ai.run(img)            # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                my_ai.draw_result(pl, res)      # 绘制结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                 # 显示结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()                    # 垃圾回收</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)                  # 打印异常信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        my_ai.deinit()                          # 反初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()                            # 销毁PipeLine实例</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以关键词唤醒keyword_spotting为例：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.pyaudio import *                     # 音频模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *                       #  软件抽象模块，主要封装媒体数据链路以及媒体缓冲区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import media.wave as wave                       # wav音频处理模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn                     # nncase运行模块，封装了kpu（kmodel推理）和ai2d（图片预处理加速）操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np                         # 类似python numpy操作，但也会有一些接口不同</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aidemo                                   # aidemo模块，封装ai demo相关前处理、后处理等操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time                                     # 时间统计</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import struct                                   # 字节字符转换模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc                                       # 垃圾回收模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os,sys                                   # 操作系统接口模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义关键词唤醒类，继承自AIBase基类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class KWSApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, kmodel_path, threshold, debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path)  # 调用基类的构造函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path = kmodel_path  # 模型文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.threshold=threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode = debug_mode  # 是否开启调试模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.cache_np = np.zeros((1, 256, 105), dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义预处理，返回模型输入tensor列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def preprocess(self,pcm_data):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pcm_data_list=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 获取音频流数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for i in range(0, len(pcm_data), 2):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 每两个字节组织成一个有符号整数，然后将其转换为浮点数，即为一次采样的数据，加入到当前一帧（0.3s）的数据列表中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int_pcm_data = struct.unpack(&quot;&lt;h&quot;, pcm_data[i:i+2])[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            float_pcm_data = float(int_pcm_data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pcm_data_list.append(float_pcm_data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 将pcm数据处理为模型输入的特征向量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mp_feats = aidemo.kws_preprocess(fp, pcm_data_list)[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mp_feats_np = np.array(mp_feats).reshape((1, 30, 40))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        audio_input_tensor = nn.from_numpy(mp_feats_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cache_input_tensor = nn.from_numpy(self.cache_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [audio_input_tensor,cache_input_tensor]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理，results是模型输出array列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self, results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logits_np = results[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.cache_np= results[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            max_logits = np.max(logits_np, axis=1)[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            max_p = np.max(max_logits)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            idx = np.argmax(max_logits)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 如果分数大于阈值，且idx==1(即包含唤醒词)，播放回复音频</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if max_p &gt; self.threshold and idx == 1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__ == &quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    os.exitpoint(os.EXITPOINT_ENABLE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nn.shrink_memory_pool()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置模型路径和其他参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_path = &quot;/sdcard/app/tests/kmodel/kws.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其它参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    THRESH = 0.5                # 检测阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SAMPLE_RATE = 16000         # 采样率16000Hz,即每秒采样16000次</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CHANNELS = 1                # 通道数 1为单声道，2为立体声</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FORMAT = paInt16            # 音频输入输出格式 paInt16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CHUNK = int(0.3 * 16000)    # 每次读取音频数据的帧数，设置为0.3s的帧数16000*0.3=4800</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reply_wav_file = &quot;/sdcard/app/tests/utils/wozai.wav&quot;         # kws唤醒词回复音频路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化音频预处理接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fp = aidemo.kws_fp_create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化音频流</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    p = PyAudio()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    p.initialize(CHUNK)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MediaManager.init()    #vb buffer初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 用于采集实时音频数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_stream = p.open(format=FORMAT,channels=CHANNELS,rate=SAMPLE_RATE,input=True,frames_per_buffer=CHUNK)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 用于播放回复音频</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output_stream = p.open(format=FORMAT,channels=CHANNELS,rate=SAMPLE_RATE,output=True,frames_per_buffer=CHUNK)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化自定义关键词唤醒实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kws = KWSApp(kmodel_path,threshold=THRESH,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()                      # 检查是否有退出信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pcm_data=input_stream.read()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                res=kws.run(pcm_data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if res:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    print(&quot;====Detected XiaonanXiaonan!====&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    wf = wave.open(reply_wav_file, &quot;rb&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    wav_data = wf.read_frames(CHUNK)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    while wav_data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        output_stream.write(wav_data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        wav_data = wf.read_frames(CHUNK)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    time.sleep(1) # 时间缓冲，用于播放回复声音</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    wf.close()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    print(&quot;Deactivated!&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()                    # 垃圾回收</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)                  # 打印异常信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_stream.stop_stream()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        output_stream.stop_stream()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_stream.close()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        output_stream.close()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        p.terminate()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MediaManager.deinit()              #释放vb buffer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        aidemo.kws_fp_destroy(fp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kws.deinit()                       # 反初始化</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="134-无预处理任务">1.3.4. 无预处理任务<a href="#134-无预处理任务" class="hash-link" aria-label="Direct link to 1.3.4. 无预处理任务" title="Direct link to 1.3.4. 无预处理任务">​</a></h4>
<p>对于不需要预处理（直接输入推理）的AI任务伪代码如下：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义AI任务类，继承自AIBase基类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class MyAIApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, kmodel_path, model_input_size, rgb888p_size=[224,224], display_size=[1920,1080], debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 调用基类的构造函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path, model_input_size, rgb888p_size, debug_mode)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path = kmodel_path  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size = model_input_size  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，并对宽度进行16的对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size = [ALIGN_UP(rgb888p_size[0], 16), rgb888p_size[1]]   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 显示分辨率，并对宽度进行16的对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size = [ALIGN_UP(display_size[0], 16), display_size[1]] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 是否开启调试模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode = debug_mode  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理，results是模型输出array列表，需要根据实际任务重写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self, results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 对于用预处理的AI任务，需要在子类中重写该函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,inputs_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 先将ulab.numpy.ndarray列表转换成tensor列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tensors=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for input_np in inputs_np:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tensors.append(nn.from_numpy(input_np))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 调用AIBase内的inference函数进行模型推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        results=self.inference(tensors)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 调用当前子类的postprocess方法进行自定义后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        outputs=self.postprocess(results)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return outputs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制结果到画面上，需要根据任务自己写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self, pl, dets):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;display_draw&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__ == &quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置模型路径，这里要替换成当前任务模型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_path = &quot;example_test.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size = [1920, 1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ###### 其它参数########</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ######################</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，用于图像处理流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl = PipeLine(rgb888p_size=rgb888p_size, display_size=display_size, display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()  # 创建PipeLine实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化自定义AI任务实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my_ai = MyAIApp(kmodel_path, model_input_size=[320, 320],rgb888p_size=rgb888p_size, display_size=display_size, debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my_ai.config_preprocess()  # 配置预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()                      # 检查是否有退出信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img = pl.get_frame()            # 获取当前帧数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                res = my_ai.run(img)            # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                my_ai.draw_result(pl, res)      # 绘制结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                 # 显示结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()                    # 垃圾回收</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)                  # 打印异常信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        my_ai.deinit()                          # 反初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()                            # 销毁PipeLine实例</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>比如单目标跟踪（nanotracker.py）中的追踪模块，只需要对模版模型和实时推理模型的输出作为追踪模型的输入，不需要预处理：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class TrackerApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,crop_input_size,thresh,rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # crop模型的输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_input_size=crop_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 跟踪框阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.thresh=thresh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 跟踪框宽、高调整系数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.CONTEXT_AMOUNT = 0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 可以不定义</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 可以不定义</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 重写run函数，因为没有预处理过程，所以原来run操作中包含的preprocess-&gt;inference-&gt;postprocess不合适，这里只包含inference-&gt;postprocess</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np_1,input_np_2,center_xy_wh):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_tensors=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_tensors.append(nn.from_numpy(input_np_1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_tensors.append(nn.from_numpy(input_np_2))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        results=self.inference(input_tensors)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return self.postprocess(results,center_xy_wh)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出array的列表,这里使用了aidemo的nanotracker_postprocess列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results,center_xy_wh):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            det = aidemo.nanotracker_postprocess(results[0],results[1],[self.rgb888p_size[1],self.rgb888p_size[0]],self.thresh,center_xy_wh,self.crop_input_size[0],self.CONTEXT_AMOUNT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return det</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="135-多模型任务">1.3.5. 多模型任务<a href="#135-多模型任务" class="hash-link" aria-label="Direct link to 1.3.5. 多模型任务" title="Direct link to 1.3.5. 多模型任务">​</a></h4>
<p>这里以双模型串联推理为例，给出的伪代码如下：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义AI任务类，继承自AIBase基类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class MyAIApp_1(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, kmodel_path, model_input_size, rgb888p_size=[224,224], display_size=[1920,1080], debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 调用基类的构造函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path, model_input_size, rgb888p_size, debug_mode)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path = kmodel_path  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size = model_input_size  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，并对宽度进行16的对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size = [ALIGN_UP(rgb888p_size[0], 16), rgb888p_size[1]]   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 显示分辨率，并对宽度进行16的对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size = [ALIGN_UP(display_size[0], 16), display_size[1]] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 是否开启调试模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode = debug_mode  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 实例化Ai2d，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d = Ai2d(debug_mode)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT, nn.ai2d_format.NCHW_FMT, np.uint8, np.uint8)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self, input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;, self.debug_mode &gt; 0): </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size = input_image_size if input_image_size else self.rgb888p_size  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 配置resize预处理方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理，results是模型输出array列表，需要根据实际任务重写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self, results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义AI任务类，继承自AIBase基类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class MyAIApp_2(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, kmodel_path, model_input_size, rgb888p_size=[224,224], display_size=[1920,1080], debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 调用基类的构造函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path, model_input_size, rgb888p_size, debug_mode)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path = kmodel_path  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size = model_input_size  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，并对宽度进行16的对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size = [ALIGN_UP(rgb888p_size[0], 16), rgb888p_size[1]]   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 显示分辨率，并对宽度进行16的对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size = [ALIGN_UP(display_size[0], 16), display_size[1]] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 是否开启调试模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode = debug_mode  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 实例化Ai2d，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d = Ai2d(debug_mode)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT, nn.ai2d_format.NCHW_FMT, np.uint8, np.uint8)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self, input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;, self.debug_mode &gt; 0): </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size = input_image_size if input_image_size else self.rgb888p_size  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 配置resize预处理方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理，results是模型输出array列表，需要根据实际任务重写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self, results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class MyApp:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(kmodel1_path,kmodel2_path,kmodel1_input_size,kmodel2_input_size,rgb888p_size,display_size,debug_mode):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 创建两个模型推理的实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.app_1=MyApp_1(kmodel1_path,kmodel1_input_size,rgb888p_size,display_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.app_2=MyApp_2(kmodel2_path,kmodel2_input_size，rgb888p_size,display_size，debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.app_1.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 编写run函数，具体代码根据AI任务的需求编写，此处只是给出一个示例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        outputs_1=self.app_1.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        outputs_2=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for out in outputs_1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.app_2.config_preprocess(out)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            out_2=self.app_2.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            outputs_2.append(out_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return outputs_1,outputs_2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,outputs_1,outputs_2):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ######其他函数########</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ####################</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__ == &quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size = [1920, 1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置模型路径，这里要替换成当前任务模型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel1_path = &quot;test_kmodel1.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmdoel1_input_size=[320,320]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel2_path = &quot;test_kmodel2.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel2_input_size=[48,48]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ###### 其它参数########</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ######################</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，用于图像处理流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl = PipeLine(rgb888p_size=rgb888p_size, display_size=display_size, display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()  # 创建PipeLine实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化自定义AI任务实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my_ai = MyApp(kmodel1_path,kmodel2_path, kmodel1_input_size,kmodel2_input_size,rgb888p_size=rgb888p_size, display_size=display_size, debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my_ai.config_preprocess()  # 配置预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()                      # 检查是否有退出信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img = pl.get_frame()            # 获取当前帧数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                outputs_1,outputs_2 = my_ai.run(img)            # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                my_ai.draw_result(pl, outputs_1,outputs_2)      # 绘制结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                 # 显示结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()                    # 垃圾回收</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)                  # 打印异常信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        my_ai.app_1.deinit()                    # 反初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        my_ai.app_2.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()                            # 销毁PipeLine实例</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>下面以车牌检测为例给出示例代码：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aidemo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义车牌检测类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class LicenceDetectionApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化函数，设置车牌检测应用的参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, kmodel_path, model_input_size, confidence_threshold=0.5, nms_threshold=0.2, rgb888p_size=[224,224], display_size=[1920,1080], debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path, model_input_size, rgb888p_size, debug_mode)  # 调用基类的初始化函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path = kmodel_path  # 模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size = model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 分类阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold = confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold = nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size = [ALIGN_UP(rgb888p_size[0], 16), rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 显示分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size = [ALIGN_UP(display_size[0], 16), display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode = debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ai2d实例，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d = Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT, nn.ai2d_format.NCHW_FMT, np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self, input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size = input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self, results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 对检测结果进行后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            det_res = aidemo.licence_det_postprocess(results, [self.rgb888p_size[1], self.rgb888p_size[0]], self.model_input_size, self.confidence_threshold, self.nms_threshold)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return det_res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义车牌识别任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class LicenceRecognitionApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 车牌字符字典</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.dict_rec = [&quot;挂&quot;, &quot;使&quot;, &quot;领&quot;, &quot;澳&quot;, &quot;港&quot;, &quot;皖&quot;, &quot;沪&quot;, &quot;津&quot;, &quot;渝&quot;, &quot;冀&quot;, &quot;晋&quot;, &quot;蒙&quot;, &quot;辽&quot;, &quot;吉&quot;, &quot;黑&quot;, &quot;苏&quot;, &quot;浙&quot;, &quot;京&quot;, &quot;闽&quot;, &quot;赣&quot;, &quot;鲁&quot;, &quot;豫&quot;, &quot;鄂&quot;, &quot;湘&quot;, &quot;粤&quot;, &quot;桂&quot;, &quot;琼&quot;, &quot;川&quot;, &quot;贵&quot;, &quot;云&quot;, &quot;藏&quot;, &quot;陕&quot;, &quot;甘&quot;, &quot;青&quot;, &quot;宁&quot;, &quot;新&quot;, &quot;警&quot;, &quot;学&quot;, &quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;, &quot;8&quot;, &quot;9&quot;, &quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;, &quot;E&quot;, &quot;F&quot;, &quot;G&quot;, &quot;H&quot;, &quot;J&quot;, &quot;K&quot;, &quot;L&quot;, &quot;M&quot;, &quot;N&quot;, &quot;P&quot;, &quot;Q&quot;, &quot;R&quot;, &quot;S&quot;, &quot;T&quot;, &quot;U&quot;, &quot;V&quot;, &quot;W&quot;, &quot;X&quot;, &quot;Y&quot;, &quot;Z&quot;, &quot;_&quot;, &quot;-&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.dict_size = len(self.dict_rec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了resize，Ai2d支持crop/shift/pad/resize/affine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出的array列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            output_data=results[0].reshape((-1,self.dict_size))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            max_indices = np.argmax(output_data, axis=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result_str = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for i in range(max_indices.shape[0]):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                index = max_indices[i]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if index &gt; 0 and (i == 0 or index != max_indices[i - 1]):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    result_str += self.dict_rec[index - 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result_str</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 车牌识别任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class LicenceRec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,licence_det_kmodel,licence_rec_kmodel,det_input_size,rec_input_size,confidence_threshold=0.25,nms_threshold=0.3,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 车牌检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.licence_det_kmodel=licence_det_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 车牌识别模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.licence_rec_kmodel=licence_rec_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.det_input_size=det_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸姿态模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rec_input_size=rec_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug_mode模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.licence_det=LicenceDetectionApp(self.licence_det_kmodel,model_input_size=self.det_input_size,confidence_threshold=self.confidence_threshold,nms_threshold=self.nms_threshold,rgb888p_size=self.rgb888p_size,display_size=self.display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.licence_rec=LicenceRecognitionApp(self.licence_rec_kmodel,model_input_size=self.rec_input_size,rgb888p_size=self.rgb888p_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.licence_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # run函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 执行车牌检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        det_boxes=self.licence_det.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 将车牌部分抠出来</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imgs_array_boxes = aidemo.ocr_rec_preprocess(input_np,[self.rgb888p_size[1],self.rgb888p_size[0]],det_boxes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imgs_array = imgs_array_boxes[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boxes = imgs_array_boxes[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rec_res = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for img_array in imgs_array:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 对每一个检测到的车牌进行识别</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.licence_rec.config_preprocess(input_image_size=[img_array.shape[3],img_array.shape[2]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            licence_str=self.licence_rec.run(img_array)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            rec_res.append(licence_str)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return det_boxes,rec_res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制车牌检测识别效果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,det_res,rec_res):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if det_res:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            point_8 = np.zeros((8),dtype=np.int16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for det_index in range(len(det_res)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for i in range(4):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x = det_res[det_index][i * 2 + 0]/self.rgb888p_size[0]*self.display_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    y = det_res[det_index][i * 2 + 1]/self.rgb888p_size[1]*self.display_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    point_8[i * 2 + 0] = int(x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    point_8[i * 2 + 1] = int(y)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for i in range(4):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_line(point_8[i * 2 + 0],point_8[i * 2 + 1],point_8[(i+1) % 4 * 2 + 0],point_8[(i+1) % 4 * 2 + 1],color=(255, 0, 255, 0),thickness=4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.draw_string_advanced( point_8[6], point_8[7] + 20, 40,rec_res[det_index] , color=(255,255,153,18))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 车牌检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    licence_det_kmodel_path=&quot;/sdcard/app/tests/kmodel/LPD_640.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 车牌识别模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    licence_rec_kmodel_path=&quot;/sdcard/app/tests/kmodel/licence_reco.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其它参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[640,360]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    licence_det_input_size=[640,640]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    licence_rec_input_size=[220,32]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold=0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold=0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，只关注传给AI的图像分辨率，显示的分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lr=LicenceRec(licence_det_kmodel_path,licence_rec_kmodel_path,det_input_size=licence_det_input_size,rec_input_size=licence_rec_input_size,confidence_threshold=confidence_threshold,nms_threshold=nms_threshold,rgb888p_size=rgb888p_size,display_size=display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()                  # 获取当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                det_res,rec_res=lr.run(img)         # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                lr.draw_result(pl,det_res,rec_res)  # 绘制当前帧推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                     # 展示推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lr.licence_det.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lr.licence_rec.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="14-参考文档">1.4. 参考文档<a href="#14-参考文档" class="hash-link" aria-label="Direct link to 1.4. 参考文档" title="Direct link to 1.4. 参考文档">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="141-k230-canmv文档">1.4.1. k230 canmv文档<a href="#141-k230-canmv文档" class="hash-link" aria-label="Direct link to 1.4.1. k230 canmv文档" title="Direct link to 1.4.1. k230 canmv文档">​</a></h4>
<p>文档链接：<a href="https://developer.canaan-creative.com/k230_canmv/dev/index.html" target="_blank" rel="noopener noreferrer">Welcome to K230 CanMV’s documentation! — K230 CanMV 文档 (canaan-creative.com)</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="142-ulab库支持">1.4.2. Ulab库支持<a href="#142-ulab库支持" class="hash-link" aria-label="Direct link to 1.4.2. Ulab库支持" title="Direct link to 1.4.2. Ulab库支持">​</a></h4>
<p>链接： <a href="https://docs.circuitpython.org/en/latest/shared-bindings/ulab/index.html" target="_blank" rel="noopener noreferrer">ulab – Manipulate numeric data similar to numpy — Adafruit CircuitPython 9.1.0-beta.3 documentation</a></p>
<p>github链接：<a href="https://github.com/v923z/micropython-ulab" target="_blank" rel="noopener noreferrer">v923z/micropython-ulab: a numpy-like fast vector module for micropython, circuitpython, and their derivatives (github.com)</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-ai-demo">2. AI Demo<a href="#2-ai-demo" class="hash-link" aria-label="Direct link to 2. AI Demo" title="Direct link to 2. AI Demo">​</a></h2>
<p>AI Demo分为两种类型：单模型、多模型，涵盖物体、人脸、人手、人体、车牌、OCR、音频（KWS、TTS）等方向；参考该文档，k230用户可以更快上手K230 AI应用的开发，实现预期效果。</p>
<table><thead><tr><th>Demo名称</th><th>场景</th><th>任务类型</th></tr></thead><tbody><tr><td>dynamic_gesture</td><td>动态手势识别</td><td>多模型任务</td></tr><tr><td>eye_gaze</td><td>注视估计</td><td>多模型任务</td></tr><tr><td>face_detection</td><td>人脸检测</td><td>单模型任务</td></tr><tr><td>face_landmark</td><td>人脸关键部位</td><td>多模型任务</td></tr><tr><td>face_mesh</td><td>人脸3D网格</td><td>多模型任务</td></tr><tr><td>face_parse</td><td>人脸解析</td><td>多模型任务</td></tr><tr><td>face_pose</td><td>人脸姿态</td><td>多模型任务</td></tr><tr><td>face_recognition</td><td>人脸识别</td><td>多模型任务</td></tr><tr><td>face_registration</td><td>人脸注册</td><td>多模型任务</td></tr><tr><td>falldown_detection</td><td>跌倒检测</td><td>单模型任务</td></tr><tr><td>finger_guessing</td><td>猜拳游戏</td><td>多模型任务</td></tr><tr><td>hand_detection</td><td>手掌检测</td><td>单模型任务</td></tr><tr><td>hand_keypoint_class</td><td>手掌关键点分类</td><td>多模型任务</td></tr><tr><td>hand_keypoint_detection</td><td>手掌关键点检测</td><td>多模型任务</td></tr><tr><td>hand_recognition</td><td>手势识别</td><td>多模型任务</td></tr><tr><td>keyword_spotting</td><td>关键词唤醒</td><td>单模型任务</td></tr><tr><td>licence_det</td><td>车牌检测</td><td>单模型任务</td></tr><tr><td>licence_det_rec</td><td>车牌识别</td><td>多模型任务</td></tr><tr><td>nanotracker</td><td>单目标跟踪</td><td>多模型任务</td></tr><tr><td>object_detect_yolov8n</td><td>yolov8n目标检测</td><td>单模型任务</td></tr><tr><td>ocr_det</td><td>OCR检测</td><td>单模型任务</td></tr><tr><td>ocr_rec</td><td>OCR识别</td><td>多模型任务</td></tr><tr><td>person_detection</td><td>人体检测</td><td>单模型任务</td></tr><tr><td>person_kp_detect</td><td>人体关键点检测</td><td>多模型任务</td></tr><tr><td>puzzle_game</td><td>拼图游戏</td><td>多模型任务</td></tr><tr><td>segment_yolov8n</td><td>yolov8分割</td><td>单模型任务</td></tr><tr><td>self_learning</td><td>自学习</td><td>单模型任务</td></tr><tr><td>space_resize</td><td>局部放大器</td><td>多模型任务</td></tr><tr><td>tts_zh</td><td>中文文本转语音</td><td>多模型任务</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-动态手势识别">2.1. 动态手势识别<a href="#21-动态手势识别" class="hash-link" aria-label="Direct link to 2.1. 动态手势识别" title="Direct link to 2.1. 动态手势识别">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from random import randint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aicube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义手掌检测任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class HandDetApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,labels,model_input_size,anchors,confidence_threshold=0.2,nms_threshold=0.5,nms_option=False, strides=[8,16,32],rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.labels=labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测锚框</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.strides = strides  # 特征下采样倍数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_option = nms_option  # NMS选项，如果为True做类间NMS,如果为False做类内NMS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ai2d实例，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了padding和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size = input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算padding参数并应用pad操作，以确保输入图像尺寸与模型输入尺寸匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            top, bottom, left, right = self.get_padding_param()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad([0, 0, 0, 0, top, bottom, left, right], 0, [114, 114, 114])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 使用双线性插值进行resize操作，调整图像尺寸以符合模型输入要求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程,参数为预处理输入tensor的shape和预处理输出的tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理过程，这里使用了aicube的anchorbasedet_post_process接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dets = aicube.anchorbasedet_post_process(results[0], results[1], results[2], self.model_input_size, self.rgb888p_size, self.strides, len(self.labels), self.confidence_threshold, self.nms_threshold, self.anchors, self.nms_option)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 返回手掌检测结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return dets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算padding参数，确保输入图像尺寸与模型输入尺寸匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_padding_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 根据目标宽度和高度计算比例因子</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_width = self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_high = self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / input_width</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / input_high</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 选择较小的比例因子，以确保图像内容完整</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算新的宽度和高度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = int(ratio * input_width)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = int(ratio * input_high)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算宽度和高度的差值，并确定padding的位置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = int(round(dh - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = int(round(dh + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = int(round(dw - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = int(round(dw + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return top, bottom, left, right</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义手势关键点分类任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class HandKPClassApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌关键点模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给 到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # crop参数列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_params=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ai2d实例，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了crop和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,det,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 如果input_image_size为None,使用视频出图大小，否则按照自定义设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算crop参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.crop_params = self.get_crop_param(det)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 设置crop预处理过程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.crop(self.crop_params[0],self.crop_params[1],self.crop_params[2],self.crop_params[3])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 设置resize预处理过程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # build预处理过程，参数为输入tensor的shape和输出tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出的array列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results=results[0].reshape(results[0].shape[0]*results[0].shape[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show = np.zeros(results.shape,dtype=np.int16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show[0::2] = results[0::2] * self.crop_params[3] + self.crop_params[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show[1::2] = results[1::2] * self.crop_params[2] + self.crop_params[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 根据输出计算手势</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            gesture=self.hk_gesture(results_show)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return results_show,gesture</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算crop参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_crop_param(self,det_box):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1, y1, x2, y2 = det_box[2],det_box[3],det_box[4],det_box[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        w,h= int(x2 - x1),int(y2 - y1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        w_det = int(float(x2 - x1) * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h_det = int(float(y2 - y1) * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x_det = int(x1*self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y_det = int(y1*self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        length = max(w, h)/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cx = (x1+x2)/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cy = (y1+y2)/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_num = 1.26*length</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1_kp = int(max(0,cx-ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y1_kp = int(max(0,cy-ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x2_kp = int(min(self.rgb888p_size[0]-1, cx+ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y2_kp = int(min(self.rgb888p_size[1]-1, cy+ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        w_kp = int(x2_kp - x1_kp + 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h_kp = int(y2_kp - y1_kp + 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [x1_kp, y1_kp, w_kp, h_kp]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 求两个vector之间的夹角</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def hk_vector_2d_angle(self,v1,v2):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;hk_vector_2d_angle&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v1_x,v1_y,v2_x,v2_y = v1[0],v1[1],v2[0],v2[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v1_norm = np.sqrt(v1_x * v1_x+ v1_y * v1_y)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v2_norm = np.sqrt(v2_x * v2_x + v2_y * v2_y)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dot_product = v1_x * v2_x + v1_y * v2_y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cos_angle = dot_product/(v1_norm*v2_norm)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            angle = np.acos(cos_angle)*180/np.pi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return angle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 根据手掌关键点检测结果判断手势类别</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def hk_gesture(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;hk_gesture&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            angle_list = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for i in range(5):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                angle = self.hk_vector_2d_angle([(results[0]-results[i*8+4]), (results[1]-results[i*8+5])],[(results[i*8+6]-results[i*8+8]),(results[i*8+7]-results[i*8+9])])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                angle_list.append(angle)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            thr_angle,thr_angle_thumb,thr_angle_s,gesture_str = 65.,53.,49.,None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if 65535. not in angle_list:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (angle_list[0]&gt;thr_angle_thumb)  and (angle_list[1]&gt;thr_angle) and (angle_list[2]&gt;thr_angle) and (angle_list[3]&gt;thr_angle) and (angle_list[4]&gt;thr_angle):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;fist&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&lt;thr_angle_s)  and (angle_list[1]&lt;thr_angle_s) and (angle_list[2]&lt;thr_angle_s) and (angle_list[3]&lt;thr_angle_s) and (angle_list[4]&lt;thr_angle_s):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;five&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&lt;thr_angle_s)  and (angle_list[1]&lt;thr_angle_s) and (angle_list[2]&gt;thr_angle) and (angle_list[3]&gt;thr_angle) and (angle_list[4]&gt;thr_angle):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;gun&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&lt;thr_angle_s)  and (angle_list[1]&lt;thr_angle_s) and (angle_list[2]&gt;thr_angle) and (angle_list[3]&gt;thr_angle) and (angle_list[4]&lt;thr_angle_s):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;love&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&gt;5)  and (angle_list[1]&lt;thr_angle_s) and (angle_list[2]&gt;thr_angle) and (angle_list[3]&gt;thr_angle) and (angle_list[4]&gt;thr_angle):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;one&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&lt;thr_angle_s)  and (angle_list[1]&gt;thr_angle) and (angle_list[2]&gt;thr_angle) and (angle_list[3]&gt;thr_angle) and (angle_list[4]&lt;thr_angle_s):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;six&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&gt;thr_angle_thumb)  and (angle_list[1]&lt;thr_angle_s) and (angle_list[2]&lt;thr_angle_s) and (angle_list[3]&lt;thr_angle_s) and (angle_list[4]&gt;thr_angle):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;three&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&lt;thr_angle_s)  and (angle_list[1]&gt;thr_angle) and (angle_list[2]&gt;thr_angle) and (angle_list[3]&gt;thr_angle) and (angle_list[4]&gt;thr_angle):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;thumbUp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&gt;thr_angle_thumb)  and (angle_list[1]&lt;thr_angle_s) and (angle_list[2]&lt;thr_angle_s) and (angle_list[3]&gt;thr_angle) and (angle_list[4]&gt;thr_angle):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;yeah&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return gesture_str</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义动态手势识别任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class DynamicGestureApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 注意：ai2d设置多个预处理时执行的顺序为：crop-&gt;shift-&gt;resize/affine-&gt;pad，如果不符合该顺序，需要配置多个ai2d对象;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 如下模型预处理要先做resize再做crop，因此要配置两个Ai2d对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d_resize=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d_resize.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d_crop=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d_crop.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 动态手势识别模型输入tensors列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.input_tensors=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 动态手势识别模型的输入tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.gesture_kmodel_input_shape = [[1, 3, 224, 224],                     # 动态手势识别kmodel输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           [1,3,56,56],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           [1,4,28,28],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           [1,4,28,28],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           [1,8,14,14],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           [1,8,14,14],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           [1,8,14,14],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           [1,12,14,14],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           [1,12,14,14],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           [1,20,7,7],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           [1,20,7,7]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 预处理参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.resize_shape = 256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.mean_values = np.array([0.485, 0.456, 0.406]).reshape((3,1,1))      # 动态手势识别预处理均值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.std_values = np.array([0.229, 0.224, 0.225]).reshape((3,1,1))       # 动态手势识别预处理方差</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.first_data=None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.max_hist_len=20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_params=self.get_crop_param()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 配置resize和crop预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d_resize.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d_resize.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.crop_params[1],self.crop_params[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d_crop.crop(self.crop_params[2],self.crop_params[3],self.crop_params[4],self.crop_params[5])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d_crop.build([1,3,self.crop_params[1],self.crop_params[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化动态手势识别模型输入列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            inputs_num=self.get_kmodel_inputs_num()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.first_data = np.ones(self.gesture_kmodel_input_shape[0], dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for i in range(inputs_num):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                data = np.zeros(self.gesture_kmodel_input_shape[i], dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.input_tensors.append(nn.from_numpy(data))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 重写预处理，因为该部分不是单纯的走一个ai2d做预处理，所以该函数需要重写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def preprocess(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 先走resize，再走crop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resize_tensor=self.ai2d_resize.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        crop_output_tensor=self.ai2d_crop.run(resize_tensor.to_numpy())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ai2d_output = crop_output_tensor.to_numpy()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.first_data[0] = ai2d_output[0].copy()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.first_data[0] = (self.first_data[0]*1.0/255 -self.mean_values)/self.std_values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.input_tensors[0]=nn.from_numpy(self.first_data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # run函数重写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np,his_logit,history):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.preprocess(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        outputs=self.inference(self.input_tensors)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 使用当前帧的输出更新下一帧的输入列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        outputs_num=self.get_kmodel_outputs_num()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for i in range(1,outputs_num):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.input_tensors[i]=nn.from_numpy(outputs[i])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 返回后处理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return self.postprocess(outputs,his_logit,history)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results,his_logit, history):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            his_logit.append(results[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            avg_logit = sum(np.array(his_logit))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            idx_ = np.argmax(avg_logit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            idx = self.gesture_process_output(idx_, history)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (idx_ != idx):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                his_logit_last = his_logit[-1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                his_logit = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                his_logit.append(his_logit_last)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return idx, avg_logit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 手势处理函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def gesture_process_output(self,pred,history):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (pred == 7 or pred == 8 or pred == 21 or pred == 22 or pred == 3 ):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pred = history[-1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (pred == 0 or pred == 4 or pred == 6 or pred == 9 or pred == 14 or pred == 1 or pred == 19 or pred == 20 or pred == 23 or pred == 24) :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pred = history[-1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (pred == 0) :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pred = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (pred != history[-1]) :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (len(history)&gt;= 2) :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (history[-1] != history[len(history)-2]) :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pred = history[-1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        history.append(pred)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (len(history) &gt; self.max_hist_len) :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            history = history[-self.max_hist_len:]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return history[-1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算crop参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_crop_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ori_w = self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ori_h = self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        width = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        height = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratiow = float(self.resize_shape) / ori_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratioh = float(self.resize_shape) / ori_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratiow &lt; ratioh:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratioh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratiow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = int(ratio * ori_w)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = int(ratio * ori_h)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = int((new_h-height)/2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = int((new_w-width)/2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new_w,new_h,left,top,width,height</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 重写逆初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def deinit(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;deinit&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            del self.kpu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            del self.ai2d_resize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            del self.ai2d_crop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.tensors.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            del self.tensors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nn.shrink_memory_pool()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint(os.EXITPOINT_ENABLE_SLEEP)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            time.sleep_ms(100)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义动态手势识别任务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class DynamicGesture:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,hand_det_kmodel,hand_kp_kmodel,gesture_kmodel,det_input_size,kp_input_size,gesture_input_size,labels,anchors,confidence_threshold=0.25,nms_threshold=0.3,nms_option=False,strides=[8,16,32],rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_det_kmodel=hand_det_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌关键点模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_kp_kmodel=hand_kp_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 动态手势识别路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.gesture_kmodel=gesture_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.det_input_size=det_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌关键点模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kp_input_size=kp_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 动态手势识别模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.gesture_input_size=gesture_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.labels=labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_option=nms_option</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.strides=strides</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 动态手势识别贴图</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.bin_width = 150                                                     # 动态手势识别屏幕坐上角标志状态文件的短边尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.bin_height = 216                                                    # 动态手势识别屏幕坐上角标志状态文件的长边尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        shang_argb = np.fromfile(&quot;/sdcard/app/tests/utils/shang.bin&quot;, dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.shang_argb = shang_argb.reshape((self.bin_height, self.bin_width, 4))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        xia_argb = np.fromfile(&quot;/sdcard/app/tests/utils/xia.bin&quot;, dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.xia_argb = xia_argb.reshape((self.bin_height, self.bin_width, 4))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        zuo_argb = np.fromfile(&quot;/sdcard/app/tests/utils/zuo.bin&quot;, dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.zuo_argb = zuo_argb.reshape((self.bin_width, self.bin_height, 4))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        you_argb = np.fromfile(&quot;/sdcard/app/tests/utils/you.bin&quot;, dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.you_argb = you_argb.reshape((self.bin_width, self.bin_height, 4))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #其他参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.TRIGGER = 0                                                         # 动态手势识别应用的结果状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.MIDDLE = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.UP = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.DOWN = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.LEFT = 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.RIGHT = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.max_hist_len = 20                                                   # 最多存储多少帧的结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug_mode模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.cur_state = self.TRIGGER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.pre_state = self.TRIGGER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.draw_state = self.TRIGGER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.vec_flag = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.his_logit = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.history = [2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.s_start = time.time_ns()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.m_start=None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_det=HandDetApp(self.hand_det_kmodel,self.labels,model_input_size=self.det_input_size,anchors=self.anchors,confidence_threshold=self.confidence_threshold,nms_threshold=self.nms_threshold,nms_option=self.nms_option,strides=self.strides,rgb888p_size=self.rgb888p_size,display_size=self.display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_kp=HandKPClassApp(self.hand_kp_kmodel,model_input_size=self.kp_input_size,rgb888p_size=self.rgb888p_size,display_size=self.display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.dg=DynamicGestureApp(self.gesture_kmodel,model_input_size=self.gesture_input_size,rgb888p_size=self.rgb888p_size,display_size=self.display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.dg.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # run函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if self.cur_state == self.TRIGGER:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 手掌检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            det_boxes=self.hand_det.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boxes=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            gesture_res=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for det_box in det_boxes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 筛选检测框</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                x1, y1, x2, y2 = det_box[2],det_box[3],det_box[4],det_box[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                w,h= int(x2 - x1),int(y2 - y1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (h&lt;(0.1*self.rgb888p_size[1])):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (w&lt;(0.25*self.rgb888p_size[0]) and ((x1&lt;(0.03*self.rgb888p_size[0])) or (x2&gt;(0.97*self.rgb888p_size[0])))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (w&lt;(0.15*self.rgb888p_size[0]) and ((x1&lt;(0.01*self.rgb888p_size[0])) or (x2&gt;(0.99*self.rgb888p_size[0])))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 手掌关键点预处理配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.hand_kp.config_preprocess(det_box)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 手掌关键点检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                hk_results,gesture_str=self.hand_kp.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                boxes.append(det_box)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gesture_res.append((hk_results,gesture_str))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return boxes,gesture_res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 动态手势识别</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            idx, avg_logit = self.dg.run(input_np, self.his_logit, self.history)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return idx,avg_logit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 根据输出结果绘制效果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,output1,output2):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        draw_img_np = np.zeros((self.display_size[1],self.display_size[0],4),dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        draw_img=image.Image(self.display_size[0], self.display_size[1], image.ARGB8888,alloc=image.ALLOC_REF,data=draw_img_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if self.cur_state == self.TRIGGER:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for i in range(len(output1)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                hk_results,gesture=output2[i][0],output2[i][1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if ((gesture == &quot;five&quot;) or (gesture == &quot;yeah&quot;)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    v_x = hk_results[24]-hk_results[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    v_y = hk_results[25]-hk_results[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    angle = self.hand_kp.hk_vector_2d_angle([v_x,v_y],[1.0,0.0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (v_y&gt;0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        angle = 360-angle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if ((70.0&lt;=angle) and (angle&lt;110.0)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if ((self.pre_state != self.UP) or (self.pre_state != self.MIDDLE)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            self.vec_flag.append(self.pre_state)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if ((len(self.vec_flag)&gt;10)or(self.pre_state == self.UP) or (self.pre_state == self.MIDDLE) or(self.pre_state == self.TRIGGER)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            draw_img_np[:self.bin_height,:self.bin_width,:] = self.shang_argb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            self.cur_state = self.UP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    elif ((110.0&lt;=angle) and (angle&lt;225.0)):                                                # 手指向右(实际方向)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (self.pre_state != self.RIGHT):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            self.vec_flag.append(self.pre_state)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if ((len(self.vec_flag)&gt;10)or(self.pre_state == self.RIGHT)or(self.pre_state == self.TRIGGER)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            draw_img_np[:self.bin_width,:self.bin_height,:] = self.you_argb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            self.cur_state = self.RIGHT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    elif((225.0&lt;=angle) and (angle&lt;315.0)):                                                 # 手指向下</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (self.pre_state != self.DOWN):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            self.vec_flag.append(self.pre_state)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if ((len(self.vec_flag)&gt;10)or(self.pre_state == self.DOWN)or(self.pre_state == self.TRIGGER)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            draw_img_np[:self.bin_height,:self.bin_width,:] = self.xia_argb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            self.cur_state = self.DOWN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    else:                                                                                   # 手指向左(实际方向)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (self.pre_state != self.LEFT):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            self.vec_flag.append(self.pre_state)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if ((len(self.vec_flag)&gt;10)or(self.pre_state == self.LEFT)or(self.pre_state == self.TRIGGER)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            draw_img_np[:self.bin_width,:self.bin_height,:] = self.zuo_argb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            self.cur_state = self.LEFT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.m_start = time.time_ns()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.his_logit = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            idx,avg_logit=output1,output2[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (self.cur_state == self.UP):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img_np[:self.bin_height,:self.bin_width,:] = self.shang_argb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if ((idx==15) or (idx==10)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.vec_flag.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (((avg_logit[idx] &gt;= 0.7) and (len(self.his_logit) &gt;= 2)) or ((avg_logit[idx] &gt;= 0.3) and (len(self.his_logit) &gt;= 4))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.s_start = time.time_ns()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.cur_state = self.TRIGGER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.draw_state = self.DOWN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.history = [2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.pre_state = self.UP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif ((idx==25)or(idx==26)) :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.vec_flag.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (((avg_logit[idx] &gt;= 0.4) and (len(self.his_logit) &gt;= 2)) or ((avg_logit[idx] &gt;= 0.3) and (len(self.his_logit) &gt;= 3))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.s_start = time.time_ns()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.cur_state = self.TRIGGER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.draw_state = self.MIDDLE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.history = [2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.pre_state = self.MIDDLE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.his_logit.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            elif (self.cur_state == self.RIGHT):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img_np[:self.bin_width,:self.bin_height,:] = self.you_argb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if  ((idx==16)or(idx==11)) :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.vec_flag.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (((avg_logit[idx] &gt;= 0.4) and (len(self.his_logit) &gt;= 2)) or ((avg_logit[idx] &gt;= 0.3) and (len(self.his_logit) &gt;= 3))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.s_start = time.time_ns()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.cur_state = self.TRIGGER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.draw_state = self.RIGHT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.history = [2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.pre_state = self.RIGHT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.his_logit.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            elif (self.cur_state == self.DOWN):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img_np[:self.bin_height,:self.bin_width,:] = self.xia_argb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if  ((idx==18)or(idx==13)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.vec_flag.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (((avg_logit[idx] &gt;= 0.4) and (len(self.his_logit) &gt;= 2)) or ((avg_logit[idx] &gt;= 0.3) and (len(self.his_logit) &gt;= 3))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.s_start = time.time_ns()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.cur_state = self.TRIGGER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.draw_state = self.UP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.history = [2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.pre_state = self.DOWN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.his_logit.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            elif (self.cur_state == self.LEFT):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img_np[:self.bin_width,:self.bin_height,:] = self.zuo_argb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if ((idx==17)or(idx==12)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.vec_flag.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (((avg_logit[idx] &gt;= 0.4) and (len(self.his_logit) &gt;= 2)) or ((avg_logit[idx] &gt;= 0.3) and (len(self.his_logit) &gt;= 3))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.s_start = time.time_ns()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.cur_state = self.TRIGGER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.draw_state = self.LEFT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.history = [2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.pre_state = self.LEFT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.his_logit.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.elapsed_time = round((time.time_ns() - self.m_start)/1000000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ((self.cur_state != self.TRIGGER) and (self.elapsed_time&gt;2000)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.cur_state = self.TRIGGER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.pre_state = self.TRIGGER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.elapsed_ms_show = round((time.time_ns()-self.s_start)/1000000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (self.elapsed_ms_show&lt;1000):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (self.draw_state == self.UP):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img.draw_arrow(1068,330,1068,130, (255,170,190,230), thickness=13)                             # 判断为向上挥动时，画一个向上的箭头</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img.draw_string_advanced(self.display_size[0]//2-50,self.display_size[1]//2-50,32,&quot;向上&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            elif (self.draw_state == self.RIGHT):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img.draw_arrow(1290,540,1536,540, (255,170,190,230), thickness=13)                             # 判断为向右挥动时，画一个向右的箭头</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img.draw_string_advanced(self.display_size[0]//2-50,self.display_size[1]//2-50,32,&quot;向右&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            elif (self.draw_state == self.DOWN):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img.draw_arrow(1068,750,1068,950, (255,170,190,230), thickness=13)                             # 判断为向下挥动时，画一个向下的箭头</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img.draw_string_advanced(self.display_size[0]//2-50,self.display_size[1]//2-50,32,&quot;向下&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            elif (self.draw_state == self.LEFT):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img.draw_arrow(846,540,600,540, (255,170,190,230), thickness=13)                               # 判断为向左挥动时，画一个向左的箭头</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img.draw_string_advanced(self.display_size[0]//2-50,self.display_size[1]//2-50,32,&quot;向左&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            elif (self.draw_state == self.MIDDLE):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img.draw_circle(1068,540,100, (255,170,190,230), thickness=2, fill=True)                       # 判断为五指捏合手势时，画一个实心圆</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img.draw_string_advanced(self.display_size[0]//2-50,self.display_size[1]//2-50,32,&quot;中间&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.draw_state = self.TRIGGER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.osd_img.copy_from(draw_img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 手掌检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_det_kmodel_path=&quot;/sdcard/app/tests/kmodel/hand_det.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 手部关键点模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_kp_kmodel_path=&quot;/sdcard/app/tests/kmodel/handkp_det.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 动态手势识别模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gesture_kmodel_path=&quot;/sdcard/app/tests/kmodel/gesture.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其他参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_det_input_size=[512,512]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_kp_input_size=[256,256]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gesture_input_size=[224,224]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold=0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold=0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels=[&quot;hand&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = [26,27, 53,52, 75,71, 80,99, 106,82, 99,134, 140,113, 161,172, 245,276]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，只关注传给AI的图像分辨率，显示的分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义动态手势识别任务实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dg=DynamicGesture(hand_det_kmodel_path,hand_kp_kmodel_path,gesture_kmodel_path,det_input_size=hand_det_input_size,kp_input_size=hand_kp_input_size,gesture_input_size=gesture_input_size,labels=labels,anchors=anchors,confidence_threshold=confidence_threshold,nms_threshold=nms_threshold,nms_option=False,strides=[8,16,32],rgb888p_size=rgb888p_size,display_size=display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()                 # 获取当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                output1,output2=dg.run(img)        # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                dg.draw_result(pl,output1,output2) # 绘制推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                    # 展示推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dg.hand_det.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dg.hand_kp.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dg.dg.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-注视估计">2.2. 注视估计<a href="#22-注视估计" class="hash-link" aria-label="Direct link to 2.2. 注视估计" title="Direct link to 2.2. 注视估计">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aidemo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import math</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义人脸检测任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FaceDetApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,anchors,confidence_threshold=0.25,nms_threshold=0.3,rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ai2d实例，用于实现模型预处 理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了padding和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 设置padding预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad(self.get_pad_param(), 0, [104,117,123])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 设置resize预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程,参数为预处理输入tensor的shape和预处理输出的tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义任务后处理,这里使用了aidemo库的face_det_post_process接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            res = aidemo.face_det_post_process(self.confidence_threshold,self.nms_threshold,self.model_input_size[0],self.anchors,self.rgb888p_size,results)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if len(res)==0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return res[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算padding参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_pad_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算最小的缩放比例，等比例缩放</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = (int)(ratio * self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = (int)(ratio * self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = (int)(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = (int)(round(dh * 2 + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = (int)(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = (int)(round(dw * 2 - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [0,0,0,0,top, bottom, left, right]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义注视估计任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class EyeGazeApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 注视估计模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ai2d实例，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了crop和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,det,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算crop预处理参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            x, y, w, h = map(lambda x: int(round(x, 0)), det[:4])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 设置crop预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.crop(x,y,w,h)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 设置resize预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程,参数为预处理输入tensor的shape和预处理输出的tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出的array列表，这里调用了aidemo库的eye_gaze_post_process接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            post_ret = aidemo.eye_gaze_post_process(results)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return post_ret[0],post_ret[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义注视估计类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class EyeGaze:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,face_det_kmodel,eye_gaze_kmodel,det_input_size,eye_gaze_input_size,anchors,confidence_threshold=0.25,nms_threshold=0.3,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_det_kmodel=face_det_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸注视估计模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.eye_gaze_kmodel=eye_gaze_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.det_input_size=det_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸注视估计模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.eye_gaze_input_size=eye_gaze_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug_mode模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_det=FaceDetApp(self.face_det_kmodel,model_input_size=self.det_input_size,anchors=self.anchors,confidence_threshold=self.confidence_threshold,nms_threshold=self.nms_threshold,rgb888p_size=self.rgb888p_size,display_size=self.display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 注视估计实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.eye_gaze=EyeGazeApp(self.eye_gaze_kmodel,model_input_size=self.eye_gaze_input_size,rgb888p_size=self.rgb888p_size,display_size=self.display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测配置预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #run方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 先进行人脸检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        det_boxes=self.face_det.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        eye_gaze_res=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for det_box in det_boxes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 对每一个检测到的人脸做注视估计</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.eye_gaze.config_preprocess(det_box)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pitch,yaw=self.eye_gaze.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            eye_gaze_res.append((pitch,yaw))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return det_boxes,eye_gaze_res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制注视估计效果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,dets,eye_gaze_res):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if dets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for det,gaze_ret in zip(dets,eye_gaze_res):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pitch , yaw = gaze_ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                length = self.display_size[0]/ 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                x, y, w, h = map(lambda x: int(round(x, 0)), det[:4])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                x = x * self.display_size[0] // self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                y = y * self.display_size[1] // self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                w = w * self.display_size[0] // self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                h = h * self.display_size[1] // self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                center_x = (x + w / 2.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                center_y = (y + h / 2.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                dx = -length * math.sin(pitch) * math.cos(yaw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                target_x = int(center_x + dx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                dy = -length * math.sin(yaw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                target_y = int(center_y + dy)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.draw_arrow(int(center_x), int(center_y), target_x, target_y, color = (255,255,0,0), size = 30, thickness = 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 人脸检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_det_kmodel_path=&quot;/sdcard/app/tests/kmodel/face_detection_320.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 人脸注视估计模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eye_gaze_kmodel_path=&quot;/sdcard/app/tests/kmodel/eye_gaze.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其他参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors_path=&quot;/sdcard/app/tests/utils/prior_data_320.bin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_det_input_size=[320,320]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eye_gaze_input_size=[448,448]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold=0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold=0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchor_len=4200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    det_dim=4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = np.fromfile(anchors_path, dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = anchors.reshape((anchor_len,det_dim))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，只关注传给AI的图像分辨率，显示的分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eg=EyeGaze(face_det_kmodel_path,eye_gaze_kmodel_path,det_input_size=face_det_input_size,eye_gaze_input_size=eye_gaze_input_size,anchors=anchors,confidence_threshold=confidence_threshold,nms_threshold=nms_threshold,rgb888p_size=rgb888p_size,display_size=display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()                          # 获取当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                det_boxes,eye_gaze_res=eg.run(img)          # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                eg.draw_result(pl,det_boxes,eye_gaze_res)   # 绘制推理效果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                             # 展示推理效果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        eg.face_det.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        eg.eye_gaze.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="23-人脸检测">2.3. 人脸检测<a href="#23-人脸检测" class="hash-link" aria-label="Direct link to 2.3. 人脸检测" title="Direct link to 2.3. 人脸检测">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import utime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aidemo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义人脸检测类，继承自AIBase基类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FaceDetectionApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, kmodel_path, model_input_size, anchors, confidence_threshold=0.5, nms_threshold=0.2, rgb888p_size=[224,224], display_size=[1920,1080], debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path, model_input_size, rgb888p_size, debug_mode)  # 调用基类的构造函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path = kmodel_path  # 模型文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size = model_input_size  # 模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold = confidence_threshold  # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold = nms_threshold  # NMS（非极大值抑制）阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors = anchors  # 锚点数据，用于目标检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size = [ALIGN_UP(rgb888p_size[0], 16), rgb888p_size[1]]  # sensor给到AI的图像分辨率，并对宽度进行16的对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size = [ALIGN_UP(display_size[0], 16), display_size[1]]  # 显示分辨率，并对宽度进行16的对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode = debug_mode  # 是否开启调试模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d = Ai2d(debug_mode)  # 实例化Ai2d，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT, nn.ai2d_format.NCHW_FMT, np.uint8, np.uint8)  # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self, input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;, self.debug_mode &gt; 0):  # 计时器，如果debug_mode大于0则开启</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size = input_image_size if input_image_size else self.rgb888p_size  # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            top, bottom, left, right = self.get_padding_param()  # 获取padding参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad([0, 0, 0, 0, top, bottom, left, right], 0, [104, 117, 123])  # 填充边缘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)  # 缩放图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])  # 构建预处理流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理，results是模型输出array列表，这里使用了aidemo库的face_det_post_process接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self, results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            post_ret = aidemo.face_det_post_process(self.confidence_threshold, self.nms_threshold, self.model_input_size[1], self.anchors, self.rgb888p_size, results)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if len(post_ret) == 0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return post_ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return post_ret[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制检测结果到画面上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self, pl, dets):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;display_draw&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if dets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.clear()  # 清除OSD图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for det in dets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # 将检测框的坐标转换为显示分辨率下的坐标</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x, y, w, h = map(lambda x: int(round(x, 0)), det[:4])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x = x * self.display_size[0] // self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    y = y * self.display_size[1] // self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    w = w * self.display_size[0] // self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    h = h * self.display_size[1] // self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_rectangle(x, y, w, h, color=(255, 255, 0, 255), thickness=2)  # 绘制矩形框</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 获取padding参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_padding_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]  # 模型输入宽度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]  # 模型输入高度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / self.rgb888p_size[0]  # 宽度缩放比例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / self.rgb888p_size[1]  # 高度缩放比例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio = min(ratio_w, ratio_h)  # 取较小的缩放比例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = int(ratio * self.rgb888p_size[0])  # 新宽度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = int(ratio * self.rgb888p_size[1])  # 新高度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2  # 宽度差</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2  # 高度差</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = int(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = int(round(dh * 2 + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = int(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = int(round(dw * 2 - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return top, bottom, left, right</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__ == &quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置模型路径和其他参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_path = &quot;/sdcard/app/tests/kmodel/face_detection_320.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其它参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold = 0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold = 0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchor_len = 4200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    det_dim = 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors_path = &quot;/sdcard/app/tests/utils/prior_data_320.bin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = np.fromfile(anchors_path, dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = anchors.reshape((anchor_len, det_dim))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size = [1920, 1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，用于图像处理流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl = PipeLine(rgb888p_size=rgb888p_size, display_size=display_size, display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()  # 创建PipeLine实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化自定义人脸检测实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_det = FaceDetectionApp(kmodel_path, model_input_size=[320, 320], anchors=anchors, confidence_threshold=confidence_threshold, nms_threshold=nms_threshold, rgb888p_size=rgb888p_size, display_size=display_size, debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_det.config_preprocess()  # 配置预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()                      # 检查是否有退出信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img = pl.get_frame()            # 获取当前帧数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                res = face_det.run(img)         # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                face_det.draw_result(pl, res)   # 绘制结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                 # 显示结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()                    # 垃圾回收</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)                  # 打印异常信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        face_det.deinit()                       # 反初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()                            # 销毁PipeLine实例</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="24-人脸关键部位">2.4. 人脸关键部位<a href="#24-人脸关键部位" class="hash-link" aria-label="Direct link to 2.4. 人脸关键部位" title="Direct link to 2.4. 人脸关键部位">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aidemo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义人脸检测任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FaceDetApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,anchors,confidence_threshold=0.25,nms_threshold=0.3,rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测任务锚框</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 实例化Ai2d，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 设置padding预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad(self.get_pad_param(), 0, [104,117,123])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 设置resize预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程,参数为预处理输入tensor的shape和预处理输出的tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出的array列表，这里使用了aidemo的face_det_post_process列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            res = aidemo.face_det_post_process(self.confidence_threshold,self.nms_threshold,self.model_input_size[0],self.anchors,self.rgb888p_size,results)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if len(res)==0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return res[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算padding参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_pad_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算最小的缩放比例，等比例缩放</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = (int)(ratio * self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = (int)(ratio * self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = (int)(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = (int)(round(dh * 2 + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = (int)(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = (int)(round(dw * 2 - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [0,0,0,0,top, bottom, left, right]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义人脸关键点任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FaceLandMarkApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 关键点模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 目标矩阵</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.matrix_dst=None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了affine，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,det,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算目标矩阵，并获取仿射变换矩阵</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.matrix_dst = self.get_affine_matrix(det)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            affine_matrix = [self.matrix_dst[0][0],self.matrix_dst[0][1],self.matrix_dst[0][2],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             self.matrix_dst[1][0],self.matrix_dst[1][1],self.matrix_dst[1][2]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 设置仿射变换预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.affine(nn.interp_method.cv2_bilinear,0, 0, 127, 1,affine_matrix)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程,参数为预处理输入tensor的shape和预处理输出的tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出的array列表，这里使用了aidemo库的invert_affine_transform接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pred=results[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # （1）将人脸关键点输出变换模型输入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            half_input_len = self.model_input_size[0] // 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pred = pred.flatten()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for i in range(len(pred)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pred[i] += (pred[i] + 1) * half_input_len</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # （2）获取仿射矩阵的逆矩阵</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            matrix_dst_inv = aidemo.invert_affine_transform(self.matrix_dst)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            matrix_dst_inv = matrix_dst_inv.flatten()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # （3）对每个关键点进行逆变换</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            half_out_len = len(pred) // 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for kp_id in range(half_out_len):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                old_x = pred[kp_id * 2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                old_y = pred[kp_id * 2 + 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 逆变换公式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new_x = old_x * matrix_dst_inv[0] + old_y * matrix_dst_inv[1] + matrix_dst_inv[2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new_y = old_x * matrix_dst_inv[3] + old_y * matrix_dst_inv[4] + matrix_dst_inv[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pred[kp_id * 2] = new_x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pred[kp_id * 2 + 1] = new_y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return pred</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_affine_matrix(self,bbox):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 获取仿射矩阵，用于将边界框映射到模型输入空间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;get_affine_matrix&quot;, self.debug_mode &gt; 1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 从边界框提取坐标和尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            x1, y1, w, h = map(lambda x: int(round(x, 0)), bbox[:4])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算缩放比例，使得边界框映射到模型输入空间的一部分</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            scale_ratio = (self.model_input_size[0]) / (max(w, h) * 1.5)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算边界框中心点在模型输入空间的坐标</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cx = (x1 + w / 2) * scale_ratio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cy = (y1 + h / 2) * scale_ratio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算模型输入空间的一半长度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            half_input_len = self.model_input_size[0] / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 创建仿射矩阵并进行设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            matrix_dst = np.zeros((2, 3), dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            matrix_dst[0, 0] = scale_ratio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            matrix_dst[0, 1] = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            matrix_dst[0, 2] = half_input_len - cx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            matrix_dst[1, 0] = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            matrix_dst[1, 1] = scale_ratio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            matrix_dst[1, 2] = half_input_len - cy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return matrix_dst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 人脸标志解析</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FaceLandMark:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,face_det_kmodel,face_landmark_kmodel,det_input_size,landmark_input_size,anchors,confidence_threshold=0.25,nms_threshold=0.3,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_det_kmodel=face_det_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸标志解析模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_landmark_kmodel=face_landmark_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.det_input_size=det_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸标志解析模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.landmark_input_size=landmark_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug_mode模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸关键点不同部位关键点列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.dict_kp_seq = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [43, 44, 45, 47, 46, 50, 51, 49, 48],              # left_eyebrow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [97, 98, 99, 100, 101, 105, 104, 103, 102],        # right_eyebrow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [35, 36, 33, 37, 39, 42, 40, 41],                  # left_eye</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [89, 90, 87, 91, 93, 96, 94, 95],                  # right_eye</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [34, 88],                                          # pupil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [72, 73, 74, 86],                                  # bridge_nose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [77, 78, 79, 80, 85, 84, 83],                      # wing_nose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [52, 55, 56, 53, 59, 58, 61, 68, 67, 71, 63, 64],  # out_lip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [65, 54, 60, 57, 69, 70, 62, 66],                  # in_lip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [1, 9, 10, 11, 12, 13, 14, 15, 16, 2, 3, 4, 5, 6, 7, 8, 0, 24, 23, 22, 21, 20, 19, 18, 32, 31, 30, 29, 28, 27, 26, 25, 17]  # basin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸关键点不同部位（顺序同dict_kp_seq）颜色配置，argb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.color_list_for_osd_kp = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (255, 0, 255, 0),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (255, 0, 255, 0),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (255, 255, 0, 255),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (255, 255, 0, 255),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (255, 255, 0, 0),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (255, 255, 170, 0),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (255, 255, 255, 0),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (255, 0, 255, 255),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (255, 255, 220, 50),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (255, 30, 30, 255)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_det=FaceDetApp(self.face_det_kmodel,model_input_size=self.det_input_size,anchors=self.anchors,confidence_threshold=self.confidence_threshold,nms_threshold=self.nms_threshold,rgb888p_size=self.rgb888p_size,display_size=self.display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸标志解析实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_landmark=FaceLandMarkApp(self.face_landmark_kmodel,model_input_size=self.landmark_input_size,rgb888p_size=self.rgb888p_size,display_size=self.display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 配置人脸检测的预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # run函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 执行人脸检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        det_boxes=self.face_det.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        landmark_res=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for det_box in det_boxes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 对每一个检测到的人脸解析关键部位</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.face_landmark.config_preprocess(det_box)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            res=self.face_landmark.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            landmark_res.append(res)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return det_boxes,landmark_res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制人脸解析效果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,dets,landmark_res):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if dets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            draw_img_np = np.zeros((self.display_size[1],self.display_size[0],4),dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            draw_img = image.Image(self.display_size[0], self.display_size[1], image.ARGB8888, alloc=image.ALLOC_REF,data = draw_img_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for pred in landmark_res:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # （1）获取单个人脸框对应的人脸关键点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for sub_part_index in range(len(self.dict_kp_seq)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # （2）构建人脸某个区域关键点集</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    sub_part = self.dict_kp_seq[sub_part_index]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    face_sub_part_point_set = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    for kp_index in range(len(sub_part)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        real_kp_index = sub_part[kp_index]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        x, y = pred[real_kp_index * 2], pred[real_kp_index * 2 + 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        x = int(x * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        y = int(y * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        face_sub_part_point_set.append((x, y))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # （3）画人脸不同区域的轮廓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if sub_part_index in (9, 6):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        color = np.array(self.color_list_for_osd_kp[sub_part_index],dtype = np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        face_sub_part_point_set = np.array(face_sub_part_point_set)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        aidemo.polylines(draw_img_np, face_sub_part_point_set,False,color,5,8,0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    elif sub_part_index == 4:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        color = self.color_list_for_osd_kp[sub_part_index]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        for kp in face_sub_part_point_set:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            x,y = kp[0],kp[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            draw_img.draw_circle(x,y ,2, color, 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        color = np.array(self.color_list_for_osd_kp[sub_part_index],dtype = np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        face_sub_part_point_set = np.array(face_sub_part_point_set)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        aidemo.contours(draw_img_np, face_sub_part_point_set,-1,color,2,8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pl.osd_img.copy_from(draw_img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 人脸检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_det_kmodel_path=&quot;/sdcard/app/tests/kmodel/face_detection_320.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 人脸关键标志模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_landmark_kmodel_path=&quot;/sdcard/app/tests/kmodel/face_landmark.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其它参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors_path=&quot;/sdcard/app/tests/utils/prior_data_320.bin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_det_input_size=[320,320]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_landmark_input_size=[192,192]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold=0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold=0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchor_len=4200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    det_dim=4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = np.fromfile(anchors_path, dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = anchors.reshape((anchor_len,det_dim))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，只关注传给AI的图像分辨率，显示的分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flm=FaceLandMark(face_det_kmodel_path,face_landmark_kmodel_path,det_input_size=face_det_input_size,landmark_input_size=face_landmark_input_size,anchors=anchors,confidence_threshold=confidence_threshold,nms_threshold=nms_threshold,rgb888p_size=rgb888p_size,display_size=display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()                          # 获取当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                det_boxes,landmark_res=flm.run(img)         # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                flm.draw_result(pl,det_boxes,landmark_res)  # 绘制推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                             # 展示推理效果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        flm.face_det.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        flm.face_landmark.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="25-人脸3d网络">2.5. 人脸3D网络<a href="#25-人脸3d网络" class="hash-link" aria-label="Direct link to 2.5. 人脸3D网络" title="Direct link to 2.5. 人脸3D网络">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aidemo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义人脸检测任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FaceDetApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,anchors,confidence_threshold=0.25,nms_threshold=0.3,rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测任务锚框</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 实例化Ai2d，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 设置padding预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad(self.get_pad_param(), 0, [104,117,123])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 设置resize预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程,参数为预处理输入tensor的shape和预处理输出的tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型推理输出的array列表，这里使用了aidemo库的face_det_post_process接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            res = aidemo.face_det_post_process(self.confidence_threshold,self.nms_threshold,self.model_input_size[0],self.anchors,self.rgb888p_size,results)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if len(res)==0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return res[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # padding参数计算</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_pad_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算最小的缩放比例，等比例缩放</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = (int)(ratio * self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = (int)(ratio * self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = (int)(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = (int)(round(dh * 2 + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = (int)(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = (int)(round(dw * 2 - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [0,0,0,0,top, bottom, left, right]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义人脸网格任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FaceMeshApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸网格模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸mesh参数均值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.param_mean = np.array([0.0003492636315058917,2.52790130161884e-07,-6.875197868794203e-07,60.1679573059082,-6.295513230725192e-07,0.0005757200415246189,-5.085391239845194e-05,74.2781982421875,5.400917189035681e-07,6.574138387804851e-05,0.0003442012530285865,-66.67157745361328,-346603.6875,-67468.234375,46822.265625,-15262.046875,4350.5888671875,-54261.453125,-18328.033203125,-1584.328857421875,-84566.34375,3835.960693359375,-20811.361328125,38094.9296875,-19967.85546875,-9241.3701171875,-19600.71484375,13168.08984375,-5259.14404296875,1848.6478271484375,-13030.662109375,-2435.55615234375,-2254.20654296875,-14396.5615234375,-6176.3291015625,-25621.919921875,226.39447021484375,-6326.12353515625,-10867.2509765625,868.465087890625,-5831.14794921875,2705.123779296875,-3629.417724609375,2043.9901123046875,-2446.6162109375,3658.697021484375,-7645.98974609375,-6674.45263671875,116.38838958740234,7185.59716796875,-1429.48681640625,2617.366455078125,-1.2070955038070679,0.6690792441368103,-0.17760828137397766,0.056725528091192245,0.03967815637588501,-0.13586315512657166,-0.09223993122577667,-0.1726071834564209,-0.015804484486579895,-0.1416848599910736],dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸mesh参数方差</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.param_std = np.array([0.00017632152594160289,6.737943476764485e-05,0.00044708489440381527,26.55023193359375,0.0001231376954820007,4.493021697271615e-05,7.923670636955649e-05,6.982563018798828,0.0004350444069132209,0.00012314890045672655,0.00017400001524947584,20.80303955078125,575421.125,277649.0625,258336.84375,255163.125,150994.375,160086.109375,111277.3046875,97311.78125,117198.453125,89317.3671875,88493.5546875,72229.9296875,71080.2109375,50013.953125,55968.58203125,47525.50390625,49515.06640625,38161.48046875,44872.05859375,46273.23828125,38116.76953125,28191.162109375,32191.4375,36006.171875,32559.892578125,25551.1171875,24267.509765625,27521.3984375,23166.53125,21101.576171875,19412.32421875,19452.203125,17454.984375,22537.623046875,16174.28125,14671.640625,15115.6884765625,13870.0732421875,13746.3125,12663.1337890625,1.5870834589004517,1.5077009201049805,0.5881357789039612,0.5889744758605957,0.21327851712703705,0.2630201280117035,0.2796429395675659,0.38030216097831726,0.16162841022014618,0.2559692859649658],dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 实例化Ai2d，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了crop和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,det,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算crop参数，并设置crop预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            roi = self.parse_roi_box_from_bbox(det)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.crop(int(roi[0]),int(roi[1]),int(roi[2]),int(roi[3]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 设置resize预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程,参数为预处理输入tensor的shape和预处理输出的tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return roi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出的array列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            param = results[0] * self.param_std + self.param_mean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return param</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def parse_roi_box_from_bbox(self,bbox):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 获取人脸roi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1, y1, w, h = map(lambda x: int(round(x, 0)), bbox[:4])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        old_size = (w + h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        center_x = x1 + w / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        center_y = y1 + h / 2 + old_size * 0.14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size = int(old_size * 1.58)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x0 = center_x - float(size) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y0 = center_y - float(size) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1 = x0 + size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y1 = y0 + size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x0 = max(0, min(x0, self.rgb888p_size[0]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y0 = max(0, min(y0, self.rgb888p_size[1]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1 = max(0, min(x1, self.rgb888p_size[0]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y1 = max(0, min(y1, self.rgb888p_size[1]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        roi = (x0, y0, x1 - x0, y1 - y0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return roi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义人脸网格后处理任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FaceMeshPostApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸网格模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 实例化Ai2d，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 重写预处理函数preprocess，因为该模型的预处理不是单纯调用一个ai2d能实现的，返回模型输入的tensor列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def preprocess(self,param):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # face mesh post模型预处理，param解析</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            param = param[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            trans_dim, shape_dim, exp_dim = 12, 40, 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            R_ = param[:trans_dim].copy().reshape((3, -1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            R = R_[:, :3].copy()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            offset = R_[:, 3].copy()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            offset = offset.reshape((3, 1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            alpha_shp = param[trans_dim:trans_dim + shape_dim].copy().reshape((-1, 1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            alpha_exp = param[trans_dim + shape_dim:].copy().reshape((-1, 1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            R_tensor = nn.from_numpy(R)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            offset_tensor = nn.from_numpy(offset)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            alpha_shp_tensor = nn.from_numpy(alpha_shp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            alpha_exp_tensor = nn.from_numpy(alpha_exp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return [R_tensor,offset_tensor,alpha_shp_tensor,alpha_exp_tensor]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义模型后处理，这里调用了aidemo的face_mesh_post_process接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results,roi):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            x, y, w, h = map(lambda x: int(round(x, 0)), roi[:4])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            x = x * self.display_size[0] // self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            y = y * self.display_size[1] // self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            w = w * self.display_size[0] // self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            h = h * self.display_size[1] // self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            roi_array = np.array([x,y,w,h],dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            aidemo.face_mesh_post_process(roi_array,results[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return results[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 3D人脸网格</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FaceMesh:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,face_det_kmodel,face_mesh_kmodel,mesh_post_kmodel,det_input_size,mesh_input_size,anchors,confidence_threshold=0.25,nms_threshold=0.3,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_det_kmodel=face_det_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸3D网格模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_mesh_kmodel=face_mesh_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸3D网格后处理模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.mesh_post_kmodel=mesh_post_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.det_input_size=det_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸3D网格模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.mesh_input_size=mesh_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug_mode模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_det=FaceDetApp(self.face_det_kmodel,model_input_size=self.det_input_size,anchors=self.anchors,confidence_threshold=self.confidence_threshold,nms_threshold=self.nms_threshold,rgb888p_size=self.rgb888p_size,display_size=self.display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸网格实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_mesh=FaceMeshApp(self.face_mesh_kmodel,model_input_size=self.mesh_input_size,rgb888p_size=self.rgb888p_size,display_size=self.display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸网格后处理实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_mesh_post=FaceMeshPostApp(self.mesh_post_kmodel,model_input_size=self.mesh_input_size,rgb888p_size=self.rgb888p_size,display_size=self.display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测预处理配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # run函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 执行人脸检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        det_boxes=self.face_det.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mesh_res=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for det_box in det_boxes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 对检测到的每一个人脸配置预处理，执行人脸网格和人脸网格后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            roi=self.face_mesh.config_preprocess(det_box)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            param=self.face_mesh.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tensors=self.face_mesh_post.preprocess(param)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results=self.face_mesh_post.inference(tensors)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            res=self.face_mesh_post.postprocess(results,roi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mesh_res.append(res)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return det_boxes,mesh_res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制人脸解析效果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,dets,mesh_res):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if dets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            draw_img_np = np.zeros((self.display_size[1],self.display_size[0],4),dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            draw_img = image.Image(self.display_size[0], self.display_size[1], image.ARGB8888, alloc=image.ALLOC_REF,data = draw_img_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for vertices in mesh_res:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                aidemo.face_draw_mesh(draw_img_np, vertices)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pl.osd_img.copy_from(draw_img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 人脸检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_det_kmodel_path=&quot;/sdcard/app/tests/kmodel/face_detection_320.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 人脸网格模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_mesh_kmodel_path=&quot;/sdcard/app/tests/kmodel/face_alignment.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 人脸网格后处理模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_mesh_post_kmodel_path=&quot;/sdcard/app/tests/kmodel/face_alignment_post.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其他参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors_path=&quot;/sdcard/app/tests/utils/prior_data_320.bin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_det_input_size=[320,320]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_mesh_input_size=[120,120]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold=0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold=0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchor_len=4200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    det_dim=4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = np.fromfile(anchors_path, dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = anchors.reshape((anchor_len,det_dim))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，只关注传给AI的图像分辨率，显示的分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fm=FaceMesh(face_det_kmodel_path,face_mesh_kmodel_path,face_mesh_post_kmodel_path,det_input_size=face_det_input_size,mesh_input_size=face_mesh_input_size,anchors=anchors,confidence_threshold=confidence_threshold,nms_threshold=nms_threshold,rgb888p_size=rgb888p_size,display_size=display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()                      # 获取当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                det_boxes,mesh_res=fm.run(img)          # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fm.draw_result(pl,det_boxes,mesh_res)   # 绘制推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                         # 显示推理效果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fm.face_det.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fm.face_mesh.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fm.face_mesh_post.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="26-人脸解析">2.6. 人脸解析<a href="#26-人脸解析" class="hash-link" aria-label="Direct link to 2.6. 人脸解析" title="Direct link to 2.6. 人脸解析">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aidemo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义人脸检测任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FaceDetApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,anchors,confidence_threshold=0.25,nms_threshold=0.3,rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 实例化Ai2d，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算padding参数，并设置padding预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad(self.get_pad_param(), 0, [104,117,123])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 设置resize预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程,参数为预处理输入tensor的shape和预处理输出的tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出的array列表，这里调用了aidemo库的face_det_post_process接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            res = aidemo.face_det_post_process(self.confidence_threshold,self.nms_threshold,self.model_input_size[0],self.anchors,self.rgb888p_size,results)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if len(res)==0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return res[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算padding参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_pad_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算最小的缩放比例，等比例缩放</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = (int)(ratio * self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = (int)(ratio * self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = (int)(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = (int)(round(dh * 2 + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = (int)(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = (int)(round(dw * 2 - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [0,0,0,0,top, bottom, left, right]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义人脸解析任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FaceParseApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 实例化Ai2d，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了affine，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,det,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算仿射变换矩阵并设置affine预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            matrix_dst = self.get_affine_matrix(det)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.affine(nn.interp_method.cv2_bilinear,0, 0, 127, 1,matrix_dst)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程,参数为预处理输入tensor的shape和预处理输出的tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出的array列表，这里将第一个输出返回</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return results[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_affine_matrix(self,bbox):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 获取仿射矩阵，用于将边界框映射到模型输入空间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;get_affine_matrix&quot;, self.debug_mode &gt; 1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 设置缩放因子</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            factor = 2.7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 从边界框提取坐标和尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            x1, y1, w, h = map(lambda x: int(round(x, 0)), bbox[:4])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 模型输入大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            edge_size = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 平移距离，使得模型输入空间的中心对准原点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            trans_distance = edge_size / 2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算边界框中心点的坐标</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            center_x = x1 + w / 2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            center_y = y1 + h / 2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算最大边长</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            maximum_edge = factor * (h if h &gt; w else w)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算缩放比例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            scale = edge_size * 2.0 / maximum_edge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算平移参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cx = trans_distance - scale * center_x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cy = trans_distance - scale * center_y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 创建仿射矩阵</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            affine_matrix = [scale, 0, cx, 0, scale, cy]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return affine_matrix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 人脸解析任务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FaceParse:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,face_det_kmodel,face_parse_kmodel,det_input_size,parse_input_size,anchors,confidence_threshold=0.25,nms_threshold=0.3,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_det_kmodel=face_det_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸解析模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_pose_kmodel=face_parse_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.det_input_size=det_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸解析模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.parse_input_size=parse_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug_mode模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测任务类实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_det=FaceDetApp(self.face_det_kmodel,model_input_size=self.det_input_size,anchors=self.anchors,confidence_threshold=self.confidence_threshold,nms_threshold=self.nms_threshold,rgb888p_size=self.rgb888p_size,display_size=self.display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸解析实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_parse=FaceParseApp(self.face_pose_kmodel,model_input_size=self.parse_input_size,rgb888p_size=self.rgb888p_size,display_size=self.display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测预处理配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # run函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 执行人脸检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        det_boxes=self.face_det.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        parse_res=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for det_box in det_boxes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 对检测到每一个人脸进行人脸解析</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.face_parse.config_preprocess(det_box)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            res=self.face_parse.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            parse_res.append(res)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return det_boxes,parse_res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制人脸解析效果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,dets,parse_res):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if dets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            draw_img_np = np.zeros((self.display_size[1],self.display_size[0],4),dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            draw_img=image.Image(self.display_size[0], self.display_size[1], image.ARGB8888,alloc=image.ALLOC_REF,data=draw_img_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for i,det in enumerate(dets):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # （1）将人脸检测框画到draw_img</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                x, y, w, h = map(lambda x: int(round(x, 0)), det[:4])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                x = x * self.display_size[0] // self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                y = y * self.display_size[1] // self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                w = w * self.display_size[0] // self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                h = h * self.display_size[1] // self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                aidemo.face_parse_post_process(draw_img_np,self.rgb888p_size,self.display_size,self.parse_input_size[0],det.tolist(),parse_res[i])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pl.osd_img.copy_from(draw_img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 人脸检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_det_kmodel_path=&quot;/sdcard/app/tests/kmodel/face_detection_320.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 人脸解析模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_parse_kmodel_path=&quot;/sdcard/app/tests/kmodel/face_parse.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其他参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors_path=&quot;/sdcard/app/tests/utils/prior_data_320.bin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_det_input_size=[320,320]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_parse_input_size=[320,320]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold=0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold=0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchor_len=4200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    det_dim=4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = np.fromfile(anchors_path, dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = anchors.reshape((anchor_len,det_dim))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，只关注传给AI的图像分辨率，显示的分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fp=FaceParse(face_det_kmodel_path,face_parse_kmodel_path,det_input_size=face_det_input_size,parse_input_size=face_parse_input_size,anchors=anchors,confidence_threshold=confidence_threshold,nms_threshold=nms_threshold,rgb888p_size=rgb888p_size,display_size=display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()                      # 获取当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                det_boxes,parse_res=fp.run(img)         # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fp.draw_result(pl,det_boxes,parse_res)  # 绘制当前帧推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                         # 展示推理效果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fp.face_det.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fp.face_parse.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="27-人脸姿态">2.7. 人脸姿态<a href="#27-人脸姿态" class="hash-link" aria-label="Direct link to 2.7. 人脸姿态" title="Direct link to 2.7. 人脸姿态">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aidemo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义人脸检测任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FaceDetApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,anchors,confidence_threshold=0.25,nms_threshold=0.3,rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 实例化Ai2d，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算padding参数，并设置padding预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad(self.get_pad_param(), 0, [104,117,123])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 设置resize预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程,参数为预处理输入tensor的shape和预处理输出的tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出的array列表，这里使用了aidemo库的face_det_post_process接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            res = aidemo.face_det_post_process(self.confidence_threshold,self.nms_threshold,self.model_input_size[0],self.anchors,self.rgb888p_size,results)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if len(res)==0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return res[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算padding参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_pad_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算最小的缩放比例，等比例缩放</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = (int)(ratio * self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = (int)(ratio * self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = (int)(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = (int)(round(dh * 2 + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = (int)(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = (int)(round(dw * 2 - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [0,0,0,0,top, bottom, left, right]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义人脸姿态任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FacePoseApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸姿态模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 实例化Ai2d，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了affine，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,det,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算affine矩阵并设置affine预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            matrix_dst = self.get_affine_matrix(det)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.affine(nn.interp_method.cv2_bilinear,0, 0, 127, 1,matrix_dst)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程,参数为预处理输入tensor的shape和预处理输出的tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出的array列表，计算欧拉角</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            R,eular = self.get_euler(results[0][0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return R,eular</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_affine_matrix(self,bbox):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 获取仿射矩阵，用于将边界框映射到模型输入空间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;get_affine_matrix&quot;, self.debug_mode &gt; 1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 设置缩放因子</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            factor = 2.7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 从边界框提取坐标和尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            x1, y1, w, h = map(lambda x: int(round(x, 0)), bbox[:4])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 模型输入大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            edge_size = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 平移距离，使得模型输入空间的中心对准原点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            trans_distance = edge_size / 2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算边界框中心点的坐标</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            center_x = x1 + w / 2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            center_y = y1 + h / 2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算最大边长</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            maximum_edge = factor * (h if h &gt; w else w)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算缩放比例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            scale = edge_size * 2.0 / maximum_edge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算平移参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cx = trans_distance - scale * center_x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cy = trans_distance - scale * center_y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 创建仿射矩阵</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            affine_matrix = [scale, 0, cx, 0, scale, cy]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return affine_matrix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def rotation_matrix_to_euler_angles(self,R):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 将旋转矩阵（3x3 矩阵）转换为欧拉角（pitch、yaw、roll）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算 sin(yaw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sy = np.sqrt(R[0, 0] ** 2 + R[1, 0] ** 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if sy &lt; 1e-6:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 若 sin(yaw) 过小，说明 pitch 接近 ±90 度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pitch = np.arctan2(-R[1, 2], R[1, 1]) * 180 / np.pi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            yaw = np.arctan2(-R[2, 0], sy) * 180 / np.pi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            roll = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算 pitch、yaw、roll 的角度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pitch = np.arctan2(R[2, 1], R[2, 2]) * 180 / np.pi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            yaw = np.arctan2(-R[2, 0], sy) * 180 / np.pi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            roll = np.arctan2(R[1, 0], R[0, 0]) * 180 / np.pi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [pitch,yaw,roll]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_euler(self,data):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 获取旋转矩阵和欧拉角</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        R = data[:3, :3].copy()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        eular = self.rotation_matrix_to_euler_angles(R)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return R,eular</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 人脸姿态任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FacePose:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,face_det_kmodel,face_pose_kmodel,det_input_size,pose_input_size,anchors,confidence_threshold=0.25,nms_threshold=0.3,rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_det_kmodel=face_det_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸姿态模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_pose_kmodel=face_pose_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.det_input_size=det_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸姿态模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.pose_input_size=pose_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug_mode模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_det=FaceDetApp(self.face_det_kmodel,model_input_size=self.det_input_size,anchors=self.anchors,confidence_threshold=self.confidence_threshold,nms_threshold=self.nms_threshold,rgb888p_size=self.rgb888p_size,display_size=self.display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_pose=FacePoseApp(self.face_pose_kmodel,model_input_size=self.pose_input_size,rgb888p_size=self.rgb888p_size,display_size=self.display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # run函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        det_boxes=self.face_det.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pose_res=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for det_box in det_boxes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 对检测到的每一个人脸做人脸姿态估计</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.face_pose.config_preprocess(det_box)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            R,eular=self.face_pose.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pose_res.append((R,eular))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return det_boxes,pose_res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制人脸姿态角效果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,dets,pose_res):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if dets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            draw_img_np = np.zeros((self.display_size[1],self.display_size[0],4),dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            draw_img=image.Image(self.display_size[0], self.display_size[1], image.ARGB8888,alloc=image.ALLOC_REF,data=draw_img_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            line_color = np.array([255, 0, 0 ,255],dtype=np.uint8)    #bgra</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for i,det in enumerate(dets):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # （1）获取人脸姿态矩阵和欧拉角</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                projections,center_point = self.build_projection_matrix(det)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                R,euler = pose_res[i]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # （2）遍历人脸投影矩阵的关键点，进行投影，并将结果画在图像上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                first_points = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                second_points = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for pp in range(8):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    sum_x, sum_y = 0.0, 0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    for cc in range(3):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        sum_x += projections[pp][cc] * R[cc][0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        sum_y += projections[pp][cc] * (-R[cc][1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    center_x,center_y = center_point[0],center_point[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x = (sum_x + center_x) / self.rgb888p_size[0] * self.display_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    y = (sum_y + center_y) / self.rgb888p_size[1] * self.display_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x = max(0, min(x, self.display_size[0]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    y = max(0, min(y, self.display_size[1]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if pp &lt; 4:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        first_points.append((x, y))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        second_points.append((x, y))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                first_points = np.array(first_points,dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                aidemo.polylines(draw_img_np,first_points,True,line_color,2,8,0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                second_points = np.array(second_points,dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                aidemo.polylines(draw_img_np,second_points,True,line_color,2,8,0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for ll in range(4):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x0, y0 = int(first_points[ll][0]),int(first_points[ll][1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x1, y1 = int(second_points[ll][0]),int(second_points[ll][1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    draw_img.draw_line(x0, y0, x1, y1, color = (255, 0, 0 ,255), thickness = 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pl.osd_img.copy_from(draw_img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def build_projection_matrix(self,det):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1, y1, w, h = map(lambda x: int(round(x, 0)), det[:4])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算边界框中心坐标</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        center_x = x1 + w / 2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        center_y = y1 + h / 2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 定义后部（rear）和前部（front）的尺寸和深度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rear_width = 0.5 * w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rear_height = 0.5 * h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rear_depth = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factor = np.sqrt(2.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        front_width = factor * rear_width</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        front_height = factor * rear_height</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        front_depth = factor * rear_width  # 使用宽度来计算深度，也可以使用高度，取决于需求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 定义立方体的顶点坐标</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        temp = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [-rear_width, -rear_height, rear_depth],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [-rear_width, rear_height, rear_depth],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [rear_width, rear_height, rear_depth],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [rear_width, -rear_height, rear_depth],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [-front_width, -front_height, front_depth],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [-front_width, front_height, front_depth],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [front_width, front_height, front_depth],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            [front_width, -front_height, front_depth]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        projections = np.array(temp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 返回投影矩阵和中心坐标</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return projections, (center_x, center_y)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 人脸检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_det_kmodel_path=&quot;/sdcard/app/tests/kmodel/face_detection_320.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 人脸姿态模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_pose_kmodel_path=&quot;/sdcard/app/tests/kmodel/face_pose.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其它参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors_path=&quot;/sdcard/app/tests/utils/prior_data_320.bin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_det_input_size=[320,320]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_pose_input_size=[120,120]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold=0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold=0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchor_len=4200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    det_dim=4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = np.fromfile(anchors_path, dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = anchors.reshape((anchor_len,det_dim))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，只关注传给AI的图像分辨率，显示的分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fp=FacePose(face_det_kmodel_path,face_pose_kmodel_path,det_input_size=face_det_input_size,pose_input_size=face_pose_input_size,anchors=anchors,confidence_threshold=confidence_threshold,nms_threshold=nms_threshold,rgb888p_size=rgb888p_size,display_size=display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()                      # 获取当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                det_boxes,pose_res=fp.run(img)          # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fp.draw_result(pl,det_boxes,pose_res)   # 绘制推理效果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                         # 展示推理效果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fp.face_det.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fp.face_pose.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="28-人脸识别">2.8. 人脸识别<a href="#28-人脸识别" class="hash-link" aria-label="Direct link to 2.8. 人脸识别" title="Direct link to 2.8. 人脸识别">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aidemo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import math</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义人脸检测任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FaceDetApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,anchors,confidence_threshold=0.25,nms_threshold=0.3,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 实例化Ai2d，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算padding参数，并设置padding预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad(self.get_pad_param(), 0, [104,117,123])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 设置resize预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程,参数为预处理输入tensor的shape和预处理输出的tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出的array列表，这里使用了aidemo库的face_det_post_process接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            res = aidemo.face_det_post_process(self.confidence_threshold,self.nms_threshold,self.model_input_size[0],self.anchors,self.rgb888p_size,results)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if len(res)==0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return res,res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return res[0],res[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_pad_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算最小的缩放比例，等比例缩放</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = (int)(ratio * self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = (int)(ratio * self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = (int)(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = (int)(round(dh * 2 + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = (int)(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = (int)(round(dw * 2 - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [0,0,0,0,top, bottom, left, right]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义人脸注册任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FaceRegistrationApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 标准5官</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.umeyama_args_112 = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            38.2946 , 51.6963 ,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            73.5318 , 51.5014 ,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            56.0252 , 71.7366 ,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            41.5493 , 92.3655 ,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            70.7299 , 92.2041</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了affine，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,landm,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算affine矩阵，并设置仿射变换预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            affine_matrix = self.get_affine_matrix(landm)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.affine(nn.interp_method.cv2_bilinear,0, 0, 127, 1,affine_matrix)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程,参数为预处理输入tensor的shape和预处理输出的tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return results[0][0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def svd22(self,a):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # svd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s = [0.0, 0.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u = [0.0, 0.0, 0.0, 0.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v = [0.0, 0.0, 0.0, 0.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s[0] = (math.sqrt((a[0] - a[3]) ** 2 + (a[1] + a[2]) ** 2) + math.sqrt((a[0] + a[3]) ** 2 + (a[1] - a[2]) ** 2)) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s[1] = abs(s[0] - math.sqrt((a[0] - a[3]) ** 2 + (a[1] + a[2]) ** 2))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v[2] = math.sin((math.atan2(2 * (a[0] * a[1] + a[2] * a[3]), a[0] ** 2 - a[1] ** 2 + a[2] ** 2 - a[3] ** 2)) / 2) if \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s[0] &gt; s[1] else 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v[0] = math.sqrt(1 - v[2] ** 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v[1] = -v[2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v[3] = v[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u[0] = -(a[0] * v[0] + a[1] * v[2]) / s[0] if s[0] != 0 else 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u[2] = -(a[2] * v[0] + a[3] * v[2]) / s[0] if s[0] != 0 else 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u[1] = (a[0] * v[1] + a[1] * v[3]) / s[1] if s[1] != 0 else -u[2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u[3] = (a[2] * v[1] + a[3] * v[3]) / s[1] if s[1] != 0 else u[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v[0] = -v[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v[2] = -v[2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return u, s, v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def image_umeyama_112(self,src):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 使用Umeyama算法计算仿射变换矩阵</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SRC_NUM = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SRC_DIM = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        src_mean = [0.0, 0.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_mean = [0.0, 0.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for i in range(0,SRC_NUM * 2,2):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            src_mean[0] += src[i]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            src_mean[1] += src[i + 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dst_mean[0] += self.umeyama_args_112[i]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dst_mean[1] += self.umeyama_args_112[i + 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        src_mean[0] /= SRC_NUM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        src_mean[1] /= SRC_NUM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_mean[0] /= SRC_NUM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_mean[1] /= SRC_NUM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        src_demean = [[0.0, 0.0] for _ in range(SRC_NUM)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_demean = [[0.0, 0.0] for _ in range(SRC_NUM)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for i in range(SRC_NUM):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            src_demean[i][0] = src[2 * i] - src_mean[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            src_demean[i][1] = src[2 * i + 1] - src_mean[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dst_demean[i][0] = self.umeyama_args_112[2 * i] - dst_mean[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dst_demean[i][1] = self.umeyama_args_112[2 * i + 1] - dst_mean[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        A = [[0.0, 0.0], [0.0, 0.0]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for i in range(SRC_DIM):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for k in range(SRC_DIM):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for j in range(SRC_NUM):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    A[i][k] += dst_demean[j][i] * src_demean[j][k]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                A[i][k] /= SRC_NUM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T = [[1, 0, 0], [0, 1, 0], [0, 0, 1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        U, S, V = self.svd22([A[0][0], A[0][1], A[1][0], A[1][1]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T[0][0] = U[0] * V[0] + U[1] * V[2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T[0][1] = U[0] * V[1] + U[1] * V[3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T[1][0] = U[2] * V[0] + U[3] * V[2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T[1][1] = U[2] * V[1] + U[3] * V[3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scale = 1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        src_demean_mean = [0.0, 0.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        src_demean_var = [0.0, 0.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for i in range(SRC_NUM):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            src_demean_mean[0] += src_demean[i][0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            src_demean_mean[1] += src_demean[i][1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        src_demean_mean[0] /= SRC_NUM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        src_demean_mean[1] /= SRC_NUM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for i in range(SRC_NUM):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            src_demean_var[0] += (src_demean_mean[0] - src_demean[i][0]) * (src_demean_mean[0] - src_demean[i][0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            src_demean_var[1] += (src_demean_mean[1] - src_demean[i][1]) * (src_demean_mean[1] - src_demean[i][1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        src_demean_var[0] /= SRC_NUM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        src_demean_var[1] /= SRC_NUM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scale = 1.0 / (src_demean_var[0] + src_demean_var[1]) * (S[0] + S[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T[0][2] = dst_mean[0] - scale * (T[0][0] * src_mean[0] + T[0][1] * src_mean[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T[1][2] = dst_mean[1] - scale * (T[1][0] * src_mean[0] + T[1][1] * src_mean[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T[0][0] *= scale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T[0][1] *= scale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T[1][0] *= scale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T[1][1] *= scale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return T</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_affine_matrix(self,sparse_points):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 获取affine变换矩阵</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;get_affine_matrix&quot;, self.debug_mode &gt; 1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 使用Umeyama算法计算仿射变换矩阵</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            matrix_dst = self.image_umeyama_112(sparse_points)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            matrix_dst = [matrix_dst[0][0],matrix_dst[0][1],matrix_dst[0][2],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          matrix_dst[1][0],matrix_dst[1][1],matrix_dst[1][2]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return matrix_dst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 人脸识别任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FaceRecognition:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,face_det_kmodel,face_reg_kmodel,det_input_size,reg_input_size,database_dir,anchors,confidence_threshold=0.25,nms_threshold=0.3,face_recognition_threshold=0.75,rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_det_kmodel=face_det_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸识别模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_reg_kmodel=face_reg_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.det_input_size=det_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸识别模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.reg_input_size=reg_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.database_dir=database_dir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_recognition_threshold=face_recognition_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug_mode模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.max_register_face = 100                  # 数据库最多人脸个数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.feature_num = 128                        # 人脸识别特征维度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.valid_register_face = 0                  # 已注册人脸数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.db_name= []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.db_data= []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_det=FaceDetApp(self.face_det_kmodel,model_input_size=self.det_input_size,anchors=self.anchors,confidence_threshold=self.confidence_threshold,nms_threshold=self.nms_threshold,rgb888p_size=self.rgb888p_size,display_size=self.display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_reg=FaceRegistrationApp(self.face_reg_kmodel,model_input_size=self.reg_input_size,rgb888p_size=self.rgb888p_size,display_size=self.display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸数据库初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.database_init()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # run函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 执行人脸检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        det_boxes,landms=self.face_det.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        recg_res = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for landm in landms:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 针对每个人脸五官点，推理得到人脸特征，并计算特征在数据库中相似度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.face_reg.config_preprocess(landm)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            feature=self.face_reg.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            res = self.database_search(feature)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            recg_res.append(res)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return det_boxes,recg_res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def database_init(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 数据初始化，构建数据库人名列表和数据库特征列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;database_init&quot;, self.debug_mode &gt; 1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            db_file_list = os.listdir(self.database_dir)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for db_file in db_file_list:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if not db_file.endswith(&#x27;.bin&#x27;):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if self.valid_register_face &gt;= self.max_register_face:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                valid_index = self.valid_register_face</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                full_db_file = self.database_dir + db_file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                with open(full_db_file, &#x27;rb&#x27;) as f:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    data = f.read()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                feature = np.frombuffer(data, dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.db_data.append(feature)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name = db_file.split(&#x27;.&#x27;)[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.db_name.append(name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.valid_register_face += 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def database_reset(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 数据库清空</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;database_reset&quot;, self.debug_mode &gt; 1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            print(&quot;database clearing...&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.db_name = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.db_data = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.valid_register_face = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            print(&quot;database clear Done!&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def database_search(self,feature):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 数据库查询</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;database_search&quot;, self.debug_mode &gt; 1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v_id = -1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v_score_max = 0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 将当前人脸特征归一化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            feature /= np.linalg.norm(feature)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 遍历当前人脸数据库，统计最高得分</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for i in range(self.valid_register_face):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                db_feature = self.db_data[i]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                db_feature /= np.linalg.norm(db_feature)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 计算数据库特征与当前人脸特征相似度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                v_score = np.dot(feature, db_feature)/2 + 0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if v_score &gt; v_score_max:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    v_score_max = v_score</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    v_id = i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if v_id == -1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 数据库中无人脸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return &#x27;unknown&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            elif v_score_max &lt; self.face_recognition_threshold:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 小于人脸识别阈值，未识别</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return &#x27;unknown&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 识别成功</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result = &#x27;name: {}, score:{}&#x27;.format(self.db_name[v_id],v_score_max)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制识别结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,dets,recg_results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if dets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for i,det in enumerate(dets):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # （1）画人脸框</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                x1, y1, w, h = map(lambda x: int(round(x, 0)), det[:4])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                x1 = x1 * self.display_size[0]//self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                y1 = y1 * self.display_size[1]//self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                w =  w * self.display_size[0]//self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                h = h * self.display_size[1]//self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.draw_rectangle(x1,y1, w, h, color=(255,0, 0, 255), thickness = 4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # （2）写人脸识别结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                recg_text = recg_results[i]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.draw_string_advanced(x1,y1,32,recg_text,color=(255, 255, 0, 0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 注意：执行人脸识别任务之前，需要先执行人脸注册任务进行人脸身份注册生成feature数据库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 人脸检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_det_kmodel_path=&quot;/sdcard/app/tests/kmodel/face_detection_320.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 人脸识别模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_reg_kmodel_path=&quot;/sdcard/app/tests/kmodel/face_recognition.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其它参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors_path=&quot;/sdcard/app/tests/utils/prior_data_320.bin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    database_dir =&quot;/sdcard/app/tests/utils/db/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_det_input_size=[320,320]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_reg_input_size=[112,112]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold=0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold=0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchor_len=4200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    det_dim=4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = np.fromfile(anchors_path, dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = anchors.reshape((anchor_len,det_dim))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_recognition_threshold = 0.75        # 人脸识别阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，只关注传给AI的图像分辨率，显示的分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fr=FaceRecognition(face_det_kmodel_path,face_reg_kmodel_path,det_input_size=face_det_input_size,reg_input_size=face_reg_input_size,database_dir=database_dir,anchors=anchors,confidence_threshold=confidence_threshold,nms_threshold=nms_threshold,face_recognition_threshold=face_recognition_threshold,rgb888p_size=rgb888p_size,display_size=display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;, 1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()                      # 获取当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                det_boxes,recg_res=fr.run(img)          # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fr.draw_result(pl,det_boxes,recg_res)   # 绘制推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                         # 展示推理效果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fr.face_det.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fr.face_reg.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="29-人脸注册">2.9. 人脸注册<a href="#29-人脸注册" class="hash-link" aria-label="Direct link to 2.9. 人脸注册" title="Direct link to 2.9. 人脸注册">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aidemo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import math</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义人脸检测任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FaceDetApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,anchors,confidence_threshold=0.25,nms_threshold=0.3,rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 实例化Ai2d，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.image_size=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.image_size=[input_image_size[1],input_image_size[0]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算padding参数，并设置padding预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad(self.get_pad_param(ai2d_input_size), 0, [104,117,123])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 设置resize预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程,参数为预处理输入tensor的shape和预处理输出的tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出的array列表，这里使用了aidemo库的face_det_post_process接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            res = aidemo.face_det_post_process(self.confidence_threshold,self.nms_threshold,self.model_input_size[0],self.anchors,self.image_size,results)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if len(res)==0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return res[0],res[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_pad_param(self,image_input_size):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算最小的缩放比例，等比例缩放</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / image_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / image_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = (int)(ratio * image_input_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = (int)(ratio * image_input_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = (int)(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = (int)(round(dh * 2 + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = (int)(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = (int)(round(dw * 2 - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [0,0,0,0,top, bottom, left, right]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义人脸注册任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FaceRegistrationApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸注册模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 标准5官</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.umeyama_args_112 = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            38.2946 , 51.6963 ,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            73.5318 , 51.5014 ,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            56.0252 , 71.7366 ,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            41.5493 , 92.3655 ,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            70.7299 , 92.2041</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了affine，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,landm,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算affine矩阵，并设置仿射变换预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            affine_matrix = self.get_affine_matrix(landm)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.affine(nn.interp_method.cv2_bilinear,0, 0, 127, 1,affine_matrix)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程,参数为预处理输入tensor的shape和预处理输出的tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return results[0][0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def svd22(self,a):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # svd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s = [0.0, 0.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u = [0.0, 0.0, 0.0, 0.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v = [0.0, 0.0, 0.0, 0.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s[0] = (math.sqrt((a[0] - a[3]) ** 2 + (a[1] + a[2]) ** 2) + math.sqrt((a[0] + a[3]) ** 2 + (a[1] - a[2]) ** 2)) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s[1] = abs(s[0] - math.sqrt((a[0] - a[3]) ** 2 + (a[1] + a[2]) ** 2))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v[2] = math.sin((math.atan2(2 * (a[0] * a[1] + a[2] * a[3]), a[0] ** 2 - a[1] ** 2 + a[2] ** 2 - a[3] ** 2)) / 2) if \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s[0] &gt; s[1] else 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v[0] = math.sqrt(1 - v[2] ** 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v[1] = -v[2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v[3] = v[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u[0] = -(a[0] * v[0] + a[1] * v[2]) / s[0] if s[0] != 0 else 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u[2] = -(a[2] * v[0] + a[3] * v[2]) / s[0] if s[0] != 0 else 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u[1] = (a[0] * v[1] + a[1] * v[3]) / s[1] if s[1] != 0 else -u[2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        u[3] = (a[2] * v[1] + a[3] * v[3]) / s[1] if s[1] != 0 else u[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v[0] = -v[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v[2] = -v[2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return u, s, v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def image_umeyama_112(self,src):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 使用Umeyama算法计算仿射变换矩阵</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SRC_NUM = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SRC_DIM = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        src_mean = [0.0, 0.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_mean = [0.0, 0.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for i in range(0,SRC_NUM * 2,2):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            src_mean[0] += src[i]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            src_mean[1] += src[i + 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dst_mean[0] += self.umeyama_args_112[i]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dst_mean[1] += self.umeyama_args_112[i + 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        src_mean[0] /= SRC_NUM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        src_mean[1] /= SRC_NUM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_mean[0] /= SRC_NUM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_mean[1] /= SRC_NUM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        src_demean = [[0.0, 0.0] for _ in range(SRC_NUM)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_demean = [[0.0, 0.0] for _ in range(SRC_NUM)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for i in range(SRC_NUM):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            src_demean[i][0] = src[2 * i] - src_mean[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            src_demean[i][1] = src[2 * i + 1] - src_mean[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dst_demean[i][0] = self.umeyama_args_112[2 * i] - dst_mean[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dst_demean[i][1] = self.umeyama_args_112[2 * i + 1] - dst_mean[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        A = [[0.0, 0.0], [0.0, 0.0]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for i in range(SRC_DIM):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for k in range(SRC_DIM):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for j in range(SRC_NUM):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    A[i][k] += dst_demean[j][i] * src_demean[j][k]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                A[i][k] /= SRC_NUM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T = [[1, 0, 0], [0, 1, 0], [0, 0, 1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        U, S, V = self.svd22([A[0][0], A[0][1], A[1][0], A[1][1]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T[0][0] = U[0] * V[0] + U[1] * V[2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T[0][1] = U[0] * V[1] + U[1] * V[3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T[1][0] = U[2] * V[0] + U[3] * V[2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T[1][1] = U[2] * V[1] + U[3] * V[3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scale = 1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        src_demean_mean = [0.0, 0.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        src_demean_var = [0.0, 0.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for i in range(SRC_NUM):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            src_demean_mean[0] += src_demean[i][0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            src_demean_mean[1] += src_demean[i][1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        src_demean_mean[0] /= SRC_NUM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        src_demean_mean[1] /= SRC_NUM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for i in range(SRC_NUM):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            src_demean_var[0] += (src_demean_mean[0] - src_demean[i][0]) * (src_demean_mean[0] - src_demean[i][0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            src_demean_var[1] += (src_demean_mean[1] - src_demean[i][1]) * (src_demean_mean[1] - src_demean[i][1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        src_demean_var[0] /= SRC_NUM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        src_demean_var[1] /= SRC_NUM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scale = 1.0 / (src_demean_var[0] + src_demean_var[1]) * (S[0] + S[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T[0][2] = dst_mean[0] - scale * (T[0][0] * src_mean[0] + T[0][1] * src_mean[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T[1][2] = dst_mean[1] - scale * (T[1][0] * src_mean[0] + T[1][1] * src_mean[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T[0][0] *= scale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T[0][1] *= scale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T[1][0] *= scale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T[1][1] *= scale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return T</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_affine_matrix(self,sparse_points):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 获取affine变换矩阵</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;get_affine_matrix&quot;, self.debug_mode &gt; 1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 使用Umeyama算法计算仿射变换矩阵</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            matrix_dst = self.image_umeyama_112(sparse_points)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            matrix_dst = [matrix_dst[0][0],matrix_dst[0][1],matrix_dst[0][2],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          matrix_dst[1][0],matrix_dst[1][1],matrix_dst[1][2]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return matrix_dst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 人脸注册任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FaceRegistration:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,face_det_kmodel,face_reg_kmodel,det_input_size,reg_input_size,database_dir,anchors,confidence_threshold=0.25,nms_threshold=0.3,rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_det_kmodel=face_det_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸注册模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_reg_kmodel=face_reg_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.det_input_size=det_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸注册模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.reg_input_size=reg_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.database_dir=database_dir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug_mode模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_det=FaceDetApp(self.face_det_kmodel,model_input_size=self.det_input_size,anchors=self.anchors,confidence_threshold=self.confidence_threshold,nms_threshold=self.nms_threshold,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_reg=FaceRegistrationApp(self.face_reg_kmodel,model_input_size=self.reg_input_size,rgb888p_size=self.rgb888p_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # run函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np,img_file):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.face_det.config_preprocess(input_image_size=[input_np.shape[3],input_np.shape[2]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        det_boxes,landms=self.face_det.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if det_boxes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if det_boxes.shape[0] == 1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 若是只检测到一张人脸，则将该人脸注册到数据库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                db_i_name = img_file.split(&#x27;.&#x27;)[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for landm in landms:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.face_reg.config_preprocess(landm,input_image_size=[input_np.shape[3],input_np.shape[2]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    reg_result = self.face_reg.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    with open(self.database_dir+&#x27;{}.bin&#x27;.format(db_i_name), &quot;wb&quot;) as file:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        file.write(reg_result.tobytes())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        print(&#x27;Success!&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                print(&#x27;Only one person in a picture when you sign up&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            print(&#x27;No person detected&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def image2rgb888array(self,img):   #4维</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 将Image转换为rgb888格式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;fr_kpu_deinit&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            img_data_rgb888=img.to_rgb888()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # hwc,rgb888</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            img_hwc=img_data_rgb888.to_numpy_ref()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            shape=img_hwc.shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            img_tmp = img_hwc.reshape((shape[0] * shape[1], shape[2]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            img_tmp_trans = img_tmp.transpose()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            img_res=img_tmp_trans.copy()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # chw,rgb888</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            img_return=img_res.reshape((1,shape[2],shape[0],shape[1]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return  img_return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 人脸检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_det_kmodel_path=&quot;/sdcard/app/tests/kmodel/face_detection_320.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 人脸注册模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_reg_kmodel_path=&quot;/sdcard/app/tests/kmodel/face_recognition.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其它参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors_path=&quot;/sdcard/app/tests/utils/prior_data_320.bin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    database_dir=&quot;/sdcard/app/tests/utils/db/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    database_img_dir=&quot;/sdcard/app/tests/utils/db_img/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_det_input_size=[320,320]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    face_reg_input_size=[112,112]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold=0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold=0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchor_len=4200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    det_dim=4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = np.fromfile(anchors_path, dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = anchors.reshape((anchor_len,det_dim))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_register_face = 100              #数据库最多人脸个数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    feature_num = 128                    #人脸识别特征维度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fr=FaceRegistration(face_det_kmodel_path,face_reg_kmodel_path,det_input_size=face_det_input_size,reg_input_size=face_reg_input_size,database_dir=database_dir,anchors=anchors,confidence_threshold=confidence_threshold,nms_threshold=nms_threshold)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 获取图像列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        img_list = os.listdir(database_img_dir)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for img_file in img_list:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            #本地读取一张图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            full_img_file = database_img_dir + img_file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            print(full_img_file)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            img = image.Image(full_img_file)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            img.compress_for_ide()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 转rgb888的chw格式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            rgb888p_img_ndarry = fr.image2rgb888array(img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 人脸注册</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fr.run(rgb888p_img_ndarry,img_file)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fr.face_det.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fr.face_reg.deinit()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="210-跌倒检测">2.10. 跌倒检测<a href="#210-跌倒检测" class="hash-link" aria-label="Direct link to 2.10. 跌倒检 测" title="Direct link to 2.10. 跌倒检测">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import utime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aicube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义跌倒检测类，继承自AIBase基类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FallDetectionApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, kmodel_path, model_input_size, labels, anchors, confidence_threshold=0.2, nms_threshold=0.5, nms_option=False, strides=[8,16,32], rgb888p_size=[224,224], display_size=[1920,1080], debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path, model_input_size, rgb888p_size, debug_mode)  # 调用基类的构造函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path = kmodel_path                      # 模型文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size = model_input_size            # 模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.labels = labels                                # 分类标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors = anchors                              # 锚点数据，用于跌倒检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.strides = strides                              # 步长设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold = confidence_threshold    # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold = nms_threshold                  # NMS（非极大值抑制）阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_option = nms_option                        # NMS选项</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size = [ALIGN_UP(rgb888p_size[0], 16), rgb888p_size[1]]  # sensor给到AI的图像分辨率，并对宽度进行16的对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size = [ALIGN_UP(display_size[0], 16), display_size[1]]  # 显示分辨率，并对宽度进行16的对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode = debug_mode                                          # 是否开启调试模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.color = [(255,0, 0, 255), (255,0, 255, 0), (255,255,0, 0), (255,255,0, 255)]  # 用于绘制不同类别的颜色</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ai2d实例，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d = Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT, nn.ai2d_format.NCHW_FMT, np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self, input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;, self.debug_mode &gt; 0):                    # 计时器，如果debug_mode大于0则开启</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size = input_image_size if input_image_size else self.rgb888p_size   # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            top, bottom, left, right = self.get_padding_param()                             # 获取padding参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad([0, 0, 0, 0, top, bottom, left, right], 0, [0,0,0])               # 填充边缘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)       # 缩放图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])  # 构建预处理流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理，results是模型输出array的列表，这里使用了aicube库的anchorbasedet_post_process接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self, results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dets = aicube.anchorbasedet_post_process(results[0], results[1], results[2], self.model_input_size, self.rgb888p_size, self.strides, len(self.labels), self.confidence_threshold, self.nms_threshold, self.anchors, self.nms_option)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return dets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制检测结果到画面上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self, pl, dets):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;display_draw&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if dets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.clear()  # 清除OSD图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for det_box in dets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # 计算显示分辨率下的坐标</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x1, y1, x2, y2 = det_box[2], det_box[3], det_box[4], det_box[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    w = (x2 - x1) * self.display_size[0] // self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    h = (y2 - y1) * self.display_size[1] // self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x1 = int(x1 * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    y1 = int(y1 * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x2 = int(x2 * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    y2 = int(y2 * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # 绘制矩形框和类别标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_rectangle(x1, y1, int(w), int(h), color=self.color[det_box[0]], thickness=2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_string_advanced(x1, y1-50, 32,&quot; &quot; + self.labels[det_box[0]] + &quot; &quot; + str(round(det_box[1],2)), color=self.color[det_box[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 获取padding参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_padding_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_width = self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_high = self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / input_width</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / input_high</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = int(ratio * input_width)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = int(ratio * input_high)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = int(round(dh - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = int(round(dh + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = int(round(dw - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = int(round(dw - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return top, bottom, left, right</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__ == &quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置模型路径和其他参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_path = &quot;/sdcard/app/tests/kmodel/yolov5n-falldown.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold = 0.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold = 0.45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size = [1920, 1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels = [&quot;Fall&quot;,&quot;NoFall&quot;]  # 模型输出类别名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = [10, 13, 16, 30, 33, 23, 30, 61, 62, 45, 59, 119, 116, 90, 156, 198, 373, 326]  # anchor设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，用于图像处理流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl = PipeLine(rgb888p_size=rgb888p_size, display_size=display_size, display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化自定义跌倒检测实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fall_det = FallDetectionApp(kmodel_path, model_input_size=[640, 640], labels=labels, anchors=anchors, confidence_threshold=confidence_threshold, nms_threshold=nms_threshold, nms_option=False, strides=[8,16,32], rgb888p_size=rgb888p_size, display_size=display_size, debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fall_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()                                  # 检查是否有退出信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img = pl.get_frame()                        # 获取当前帧数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                res = fall_det.run(img)                     # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fall_det.draw_result(pl, res)               # 绘制结果到PipeLine的osd图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                             # 显示当前的绘制结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()                                # 垃圾回收</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)                              # 打印异常信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fall_det.deinit()                                   # 反初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()                                        # 销毁PipeLine实例</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="211-猜拳游戏">2.11. 猜拳游戏<a href="#211-猜拳游戏" class="hash-link" aria-label="Direct link to 2.11. 猜拳游戏" title="Direct link to 2.11. 猜拳游戏">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from random import randint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aicube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义手掌检测任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class HandDetApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,labels,model_input_size,anchors,confidence_threshold=0.2,nms_threshold=0.5,nms_option=False, strides=[8,16,32],rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.labels=labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors            # 锚框，检测任务使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.strides = strides          # 特征下采样倍数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_option = nms_option    # NMS选项，如果为True做类间NMS,如果为False做类内NMS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 实例化Ai2d，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size = input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算padding参数并应用pad操作，以确保输入图像尺寸与模型输入尺寸匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            top, bottom, left, right = self.get_padding_param()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad([0, 0, 0, 0, top, bottom, left, right], 0, [114, 114, 114])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 使用双线性插值进行resize操作，调整图像尺寸以符合模型输入要求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程，参数是ai2d预处理的输入tensor的shape和输出tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理，results是模型输出array的列表，这里使用了aicube库的anchorbasedet_post_process接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dets = aicube.anchorbasedet_post_process(results[0], results[1], results[2], self.model_input_size, self.rgb888p_size, self.strides, len(self.labels), self.confidence_threshold, self.nms_threshold, self.anchors, self.nms_option)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 返回手掌检测结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return dets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算padding参数，确保输入图像尺寸与模型输入尺寸匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_padding_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 根据目标宽度和高度计算比例因子</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_width = self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_high = self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / input_width</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / input_high</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 选择较小的比例因子，以确保图像内容完整</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算新的宽度和高度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = int(ratio * input_width)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = int(ratio * input_high)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算宽度和高度的差值，并确定padding的位置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = int(round(dh - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = int(round(dh + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = int(round(dw - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = int(round(dw + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return top, bottom, left, right</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义手势关键点分类任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class HandKPClassApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # crop参数列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_params=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了crop和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,det,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算crop参数并设置crop预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.crop_params = self.get_crop_param(det)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.crop(self.crop_params[0],self.crop_params[1],self.crop_params[2],self.crop_params[3])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 设置resize预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程，参数是ai2d预处理的输入tensor的shape和输出tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出array的列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results=results[0].reshape(results[0].shape[0]*results[0].shape[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show = np.zeros(results.shape,dtype=np.int16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show[0::2] = results[0::2] * self.crop_params[3] + self.crop_params[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show[1::2] = results[1::2] * self.crop_params[2] + self.crop_params[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            gesture=self.hk_gesture(results_show)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show[0::2] = results_show[0::2] * (self.display_size[0] / self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show[1::2] = results_show[1::2] * (self.display_size[1] / self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return results_show,gesture</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算crop参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_crop_param(self,det_box):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1, y1, x2, y2 = det_box[2],det_box[3],det_box[4],det_box[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        w,h= int(x2 - x1),int(y2 - y1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        w_det = int(float(x2 - x1) * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h_det = int(float(y2 - y1) * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x_det = int(x1*self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y_det = int(y1*self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        length = max(w, h)/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cx = (x1+x2)/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cy = (y1+y2)/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_num = 1.26*length</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1_kp = int(max(0,cx-ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y1_kp = int(max(0,cy-ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x2_kp = int(min(self.rgb888p_size[0]-1, cx+ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y2_kp = int(min(self.rgb888p_size[1]-1, cy+ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        w_kp = int(x2_kp - x1_kp + 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h_kp = int(y2_kp - y1_kp + 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [x1_kp, y1_kp, w_kp, h_kp]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 求两个vector之间的夹角</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def hk_vector_2d_angle(self,v1,v2):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;hk_vector_2d_angle&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v1_x,v1_y,v2_x,v2_y = v1[0],v1[1],v2[0],v2[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v1_norm = np.sqrt(v1_x * v1_x+ v1_y * v1_y)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v2_norm = np.sqrt(v2_x * v2_x + v2_y * v2_y)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dot_product = v1_x * v2_x + v1_y * v2_y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cos_angle = dot_product/(v1_norm*v2_norm)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            angle = np.acos(cos_angle)*180/np.pi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return angle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 根据手掌关键点检测结果判断手势类别</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def hk_gesture(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;hk_gesture&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            angle_list = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for i in range(5):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                angle = self.hk_vector_2d_angle([(results[0]-results[i*8+4]), (results[1]-results[i*8+5])],[(results[i*8+6]-results[i*8+8]),(results[i*8+7]-results[i*8+9])])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                angle_list.append(angle)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            thr_angle,thr_angle_thumb,thr_angle_s,gesture_str = 65.,53.,49.,None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if 65535. not in angle_list:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (angle_list[0]&gt;thr_angle_thumb)  and (angle_list[1]&gt;thr_angle) and (angle_list[2]&gt;thr_angle) and (angle_list[3]&gt;thr_angle) and (angle_list[4]&gt;thr_angle):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;fist&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&lt;thr_angle_s)  and (angle_list[1]&lt;thr_angle_s) and (angle_list[2]&lt;thr_angle_s) and (angle_list[3]&lt;thr_angle_s) and (angle_list[4]&lt;thr_angle_s):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;five&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&lt;thr_angle_s)  and (angle_list[1]&lt;thr_angle_s) and (angle_list[2]&gt;thr_angle) and (angle_list[3]&gt;thr_angle) and (angle_list[4]&gt;thr_angle):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;gun&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&lt;thr_angle_s)  and (angle_list[1]&lt;thr_angle_s) and (angle_list[2]&gt;thr_angle) and (angle_list[3]&gt;thr_angle) and (angle_list[4]&lt;thr_angle_s):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;love&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&gt;5)  and (angle_list[1]&lt;thr_angle_s) and (angle_list[2]&gt;thr_angle) and (angle_list[3]&gt;thr_angle) and (angle_list[4]&gt;thr_angle):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;one&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&lt;thr_angle_s)  and (angle_list[1]&gt;thr_angle) and (angle_list[2]&gt;thr_angle) and (angle_list[3]&gt;thr_angle) and (angle_list[4]&lt;thr_angle_s):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;six&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&gt;thr_angle_thumb)  and (angle_list[1]&lt;thr_angle_s) and (angle_list[2]&lt;thr_angle_s) and (angle_list[3]&lt;thr_angle_s) and (angle_list[4]&gt;thr_angle):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;three&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&lt;thr_angle_s)  and (angle_list[1]&gt;thr_angle) and (angle_list[2]&gt;thr_angle) and (angle_list[3]&gt;thr_angle) and (angle_list[4]&gt;thr_angle):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;thumbUp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&gt;thr_angle_thumb)  and (angle_list[1]&lt;thr_angle_s) and (angle_list[2]&lt;thr_angle_s) and (angle_list[3]&gt;thr_angle) and (angle_list[4]&gt;thr_angle):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;yeah&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return gesture_str</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 猜拳游戏任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FingerGuess:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,hand_det_kmodel,hand_kp_kmodel,det_input_size,kp_input_size,labels,anchors,confidence_threshold=0.25,nms_threshold=0.3,nms_option=False,strides=[8,16,32],guess_mode=3,rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_det_kmodel=hand_det_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌关键点模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_kp_kmodel=hand_kp_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.det_input_size=det_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌关键点模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kp_input_size=kp_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.labels=labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms选项</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_option=nms_option</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 特征图针对输入的下采样倍数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.strides=strides</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug_mode模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.guess_mode=guess_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 石头剪刀布的贴图array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.five_image = self.read_file(&quot;/sdcard/app/tests/utils/five.bin&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.fist_image = self.read_file(&quot;/sdcard/app/tests/utils/fist.bin&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.shear_image = self.read_file(&quot;/sdcard/app/tests/utils/shear.bin&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.counts_guess = -1                                                               # 猜拳次数 计数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.player_win = 0                                                                  # 玩家 赢次计数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.k230_win = 0                                                                    # k230 赢次计数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.sleep_end = False                                                               # 是否 停顿</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.set_stop_id = True                                                              # 是否 暂停猜拳</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.LIBRARY = [&quot;fist&quot;,&quot;yeah&quot;,&quot;five&quot;]                                                # 猜拳 石头剪刀布 三种方案的dict</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_det=HandDetApp(self.hand_det_kmodel,self.labels,model_input_size=self.det_input_size,anchors=self.anchors,confidence_threshold=self.confidence_threshold,nms_threshold=self.nms_threshold,nms_option=self.nms_option,strides=self.strides,rgb888p_size=self.rgb888p_size,display_size=self.display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_kp=HandKPClassApp(self.hand_kp_kmodel,model_input_size=self.kp_input_size,rgb888p_size=self.rgb888p_size,display_size=self.display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # run函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 先进行手掌检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        det_boxes=self.hand_det.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boxes=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gesture_res=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for det_box in det_boxes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 对检测的手做手势识别</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            x1, y1, x2, y2 = det_box[2],det_box[3],det_box[4],det_box[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            w,h= int(x2 - x1),int(y2 - y1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (h&lt;(0.1*self.rgb888p_size[1])):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (w&lt;(0.25*self.rgb888p_size[0]) and ((x1&lt;(0.03*self.rgb888p_size[0])) or (x2&gt;(0.97*self.rgb888p_size[0])))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (w&lt;(0.15*self.rgb888p_size[0]) and ((x1&lt;(0.01*self.rgb888p_size[0])) or (x2&gt;(0.99*self.rgb888p_size[0])))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.hand_kp.config_preprocess(det_box)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show,gesture=self.hand_kp.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boxes.append(det_box)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            gesture_res.append(gesture)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return boxes,gesture_res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制效果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,dets,gesture_res):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌的手势分类得到用户的出拳，根据不同模式给出开发板的出拳，并将对应的贴图放到屏幕上显示</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (len(dets) &gt;= 2):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pl.osd_img.draw_string_advanced( self.display_size[0]//2-50,self.display_size[1]//2-50,60, &quot;请保证只有一只手入镜！&quot;, color=(255,255,0,0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        elif (self.guess_mode == 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            draw_img_np = np.zeros((self.display_size[1],self.display_size[0],4),dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            draw_img = image.Image(self.display_size[0], self.display_size[1], image.ARGB8888, alloc=image.ALLOC_REF,data = draw_img_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (gesture_res[0] == &quot;fist&quot;):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img_np[:400,:400,:] = self.shear_image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            elif (gesture_res[0] == &quot;five&quot;):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img_np[:400,:400,:] = self.fist_image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            elif (gesture_res[0] == &quot;yeah&quot;):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img_np[:400,:400,:] = self.five_image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pl.osd_img.copy_from(draw_img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        elif (self.guess_mode == 1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            draw_img_np = np.zeros((self.display_size[1],self.display_size[0],4),dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            draw_img = image.Image(self.display_size[0], self.display_size[1], image.ARGB8888, alloc=image.ALLOC_REF,data = draw_img_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (gesture_res[0] == &quot;fist&quot;):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img_np[:400,:400,:] = self.five_image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            elif (gesture_res[0] == &quot;five&quot;):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img_np[:400,:400,:] = self.shear_image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            elif (gesture_res[0] == &quot;yeah&quot;):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img_np[:400,:400,:] = self.fist_image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pl.osd_img.copy_from(draw_img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            draw_img_np = np.zeros((self.display_size[1],self.display_size[0],4),dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            draw_img = image.Image(self.display_size[0], self.display_size[1], image.ARGB8888, alloc=image.ALLOC_REF,data = draw_img_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (self.sleep_end):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                time.sleep_ms(2000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.sleep_end = False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (len(dets) == 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.set_stop_id = True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (self.counts_guess == -1 and gesture_res[0] != &quot;fist&quot; and gesture_res[0] != &quot;yeah&quot; and gesture_res[0] != &quot;five&quot;):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img.draw_string_advanced( self.display_size[0]//2-50,self.display_size[1]//2-50,60, &quot;游戏开始&quot;, color=(255,255,0,0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img.draw_string_advanced( self.display_size[0]//2-50,self.display_size[1]//2-50,60, &quot;第一回合&quot;, color=(255,255,0,0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            elif (self.counts_guess == self.guess_mode):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (self.k230_win &gt; self.player_win):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    draw_img.draw_string_advanced( self.display_size[0]//2-50,self.display_size[1]//2-50,60, &quot;你输了！&quot;, color=(255,255,0,0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (self.k230_win &lt; self.player_win):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    draw_img.draw_string_advanced( self.display_size[0]//2-50,self.display_size[1]//2-50,60, &quot;你赢了！&quot;, color=(255,255,0,0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    draw_img.draw_string_advanced( self.display_size[0]//2-50,self.display_size[1]//2-50,60, &quot;平局&quot;, color=(255,255,0,0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.counts_guess = -1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.player_win = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.k230_win = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.sleep_end = True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (self.set_stop_id):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (self.counts_guess == -1 and (gesture_res[0] == &quot;fist&quot; or gesture_res[0] == &quot;yeah&quot; or gesture_res[0] == &quot;five&quot;)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.counts_guess = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (self.counts_guess != -1 and (gesture_res[0] == &quot;fist&quot; or gesture_res[0] == &quot;yeah&quot; or gesture_res[0] == &quot;five&quot;)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        k230_guess = randint(1,10000) % 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (gesture_res[0] == &quot;fist&quot; and self.LIBRARY[k230_guess] == &quot;yeah&quot;):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            self.player_win += 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        elif (gesture_res[0] == &quot;fist&quot; and self.LIBRARY[k230_guess] == &quot;five&quot;):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            self.k230_win += 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (gesture_res[0] == &quot;yeah&quot; and self.LIBRARY[k230_guess] == &quot;fist&quot;):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            self.k230_win += 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        elif (gesture_res[0] == &quot;yeah&quot; and self.LIBRARY[k230_guess] == &quot;five&quot;):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            self.player_win += 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (gesture_res[0] == &quot;five&quot; and self.LIBRARY[k230_guess] == &quot;fist&quot;):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            self.player_win += 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        elif (gesture_res[0] == &quot;five&quot; and self.LIBRARY[k230_guess] == &quot;yeah&quot;):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            self.k230_win += 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (self.LIBRARY[k230_guess] == &quot;fist&quot;):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            draw_img_np[:400,:400,:] = self.fist_image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        elif (self.LIBRARY[k230_guess] == &quot;five&quot;):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            draw_img_np[:400,:400,:] = self.five_image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        elif (self.LIBRARY[k230_guess] == &quot;yeah&quot;):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            draw_img_np[:400,:400,:] = self.shear_image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.counts_guess += 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        draw_img.draw_string_advanced(self.display_size[0]//2-50,self.display_size[1]//2-50,60,&quot;第&quot; + str(self.counts_guess) + &quot;回合&quot;, color=(255,255,0,0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.set_stop_id = False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.sleep_end = True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        draw_img.draw_string_advanced(self.display_size[0]//2-50,self.display_size[1]//2-50,60,&quot;第&quot; + str(self.counts_guess+1) + &quot;回合&quot;, color=(255,255,0,0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pl.osd_img.copy_from(draw_img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 读取石头剪刀布的bin文件方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def read_file(self,file_name):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image_arr = np.fromfile(file_name,dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        image_arr = image_arr.reshape((400,400,4))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return image_arr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 手掌检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_det_kmodel_path=&quot;/sdcard/app/tests/kmodel/hand_det.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 手掌关键点模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_kp_kmodel_path=&quot;/sdcard/app/tests/kmodel/handkp_det.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其它参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors_path=&quot;/sdcard/app/tests/utils/prior_data_320.bin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_det_input_size=[512,512]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_kp_input_size=[256,256]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold=0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold=0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels=[&quot;hand&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = [26,27, 53,52, 75,71, 80,99, 106,82, 99,134, 140,113, 161,172, 245,276]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 猜拳模式  0 玩家稳赢 ， 1 玩家必输 ， n &gt; 2 多局多胜</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    guess_mode = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，只关注传给AI的图像分辨率，显示的分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hkc=FingerGuess(hand_det_kmodel_path,hand_kp_kmodel_path,det_input_size=hand_det_input_size,kp_input_size=hand_kp_input_size,labels=labels,anchors=anchors,confidence_threshold=confidence_threshold,nms_threshold=nms_threshold,nms_option=False,strides=[8,16,32],guess_mode=guess_mode,rgb888p_size=rgb888p_size,display_size=display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()                          # 获取当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                det_boxes,gesture_res=hkc.run(img)          # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                hkc.draw_result(pl,det_boxes,gesture_res)   # 绘制推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                             # 展示推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hkc.hand_det.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hkc.hand_kp.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="212-手掌检测">2.12. 手掌检测<a href="#212-手掌检测" class="hash-link" aria-label="Direct link to 2.12. 手掌检测" title="Direct link to 2.12. 手掌检测">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import utime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aicube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义手掌检测类，继承自AIBase基类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class HandDetectionApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, kmodel_path, model_input_size, labels, anchors, confidence_threshold=0.2, nms_threshold=0.5, nms_option=False, strides=[8,16,32], rgb888p_size=[224,224], display_size=[1920,1080], debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path, model_input_size, rgb888p_size, debug_mode)  # 调用基类的构造函数，初始化模型文件路径、模型输入分辨率、RGB图像分辨率和调试模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path = kmodel_path  # 模型文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size = model_input_size  # 模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.labels = labels  # 模型输出的类别标签列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors = anchors  # 用于目标检测的锚点尺寸列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.strides = strides  # 特征下采样倍数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold = confidence_threshold  # 置信度阈值，用于过滤低置信度的检测结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold = nms_threshold  # NMS（非极大值抑制）阈值，用于去除重叠的检测框</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_option = nms_option  # NMS选项，可能影响NMS的具体实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size = [ALIGN_UP(rgb888p_size[0], 16), rgb888p_size[1]]  # sensor给到AI的图像分辨率，对齐到最近的16的倍数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size = [ALIGN_UP(display_size[0], 16), display_size[1]]  # 显示分辨率，对齐到最近的16的倍数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode = debug_mode  # 调试模式，用于输出调试信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d = Ai2d(debug_mode)  # 实例化Ai2d类，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型，这里使用NCHW格式，数据类型为uint8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT, nn.ai2d_format.NCHW_FMT, np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self, input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;, self.debug_mode &gt; 0):  # 使用ScopedTiming装饰器来测量预处理配置的时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size = input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算padding参数并应用pad操作，以确保输入图像尺寸与模型输入尺寸匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            top, bottom, left, right = self.get_padding_param()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad([0, 0, 0, 0, top, bottom, left, right], 0, [0, 0, 0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 使用双线性插值进行resize操作，调整图像尺寸以符合模型输入要求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理，用于处理模型输出结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self, results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;, self.debug_mode &gt; 0):  # 使用ScopedTiming装饰器来测量后处理的时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 使用aicube库的函数进行后处理，得到最终的检测结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dets = aicube.anchorbasedet_post_process(results[0], results[1], results[2], self.model_input_size, self.rgb888p_size, self.strides, len(self.labels), self.confidence_threshold, self.nms_threshold, self.anchors, self.nms_option)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return dets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制检测结果到屏幕上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self, pl, dets):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;display_draw&quot;, self.debug_mode &gt; 0):  # 使用ScopedTiming装饰器来测量绘制结果的时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if dets:  # 如果存在检测结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.clear()  # 清除屏幕上的旧内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for det_box in dets:  # 遍历每个检测框</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # 根据模型输出计算检测框的像素坐标，并调整大小以适应显示分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x1, y1, x2, y2 = det_box[2], det_box[3], det_box[4], det_box[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    w = float(x2 - x1) * self.display_size[0] // self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    h = float(y2 - y1) * self.display_size[1] // self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x1 = int(x1 * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    y1 = int(y1 * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x2 = int(x2 * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    y2 = int(y2 * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # 过滤掉太小或者位置不合理的检测框</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (h &lt; (0.1 * self.display_size[0])):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (w &lt; (0.25 * self.display_size[0]) and ((x1 &lt; (0.03 * self.display_size[0])) or (x2 &gt; (0.97 * self.display_size[0])))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (w &lt; (0.15 * self.display_size[0]) and ((x1 &lt; (0.01 * self.display_size[0])) or (x2 &gt; (0.99 * self.display_size[0])))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # 绘制矩形框和类别标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_rectangle(x1, y1, int(w), int(h), color=(255, 0, 255, 0), thickness=2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_string_advanced(x1, y1-50,32, &quot; &quot; + self.labels[det_box[0]] + &quot; &quot; + str(round(det_box[1], 2)), color=(255, 0, 255, 0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.clear()  # 如果没有检测结果，清空屏幕</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算padding参数，确保输入图像尺寸与模型输入尺寸匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_padding_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 根据目标宽度和高度计算比例因子</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_width = self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_high = self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / input_width</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / input_high</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 选择较小的比例因子，以确保图像内容完整</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算新的宽度和高度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = int(ratio * input_width)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = int(ratio * input_high)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算宽度和高度的差值，并确定padding的位置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = int(round(dh - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = int(round(dh + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = int(round(dw - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = int(round(dw + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return top, bottom, left, right</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_path=&quot;/sdcard/app/tests/kmodel/hand_det.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其它参数设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold = 0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold = 0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels = [&quot;hand&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = [26,27, 53,52, 75,71, 80,99, 106,82, 99,134, 140,113, 161,172, 245,276]   #anchor设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化自定义手掌检测实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_det=HandDetectionApp(kmodel_path,model_input_size=[512,512],labels=labels,anchors=anchors,confidence_threshold=confidence_threshold,nms_threshold=nms_threshold,nms_option=False,strides=[8,16,32],rgb888p_size=rgb888p_size,display_size=display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()                              # 检查是否有退出信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()                      # 获取当前帧数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                res=hand_det.run(img)                   # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                hand_det.draw_result(pl,res)            # 绘制结果到PipeLine的osd图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                         # 显示当前的绘制结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()                            # 垃圾回收</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hand_det.deinit()                               # 反初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()                                    # 销毁PipeLine实例</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="213-手掌关键点分类">2.13. 手掌关键点分类<a href="#213-手掌关键点分类" class="hash-link" aria-label="Direct link to 2.13. 手掌关键点分类" title="Direct link to 2.13. 手掌关键点分类">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aicube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义手掌检测任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class HandDetApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,labels,model_input_size,anchors,confidence_threshold=0.2,nms_threshold=0.5,nms_option=False, strides=[8,16,32],rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.labels=labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 锚框,目标检测任务使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 特征下采样倍数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.strides = strides</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # NMS选项，如果为True做类间NMS,如果为False做类内NMS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_option = nms_option</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ai2d实例用于实现预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置ai2d的输入输出的格式和数据类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size = input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算padding参数并应用pad操作，以确保输入图像尺寸与模型输入尺寸匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            top, bottom, left, right = self.get_padding_param()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad([0, 0, 0, 0, top, bottom, left, right], 0, [114, 114, 114])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 使用双线性插值进行resize操作，调整图像尺寸以符合模型输入要求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程,参数为预处理输入tensor的shape和预处理输出的tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理，用于处理模型输出结果，这里使用了aicube库的anchorbasedet_post_process接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dets = aicube.anchorbasedet_post_process(results[0], results[1], results[2], self.model_input_size, self.rgb888p_size, self.strides, len(self.labels), self.confidence_threshold, self.nms_threshold, self.anchors, self.nms_option)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 返回手掌检测结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return dets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算padding参数，确保输入图像尺寸与模型输入尺寸匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_padding_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 根据目标宽度和高度计算比例因子</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_width = self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_high = self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / input_width</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / input_high</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 选择较小的比例因子，以确保图像内容完整</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算新的宽度和高度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = int(ratio * input_width)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = int(ratio * input_high)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算宽度和高度的差值，并确定padding的位置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = int(round(dh - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = int(round(dh + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = int(round(dw - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = int(round(dw + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return top, bottom, left, right</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义手势关键点分类任务 类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class HandKPClassApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_params=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ai2d实例用于实现预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置ai2d的输入输出的格式和数据类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了crop和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,det,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.crop_params = self.get_crop_param(det)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.crop(self.crop_params[0],self.crop_params[1],self.crop_params[2],self.crop_params[3])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，得到手掌手势结果和手掌关键点数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results=results[0].reshape(results[0].shape[0]*results[0].shape[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show = np.zeros(results.shape,dtype=np.int16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show[0::2] = results[0::2] * self.crop_params[3] + self.crop_params[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show[1::2] = results[1::2] * self.crop_params[2] + self.crop_params[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            gesture=self.hk_gesture(results_show)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show[0::2] = results_show[0::2] * (self.display_size[0] / self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show[1::2] = results_show[1::2] * (self.display_size[1] / self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return results_show,gesture</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算crop参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_crop_param(self,det_box):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1, y1, x2, y2 = det_box[2],det_box[3],det_box[4],det_box[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        w,h= int(x2 - x1),int(y2 - y1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        w_det = int(float(x2 - x1) * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h_det = int(float(y2 - y1) * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x_det = int(x1*self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y_det = int(y1*self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        length = max(w, h)/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cx = (x1+x2)/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cy = (y1+y2)/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_num = 1.26*length</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1_kp = int(max(0,cx-ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y1_kp = int(max(0,cy-ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x2_kp = int(min(self.rgb888p_size[0]-1, cx+ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y2_kp = int(min(self.rgb888p_size[1]-1, cy+ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        w_kp = int(x2_kp - x1_kp + 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h_kp = int(y2_kp - y1_kp + 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [x1_kp, y1_kp, w_kp, h_kp]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 求两个vector之间的夹角</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def hk_vector_2d_angle(self,v1,v2):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;hk_vector_2d_angle&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v1_x,v1_y,v2_x,v2_y = v1[0],v1[1],v2[0],v2[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v1_norm = np.sqrt(v1_x * v1_x+ v1_y * v1_y)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v2_norm = np.sqrt(v2_x * v2_x + v2_y * v2_y)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dot_product = v1_x * v2_x + v1_y * v2_y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cos_angle = dot_product/(v1_norm*v2_norm)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            angle = np.acos(cos_angle)*180/np.pi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return angle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 根据手掌关键点检测结果判断手势类别</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def hk_gesture(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;hk_gesture&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            angle_list = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for i in range(5):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                angle = self.hk_vector_2d_angle([(results[0]-results[i*8+4]), (results[1]-results[i*8+5])],[(results[i*8+6]-results[i*8+8]),(results[i*8+7]-results[i*8+9])])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                angle_list.append(angle)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            thr_angle,thr_angle_thumb,thr_angle_s,gesture_str = 65.,53.,49.,None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if 65535. not in angle_list:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (angle_list[0]&gt;thr_angle_thumb)  and (angle_list[1]&gt;thr_angle) and (angle_list[2]&gt;thr_angle) and (angle_list[3]&gt;thr_angle) and (angle_list[4]&gt;thr_angle):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;fist&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&lt;thr_angle_s)  and (angle_list[1]&lt;thr_angle_s) and (angle_list[2]&lt;thr_angle_s) and (angle_list[3]&lt;thr_angle_s) and (angle_list[4]&lt;thr_angle_s):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;five&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&lt;thr_angle_s)  and (angle_list[1]&lt;thr_angle_s) and (angle_list[2]&gt;thr_angle) and (angle_list[3]&gt;thr_angle) and (angle_list[4]&gt;thr_angle):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;gun&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&lt;thr_angle_s)  and (angle_list[1]&lt;thr_angle_s) and (angle_list[2]&gt;thr_angle) and (angle_list[3]&gt;thr_angle) and (angle_list[4]&lt;thr_angle_s):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;love&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&gt;5)  and (angle_list[1]&lt;thr_angle_s) and (angle_list[2]&gt;thr_angle) and (angle_list[3]&gt;thr_angle) and (angle_list[4]&gt;thr_angle):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;one&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&lt;thr_angle_s)  and (angle_list[1]&gt;thr_angle) and (angle_list[2]&gt;thr_angle) and (angle_list[3]&gt;thr_angle) and (angle_list[4]&lt;thr_angle_s):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;six&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&gt;thr_angle_thumb)  and (angle_list[1]&lt;thr_angle_s) and (angle_list[2]&lt;thr_angle_s) and (angle_list[3]&lt;thr_angle_s) and (angle_list[4]&gt;thr_angle):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;three&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&lt;thr_angle_s)  and (angle_list[1]&gt;thr_angle) and (angle_list[2]&gt;thr_angle) and (angle_list[3]&gt;thr_angle) and (angle_list[4]&gt;thr_angle):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;thumbUp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elif (angle_list[0]&gt;thr_angle_thumb)  and (angle_list[1]&lt;thr_angle_s) and (angle_list[2]&lt;thr_angle_s) and (angle_list[3]&gt;thr_angle) and (angle_list[4]&gt;thr_angle):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gesture_str = &quot;yeah&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return gesture_str</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 手掌关键点分类任务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class HandKeyPointClass:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,hand_det_kmodel,hand_kp_kmodel,det_input_size,kp_input_size,labels,anchors,confidence_threshold=0.25,nms_threshold=0.3,nms_option=False,strides=[8,16,32],rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_det_kmodel=hand_det_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌关键点模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_kp_kmodel=hand_kp_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.det_input_size=det_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌关键点模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kp_input_size=kp_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.labels=labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_option=nms_option</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.strides=strides</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug_mode模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_det=HandDetApp(self.hand_det_kmodel,self.labels,model_input_size=self.det_input_size,anchors=self.anchors,confidence_threshold=self.confidence_threshold,nms_threshold=self.nms_threshold,nms_option=self.nms_option,strides=self.strides,rgb888p_size=self.rgb888p_size,display_size=self.display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_kp=HandKPClassApp(self.hand_kp_kmodel,model_input_size=self.kp_input_size,rgb888p_size=self.rgb888p_size,display_size=self.display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # run函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 执行手掌检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        det_boxes=self.hand_det.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boxes=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gesture_res=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for det_box in det_boxes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 对于检测到的每一个手掌执行关键点识别</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            x1, y1, x2, y2 = det_box[2],det_box[3],det_box[4],det_box[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            w,h= int(x2 - x1),int(y2 - y1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (h&lt;(0.1*self.rgb888p_size[1])):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (w&lt;(0.25*self.rgb888p_size[0]) and ((x1&lt;(0.03*self.rgb888p_size[0])) or (x2&gt;(0.97*self.rgb888p_size[0])))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (w&lt;(0.15*self.rgb888p_size[0]) and ((x1&lt;(0.01*self.rgb888p_size[0])) or (x2&gt;(0.99*self.rgb888p_size[0])))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.hand_kp.config_preprocess(det_box)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show,gesture=self.hand_kp.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            gesture_res.append((results_show,gesture))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boxes.append(det_box)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return boxes,gesture_res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制效果，绘制关键点、手掌检测框和识别结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,dets,gesture_res):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if len(dets)&gt;0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for k in range(len(dets)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                det_box=dets[k]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                x1, y1, x2, y2 = det_box[2],det_box[3],det_box[4],det_box[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                w,h= int(x2 - x1),int(y2 - y1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (h&lt;(0.1*self.rgb888p_size[1])):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (w&lt;(0.25*self.rgb888p_size[0]) and ((x1&lt;(0.03*self.rgb888p_size[0])) or (x2&gt;(0.97*self.rgb888p_size[0])))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (w&lt;(0.15*self.rgb888p_size[0]) and ((x1&lt;(0.01*self.rgb888p_size[0])) or (x2&gt;(0.99*self.rgb888p_size[0])))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                w_det = int(float(x2 - x1) * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                h_det = int(float(y2 - y1) * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                x_det = int(x1*self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                y_det = int(y1*self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.draw_rectangle(x_det, y_det, w_det, h_det, color=(255, 0, 255, 0), thickness = 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                results_show=gesture_res[k][0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for i in range(len(results_show)/2):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_circle(results_show[i*2], results_show[i*2+1], 1, color=(255, 0, 255, 0),fill=False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for i in range(5):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    j = i*8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if i==0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        R = 255; G = 0; B = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if i==1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        R = 255; G = 0; B = 255</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if i==2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        R = 255; G = 255; B = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if i==3:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        R = 0; G = 255; B = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if i==4:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        R = 0; G = 0; B = 255</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_line(results_show[0], results_show[1], results_show[j+2], results_show[j+3], color=(255,R,G,B), thickness = 3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_line(results_show[j+2], results_show[j+3], results_show[j+4], results_show[j+5], color=(255,R,G,B), thickness = 3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_line(results_show[j+4], results_show[j+5], results_show[j+6], results_show[j+7], color=(255,R,G,B), thickness = 3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_line(results_show[j+6], results_show[j+7], results_show[j+8], results_show[j+9], color=(255,R,G,B), thickness = 3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gesture_str=gesture_res[k][1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.draw_string_advanced( x_det , y_det-50,32, &quot; &quot; + str(gesture_str), color=(255,0, 255, 0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 手掌检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_det_kmodel_path=&quot;/sdcard/app/tests/kmodel/hand_det.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 手掌关键点模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_kp_kmodel_path=&quot;/sdcard/app/tests/kmodel/handkp_det.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其他参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors_path=&quot;/sdcard/app/tests/utils/prior_data_320.bin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_det_input_size=[512,512]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_kp_input_size=[256,256]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold=0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold=0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels=[&quot;hand&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = [26,27, 53,52, 75,71, 80,99, 106,82, 99,134, 140,113, 161,172, 245,276]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，只关注传给AI的图像分辨率，显示的分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hkc=HandKeyPointClass(hand_det_kmodel_path,hand_kp_kmodel_path,det_input_size=hand_det_input_size,kp_input_size=hand_kp_input_size,labels=labels,anchors=anchors,confidence_threshold=confidence_threshold,nms_threshold=nms_threshold,nms_option=False,strides=[8,16,32],rgb888p_size=rgb888p_size,display_size=display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()                          # 获取当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                det_boxes,gesture_res=hkc.run(img)          # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                hkc.draw_result(pl,det_boxes,gesture_res)   # 绘制当前帧推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                             # 展示推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hkc.hand_det.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hkc.hand_kp.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="214-手掌关键点检测">2.14. 手掌关键点检测<a href="#214-手掌关键点检测" class="hash-link" aria-label="Direct link to 2.14. 手掌关键点检测" title="Direct link to 2.14. 手掌关键点检测">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aicube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义手掌检测任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class HandDetApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,labels,model_input_size,anchors,confidence_threshold=0.2,nms_threshold=0.5,nms_option=False, strides=[8,16,32],rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.labels=labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 锚框,目标检测任务使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 特征下采样倍数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.strides = strides</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # NMS选项，如果为True做类间NMS,如果为False做类内NMS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_option = nms_option</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ai2d实例用于实现预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置ai2d的输入输出的格式和数据类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size = input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算padding参数并应用pad操作，以确保输入图像尺寸与模型输入尺寸匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            top, bottom, left, right = self.get_padding_param()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad([0, 0, 0, 0, top, bottom, left, right], 0, [114, 114, 114])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 使用双线性插值进行resize操作，调整图像尺寸以符合模型输入要求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程,参数为预处理输入tensor的shape和预处理输出的tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理，用于处理模型输出结果，这里使用了aicube库的anchorbasedet_post_process接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dets = aicube.anchorbasedet_post_process(results[0], results[1], results[2], self.model_input_size, self.rgb888p_size, self.strides, len(self.labels), self.confidence_threshold, self.nms_threshold, self.anchors, self.nms_option)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 返回手掌检测结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return dets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算padding参数，确保输入图像尺寸与模型输入尺寸匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_padding_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 根据目标宽度和高度计算比例因子</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_width = self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_high = self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / input_width</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / input_high</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 选择较小的比例因子，以确保图像内容完整</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算新的宽度和高度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = int(ratio * input_width)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = int(ratio * input_high)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算宽度和高度的差值，并确定padding的位置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = int(round(dh - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = int(round(dh + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = int(round(dw - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = int(round(dw + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return top, bottom, left, right</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义手势关键点检测任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class HandKPDetApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_params=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ai2d实例用于实现预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置ai2d的输入输出的格式和数据类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了crop和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,det,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.crop_params = self.get_crop_param(det)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.crop(self.crop_params[0],self.crop_params[1],self.crop_params[2],self.crop_params[3])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出的array列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results=results[0].reshape(results[0].shape[0]*results[0].shape[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show = np.zeros(results.shape,dtype=np.int16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show[0::2] = results[0::2] * self.crop_params[3] + self.crop_params[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show[1::2] = results[1::2] * self.crop_params[2] + self.crop_params[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show[0::2] = results_show[0::2] * (self.display_size[0] / self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show[1::2] = results_show[1::2] * (self.display_size[1] / self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return results_show</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算crop参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_crop_param(self,det_box):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1, y1, x2, y2 = det_box[2],det_box[3],det_box[4],det_box[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        w,h= int(x2 - x1),int(y2 - y1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        w_det = int(float(x2 - x1) * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h_det = int(float(y2 - y1) * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x_det = int(x1*self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y_det = int(y1*self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        length = max(w, h)/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cx = (x1+x2)/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cy = (y1+y2)/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_num = 1.26*length</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1_kp = int(max(0,cx-ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y1_kp = int(max(0,cy-ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x2_kp = int(min(self.rgb888p_size[0]-1, cx+ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y2_kp = int(min(self.rgb888p_size[1]-1, cy+ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        w_kp = int(x2_kp - x1_kp + 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h_kp = int(y2_kp - y1_kp + 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [x1_kp, y1_kp, w_kp, h_kp]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 手掌关键点检测任务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class HandKeyPointDet:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,hand_det_kmodel,hand_kp_kmodel,det_input_size,kp_input_size,labels,anchors,confidence_threshold=0.25,nms_threshold=0.3,nms_option=False,strides=[8,16,32],rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_det_kmodel=hand_det_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌关键点模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_kp_kmodel=hand_kp_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.det_input_size=det_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌关键点模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kp_input_size=kp_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.labels=labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms选项</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_option=nms_option</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 特征图对于输入的下采样倍数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.strides=strides</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug_mode模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_det=HandDetApp(self.hand_det_kmodel,self.labels,model_input_size=self.det_input_size,anchors=self.anchors,confidence_threshold=self.confidence_threshold,nms_threshold=self.nms_threshold,nms_option=self.nms_option,strides=self.strides,rgb888p_size=self.rgb888p_size,display_size=self.display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_kp=HandKPDetApp(self.hand_kp_kmodel,model_input_size=self.kp_input_size,rgb888p_size=self.rgb888p_size,display_size=self.display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # run函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        det_boxes=self.hand_det.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hand_res=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boxes=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for det_box in det_boxes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 对检测到的每个手掌执行手势关键点识别</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            x1, y1, x2, y2 = det_box[2],det_box[3],det_box[4],det_box[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            w,h= int(x2 - x1),int(y2 - y1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 丢弃不合理的框</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (h&lt;(0.1*self.rgb888p_size[1])):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (w&lt;(0.25*self.rgb888p_size[0]) and ((x1&lt;(0.03*self.rgb888p_size[0])) or (x2&gt;(0.97*self.rgb888p_size[0])))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (w&lt;(0.15*self.rgb888p_size[0]) and ((x1&lt;(0.01*self.rgb888p_size[0])) or (x2&gt;(0.99*self.rgb888p_size[0])))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.hand_kp.config_preprocess(det_box)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show=self.hand_kp.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boxes.append(det_box)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            hand_res.append(results_show)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return boxes,hand_res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制效果，绘制手掌关键点、检测框</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,dets,hand_res):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if dets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for k in range(len(dets)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                det_box=dets[k]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                x1, y1, x2, y2 = det_box[2],det_box[3],det_box[4],det_box[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                w,h= int(x2 - x1),int(y2 - y1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                w_det = int(float(x2 - x1) * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                h_det = int(float(y2 - y1) * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                x_det = int(x1*self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                y_det = int(y1*self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.draw_rectangle(x_det, y_det, w_det, h_det, color=(255, 0, 255, 0), thickness = 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                results_show=hand_res[k]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for i in range(len(results_show)/2):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_circle(results_show[i*2], results_show[i*2+1], 1, color=(255, 0, 255, 0),fill=False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for i in range(5):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    j = i*8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if i==0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        R = 255; G = 0; B = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if i==1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        R = 255; G = 0; B = 255</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if i==2:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        R = 255; G = 255; B = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if i==3:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        R = 0; G = 255; B = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if i==4:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        R = 0; G = 0; B = 255</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_line(results_show[0], results_show[1], results_show[j+2], results_show[j+3], color=(255,R,G,B), thickness = 3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_line(results_show[j+2], results_show[j+3], results_show[j+4], results_show[j+5], color=(255,R,G,B), thickness = 3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_line(results_show[j+4], results_show[j+5], results_show[j+6], results_show[j+7], color=(255,R,G,B), thickness = 3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_line(results_show[j+6], results_show[j+7], results_show[j+8], results_show[j+9], color=(255,R,G,B), thickness = 3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 手掌检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_det_kmodel_path=&quot;/sdcard/app/tests/kmodel/hand_det.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 手部关键点模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_kp_kmodel_path=&quot;/sdcard/app/tests/kmodel/handkp_det.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其它参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors_path=&quot;/sdcard/app/tests/utils/prior_data_320.bin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_det_input_size=[512,512]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_kp_input_size=[256,256]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold=0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold=0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels=[&quot;hand&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = [26,27, 53,52, 75,71, 80,99, 106,82, 99,134, 140,113, 161,172, 245,276]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，只关注传给AI的图像分辨率，显示的分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hkd=HandKeyPointDet(hand_det_kmodel_path,hand_kp_kmodel_path,det_input_size=hand_det_input_size,kp_input_size=hand_kp_input_size,labels=labels,anchors=anchors,confidence_threshold=confidence_threshold,nms_threshold=nms_threshold,nms_option=False,strides=[8,16,32],rgb888p_size=rgb888p_size,display_size=display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()                      # 获取当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                det_boxes,hand_res=hkd.run(img)         # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                hkd.draw_result(pl,det_boxes,hand_res)  # 绘制推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                         # 展示推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hkd.hand_det.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hkd.hand_kp.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="215-手势识别">2.15. 手势识别<a href="#215-手势识别" class="hash-link" aria-label="Direct link to 2.15. 手势识别" title="Direct link to 2.15. 手势识别">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aicube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义手掌检测任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class HandDetApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,anchors,confidence_threshold=0.2,nms_threshold=0.5,nms_option=False, strides=[8,16,32],rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 锚框,目标检测任务使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 特征下采样倍数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.strides = strides</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # NMS选项，如果为True做类间NMS,如果为False做类内NMS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_option = nms_option</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ai2d实例用于实现预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置ai2d的输入输出的格式和数据类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处  理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size = input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算padding参数并应用pad操作，以确保输入图像尺寸与模型输入尺寸匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            top, bottom, left, right = self.get_padding_param()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad([0, 0, 0, 0, top, bottom, left, right], 0, [114, 114, 114])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 使用双线性插值进行resize操作，调整图像尺寸以符合模型输入要求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程,参数为预处理输入tensor的shape和预处理输出的tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理，用于处理模型输出结果，这里使用了aicube库的anchorbasedet_post_process接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dets = aicube.anchorbasedet_post_process(results[0], results[1], results[2], self.model_input_size, self.rgb888p_size, self.strides,1, self.confidence_threshold, self.nms_threshold, self.anchors, self.nms_option)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 返回手掌检测结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return dets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算padding参数，确保输入图像尺寸与模型输入尺寸匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_padding_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 根据目标宽度和高度计算比例因子</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_width = self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_high = self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / input_width</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / input_high</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 选择较小的比例因子，以确保图像内容完整</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算新的宽度和高度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = int(ratio * input_width)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = int(ratio * input_high)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算宽度和高度的差值，并确定padding的位置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = int(round(dh - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = int(round(dh + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = int(round(dw - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = int(round(dw + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return top, bottom, left, right</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义手势识别任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class HandRecognitionApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,labels,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.labels=labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_params=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ai2d实例用于实现预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置ai2d的输入输出的格式和数据类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了crop和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,det,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.crop_params = self.get_crop_param(det)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.crop(self.crop_params[0],self.crop_params[1],self.crop_params[2],self.crop_params[3])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出的array列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result=results[0].reshape(results[0].shape[0]*results[0].shape[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            x_softmax = self.softmax(result)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            idx = np.argmax(x_softmax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            text = &quot; &quot; + self.labels[idx] + &quot;: &quot; + str(round(x_softmax[idx],2))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算crop参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_crop_param(self,det_box):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1, y1, x2, y2 = det_box[2],det_box[3],det_box[4],det_box[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        w,h= int(x2 - x1),int(y2 - y1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        w_det = int(float(x2 - x1) * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h_det = int(float(y2 - y1) * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x_det = int(x1*self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y_det = int(y1*self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        length = max(w, h)/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cx = (x1+x2)/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cy = (y1+y2)/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_num = 1.26*length</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1_kp = int(max(0,cx-ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y1_kp = int(max(0,cy-ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x2_kp = int(min(self.rgb888p_size[0]-1, cx+ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y2_kp = int(min(self.rgb888p_size[1]-1, cy+ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        w_kp = int(x2_kp - x1_kp + 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h_kp = int(y2_kp - y1_kp + 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [x1_kp, y1_kp, w_kp, h_kp]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # softmax实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def softmax(self,x):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x -= np.max(x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x = np.exp(x) / np.sum(np.exp(x))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class HandRecognition:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,hand_det_kmodel,hand_kp_kmodel,det_input_size,kp_input_size,labels,anchors,confidence_threshold=0.25,nms_threshold=0.3,nms_option=False,strides=[8,16,32],rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_det_kmodel=hand_det_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌关键点模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_kp_kmodel=hand_kp_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.det_input_size=det_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌关键点模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kp_input_size=kp_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.labels=labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms选项</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_option=nms_option</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 特征图针对输出的下采  样倍数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.strides=strides</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug_mode模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_det=HandDetApp(self.hand_det_kmodel,model_input_size=self.det_input_size,anchors=self.anchors,confidence_threshold=self.confidence_threshold,nms_threshold=self.nms_threshold,nms_option=self.nms_option,strides=self.strides,rgb888p_size=self.rgb888p_size,display_size=self.display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_rec=HandRecognitionApp(self.hand_kp_kmodel,model_input_size=self.kp_input_size,labels=self.labels,rgb888p_size=self.rgb888p_size,display_size=self.display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # run函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 执行手掌检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        det_boxes=self.hand_det.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hand_rec_res=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hand_det_res=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for det_box in det_boxes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 对检测到的每一个手掌执行手势识别</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            x1, y1, x2, y2 = det_box[2],det_box[3],det_box[4],det_box[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            w,h= int(x2 - x1),int(y2 - y1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (h&lt;(0.1*self.rgb888p_size[1])):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (w&lt;(0.25*self.rgb888p_size[0]) and ((x1&lt;(0.03*self.rgb888p_size[0])) or (x2&gt;(0.97*self.rgb888p_size[0])))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (w&lt;(0.15*self.rgb888p_size[0]) and ((x1&lt;(0.01*self.rgb888p_size[0])) or (x2&gt;(0.99*self.rgb888p_size[0])))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.hand_rec.config_preprocess(det_box)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            text=self.hand_rec.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            hand_det_res.append(det_box)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            hand_rec_res.append(text)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return hand_det_res,hand_rec_res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制效果，绘制识别结果和检测框</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,hand_det_res,hand_rec_res):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if hand_det_res:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for k in range(len(hand_det_res)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                det_box=hand_det_res[k]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                x1, y1, x2, y2 = det_box[2],det_box[3],det_box[4],det_box[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                w,h= int(x2 - x1),int(y2 - y1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                w_det = int(float(x2 - x1) * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                h_det = int(float(y2 - y1) * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                x_det = int(x1*self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                y_det = int(y1*self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.draw_rectangle(x_det, y_det, w_det, h_det, color=(255, 0, 255, 0), thickness = 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.draw_string_advanced( x_det, y_det-50, 32,hand_rec_res[k], color=(255,0, 255, 0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 手掌检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_det_kmodel_path=&quot;/sdcard/app/tests/kmodel/hand_det.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 手势识别模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_rec_kmodel_path=&quot;/sdcard/app/tests/kmodel/hand_reco.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其它参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors_path=&quot;/sdcard/app/tests/utils/prior_data_320.bin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_det_input_size=[512,512]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_rec_input_size=[224,224]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold=0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold=0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels=[&quot;gun&quot;,&quot;other&quot;,&quot;yeah&quot;,&quot;five&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = [26,27, 53,52, 75,71, 80,99, 106,82, 99,134, 140,113, 161,172, 245,276]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，只关注传给AI的图像分辨率，显示的分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hr=HandRecognition(hand_det_kmodel_path,hand_rec_kmodel_path,det_input_size=hand_det_input_size,kp_input_size=hand_rec_input_size,labels=labels,anchors=anchors,confidence_threshold=confidence_threshold,nms_threshold=nms_threshold,nms_option=False,strides=[8,16,32],rgb888p_size=rgb888p_size,display_size=display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()                              # 获取当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                hand_det_res,hand_rec_res=hr.run(img)           # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                hr.draw_result(pl,hand_det_res,hand_rec_res)    # 绘制推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                                 # 展示推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hr.hand_det.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hr.hand_rec.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="216-关键词唤醒">2.16 关键词唤醒<a href="#216-关键词唤醒" class="hash-link" aria-label="Direct link to 2.16 关键词唤醒" title="Direct link to 2.16 关键词唤醒">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.pyaudio import *                     # 音频模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *                       # 软件抽象模块，主要封装媒体数据链路以及媒体缓冲区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import media.wave as wave                       # wav音频处理模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn                     # nncase运行模块，封装了kpu（kmodel推理）和ai2d（图片预处理加速）操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np                         # 类似python numpy操作，但也会有一些接口不同</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aidemo                                   # aidemo模块，封装ai demo相关前处理、后处理等操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time                                     # 时间统计</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import struct                                   # 字节字符转换模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc                                       # 垃圾回收模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os,sys                                   # 操作系统接口模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义关键词唤醒类，继承自AIBase基类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class KWSApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, kmodel_path, threshold, debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path)  # 调用基类的构造函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path = kmodel_path  # 模型文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.threshold=threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode = debug_mode  # 是否开启调试模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.cache_np = np.zeros((1, 256, 105), dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义预处理，返回模型输入tensor列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def preprocess(self,pcm_data):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pcm_data_list=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 获取音频流数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for i in range(0, len(pcm_data), 2):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 每两个字节组织成一个有符号整数，然后将其转换为浮点数，即为一次采样的数据，加入到当前一帧（0.3s）的数据列表中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int_pcm_data = struct.unpack(&quot;&lt;h&quot;, pcm_data[i:i+2])[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            float_pcm_data = float(int_pcm_data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pcm_data_list.append(float_pcm_data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 将pcm数据处理为模型输入的特征向量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mp_feats = aidemo.kws_preprocess(fp, pcm_data_list)[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mp_feats_np = np.array(mp_feats).reshape((1, 30, 40))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        audio_input_tensor = nn.from_numpy(mp_feats_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cache_input_tensor = nn.from_numpy(self.cache_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [audio_input_tensor,cache_input_tensor]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理，results是模型输出array列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self, results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logits_np = results[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.cache_np= results[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            max_logits = np.max(logits_np, axis=1)[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            max_p = np.max(max_logits)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            idx = np.argmax(max_logits)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 如果分数大于阈值，且idx==1(即包含唤醒词)，播放回复音频</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if max_p &gt; self.threshold and idx == 1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__ == &quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    os.exitpoint(os.EXITPOINT_ENABLE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nn.shrink_memory_pool()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置模型路径和其他参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_path = &quot;/sdcard/app/tests/kmodel/kws.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其它参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    THRESH = 0.5                # 检测阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SAMPLE_RATE = 16000         # 采样率16000Hz,即每秒采样16000次</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CHANNELS = 1                # 通道数 1为单声道，2为立体声</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FORMAT = paInt16            # 音频输入输出格式 paInt16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CHUNK = int(0.3 * 16000)    # 每次读取音频数据的帧数，设置为0.3s的帧数16000*0.3=4800</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reply_wav_file = &quot;/sdcard/app/tests/utils/wozai.wav&quot;         # kws唤醒词回复音频路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化音频预处理接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fp = aidemo.kws_fp_create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化音频流</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    p = PyAudio()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    p.initialize(CHUNK)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MediaManager.init()    #vb buffer初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 用于采集实时音频数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_stream = p.open(format=FORMAT,channels=CHANNELS,rate=SAMPLE_RATE,input=True,frames_per_buffer=CHUNK)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 用于播放回复音频</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output_stream = p.open(format=FORMAT,channels=CHANNELS,rate=SAMPLE_RATE,output=True,frames_per_buffer=CHUNK)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化自定义关键词唤醒实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kws = KWSApp(kmodel_path,threshold=THRESH,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()                      # 检查是否有退出信号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pcm_data=input_stream.read()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                res=kws.run(pcm_data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if res:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    print(&quot;====Detected XiaonanXiaonan!====&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    wf = wave.open(reply_wav_file, &quot;rb&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    wav_data = wf.read_frames(CHUNK)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    while wav_data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        output_stream.write(wav_data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        wav_data = wf.read_frames(CHUNK)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    time.sleep(1) # 时间缓冲，用于播放回复声音</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    wf.close()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    print(&quot;Deactivated!&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()                    # 垃圾回收</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)                  # 打印异常信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_stream.stop_stream()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        output_stream.stop_stream()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_stream.close()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        output_stream.close()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        p.terminate()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MediaManager.deinit()              #释放vb buffer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        aidemo.kws_fp_destroy(fp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kws.deinit()                       # 反初始化</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="217-车牌检测">2.17. 车牌检测<a href="#217-车牌检测" class="hash-link" aria-label="Direct link to 2.17. 车牌检测" title="Direct link to 2.17. 车牌检测">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import utime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aidemo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义车牌检测类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class LicenceDetectionApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化函数，设置车牌检测应用的参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, kmodel_path, model_input_size, confidence_threshold=0.5, nms_threshold=0.2, rgb888p_size=[224,224], display_size=[1920,1080], debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path, model_input_size, rgb888p_size, debug_mode)  # 调用基类的初始化函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path = kmodel_path  # 模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size = model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 分类阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold = confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold = nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size = [ALIGN_UP(rgb888p_size[0], 16), rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 显示分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size = [ALIGN_UP(display_size[0], 16), display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode = debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ai2d实例，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d = Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT, nn.ai2d_format.NCHW_FMT, np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self, input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size = input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self, results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 对检测结果进行后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            det_res = aidemo.licence_det_postprocess(results, [self.rgb888p_size[1], self.rgb888p_size[0]], self.model_input_size, self.confidence_threshold, self.nms_threshold)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return det_res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制检测结果到屏幕上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self, pl, dets):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;display_draw&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if dets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.clear()  # 清除屏幕</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                point_8 = np.zeros((8), dtype=np.int16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for det in dets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # 将检测框坐标从sensor图像分辨率转换为显示分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    for i in range(4):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        x = det[i * 2 + 0] / self.rgb888p_size[0] * self.display_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        y = det[i * 2 + 1] / self.rgb888p_size[1] * self.display_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        point_8[i * 2 + 0] = int(x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        point_8[i * 2 + 1] = int(y)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # 在屏幕上绘制检测框</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    for i in range(4):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pl.osd_img.draw_line(point_8[i * 2 + 0], point_8[i * 2 + 1], point_8[(i + 1) % 4 * 2 + 0], point_8[(i + 1) % 4 * 2 + 1], color=(255, 0, 255, 0), thickness=4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.clear()  # 如果没有检测结果，则清空屏幕</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_path=&quot;/sdcard/app/tests/kmodel/LPD_640.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其它参数设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold = 0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold = 0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化自定义车牌检测实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    licence_det=LicenceDetectionApp(kmodel_path,model_input_size=[640,640],confidence_threshold=confidence_threshold,nms_threshold=nms_threshold,rgb888p_size=rgb888p_size,display_size=display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    licence_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 获取当前帧数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                res=licence_det.run(img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 绘制结果到PipeLine的osd图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                licence_det.draw_result(pl,res)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 显示当前的绘制结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        licence_det.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="218-车牌识别">2.18. 车牌识别<a href="#218-车牌识别" class="hash-link" aria-label="Direct link to 2.18. 车牌识别" title="Direct link to 2.18. 车牌识别">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aidemo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义车牌检测类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class LicenceDetectionApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化函数，设置车牌检测应用的参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, kmodel_path, model_input_size, confidence_threshold=0.5, nms_threshold=0.2, rgb888p_size=[224,224], display_size=[1920,1080], debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path, model_input_size, rgb888p_size, debug_mode)  # 调用基类的初始化函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path = kmodel_path  # 模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size = model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 分类阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold = confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold = nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size = [ALIGN_UP(rgb888p_size[0], 16), rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 显示分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size = [ALIGN_UP(display_size[0], 16), display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode = debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ai2d实例，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d = Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT, nn.ai2d_format.NCHW_FMT, np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self, input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size = input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self, results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 对检测结果进行后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            det_res = aidemo.licence_det_postprocess(results, [self.rgb888p_size[1], self.rgb888p_size[0]], self.model_input_size, self.confidence_threshold, self.nms_threshold)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return det_res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义车牌识别任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class LicenceRecognitionApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 车牌字符字典</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.dict_rec = [&quot;挂&quot;, &quot;使&quot;, &quot;领&quot;, &quot;澳&quot;, &quot;港&quot;, &quot;皖&quot;, &quot;沪&quot;, &quot;津&quot;, &quot;渝&quot;, &quot;冀&quot;, &quot;晋&quot;, &quot;蒙&quot;, &quot;辽&quot;, &quot;吉&quot;, &quot;黑&quot;, &quot;苏&quot;, &quot;浙&quot;, &quot;京&quot;, &quot;闽&quot;, &quot;赣&quot;, &quot;鲁&quot;, &quot;豫&quot;, &quot;鄂&quot;, &quot;湘&quot;, &quot;粤&quot;, &quot;桂&quot;, &quot;琼&quot;, &quot;川&quot;, &quot;贵&quot;, &quot;云&quot;, &quot;藏&quot;, &quot;陕&quot;, &quot;甘&quot;, &quot;青&quot;, &quot;宁&quot;, &quot;新&quot;, &quot;警&quot;, &quot;学&quot;, &quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;, &quot;8&quot;, &quot;9&quot;, &quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;, &quot;E&quot;, &quot;F&quot;, &quot;G&quot;, &quot;H&quot;, &quot;J&quot;, &quot;K&quot;, &quot;L&quot;, &quot;M&quot;, &quot;N&quot;, &quot;P&quot;, &quot;Q&quot;, &quot;R&quot;, &quot;S&quot;, &quot;T&quot;, &quot;U&quot;, &quot;V&quot;, &quot;W&quot;, &quot;X&quot;, &quot;Y&quot;, &quot;Z&quot;, &quot;_&quot;, &quot;-&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.dict_size = len(self.dict_rec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了resize，Ai2d支持crop/shift/pad/resize/affine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出的array列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            output_data=results[0].reshape((-1,self.dict_size))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            max_indices = np.argmax(output_data, axis=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result_str = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for i in range(max_indices.shape[0]):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                index = max_indices[i]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if index &gt; 0 and (i == 0 or index != max_indices[i - 1]):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    result_str += self.dict_rec[index - 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result_str</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 车牌识别任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class LicenceRec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,licence_det_kmodel,licence_rec_kmodel,det_input_size,rec_input_size,confidence_threshold=0.25,nms_threshold=0.3,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 车牌检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.licence_det_kmodel=licence_det_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 车牌识别模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.licence_rec_kmodel=licence_rec_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.det_input_size=det_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 人脸姿态模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rec_input_size=rec_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug_mode模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.licence_det=LicenceDetectionApp(self.licence_det_kmodel,model_input_size=self.det_input_size,confidence_threshold=self.confidence_threshold,nms_threshold=self.nms_threshold,rgb888p_size=self.rgb888p_size,display_size=self.display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.licence_rec=LicenceRecognitionApp(self.licence_rec_kmodel,model_input_size=self.rec_input_size,rgb888p_size=self.rgb888p_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.licence_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # run函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 执行车牌检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        det_boxes=self.licence_det.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 将车牌部分抠出来</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imgs_array_boxes = aidemo.ocr_rec_preprocess(input_np,[self.rgb888p_size[1],self.rgb888p_size[0]],det_boxes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        imgs_array = imgs_array_boxes[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boxes = imgs_array_boxes[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rec_res = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for img_array in imgs_array:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 对每一个检测到的车牌进行识别</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.licence_rec.config_preprocess(input_image_size=[img_array.shape[3],img_array.shape[2]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            licence_str=self.licence_rec.run(img_array)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            rec_res.append(licence_str)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return det_boxes,rec_res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制车牌检测识别效果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,det_res,rec_res):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if det_res:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            point_8 = np.zeros((8),dtype=np.int16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for det_index in range(len(det_res)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for i in range(4):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x = det_res[det_index][i * 2 + 0]/self.rgb888p_size[0]*self.display_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    y = det_res[det_index][i * 2 + 1]/self.rgb888p_size[1]*self.display_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    point_8[i * 2 + 0] = int(x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    point_8[i * 2 + 1] = int(y)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for i in range(4):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_line(point_8[i * 2 + 0],point_8[i * 2 + 1],point_8[(i+1) % 4 * 2 + 0],point_8[(i+1) % 4 * 2 + 1],color=(255, 0, 255, 0),thickness=4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.draw_string_advanced( point_8[6], point_8[7] + 20, 40,rec_res[det_index] , color=(255,255,153,18))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 车牌检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    licence_det_kmodel_path=&quot;/sdcard/app/tests/kmodel/LPD_640.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 车牌识别模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    licence_rec_kmodel_path=&quot;/sdcard/app/tests/kmodel/licence_reco.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其它参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[640,360]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    licence_det_input_size=[640,640]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    licence_rec_input_size=[220,32]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold=0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold=0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，只关注传给AI的图像分辨率，显示的分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lr=LicenceRec(licence_det_kmodel_path,licence_rec_kmodel_path,det_input_size=licence_det_input_size,rec_input_size=licence_rec_input_size,confidence_threshold=confidence_threshold,nms_threshold=nms_threshold,rgb888p_size=rgb888p_size,display_size=display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()                  # 获取当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                det_res,rec_res=lr.run(img)         # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                lr.draw_result(pl,det_res,rec_res)  # 绘制当前帧推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                     # 展示推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lr.licence_det.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lr.licence_rec.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="219-单目标跟踪">2.19. 单目标跟踪<a href="#219-单目标跟踪" class="hash-link" aria-label="Direct link to 2.19. 单目标跟踪" title="Direct link to 2.19. 单目标跟踪">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from random import randint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aidemo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义跟踪模版任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class TrackCropApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,ratio_src_crop,center_xy_wh,rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 跟踪模板输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 跟踪框宽、高调整系数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.CONTEXT_AMOUNT = 0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #src模型和crop模型输入比值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ratio_src_crop = ratio_src_crop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.center_xy_wh=center_xy_wh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # padding和crop参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.pad_crop_params=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 注意：ai2d设置多个预处理时执行的顺序为：crop-&gt;shift-&gt;resize/affine-&gt;pad，如果不符合该顺序，需要配置多个ai2d对象;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 如下模型预处理要先做resize+padding再做resize+crop，因此要配置两个Ai2d对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d_pad=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d_pad.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d_crop=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d_crop.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.need_pad=False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，  这里使用了crop、pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size = input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算padding参数并应用pad操作，以确保输入图像尺寸与模型输入尺寸匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.pad_crop_params= self.get_padding_crop_param()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 如果需要padding,配置padding部分，否则只走crop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (self.pad_crop_params[0] != 0 or self.pad_crop_params[1] != 0 or self.pad_crop_params[2] != 0 or self.pad_crop_params[3] != 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.need_pad=True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.ai2d_pad.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.ai2d_pad.pad([0, 0, 0, 0, self.pad_crop_params[0], self.pad_crop_params[1], self.pad_crop_params[2], self.pad_crop_params[3]], 0, [114, 114, 114])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                output_size=[self.rgb888p_size[0]+self.pad_crop_params[2]+self.pad_crop_params[3],self.rgb888p_size[1]+self.pad_crop_params[0]+self.pad_crop_params[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.ai2d_pad.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,output_size[1],output_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.ai2d_crop.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.ai2d_crop.crop(int(self.pad_crop_params[4]),int(self.pad_crop_params[6]),int(self.pad_crop_params[5]-self.pad_crop_params[4]+1),int(self.pad_crop_params[7]-self.pad_crop_params[6]+1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.ai2d_crop.build([1,3,output_size[1],output_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.need_pad=False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.ai2d_crop.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.ai2d_crop.crop(int(self.center_xy_wh[0]-self.pad_crop_params[8]/2.0),int(self.center_xy_wh[1]-self.pad_crop_params[8]/2.0),int(self.pad_crop_params[8]),int(self.pad_crop_params[8]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.ai2d_crop.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 重写预处理函数preprocess，因为该部分不是单纯的走一个ai2d做预处理，所以该函数需要重写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def preprocess(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if self.need_pad:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pad_output=self.ai2d_pad.run(input_np).to_numpy()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return [self.ai2d_crop.run(pad_output)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return [self.ai2d_crop.run(input_np)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出array的列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return results[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算padding和crop参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_padding_crop_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s_z = round(np.sqrt((self.center_xy_wh[2] + self.CONTEXT_AMOUNT * (self.center_xy_wh[2] + self.center_xy_wh[3])) * (self.center_xy_wh[3] + self.CONTEXT_AMOUNT * (self.center_xy_wh[2] + self.center_xy_wh[3]))))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c = (s_z + 1) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context_xmin = np.floor(self.center_xy_wh[0] - c + 0.5)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context_xmax = int(context_xmin + s_z - 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context_ymin = np.floor(self.center_xy_wh[1] - c + 0.5)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context_ymax = int(context_ymin + s_z - 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left_pad = int(max(0, -context_xmin))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top_pad = int(max(0, -context_ymin))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right_pad = int(max(0, int(context_xmax - self.rgb888p_size[0] + 1)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom_pad = int(max(0, int(context_ymax - self.rgb888p_size[1] + 1)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context_xmin = context_xmin + left_pad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context_xmax = context_xmax + left_pad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context_ymin = context_ymin + top_pad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context_ymax = context_ymax + top_pad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [top_pad,bottom_pad,left_pad,right_pad,context_xmin,context_xmax,context_ymin,context_ymax,s_z]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #重写deinit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def deinit(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;deinit&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            del self.ai2d_pad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            del self.ai2d_crop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            super().deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义跟踪实时任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class TrackSrcApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,ratio_src_crop,rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # padding和crop参数列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.pad_crop_params=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 跟踪框宽、高调整系数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.CONTEXT_AMOUNT = 0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # src和crop模型的输入尺寸比例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ratio_src_crop = ratio_src_crop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 注意：ai2d设置多个预处理时执行的顺序为：crop-&gt;shift-&gt;resize/affine-&gt;pad，如果不符合该顺序，需要配置多个ai2d对象;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 如下模型预处理要先做resize+padding再做resize+crop，因此要配置两个Ai2d对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d_pad=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d_pad.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d_crop=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d_crop.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.need_pad=False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了crop、pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请 打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,center_xy_wh,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算padding参数并应用pad操作，以确保输入图像尺寸与模型输入尺寸匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.pad_crop_params= self.get_padding_crop_param(center_xy_wh)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 如果需要padding,配置padding部分，否则只走crop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (self.pad_crop_params[0] != 0 or self.pad_crop_params[1] != 0 or self.pad_crop_params[2] != 0 or self.pad_crop_params[3] != 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.need_pad=True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.ai2d_pad.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.ai2d_pad.pad([0, 0, 0, 0, self.pad_crop_params[0], self.pad_crop_params[1], self.pad_crop_params[2], self.pad_crop_params[3]], 0, [114, 114, 114])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                output_size=[self.rgb888p_size[0]+self.pad_crop_params[2]+self.pad_crop_params[3],self.rgb888p_size[1]+self.pad_crop_params[0]+self.pad_crop_params[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.ai2d_pad.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,output_size[1],output_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.ai2d_crop.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.ai2d_crop.crop(int(self.pad_crop_params[4]),int(self.pad_crop_params[6]),int(self.pad_crop_params[5]-self.pad_crop_params[4]+1),int(self.pad_crop_params[7]-self.pad_crop_params[6]+1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.ai2d_crop.build([1,3,output_size[1],output_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.need_pad=False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.ai2d_crop.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.ai2d_crop.crop(int(center_xy_wh[0]-self.pad_crop_params[8]/2.0),int(center_xy_wh[1]-self.pad_crop_params[8]/2.0),int(self.pad_crop_params[8]),int(self.pad_crop_params[8]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.ai2d_crop.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 重写预处理函数preprocess，因为该部分不是单纯的走一个ai2d做预处理，所以该函数需要重写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def preprocess(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;preprocess&quot;,self.debug_mode&gt;0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if self.need_pad:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pad_output=self.ai2d_pad.run(input_np).to_numpy()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return [self.ai2d_crop.run(pad_output)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return [self.ai2d_crop.run(input_np)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出array的列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return results[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算padding和crop参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_padding_crop_param(self,center_xy_wh):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s_z = round(np.sqrt((center_xy_wh[2] + self.CONTEXT_AMOUNT * (center_xy_wh[2] + center_xy_wh[3])) * (center_xy_wh[3] + self.CONTEXT_AMOUNT * (center_xy_wh[2] + center_xy_wh[3])))) * self.ratio_src_crop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c = (s_z + 1) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context_xmin = np.floor(center_xy_wh[0] - c + 0.5)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context_xmax = int(context_xmin + s_z - 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context_ymin = np.floor(center_xy_wh[1] - c + 0.5)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context_ymax = int(context_ymin + s_z - 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left_pad = int(max(0, -context_xmin))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top_pad = int(max(0, -context_ymin))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right_pad = int(max(0, int(context_xmax - self.rgb888p_size[0] + 1)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom_pad = int(max(0, int(context_ymax - self.rgb888p_size[1] + 1)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context_xmin = context_xmin + left_pad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context_xmax = context_xmax + left_pad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context_ymin = context_ymin + top_pad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context_ymax = context_ymax + top_pad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [top_pad,bottom_pad,left_pad,right_pad,context_xmin,context_xmax,context_ymin,context_ymax,s_z]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 重写deinit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def deinit(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;deinit&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            del self.ai2d_pad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            del self.ai2d_crop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            super().deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class TrackerApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,crop_input_size,thresh,rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # crop模型的输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_input_size=crop_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 跟踪框阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.thresh=thresh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 跟踪框宽、高调整系数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.CONTEXT_AMOUNT = 0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 重写run函数，因为没有预处理过程，所以原来run操作中包含的preprocess-&gt;inference-&gt;postprocess不合适，这里只包含inference-&gt;postprocess</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np_1,input_np_2,center_xy_wh):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_tensors=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_tensors.append(nn.from_numpy(input_np_1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_tensors.append(nn.from_numpy(input_np_2))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        results=self.inference(input_tensors)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return self.postprocess(results,center_xy_wh)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出array的列表,这里使用了aidemo的nanotracker_postprocess列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results,center_xy_wh):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            det = aidemo.nanotracker_postprocess(results[0],results[1],[self.rgb888p_size[1],self.rgb888p_size[0]],self.thresh,center_xy_wh,self.crop_input_size[0],self.CONTEXT_AMOUNT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return det</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class NanoTracker:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,track_crop_kmodel,track_src_kmodel,tracker_kmodel,crop_input_size,src_input_size,threshold=0.25,rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 跟踪模版模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.track_crop_kmodel=track_crop_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 跟踪实时模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.track_src_kmodel=track_src_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 跟踪模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.tracker_kmodel=tracker_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 跟踪模版模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_input_size=crop_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 跟踪实时模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.src_input_size=src_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.threshold=threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.CONTEXT_AMOUNT=0.5       # 跟踪框宽、高调整系数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ratio_src_crop = 0.0     # src模型和crop模型输入比值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.track_x1 = float(600)    # 起始跟踪目标框左上角点x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.track_y1 = float(300)    # 起始跟踪目标框左上角点y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.track_w = float(100)     # 起始跟踪目标框w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.track_h = float(100)     # 起始跟踪目标框h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.draw_mean=[]             # 初始目标框位置列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.center_xy_wh = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.track_boxes = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.center_xy_wh_tmp = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.track_boxes_tmp=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_output=None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.src_output=None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 跟踪框初始化时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.seconds = 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.endtime = time.time() + self.seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.enter_init = True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨  率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.init_param()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.track_crop=TrackCropApp(self.track_crop_kmodel,model_input_size=self.crop_input_size,ratio_src_crop=self.ratio_src_crop,center_xy_wh=self.center_xy_wh,rgb888p_size=self.rgb888p_size,display_size=self.display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.track_src=TrackSrcApp(self.track_src_kmodel,model_input_size=self.src_input_size,ratio_src_crop=self.ratio_src_crop,rgb888p_size=self.rgb888p_size,display_size=self.display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.tracker=TrackerApp(self.tracker_kmodel,crop_input_size=self.crop_input_size,thresh=self.threshold,rgb888p_size=self.rgb888p_size,display_size=self.display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.track_crop.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # run函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 在初始化时间内，crop模版部分的到跟踪模版特征，否则，对当前帧进行src推理得到特征并使用tracker对两个特征推理，得到跟踪框的坐标</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nowtime = time.time()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (self.enter_init and nowtime &lt;= self.endtime):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            print(&quot;倒计时: &quot; + str(self.endtime - nowtime) + &quot; 秒&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.crop_output=self.track_crop.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            time.sleep(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return self.draw_mean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.track_src.config_preprocess(self.center_xy_wh)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.src_output=self.track_src.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            det=self.tracker.run(self.crop_output,self.src_output,self.center_xy_wh)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return det</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制效果，绘制跟踪框位置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,box):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if self.enter_init:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pl.osd_img.draw_rectangle(box[0],box[1],box[2],box[3],color=(255, 0, 255, 0),thickness = 4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (time.time() &gt; self.endtime):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.enter_init = False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.track_boxes = box[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.center_xy_wh = box[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            track_bool = True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (len(self.track_boxes) != 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                track_bool = self.track_boxes[0] &gt; 10 and self.track_boxes[1] &gt; 10 and self.track_boxes[0] + self.track_boxes[2] &lt; self.rgb888p_size[0] - 10 and self.track_boxes[1] + self.track_boxes[3] &lt; self.rgb888p_size[1] - 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                track_bool = False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (len(self.center_xy_wh) != 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                track_bool = track_bool and self.center_xy_wh[2] * self.center_xy_wh[3] &lt; 40000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                track_bool = False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (track_bool):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.center_xy_wh_tmp = self.center_xy_wh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.track_boxes_tmp = self.track_boxes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                x1 = int(float(self.track_boxes[0]) * self.display_size[0] / self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                y1 = int(float(self.track_boxes[1]) * self.display_size[1] / self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                w = int(float(self.track_boxes[2]) * self.display_size[0] / self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                h = int(float(self.track_boxes[3]) * self.display_size[1] / self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.draw_rectangle(x1, y1, w, h, color=(255, 255, 0, 0),thickness = 4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.center_xy_wh = self.center_xy_wh_tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.track_boxes = self.track_boxes_tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                x1 = int(float(self.track_boxes[0]) * self.display_size[0] / self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                y1 = int(float(self.track_boxes[1]) * self.display_size[1] / self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                w = int(float(self.track_boxes[2]) * self.display_size[0] / self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                h = int(float(self.track_boxes[3]) * self.display_size[1] / self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.draw_rectangle(x1, y1, w, h, color=(255, 255, 0, 0),thickness = 4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.draw_string_advanced( x1 , y1-50,32, &quot;请远离摄像头，保持跟踪物体大小基本一致!&quot; , color=(255, 255 ,0 , 0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.draw_string_advanced( x1 , y1-100,32, &quot;请靠近中心!&quot; , color=(255, 255 ,0 , 0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # crop参数初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def init_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ratio_src_crop = float(self.src_input_size[0])/float(self.crop_input_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print(self.ratio_src_crop)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (self.track_x1 &lt; 50 or self.track_y1 &lt; 50 or self.track_x1+self.track_w &gt;= self.rgb888p_size[0]-50 or self.track_y1+self.track_h &gt;= self.rgb888p_size[1]-50):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    print(&quot;**剪切范围超出图像范围**&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            track_mean_x = self.track_x1 + self.track_w / 2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            track_mean_y = self.track_y1 + self.track_h / 2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            draw_mean_w = int(self.track_w / self.rgb888p_size[0] * self.display_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            draw_mean_h = int(self.track_h / self.rgb888p_size[1] * self.display_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            draw_mean_x = int(track_mean_x / self.rgb888p_size[0] * self.display_size[0] - draw_mean_w / 2.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            draw_mean_y = int(track_mean_y / self.rgb888p_size[1] * self.display_size[1] - draw_mean_h / 2.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.draw_mean=[draw_mean_x,draw_mean_y,draw_mean_w,draw_mean_h]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.center_xy_wh = [track_mean_x,track_mean_y,self.track_w,self.track_h]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.center_xy_wh_tmp=[track_mean_x,track_mean_y,self.track_w,self.track_h]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.track_boxes = [self.track_x1,self.track_y1,self.track_w,self.track_h,1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.track_boxes_tmp=np.array([self.track_x1,self.track_y1,self.track_w,self.track_h,1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 跟踪模板模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    track_crop_kmodel_path=&quot;/sdcard/app/tests/kmodel/cropped_test127.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 跟踪实时模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    track_src_kmodel_path=&quot;/sdcard/app/tests/kmodel/nanotrack_backbone_sim.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 跟踪模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tracker_kmodel_path=&quot;/sdcard/app/tests/kmodel/nanotracker_head_calib_k230.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其他参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[1280,720]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    track_crop_input_size=[127,127]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    track_src_input_size=[255,255]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    threshold=0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，只关注传给AI的图像分辨率，显示的分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    track=NanoTracker(track_crop_kmodel_path,track_src_kmodel_path,tracker_kmodel_path,crop_input_size=track_crop_input_size,src_input_size=track_src_input_size,threshold=threshold,rgb888p_size=rgb888p_size,display_size=display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()              # 获取当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                output=track.run(img)           # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                track.draw_result(pl,output)    # 绘制当前帧推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                 # 展示推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        track.track_crop.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        track.track_src.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        track.tracker.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="220-yolov8n目标检测">2.20. yolov8n目标检测<a href="#220-yolov8n目标检测" class="hash-link" aria-label="Direct link to 2.20. yolov8n目标检测" title="Direct link to 2.20. yolov8n目标检测">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import utime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aidemo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义YOLOv8检测类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ObjectDetectionApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,labels,model_input_size,max_boxes_num,confidence_threshold=0.5,nms_threshold=0.2,rgb888p_size=[224,224],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.labels=labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 阈值设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.max_boxes_num=max_boxes_num</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 显示分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #  检测框预置颜色值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.color_four=[(255, 220, 20, 60), (255, 119, 11, 32), (255, 0, 0, 142), (255, 0, 0, 230),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         (255, 106, 0, 228), (255, 0, 60, 100), (255, 0, 80, 100), (255, 0, 0, 70),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         (255, 0, 0, 192), (255, 250, 170, 30), (255, 100, 170, 30), (255, 220, 220, 0),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         (255, 175, 116, 175), (255, 250, 0, 30), (255, 165, 42, 42), (255, 255, 77, 255),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         (255, 0, 226, 252), (255, 182, 182, 255), (255, 0, 82, 0), (255, 120, 166, 157)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 宽高缩放比例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.x_factor = float(self.rgb888p_size[0])/self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.y_factor = float(self.rgb888p_size[1])/self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ai2d实例，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，您可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result=results[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result = result.reshape((result.shape[0] * result.shape[1], result.shape[2]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            output_data = result.transpose()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boxes_ori = output_data[:,0:4]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            scores_ori = output_data[:,4:]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            confs_ori = np.max(scores_ori,axis=-1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            inds_ori = np.argmax(scores_ori,axis=-1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boxes,scores,inds = [],[],[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for i in range(len(boxes_ori)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if confs_ori[i] &gt; confidence_threshold:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    scores.append(confs_ori[i])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    inds.append(inds_ori[i])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x = boxes_ori[i,0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    y = boxes_ori[i,1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    w = boxes_ori[i,2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    h = boxes_ori[i,3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    left = int((x - 0.5 * w) * self.x_factor)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    top = int((y - 0.5 * h) * self.y_factor)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    right = int((x + 0.5 * w) * self.x_factor)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    bottom = int((y + 0.5 * h) * self.y_factor)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    boxes.append([left,top,right,bottom])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if len(boxes)==0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boxes = np.array(boxes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            scores = np.array(scores)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            inds = np.array(inds)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # NMS过程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            keep = self.nms(boxes,scores,nms_threshold)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dets = np.concatenate((boxes, scores.reshape((len(boxes),1)), inds.reshape((len(boxes),1))), axis=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dets_out = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for keep_i in keep:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                dets_out.append(dets[keep_i])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dets_out = np.array(dets_out)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dets_out = dets_out[:self.max_boxes_num, :]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return dets_out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,dets):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;display_draw&quot;,self.debug_mode &gt;0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if dets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for det in dets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x1, y1, x2, y2 = map(lambda x: int(round(x, 0)), det[:4])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x= x1*self.display_size[0] // self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    y= y1*self.display_size[1] // self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    w = (x2 - x1) * self.display_size[0] // self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    h = (y2 - y1) * self.display_size[1] // self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_rectangle(x,y, w, h, color=self.get_color(int(det[5])),thickness=4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_string_advanced( x , y-50,32,&quot; &quot; + self.labels[int(det[5])] + &quot; &quot; + str(round(det[4],2)) , color=self.get_color(int(det[5])))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 多目标检测 非最大值抑制方法实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def nms(self,boxes,scores,thresh):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;&quot;&quot;Pure Python NMS baseline.&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1,y1,x2,y2 = boxes[:, 0],boxes[:, 1],boxes[:, 2],boxes[:, 3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        areas = (x2 - x1 + 1) * (y2 - y1 + 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        order = np.argsort(scores,axis = 0)[::-1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        keep = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while order.size &gt; 0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            i = order[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            keep.append(i)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new_x1,new_y1,new_x2,new_y2,new_areas = [],[],[],[],[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for order_i in order:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new_x1.append(x1[order_i])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new_x2.append(x2[order_i])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new_y1.append(y1[order_i])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new_y2.append(y2[order_i])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new_areas.append(areas[order_i])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new_x1 = np.array(new_x1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new_x2 = np.array(new_x2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new_y1 = np.array(new_y1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new_y2 = np.array(new_y2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            xx1 = np.maximum(x1[i], new_x1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            yy1 = np.maximum(y1[i], new_y1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            xx2 = np.minimum(x2[i], new_x2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            yy2 = np.minimum(y2[i], new_y2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            w = np.maximum(0.0, xx2 - xx1 + 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            h = np.maximum(0.0, yy2 - yy1 + 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            inter = w * h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new_areas = np.array(new_areas)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ovr = inter / (areas[i] + new_areas - inter)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new_order = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for ovr_i,ind in enumerate(ovr):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if ind &lt; thresh:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    new_order.append(order[ovr_i])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            order = np.array(new_order,dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return keep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 根据当前类别索引获取框的颜色</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_color(self, x):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        idx=x%len(self.color_four)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return self.color_four[idx]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_path=&quot;/sdcard/app/tests/kmodel/yolov8n_320.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels = [&quot;person&quot;, &quot;bicycle&quot;, &quot;car&quot;, &quot;motorcycle&quot;, &quot;airplane&quot;, &quot;bus&quot;, &quot;train&quot;, &quot;truck&quot;, &quot;boat&quot;, &quot;traffic light&quot;, &quot;fire hydrant&quot;, &quot;stop sign&quot;, &quot;parking meter&quot;, &quot;bench&quot;, &quot;bird&quot;, &quot;cat&quot;, &quot;dog&quot;, &quot;horse&quot;, &quot;sheep&quot;, &quot;cow&quot;, &quot;elephant&quot;, &quot;bear&quot;, &quot;zebra&quot;, &quot;giraffe&quot;, &quot;backpack&quot;, &quot;umbrella&quot;, &quot;handbag&quot;, &quot;tie&quot;, &quot;suitcase&quot;, &quot;frisbee&quot;, &quot;skis&quot;, &quot;snowboard&quot;, &quot;sports ball&quot;, &quot;kite&quot;, &quot;baseball bat&quot;, &quot;baseball glove&quot;, &quot;skateboard&quot;, &quot;surfboard&quot;, &quot;tennis racket&quot;, &quot;bottle&quot;, &quot;wine glass&quot;, &quot;cup&quot;, &quot;fork&quot;, &quot;knife&quot;, &quot;spoon&quot;, &quot;bowl&quot;, &quot;banana&quot;, &quot;apple&quot;, &quot;sandwich&quot;, &quot;orange&quot;, &quot;broccoli&quot;, &quot;carrot&quot;, &quot;hot dog&quot;, &quot;pizza&quot;, &quot;donut&quot;, &quot;cake&quot;, &quot;chair&quot;, &quot;couch&quot;, &quot;potted plant&quot;, &quot;bed&quot;, &quot;dining table&quot;, &quot;toilet&quot;, &quot;tv&quot;, &quot;laptop&quot;, &quot;mouse&quot;, &quot;remote&quot;, &quot;keyboard&quot;, &quot;cell phone&quot;, &quot;microwave&quot;, &quot;oven&quot;, &quot;toaster&quot;, &quot;sink&quot;, &quot;refrigerator&quot;, &quot;book&quot;, &quot;clock&quot;, &quot;vase&quot;, &quot;scissors&quot;, &quot;teddy bear&quot;, &quot;hair drier&quot;, &quot;toothbrush&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其它参数设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold = 0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold = 0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_boxes_num = 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[320,320]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化自定义目标检测实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ob_det=ObjectDetectionApp(kmodel_path,labels=labels,model_input_size=[320,320],max_boxes_num=max_boxes_num,confidence_threshold=confidence_threshold,nms_threshold=nms_threshold,rgb888p_size=rgb888p_size,display_size=display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ob_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 获取当前帧数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                res=ob_det.run(img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 绘制结果到PipeLine的osd图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ob_det.draw_result(pl,res)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 显示当前的绘制结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ob_det.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="221-ocr检测">2.21. OCR检测<a href="#221-ocr检测" class="hash-link" aria-label="Direct link to 2.21. OCR检测" title="Direct link to 2.21. OCR检测">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import utime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aicube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义OCR检测类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class OCRDetectionApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,mask_threshold=0.5,box_threshold=0.2,rgb888p_size=[224,224],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 分类阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.mask_threshold=mask_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.box_threshold=box_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 显示分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ai2d实例，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，您可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            top,bottom,left,right=self.get_padding_param()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad([0,0,0,0,top,bottom,left,right], 0, [0,0,0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # chw2hwc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            hwc_array=self.chw2hwc(self.cur_img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 这里使用了aicube封装的接口seg_post_process做后处理，返回一个和display_size相同分辨率的mask图</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # det_boxes结构为[[crop_array_nhwc,[p1_x,p1_y,p2_x,p2_y,p3_x,p3_y,p4_x,p4_y]],...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            det_boxes = aicube.ocr_post_process(results[0][:,:,:,0].reshape(-1), hwc_array.reshape(-1),self.model_input_size,self.rgb888p_size, self.mask_threshold, self.box_threshold)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            all_boxes_pos=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for det_box in det_boxes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                all_boxes_pos.append(det_box[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return all_boxes_pos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,all_boxes_pos):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;display_draw&quot;,self.debug_mode &gt;0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 一次绘制四条边，得到文本检测的四边形</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for i in range(len(all_boxes_pos)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for j in range(4):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x1=all_boxes_pos[i][2*j]*self.display_size[0]//self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    y1=all_boxes_pos[i][2*j+1]*self.display_size[1]//self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x2=all_boxes_pos[i][(2*j+2)%8]*self.display_size[0]//self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    y2=all_boxes_pos[i][(2*j+3)%8]*self.display_size[1]//self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_line(int(x1),int(y1),int(x2),int(y2),color=(255,255,0,0),thickness=4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算padding参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_padding_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 右padding或下padding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_width = self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_high = self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / input_width</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / input_high</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = (int)(ratio * input_width)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = (int)(ratio * input_high)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = (int)(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = (int)(round(dh * 2 + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = (int)(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = (int)(round(dw * 2 - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return  top, bottom, left, right</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # chw2hwc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def chw2hwc(self,features):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ori_shape = (features.shape[0], features.shape[1], features.shape[2])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c_hw_ = features.reshape((ori_shape[0], ori_shape[1] * ori_shape[2]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hw_c_ = c_hw_.transpose()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_array = hw_c_.copy()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hwc_array = new_array.reshape((ori_shape[1], ori_shape[2], ori_shape[0]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        del c_hw_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        del hw_c_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        del new_array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return hwc_array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_path=&quot;/sdcard/app/tests/kmodel/ocr_det_int16.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # kmodel其它参数设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mask_threshold = 0.25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    box_threshold = 0.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[640,360]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化自定义OCR检测实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ocr_det=OCRDetectionApp(kmodel_path,model_input_size=[640,640],mask_threshold=mask_threshold,box_threshold=box_threshold,rgb888p_size=rgb888p_size,display_size=display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ocr_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 获取当前帧数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                res=ocr_det.run(img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 绘制结果到PipeLine的osd图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ocr_det.draw_result(pl,res)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 显示当前的绘制结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ocr_det.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="222-ocr识别">2.22. OCR识别<a href="#222-ocr识别" class="hash-link" aria-label="Direct link to 2.22. OCR识别" title="Direct link to 2.22. OCR识别">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aicube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义OCR检测类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class OCRDetectionApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,mask_threshold=0.5,box_threshold=0.2,rgb888p_size=[224,224],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 分类阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.mask_threshold=mask_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.box_threshold=box_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 显示分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ai2d实例，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，您可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            top,bottom,left,right=self.get_padding_param()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad([0,0,0,0,top,bottom,left,right], 0, [0,0,0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # chw2hwc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            hwc_array=self.chw2hwc(self.cur_img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 这里使用了aicube封装的接口ocr_post_process做后处理,返回的det_boxes结构为[[crop_array_nhwc,[p1_x,p1_y,p2_x,p2_y,p3_x,p3_y,p4_x,p4_y]],...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            det_boxes = aicube.ocr_post_process(results[0][:,:,:,0].reshape(-1), hwc_array.reshape(-1),self.model_input_size,self.rgb888p_size, self.mask_threshold, self.box_threshold)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return det_boxes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算padding参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_padding_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 右padding或下padding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_width = self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_high = self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / input_width</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / input_high</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = (int)(ratio * input_width)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = (int)(ratio * input_high)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = (int)(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = (int)(round(dh * 2 + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = (int)(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = (int)(round(dw * 2 - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return  top, bottom, left, right</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # chw2hwc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def chw2hwc(self,features):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ori_shape = (features.shape[0], features.shape[1], features.shape[2])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c_hw_ = features.reshape((ori_shape[0], ori_shape[1] * ori_shape[2]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hw_c_ = c_hw_.transpose()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_array = hw_c_.copy()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hwc_array = new_array.reshape((ori_shape[1], ori_shape[2], ori_shape[0]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        del c_hw_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        del hw_c_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        del new_array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return hwc_array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义OCR识别任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class OCRRecognitionApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,dict_path,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 识别模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.dict_path=dict_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.dict_word=None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 读取OCR的字典</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.read_dict()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.RGB_packed,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None,input_np=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            top,bottom,left,right=self.get_padding_param(ai2d_input_size,self.model_input_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad([0,0,0,0,top,bottom,left,right], 0, [0,0,0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 如果传入input_np，输入shape为input_np的shape,如果不传入，输入shape为[1,3,ai2d_input_size[1],ai2d_input_size[0]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([input_np.shape[0],input_np.shape[1],input_np.shape[2],input_np.shape[3]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出的array列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preds = np.argmax(results[0], axis=2).reshape((-1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            output_txt = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for i in range(len(preds)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 当前识别字符不是字典的最后一个字符并且和前一个字符不重复（去重），加入识别结果字符串</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if preds[i] != (len(self.dict_word) - 1) and (not (i &gt; 0 and preds[i - 1] == preds[i])):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    output_txt = output_txt + self.dict_word[preds[i]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return output_txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算padding参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_padding_param(self,src_size,dst_size):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 右padding或下padding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = dst_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = dst_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_width = src_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_high = src_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / input_width</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / input_high</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = (int)(ratio * input_width)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = (int)(ratio * input_high)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = (int)(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = (int)(round(dh * 2 + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = (int)(round(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = (int)(round(dw * 2 - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return  top, bottom, left, right</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def read_dict(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if self.dict_path!=&quot;&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with open(dict_path, &#x27;r&#x27;) as file:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                line_one = file.read(100000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                line_list = line_one.split(&quot;\r\n&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.dict_word = {num: char.replace(&quot;\r&quot;, &quot;&quot;).replace(&quot;\n&quot;, &quot;&quot;) for num, char in enumerate(line_list)}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class OCRDetRec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,ocr_det_kmodel,ocr_rec_kmodel,det_input_size,rec_input_size,dict_path,mask_threshold=0.25,box_threshold=0.3,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # OCR检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ocr_det_kmodel=ocr_det_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # OCR识别模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ocr_rec_kmodel=ocr_rec_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # OCR检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.det_input_size=det_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # OCR识别模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rec_input_size=rec_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 字典路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.dict_path=dict_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.mask_threshold=mask_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.box_threshold=box_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug_mode模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ocr_det=OCRDetectionApp(self.ocr_det_kmodel,model_input_size=self.det_input_size,mask_threshold=self.mask_threshold,box_threshold=self.box_threshold,rgb888p_size=self.rgb888p_size,display_size=self.display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ocr_rec=OCRRecognitionApp(self.ocr_rec_kmodel,model_input_size=self.rec_input_size,dict_path=self.dict_path,rgb888p_size=self.rgb888p_size,display_size=self.display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ocr_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # run函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 先进行OCR检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        det_res=self.ocr_det.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boxes=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ocr_res=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for det in det_res:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 对得到的每个检测框执行OCR识别</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ocr_rec.config_preprocess(input_image_size=[det[0].shape[2],det[0].shape[1]],input_np=det[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ocr_str=self.ocr_rec.run(det[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ocr_res.append(ocr_str)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boxes.append(det[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return boxes,ocr_res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制OCR检测识别效果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,det_res,rec_res):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if det_res:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 循环绘制所有检测到的框</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for j in range(len(det_res)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 将原图的坐标点转换成显示的坐标点，循环绘制四条直线，得到一个矩形框</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for i in range(4):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x1 = det_res[j][(i * 2)] / self.rgb888p_size[0] * self.display_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    y1 = det_res[j][(i * 2 + 1)] / self.rgb888p_size[1] * self.display_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x2 = det_res[j][((i + 1) * 2) % 8] / self.rgb888p_size[0] * self.display_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    y2 = det_res[j][((i + 1) * 2 + 1) % 8] / self.rgb888p_size[1] * self.display_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_line((int(x1), int(y1), int(x2), int(y2)), color=(255, 0, 0, 255),thickness=5)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.draw_string_advanced(int(x1),int(y1),32,rec_res[j],color=(0,0,255))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # OCR检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ocr_det_kmodel_path=&quot;/sdcard/app/tests/kmodel/ocr_det_int16.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # OCR识别模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ocr_rec_kmodel_path=&quot;/sdcard/app/tests/kmodel/ocr_rec_int16.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其他参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dict_path=&quot;/sdcard/app/tests/utils/dict.txt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[640,360]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ocr_det_input_size=[640,640]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ocr_rec_input_size=[512,32]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mask_threshold=0.25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    box_threshold=0.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，只关注传给AI的图像分辨率，显示的分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ocr=OCRDetRec(ocr_det_kmodel_path,ocr_rec_kmodel_path,det_input_size=ocr_det_input_size,rec_input_size=ocr_rec_input_size,dict_path=dict_path,mask_threshold=mask_threshold,box_threshold=box_threshold,rgb888p_size=rgb888p_size,display_size=display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()                  # 获取当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                det_res,rec_res=ocr.run(img)        # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ocr.draw_result(pl,det_res,rec_res) # 绘制当前帧推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                     # 展示当前帧推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ocr.ocr_det.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ocr.ocr_rec.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="223-人体检测">2.23. 人体检测<a href="#223-人体检测" class="hash-link" aria-label="Direct link to 2.23. 人体检测" title="Direct link to 2.23. 人体检测">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import utime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aicube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义人体检测类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class PersonDetectionApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,labels,anchors,confidence_threshold=0.2,nms_threshold=0.5,nms_option=False,strides=[8,16,32],rgb888p_size=[224,224],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.labels=labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测anchors设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 特征图降采样倍数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.strides=strides</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_option=nms_option</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 显示分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ai2d实例，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作  ，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，您可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            top,bottom,left,right=self.get_padding_param()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad([0,0,0,0,top,bottom,left,right], 0, [0,0,0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 这里使用了aicube模型的后处理接口anchorbasedet_post_preocess</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dets = aicube.anchorbasedet_post_process(results[0], results[1], results[2], self.model_input_size, self.rgb888p_size, self.strides, len(self.labels), self.confidence_threshold, self.nms_threshold, self.anchors, self.nms_option)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return dets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,dets):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;display_draw&quot;,self.debug_mode &gt;0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if dets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for det_box in dets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x1, y1, x2, y2 = det_box[2],det_box[3],det_box[4],det_box[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    w = float(x2 - x1) * self.display_size[0] // self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    h = float(y2 - y1) * self.display_size[1] // self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x1 = int(x1 * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    y1 = int(y1 * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x2 = int(x2 * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    y2 = int(y2 * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (h&lt;(0.1*self.display_size[0])):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (w&lt;(0.25*self.display_size[0]) and ((x1&lt;(0.03*self.display_size[0])) or (x2&gt;(0.97*self.display_size[0])))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (w&lt;(0.15*self.display_size[0]) and ((x1&lt;(0.01*self.display_size[0])) or (x2&gt;(0.99*self.display_size[0])))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_rectangle(x1 , y1 , int(w) , int(h), color=(255, 0, 255, 0), thickness = 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_string_advanced( x1 , y1-50,32, &quot; &quot; + self.labels[det_box[0]] + &quot; &quot; + str(round(det_box[1],2)), color=(255,0, 255, 0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算padding参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_padding_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_width = self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_high = self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / input_width</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / input_high</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = (int)(ratio * input_width)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = (int)(ratio * input_high)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = int(round(dh - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = int(round(dh + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = int(round(dw - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = int(round(dw - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return  top, bottom, left, right</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_path=&quot;/sdcard/app/tests/kmodel/person_detect_yolov5n.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其它参数设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold = 0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold = 0.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels = [&quot;person&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = [10, 13, 16, 30, 33, 23, 30, 61, 62, 45, 59, 119, 116, 90, 156, 198, 373, 326]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化自定义人体检测实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    person_det=PersonDetectionApp(kmodel_path,model_input_size=[640,640],labels=labels,anchors=anchors,confidence_threshold=confidence_threshold,nms_threshold=nms_threshold,nms_option=False,strides=[8,16,32],rgb888p_size=rgb888p_size,display_size=display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    person_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 获取当前帧数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                res=person_det.run(img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 绘制结果到PipeLine的osd图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                person_det.draw_result(pl,res)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 显示当前的绘制结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        person_det.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="224-人体关键点检测">2.24. 人体关键点检测<a href="#224-人体关键点检测" class="hash-link" aria-label="Direct link to 2.24. 人体关键点检测" title="Direct link to 2.24. 人体关键点检测">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import utime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aidemo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义人体关键点检测类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class PersonKeyPointApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,confidence_threshold=0.2,nms_threshold=0.5,rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 显示分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #骨骼信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.SKELETON = [(16, 14),(14, 12),(17, 15),(15, 13),(12, 13),(6,  12),(7,  13),(6,  7),(6,  8),(7,  9),(8,  10),(9,  11),(2,  3),(1,  2),(1,  3),(2,  4),(3,  5),(4,  6),(5,  7)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #肢体颜色</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.LIMB_COLORS = [(255, 51,  153, 255),(255, 51,  153, 255),(255, 51,  153, 255),(255, 51,  153, 255),(255, 255, 51,  255),(255, 255, 51,  255),(255, 255, 51,  255),(255, 255, 128, 0),(255, 255, 128, 0),(255, 255, 128, 0),(255, 255, 128, 0),(255, 255, 128, 0),(255, 0,   255, 0),(255, 0,   255, 0),(255, 0,   255, 0),(255, 0,   255, 0),(255, 0,   255, 0),(255, 0,   255, 0),(255, 0,   255, 0)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #关键点颜色，共17个</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.KPS_COLORS = [(255, 0,   255, 0),(255, 0,   255, 0),(255, 0,   255, 0),(255, 0,   255, 0),(255, 0,   255, 0),(255, 255, 128, 0),(255, 255, 128, 0),(255, 255, 128, 0),(255, 255, 128, 0),(255, 255, 128, 0),(255, 255, 128, 0),(255, 51,  153, 255),(255, 51,  153, 255),(255, 51,  153, 255),(255, 51,  153, 255),(255, 51,  153, 255),(255, 51,  153, 255)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ai2d实例，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，您可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            top,bottom,left,right=self.get_padding_param()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad([0,0,0,0,top,bottom,left,right], 0, [0,0,0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 这里使用了aidemo库的person_kp_postprocess接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results = aidemo.person_kp_postprocess(results[0],[self.rgb888p_size[1],self.rgb888p_size[0]],self.model_input_size,self.confidence_threshold,self.nms_threshold)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return results</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #绘制结果，绘制人体关键点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,res):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;display_draw&quot;,self.debug_mode &gt;0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if res[0]:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                kpses = res[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for i in range(len(res[0])):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    for k in range(17+2):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (k &lt; 17):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            kps_x,kps_y,kps_s = round(kpses[i][k][0]),round(kpses[i][k][1]),kpses[i][k][2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            kps_x1 = int(float(kps_x) * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            kps_y1 = int(float(kps_y) * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if (kps_s &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                pl.osd_img.draw_circle(kps_x1,kps_y1,5,self.KPS_COLORS[k],4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ske = self.SKELETON[k]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pos1_x,pos1_y= round(kpses[i][ske[0]-1][0]),round(kpses[i][ske[0]-1][1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pos1_x_ = int(float(pos1_x) * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pos1_y_ = int(float(pos1_y) * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pos2_x,pos2_y = round(kpses[i][(ske[1] -1)][0]),round(kpses[i][(ske[1] -1)][1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pos2_x_ = int(float(pos2_x) * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pos2_y_ = int(float(pos2_y) * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pos1_s,pos2_s = kpses[i][(ske[0] -1)][2],kpses[i][(ske[1] -1)][2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (pos1_s &gt; 0.0 and pos2_s &gt;0.0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            pl.osd_img.draw_line(pos1_x_,pos1_y_,pos2_x_,pos2_y_,self.LIMB_COLORS[k],4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算padding参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_padding_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_width = self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_high = self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / input_width</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / input_high</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = (int)(ratio * input_width)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = (int)(ratio * input_high)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = int(round(dh - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = int(round(dh + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = int(round(dw - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = int(round(dw - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return  top, bottom, left, right</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_path=&quot;/sdcard/app/tests/kmodel/yolov8n-pose.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其它参数设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold = 0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold = 0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化自定义人体关键点检测实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    person_kp=PersonKeyPointApp(kmodel_path,model_input_size=[320,320],confidence_threshold=confidence_threshold,nms_threshold=nms_threshold,rgb888p_size=rgb888p_size,display_size=display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    person_kp.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 获取当前帧数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                res=person_kp.run(img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 绘制结果到PipeLine的osd图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                person_kp.draw_result(pl,res)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 显示当前的绘制结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        person_kp.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="225-拼图游戏">2.25. 拼图游戏<a href="#225-拼图游戏" class="hash-link" aria-label="Direct link to 2.25. 拼图游戏" title="Direct link to 2.25. 拼图游戏">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aicube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义手掌检测任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class HandDetApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,labels,model_input_size,anchors,confidence_threshold=0.2,nms_threshold=0.5,nms_option=False, strides=[8,16,32],rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.labels=labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.strides = strides  # 特征下采样倍数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_option = nms_option  # NMS选项，如果为True做类间NMS,如果为False做类内NMS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size = input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算padding参数并应用pad操作，以确保输入图像尺寸与模型输入尺寸匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            top, bottom, left, right = self.get_padding_param()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad([0, 0, 0, 0, top, bottom, left, right], 0, [114, 114, 114])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 使用双线性插值进行resize操作，调整图像尺寸以符合模型输入要求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型的输出array列表，这里使用了aicube库的anchorbasedet_post_process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dets = aicube.anchorbasedet_post_process(results[0], results[1], results[2], self.model_input_size, self.rgb888p_size, self.strides, len(self.labels), self.confidence_threshold, self.nms_threshold, self.anchors, self.nms_option)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 返回手掌检测结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return dets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算padding参数，确保输入图像尺寸与模型输入尺寸匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_padding_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 根据目标宽度和高度计算比例因子</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_width = self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_high = self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / input_width</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / input_high</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 选择较小的比例因子，以确保图像内容完整</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算新的宽度和高度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = int(ratio * input_width)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = int(ratio * input_high)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算宽度和高度的差值，并确定padding的位置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = int(round(dh - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = int(round(dh + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = int(round(dw - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = int(round(dw + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return top, bottom, left, right</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义手势关键点分类任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class HandKPClassApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_params=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了crop和resize，Ai2d支持crop/shift/pad/resize/affine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,det,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.crop_params = self.get_crop_param(det)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.crop(self.crop_params[0],self.crop_params[1],self.crop_params[2],self.crop_params[3])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型的输出array列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results=results[0].reshape(results[0].shape[0]*results[0].shape[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show = np.zeros(results.shape,dtype=np.int16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show[0::2] = (results[0::2] * self.crop_params[3] + self.crop_params[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show[1::2] = (results[1::2] * self.crop_params[2] + self.crop_params[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return results_show</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算crop参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_crop_param(self,det_box):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1, y1, x2, y2 = det_box[2],det_box[3],det_box[4],det_box[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        w,h= int(x2 - x1),int(y2 - y1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        w_det = int(float(x2 - x1) * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h_det = int(float(y2 - y1) * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x_det = int(x1*self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y_det = int(y1*self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        length = max(w, h)/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cx = (x1+x2)/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cy = (y1+y2)/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_num = 1.26*length</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1_kp = int(max(0,cx-ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y1_kp = int(max(0,cy-ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x2_kp = int(min(self.rgb888p_size[0]-1, cx+ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y2_kp = int(min(self.rgb888p_size[1]-1, cy+ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        w_kp = int(x2_kp - x1_kp + 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h_kp = int(y2_kp - y1_kp + 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [x1_kp, y1_kp, w_kp, h_kp]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 拼图游戏任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class PuzzleGame:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,hand_det_kmodel,hand_kp_kmodel,det_input_size,kp_input_size,labels,anchors,confidence_threshold=0.25,nms_threshold=0.3,nms_option=False,strides=[8,16,32],rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_det_kmodel=hand_det_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌关键点模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_kp_kmodel=hand_kp_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.det_input_size=det_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌关键点模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kp_input_size=kp_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.labels=labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_option=nms_option</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.strides=strides</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug_mode模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.level = 3                                                              # 游戏级别 目前只支持设置为 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.puzzle_width = self.display_size[1]                                    # 设定 拼图宽</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.puzzle_height = self.display_size[1]                                   # 设定 拼图高</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.puzzle_ori_width = self.display_size[0] - self.puzzle_width - 50       # 设定 原始拼图宽</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.puzzle_ori_height = self.display_size[0] - self.puzzle_height - 50     # 设定 原始拼图高</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.every_block_width = int(self.puzzle_width/self.level)                  # 设定 拼图块宽</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.every_block_height = int(self.puzzle_height/self.level)                # 设定 拼图块高</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ori_every_block_width = int(self.puzzle_ori_width/self.level)          # 设定 原始拼图宽</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ori_every_block_height = int(self.puzzle_ori_height/self.level)        # 设定 原始拼图高</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ratio_num = self.every_block_width/360.0                               # 字体比例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.blank_x = 0                                                            # 空白块 角点x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.blank_y = 0                                                            # 空白块 角点y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.direction_vec = [-1,1,-1,1]                                            # 空白块四种移动方向</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.exact_division_x = 0                                                   # 交换块 角点x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.exact_division_y = 0                                                   # 交换块 角点y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.distance_tow_points = self.display_size[0]                             # 两手指距离</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.distance_thred = self.every_block_width*0.4                            # 两手指距离阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.osd_frame_tmp = np.zeros((self.display_size[1],self.display_size[0],4),dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.osd_frame_tmp_img = image.Image(self.display_size[0], self.display_size[1], image.ARGB8888,alloc=image.ALLOC_REF,data=self.osd_frame_tmp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.move_mat = np.zeros((self.every_block_height,self.every_block_width,4),dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.init_osd_frame()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_det=HandDetApp(self.hand_det_kmodel,self.labels,model_input_size=self.det_input_size,anchors=self.anchors,confidence_threshold=self.confidence_threshold,nms_threshold=self.nms_threshold,nms_option=self.nms_option,strides=self.strides,rgb888p_size=self.rgb888p_size,display_size=self.display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_kp=HandKPClassApp(self.hand_kp_kmodel,model_input_size=self.kp_input_size,rgb888p_size=self.rgb888p_size,display_size=self.display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化拼图界面，绘制两个3*3的拼图</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def init_osd_frame(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.osd_frame_tmp[0:self.puzzle_height,0:self.puzzle_width,3] = 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.osd_frame_tmp[0:self.puzzle_height,0:self.puzzle_width,2] = 150</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.osd_frame_tmp[0:self.puzzle_height,0:self.puzzle_width,1] = 130</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.osd_frame_tmp[0:self.puzzle_height,0:self.puzzle_width,0] = 127</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.osd_frame_tmp[(self.display_size[1]-self.puzzle_ori_height)//2:(self.display_size[1]-self.puzzle_ori_height)//2+self.puzzle_ori_width,self.puzzle_width+25:self.puzzle_width+25+self.puzzle_ori_height,3] = 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.osd_frame_tmp[(self.display_size[1]-self.puzzle_ori_height)//2:(self.display_size[1]-self.puzzle_ori_height)//2+self.puzzle_ori_width,self.puzzle_width+25:self.puzzle_width+25+self.puzzle_ori_height,2] = 150</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.osd_frame_tmp[(self.display_size[1]-self.puzzle_ori_height)//2:(self.display_size[1]-self.puzzle_ori_height)//2+self.puzzle_ori_width,self.puzzle_width+25:self.puzzle_width+25+self.puzzle_ori_height,1] = 130</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.osd_frame_tmp[(self.display_size[1]-self.puzzle_ori_height)//2:(self.display_size[1]-self.puzzle_ori_height)//2+self.puzzle_ori_width,self.puzzle_width+25:self.puzzle_width+25+self.puzzle_ori_height,0] = 127</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for i in range(self.level*self.level):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.osd_frame_tmp_img.draw_rectangle((i%self.level)*self.every_block_width,(i//self.level)*self.every_block_height,self.every_block_width,self.every_block_height,(255,0,0,0),5)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.osd_frame_tmp_img.draw_string_advanced((i%self.level)*self.every_block_width + 55,(i//self.level)*self.every_block_height + 45,int(60*self.ratio_num),str(i),color=(255,0,0,255))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.osd_frame_tmp_img.draw_rectangle(self.puzzle_width+25 + (i%self.level)*self.ori_every_block_width,(self.display_size[1]-self.puzzle_ori_height)//2 + (i//self.level)*self.ori_every_block_height,self.ori_every_block_width,self.ori_every_block_height,(255,0,0,0),5)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.osd_frame_tmp_img.draw_string_advanced(self.puzzle_width+25 + (i%self.level)*self.ori_every_block_width + 50,(self.display_size[1]-self.puzzle_ori_height)//2 + (i//self.level)*self.ori_every_block_height + 25,int(50*self.ratio_num),str(i),color=(255,0,0,255))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.osd_frame_tmp[0:self.every_block_height,0:self.every_block_width,3] = 114</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.osd_frame_tmp[0:self.every_block_height,0:self.every_block_width,2] = 114</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.osd_frame_tmp[0:self.every_block_height,0:self.every_block_width,1] = 114</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.osd_frame_tmp[0:self.every_block_height,0:self.every_block_width,0] = 220</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.osd_frame_tmp[(self.display_size[1]-self.puzzle_ori_height)//2:(self.display_size[1]-self.puzzle_ori_height)//2+self.ori_every_block_width,self.puzzle_width+25:self.puzzle_width+25+self.ori_every_block_height,3] = 114</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.osd_frame_tmp[(self.display_size[1]-self.puzzle_ori_height)//2:(self.display_size[1]-self.puzzle_ori_height)//2+self.ori_every_block_width,self.puzzle_width+25:self.puzzle_width+25+self.ori_every_block_height,2] = 114</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.osd_frame_tmp[(self.display_size[1]-self.puzzle_ori_height)//2:(self.display_size[1]-self.puzzle_ori_height)//2+self.ori_every_block_width,self.puzzle_width+25:self.puzzle_width+25+self.ori_every_block_height,1] = 114</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.osd_frame_tmp[(self.display_size[1]-self.puzzle_ori_height)//2:(self.display_size[1]-self.puzzle_ori_height)//2+self.ori_every_block_width,self.puzzle_width+25:self.puzzle_width+25+self.ori_every_block_height,0] = 220</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for i in range(self.level*10):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            k230_random = int(random.random() * 100) % 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            blank_x_tmp = self.blank_x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            blank_y_tmp = self.blank_y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (k230_random &lt; 2):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                blank_x_tmp = self.blank_x + self.direction_vec[k230_random]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                blank_y_tmp = self.blank_y + self.direction_vec[k230_random]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ((blank_x_tmp &gt;= 0 and blank_x_tmp &lt; self.level) and (blank_y_tmp &gt;= 0 and blank_y_tmp &lt; self.level) and (abs(self.blank_x - blank_x_tmp) &lt;= 1 and abs(self.blank_y - blank_y_tmp) &lt;= 1)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                move_rect = [blank_x_tmp*self.every_block_width,blank_y_tmp*self.every_block_height,self.every_block_width,self.every_block_height]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                blank_rect = [self.blank_x*self.every_block_width,self.blank_y*self.every_block_height,self.every_block_width,self.every_block_height]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.move_mat[:] = self.osd_frame_tmp[move_rect[1]:move_rect[1]+move_rect[3],move_rect[0]:move_rect[0]+move_rect[2],:]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.osd_frame_tmp[move_rect[1]:move_rect[1]+move_rect[3],move_rect[0]:move_rect[0]+move_rect[2],:] = self.osd_frame_tmp[blank_rect[1]:blank_rect[1]+blank_rect[3],blank_rect[0]:blank_rect[0]+blank_rect[2],:]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.osd_frame_tmp[blank_rect[1]:blank_rect[1]+blank_rect[3],blank_rect[0]:blank_rect[0]+blank_rect[2],:] = self.move_mat[:]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.blank_x = blank_x_tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.blank_y = blank_y_tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # run函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 先进行手掌检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        det_boxes=self.hand_det.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        det_res=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        two_point = np.zeros((4),dtype=np.int16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 对于每一个检测到的手掌做筛选</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for det_box in det_boxes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            x1, y1, x2, y2 = det_box[2],det_box[3],det_box[4],det_box[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            w,h= int(x2 - x1),int(y2 - y1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (h&lt;(0.1*self.rgb888p_size[1])):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (w&lt;(0.25*self.rgb888p_size[0]) and ((x1&lt;(0.03*self.rgb888p_size[0])) or (x2&gt;(0.97*self.rgb888p_size[0])))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (w&lt;(0.15*self.rgb888p_size[0]) and ((x1&lt;(0.01*self.rgb888p_size[0])) or (x2&gt;(0.99*self.rgb888p_size[0])))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            det_res.append(det_box)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if len(det_res)!=0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 对第一个手掌做手掌关键点检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            det_box=det_res[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.hand_kp.config_preprocess(det_box)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show=self.hand_kp.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            two_point[0],two_point[1],two_point[2],two_point[3] = results_show[8],results_show[9],results_show[16+8],results_show[16+9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return det_res,two_point</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制效果，手指拇指和中指位置判断拼图移动位置，并与周边空白位置做交换</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,det_res,two_point):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if len(det_res)==1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (two_point[1] &lt;= self.rgb888p_size[0]):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.distance_tow_points = np.sqrt(pow((two_point[0]-two_point[2]),2) + pow((two_point[1] - two_point[3]),2))* 1.0 / self.rgb888p_size[0] * self.display_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.exact_division_x = int((two_point[0] * 1.0 / self.rgb888p_size[0] * self.display_size[0])//self.every_block_width)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.exact_division_y = int((two_point[1] * 1.0 / self.rgb888p_size[1] * self.display_size[1])//self.every_block_height)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (self.distance_tow_points &lt; self.distance_thred and self.exact_division_x &gt;= 0 and self.exact_division_x &lt; self.level and self.exact_division_y &gt;= 0 and self.exact_division_y &lt; self.level):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (abs(self.blank_x - self.exact_division_x) == 1 and abs(self.blank_y - self.exact_division_y) == 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        move_rect = [self.exact_division_x*self.every_block_width,self.exact_division_y*self.every_block_height,self.every_block_width,self.every_block_height]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        blank_rect = [self.blank_x*self.every_block_width,self.blank_y*self.every_block_height,self.every_block_width,self.every_block_height]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.move_mat[:] = self.osd_frame_tmp[move_rect[1]:move_rect[1]+move_rect[3],move_rect[0]:move_rect[0]+move_rect[2],:]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.osd_frame_tmp[move_rect[1]:move_rect[1]+move_rect[3],move_rect[0]:move_rect[0]+move_rect[2],:] = self.osd_frame_tmp[blank_rect[1]:blank_rect[1]+blank_rect[3],blank_rect[0]:blank_rect[0]+blank_rect[2],:]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.osd_frame_tmp[blank_rect[1]:blank_rect[1]+blank_rect[3],blank_rect[0]:blank_rect[0]+blank_rect[2],:] = self.move_mat[:]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.blank_x = self.exact_division_x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    elif (abs(self.blank_y - self.exact_division_y) == 1 and abs(self.blank_x - self.exact_division_x) == 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        move_rect = [self.exact_division_x*self.every_block_width,self.exact_division_y*self.every_block_height,self.every_block_width,self.every_block_height]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        blank_rect = [self.blank_x*self.every_block_width,self.blank_y*self.every_block_height,self.every_block_width,self.every_block_height]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.move_mat[:] = self.osd_frame_tmp[move_rect[1]:move_rect[1]+move_rect[3],move_rect[0]:move_rect[0]+move_rect[2],:]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.osd_frame_tmp[move_rect[1]:move_rect[1]+move_rect[3],move_rect[0]:move_rect[0]+move_rect[2],:] = self.osd_frame_tmp[blank_rect[1]:blank_rect[1]+blank_rect[3],blank_rect[0]:blank_rect[0]+blank_rect[2],:]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.osd_frame_tmp[blank_rect[1]:blank_rect[1]+blank_rect[3],blank_rect[0]:blank_rect[0]+blank_rect[2],:] = self.move_mat[:]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        self.blank_y = self.exact_division_y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.copy_from(self.osd_frame_tmp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x1 = int(two_point[0] * 1.0 * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    y1 = int(two_point[1] * 1.0 * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_circle(x1, y1, 1, color=(255, 0, 255, 255),thickness=4,fill=False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.copy_from(self.osd_frame_tmp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x1 = int(two_point[0] * 1.0 * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    y1 = int(two_point[1] * 1.0 * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_circle(x1, y1, 1, color=(255, 255, 255, 0),thickness=4,fill=False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pl.osd_img.copy_from(self.osd_frame_tmp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pl.osd_img.draw_string_advanced((self.display_size[0]//2),(self.display_size[1]//2),32,&quot;请保证一只手入镜!&quot;,color=(255,0,0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 手掌检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_det_kmodel_path=&quot;/sdcard/app/tests/kmodel/hand_det.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 手掌关键点模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_kp_kmodel_path=&quot;/sdcard/app/tests/kmodel/handkp_det.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其他参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors_path=&quot;/sdcard/app/tests/utils/prior_data_320.bin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_det_input_size=[512,512]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_kp_input_size=[256,256]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold=0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold=0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels=[&quot;hand&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = [26,27, 53,52, 75,71, 80,99, 106,82, 99,134, 140,113, 161,172, 245,276]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，只关注传给AI的图像分辨率，显示的分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg=PuzzleGame(hand_det_kmodel_path,hand_kp_kmodel_path,det_input_size=hand_det_input_size,kp_input_size=hand_kp_input_size,labels=labels,anchors=anchors,confidence_threshold=confidence_threshold,nms_threshold=nms_threshold,nms_option=False,strides=[8,16,32],rgb888p_size=rgb888p_size,display_size=display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()                      # 获取当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                det_res,two_point=pg.run(img)           # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pg.draw_result(pl,det_res,two_point)    # 绘制当前帧推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()                         # 展示推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pg.hand_det.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pg.hand_kp.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="226-yolov8分割">2.26. yolov8分割<a href="#226-yolov8分割" class="hash-link" aria-label="Direct link to 2.26. yolov8分割" title="Direct link to 2.26. yolov8分割">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import utime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aidemo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义YOLOv8分割类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class SegmentationApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,labels,model_input_size,confidence_threshold=0.2,nms_threshold=0.5,mask_threshold=0.5,rgb888p_size=[224,224],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 分割类别标签</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.labels=labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # mask阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.mask_threshold=mask_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 显示分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测框预置颜色值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.color_four=[(255, 220, 20, 60), (255, 119, 11, 32), (255, 0, 0, 142), (255, 0, 0, 230),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         (255, 106, 0, 228), (255, 0, 60, 100), (255, 0, 80, 100), (255, 0, 0, 70),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         (255, 0, 0, 192), (255, 250, 170, 30), (255, 100, 170, 30), (255, 220, 220, 0),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         (255, 175, 116, 175), (255, 250, 0, 30), (255, 165, 42, 42), (255, 255, 77, 255),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         (255, 0, 226, 252), (255, 182, 182, 255), (255, 0, 82, 0), (255, 120, 166, 157)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 分割结果的numpy.array，用于给到aidemo后处理接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.masks=np.zeros((1,self.display_size[1],self.display_size[0],4))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ai2d实例，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了pad和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，您可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            top,bottom,left,right=self.get_padding_param()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad([0,0,0,0,top,bottom,left,right], 0, [114,114,114])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 这里使用了aidemo的segment_postprocess接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            seg_res = aidemo.segment_postprocess(results,[self.rgb888p_size[1],self.rgb888p_size[0]],self.model_input_size,[self.display_size[1],self.display_size[0]],self.confidence_threshold,self.nms_threshold,self.mask_threshold,self.masks)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return seg_res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,seg_res):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;display_draw&quot;,self.debug_mode &gt;0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if seg_res[0]:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                mask_img=image.Image(self.display_size[0], self.display_size[1], image.ARGB8888,alloc=image.ALLOC_REF,data=self.masks)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.copy_from(mask_img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                dets,ids,scores = seg_res[0],seg_res[1],seg_res[2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for i, det in enumerate(dets):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    x1, y1, w, h = map(lambda x: int(round(x, 0)), det)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_string_advanced(x1,y1-50,32, &quot; &quot; + self.labels[int(ids[i])] + &quot; &quot; + str(round(scores[i],2)) , color=self.get_color(int(ids[i])))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算padding参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_padding_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = float(dst_w) / self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = float(dst_h) / self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = (int)(ratio * self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = (int)(ratio * self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = (int)(round(dh - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = (int)(round(dh + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = (int)(round(dw - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = (int)(round(dw + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return  top, bottom, left, right</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 根据当前类别索引获取框的颜色</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_color(self, x):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        idx=x%len(self.color_four)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return self.color_four[idx]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_path=&quot;/sdcard/app/tests/kmodel/yolov8n_seg_320.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels = [&quot;person&quot;, &quot;bicycle&quot;, &quot;car&quot;, &quot;motorcycle&quot;, &quot;airplane&quot;, &quot;bus&quot;, &quot;train&quot;, &quot;truck&quot;, &quot;boat&quot;, &quot;traffic light&quot;, &quot;fire hydrant&quot;, &quot;stop sign&quot;, &quot;parking meter&quot;, &quot;bench&quot;, &quot;bird&quot;, &quot;cat&quot;, &quot;dog&quot;, &quot;horse&quot;, &quot;sheep&quot;, &quot;cow&quot;, &quot;elephant&quot;, &quot;bear&quot;, &quot;zebra&quot;, &quot;giraffe&quot;, &quot;backpack&quot;, &quot;umbrella&quot;, &quot;handbag&quot;, &quot;tie&quot;, &quot;suitcase&quot;, &quot;frisbee&quot;, &quot;skis&quot;, &quot;snowboard&quot;, &quot;sports ball&quot;, &quot;kite&quot;, &quot;baseball bat&quot;, &quot;baseball glove&quot;, &quot;skateboard&quot;, &quot;surfboard&quot;, &quot;tennis racket&quot;, &quot;bottle&quot;, &quot;wine glass&quot;, &quot;cup&quot;, &quot;fork&quot;, &quot;knife&quot;, &quot;spoon&quot;, &quot;bowl&quot;, &quot;banana&quot;, &quot;apple&quot;, &quot;sandwich&quot;, &quot;orange&quot;, &quot;broccoli&quot;, &quot;carrot&quot;, &quot;hot dog&quot;, &quot;pizza&quot;, &quot;donut&quot;, &quot;cake&quot;, &quot;chair&quot;, &quot;couch&quot;, &quot;potted plant&quot;, &quot;bed&quot;, &quot;dining table&quot;, &quot;toilet&quot;, &quot;tv&quot;, &quot;laptop&quot;, &quot;mouse&quot;, &quot;remote&quot;, &quot;keyboard&quot;, &quot;cell phone&quot;, &quot;microwave&quot;, &quot;oven&quot;, &quot;toaster&quot;, &quot;sink&quot;, &quot;refrigerator&quot;, &quot;book&quot;, &quot;clock&quot;, &quot;vase&quot;, &quot;scissors&quot;, &quot;teddy bear&quot;, &quot;hair drier&quot;, &quot;toothbrush&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #其它参数设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold = 0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold = 0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mask_threshold=0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[320,320]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化自定义YOLOV8分割示例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    seg=SegmentationApp(kmodel_path,labels=labels,model_input_size=[320,320],confidence_threshold=confidence_threshold,nms_threshold=nms_threshold,mask_threshold=mask_threshold,rgb888p_size=rgb888p_size,display_size=display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    seg.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 获取当前帧数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                seg_res=seg.run(img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 绘制结果到PipeLine的osd图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                seg.draw_result(pl,seg_res)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 显示当前的绘制结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        seg.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="227-自学习">2.27. 自学习<a href="#227-自学习" class="hash-link" aria-label="Direct link to 2.27. 自学习" title="Direct link to 2.27. 自学习">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import utime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aicube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义自学习类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class SelfLearningApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,labels,top_k,threshold,database_path,rgb888p_size=[224,224],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.labels=labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.database_path=database_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 显示分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 识别阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.threshold = threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 选择top_k个相似度大于阈值的结果类别</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.top_k = top_k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #对应类别注册特征数量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.features=[2,2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #注册单个特征中途间隔帧数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.time_one=60</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.time_all = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.time_now = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 类别索引</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.category_index = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 特征化部分剪切宽高</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_w = 400</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_h = 400</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # crop的位置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_x = self.rgb888p_size[0] / 2.0 - self.crop_w / 2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_y = self.rgb888p_size[1] / 2.0 - self.crop_h / 2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_x_osd=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_y_osd=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_w_osd=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_h_osd=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Ai2d实例，用于实现模型预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 设置Ai2d的输入输出格式和类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.data_init()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了crop和resize，Ai2d支持crop/shift/pad/resize/affine，具体代码请打开/sdcard/app/libs/AI2D.py查看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，您可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.crop(int(self.crop_x),int(self.crop_y),int(self.crop_w),int(self.crop_h))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return results[0][0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制结果，绘制特征采集框和特征分类框</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,feature):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;display_draw&quot;,self.debug_mode &gt;0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pl.osd_img.draw_rectangle(self.crop_x_osd,self.crop_y_osd, self.crop_w_osd, self.crop_h_osd, color=(255, 255, 0, 255), thickness = 4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (self.category_index &lt; len(self.labels)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.time_now += 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.osd_img.draw_string_advanced(50, self.crop_y_osd-50, 30,&quot;请将待添加类别放入框内进行特征采集：&quot;+self.labels[self.category_index] + &quot;_&quot; + str(int(self.time_now-1) // self.time_one) + &quot;.bin&quot;, color=(255,255,0,0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                with open(self.database_path + self.labels[self.category_index] + &quot;_&quot; + str(int(self.time_now-1) // self.time_one) + &quot;.bin&quot;, &#x27;wb&#x27;) as f:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    f.write(feature.tobytes())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (self.time_now // self.time_one == self.features[self.category_index]):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.category_index += 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.time_all -= self.time_now</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.time_now = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                results_learn = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                list_features = os.listdir(self.database_path)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for feature_name in list_features:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    with open(self.database_path + feature_name, &#x27;rb&#x27;) as f:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        data = f.read()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    save_vec = np.frombuffer(data, dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    score = self.getSimilarity(feature, save_vec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (score &gt; self.threshold):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        res = feature_name.split(&quot;_&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        is_same = False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        for r in results_learn:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if (r[&quot;category&quot;] ==  res[0]):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                if (r[&quot;score&quot;] &lt; score):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    r[&quot;bin_file&quot;] = feature_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    r[&quot;score&quot;] = score</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                is_same = True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (not is_same):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if(len(results_learn) &lt; self.top_k):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                evec = {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                evec[&quot;category&quot;] = res[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                evec[&quot;score&quot;] = score</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                evec[&quot;bin_file&quot;] = feature_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                results_learn.append( evec )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                results_learn = sorted(results_learn, key=lambda x: -x[&quot;score&quot;])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                if( score &lt;= results_learn[self.top_k-1][&quot;score&quot;] ):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    evec = {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    evec[&quot;category&quot;] = res[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    evec[&quot;score&quot;] = score</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    evec[&quot;bin_file&quot;] = feature_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    results_learn.append( evec )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    results_learn = sorted(results_learn, key=lambda x: -x[&quot;score&quot;])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    results_learn.pop()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                draw_y = 200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for r in results_learn:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    pl.osd_img.draw_string_advanced( 50 , draw_y,50,r[&quot;category&quot;] + &quot; : &quot; + str(r[&quot;score&quot;]), color=(255,255,0,0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    draw_y += 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #数据初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def data_init(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        os.mkdir(self.database_path)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_x_osd = int(self.crop_x / self.rgb888p_size[0] * self.display_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_y_osd = int(self.crop_y / self.rgb888p_size[1] * self.display_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_w_osd = int(self.crop_w / self.rgb888p_size[0] * self.display_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_h_osd = int(self.crop_h / self.rgb888p_size[1] * self.display_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for i in range(len(self.labels)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for j in range(self.features[i]):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.time_all += self.time_one</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 获取两个特征向量的相似度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def getSimilarity(self,output_vec,save_vec):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tmp = sum(output_vec * save_vec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mold_out = np.sqrt(sum(output_vec * output_vec))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mold_save = np.sqrt(sum(save_vec * save_vec))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return tmp / (mold_out * mold_save)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_path=&quot;/sdcard/app/tests/kmodel/recognition.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    database_path=&quot;/sdcard/app/tests/utils/features/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 其它参数设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model_input_size=[224,224]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels=[&quot;苹果&quot;,&quot;香蕉&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    top_k=3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    threshold=0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化自学习实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sl=SelfLearningApp(kmodel_path,model_input_size=model_input_size,labels=labels,top_k=top_k,threshold=threshold,database_path=database_path,rgb888p_size=rgb888p_size,display_size=display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sl.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 获取当前帧数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                res=sl.run(img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 绘制结果到PipeLine的osd图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sl.draw_result(pl,res)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 显示当前的绘制结 果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 删除features文件夹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stat_info = os.stat(database_path)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (stat_info[0] &amp; 0x4000):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            list_files = os.listdir(database_path)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for l in list_files:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                os.remove(database_path + l)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        os.rmdir(database_path)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sl.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="228-局部放大器">2.28. 局部放大器<a href="#228-局部放大器" class="hash-link" aria-label="Direct link to 2.28. 局部放大器" title="Direct link to 2.28. 局部放大器">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import PipeLine, ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ujson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aicube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义手掌检测任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class HandDetApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,labels,model_input_size,anchors,confidence_threshold=0.2,nms_threshold=0.5,nms_option=False, strides=[8,16,32],rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.labels=labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.strides = strides  # 特征下采样倍数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_option = nms_option  # NMS选项，如果为True做类间NMS,如果为False做类内NMS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size = input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 计算padding参数并应用pad操作，以确保输入图像尺寸与模型输入尺寸匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            top, bottom, left, right = self.get_padding_param()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.pad([0, 0, 0, 0, top, bottom, left, right], 0, [114, 114, 114])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 使用双线性插值进行resize操作，调整图像尺寸以符合模型输入要求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 构建预处理流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出的array列表，这里使用了aicube库的anchorbasedet_post_process接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dets = aicube.anchorbasedet_post_process(results[0], results[1], results[2], self.model_input_size, self.rgb888p_size, self.strides, len(self.labels), self.confidence_threshold, self.nms_threshold, self.anchors, self.nms_option)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 返回手掌检测结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return dets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算padding参数，确保输入图像尺寸与模型输入尺寸匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_padding_param(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 根据目标宽度和高度计算比例因子</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_w = self.model_input_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dst_h = self.model_input_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_width = self.rgb888p_size[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_high = self.rgb888p_size[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_w = dst_w / input_width</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_h = dst_h / input_high</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 选择较小的比例因子，以确保图像内容完整</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ratio_w &lt; ratio_h:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ratio = ratio_h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算新的宽度和高度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_w = int(ratio * input_width)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_h = int(ratio * input_high)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 计算宽度和高度的差值，并确定padding的位置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dw = (dst_w - new_w) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dh = (dst_h - new_h) / 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top = int(round(dh - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bottom = int(round(dh + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        left = int(round(dw - 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        right = int(round(dw + 0.1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return top, bottom, left, right</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义手势关键点分类任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class HandKPClassApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,kmodel_path,model_input_size,rgb888p_size=[1920,1080],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path,model_input_size,rgb888p_size,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path=kmodel_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.model_input_size=model_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_params=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 配置预处理操作，这里使用了crop和resize，Ai2d支持crop/shift/pad/resize/affine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def config_preprocess(self,det,input_image_size=None):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;set preprocess config&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化ai2d预处理配置，默认为sensor给到AI的尺寸，可以通过设置input_image_size自行修改输入尺寸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ai2d_input_size=input_image_size if input_image_size else self.rgb888p_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.crop_params = self.get_crop_param(det)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.crop(self.crop_params[0],self.crop_params[1],self.crop_params[2],self.crop_params[3])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.ai2d.build([1,3,ai2d_input_size[1],ai2d_input_size[0]],[1,3,self.model_input_size[1],self.model_input_size[0]])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义后处理，results是模型输出的array列表，返回手部关键点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self,results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;postprocess&quot;,self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results=results[0].reshape(results[0].shape[0]*results[0].shape[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show = np.zeros(results.shape,dtype=np.int16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show[0::2] = (results[0::2] * self.crop_params[3] + self.crop_params[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show[1::2] = (results[1::2] * self.crop_params[2] + self.crop_params[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return results_show</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 计算crop参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def get_crop_param(self,det_box):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1, y1, x2, y2 = det_box[2],det_box[3],det_box[4],det_box[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        w,h= int(x2 - x1),int(y2 - y1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        w_det = int(float(x2 - x1) * self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h_det = int(float(y2 - y1) * self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x_det = int(x1*self.display_size[0] // self.rgb888p_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y_det = int(y1*self.display_size[1] // self.rgb888p_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        length = max(w, h)/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cx = (x1+x2)/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cy = (y1+y2)/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ratio_num = 1.26*length</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x1_kp = int(max(0,cx-ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y1_kp = int(max(0,cy-ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x2_kp = int(min(self.rgb888p_size[0]-1, cx+ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y2_kp = int(min(self.rgb888p_size[1]-1, cy+ratio_num))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        w_kp = int(x2_kp - x1_kp + 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h_kp = int(y2_kp - y1_kp + 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return [x1_kp, y1_kp, w_kp, h_kp]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class SpaceResize:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,hand_det_kmodel,hand_kp_kmodel,det_input_size,kp_input_size,labels,anchors,confidence_threshold=0.25,nms_threshold=0.3,nms_option=False,strides=[8,16,32],rgb888p_size=[1280,720],display_size=[1920,1080],debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_det_kmodel=hand_det_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌关键点模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_kp_kmodel=hand_kp_kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌检测模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.det_input_size=det_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 手掌关键点模型输入分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kp_input_size=kp_input_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.labels=labels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.anchors=anchors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 置信度阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.confidence_threshold=confidence_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_threshold=nms_threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.nms_option=nms_option</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.strides=strides</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # sensor给到AI的图像分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rgb888p_size=[ALIGN_UP(rgb888p_size[0],16),rgb888p_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 视频输出VO分辨率，宽16字节对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.display_size=[ALIGN_UP(display_size[0],16),display_size[1]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # debug_mode模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.first_start = True                                              # 首次手掌入镜参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.two_point_left_x = 0                                            # 中指食指包括范围 x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.two_point_top_y = 0                                             # 中指食指包括范围 y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.two_point_mean_w = 0                                            # 中指食指首次入镜包括范围 w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.two_point_mean_h = 0                                            # 中指食指首次入镜包括范围 h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.two_point_crop_w = 0                                            # 中指食指包括范围 w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.two_point_crop_h = 0                                            # 中指食指包括范围 h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.osd_plot_x = 0                                                  # osd 画缩放图起始点 x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.osd_plot_y = 0                                                  # osd 画缩放图起始点 y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ori_new_ratio = 0                                               # 缩放比例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.new_resize_w = 0                                                # 缩放后 w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.new_resize_h = 0                                                # 缩放后 h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.crop_area = 0                                                   # 剪切区域</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rect_frame_x = 0                                                # osd绘画起始点 x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.rect_frame_y = 0                                                # osd绘画起始点 y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.masks = np.zeros((self.display_size[1],self.display_size[0],4),dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.mask_img=image.Image(self.display_size[0], self.display_size[1], image.ARGB8888,alloc=image.ALLOC_REF,data=self.masks)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_det=HandDetApp(self.hand_det_kmodel,self.labels,model_input_size=self.det_input_size,anchors=self.anchors,confidence_threshold=self.confidence_threshold,nms_threshold=self.nms_threshold,nms_option=self.nms_option,strides=self.strides,rgb888p_size=self.rgb888p_size,display_size=self.display_size,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_kp=HandKPClassApp(self.hand_kp_kmodel,model_input_size=self.kp_input_size,rgb888p_size=self.rgb888p_size,display_size=self.display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d=Ai2d(debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.set_ai2d_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.RGB_packed,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hand_det.config_preprocess()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 对输入数据做预处理，对拇指和中指部分做裁剪并做resize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def imgprocess(self,input_np,x,y,w,h,out_w,out_h):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.crop(x, y, w, h)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.resize(nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ai2d.build([1,3,self.rgb888p_size[1],self.rgb888p_size[0]],[1,out_h, out_w,3])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return self.ai2d.run(input_np).to_numpy()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # run函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,input_np):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 先进行手掌检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        det_boxes=self.hand_det.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        det_res=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        two_point = np.zeros((4),dtype=np.int16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for det_box in det_boxes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 筛选符合要求的手掌</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            x1, y1, x2, y2 = det_box[2],det_box[3],det_box[4],det_box[5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            w,h= int(x2 - x1),int(y2 - y1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (h&lt;(0.1*self.rgb888p_size[1])):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (w&lt;(0.25*self.rgb888p_size[0]) and ((x1&lt;(0.03*self.rgb888p_size[0])) or (x2&gt;(0.97*self.rgb888p_size[0])))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (w&lt;(0.15*self.rgb888p_size[0]) and ((x1&lt;(0.01*self.rgb888p_size[0])) or (x2&gt;(0.99*self.rgb888p_size[0])))):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            det_res.append(det_box)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if len(det_res)!=0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 选择第一个手掌做手掌关键点识别，然后裁剪拇指和中指区域做resize并替换原图中的部分</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            det_box=det_res[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.hand_kp.config_preprocess(det_box)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results_show=self.hand_kp.run(input_np)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            two_point[0],two_point[1],two_point[2],two_point[3] = results_show[8],results_show[9],results_show[16+8],results_show[16+9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (self.first_start):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (two_point[0] &gt; 0 and two_point[0] &lt; self.rgb888p_size[0] and two_point[2] &gt; 0 and two_point[2] &lt; self.rgb888p_size[0] and two_point[1] &gt; 0 and two_point[1] &lt; self.rgb888p_size[1] and two_point[3] &gt; 0 and two_point[3] &lt; self.rgb888p_size[1]):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.two_point_mean_w = np.sqrt(pow(two_point[0] - two_point[2],2) + pow(two_point[1] - two_point[3],2))*0.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.two_point_mean_h = np.sqrt(pow(two_point[0] - two_point[2],2) + pow(two_point[1] - two_point[3],2))*0.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self.first_start = False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.mask_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.two_point_left_x = int(max((two_point[0] + two_point[2]) / 2 - self.two_point_mean_w / 2, 0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.two_point_top_y = int(max((two_point[1] + two_point[3]) / 2 - self.two_point_mean_h / 2, 0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.two_point_crop_w = int(min(min((two_point[0] + two_point[2]) / 2 - self.two_point_mean_w / 2 + self.two_point_mean_w , self.two_point_mean_w), self.rgb888p_size[0] - ((two_point[0] + two_point[2]) / 2 - self.two_point_mean_w / 2)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.two_point_crop_h = int(min(min((two_point[1] + two_point[3]) / 2 - self.two_point_mean_h / 2 + self.two_point_mean_h , self.two_point_mean_h), self.rgb888p_size[1] - ((two_point[1] + two_point[3]) / 2 - self.two_point_mean_h / 2)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.ori_new_ratio = np.sqrt(pow((two_point[0] - two_point[2]),2) + pow((two_point[1] - two_point[3]),2))*0.8 / self.two_point_mean_w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.new_resize_w = min(int(self.two_point_crop_w * self.ori_new_ratio / self.rgb888p_size[0] * self.display_size[0]),600)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.new_resize_h = min(int(self.two_point_crop_h * self.ori_new_ratio / self.rgb888p_size[1] * self.display_size[1]),600)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.rect_frame_x = int(self.two_point_left_x * 1.0 / self.rgb888p_size[0] * self.display_size[0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.rect_frame_y = int(self.two_point_top_y * 1.0 / self.rgb888p_size[1] * self.display_size[1])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.draw_w = min(self.new_resize_w,self.display_size[0]-self.rect_frame_x-1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.draw_h = min(self.new_resize_h,self.display_size[1]-self.rect_frame_y-1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                space_np_out = self.imgprocess(input_np, self.two_point_left_x, self.two_point_top_y, self.two_point_crop_w, self.two_point_crop_h, self.new_resize_w, self.new_resize_h)      # 运行 隔空缩放检测 ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.masks[self.rect_frame_y:self.rect_frame_y + self.draw_h,self.rect_frame_x:self.rect_frame_x + self.draw_w,0] = 255</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.masks[self.rect_frame_y:self.rect_frame_y + self.draw_h,self.rect_frame_x:self.rect_frame_x + self.draw_w,1:4] = space_np_out[0][0:self.draw_h,0:self.draw_w,:]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return det_res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 绘制效果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def draw_result(self,pl,det_res):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if len(det_res)==1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pl.osd_img.copy_from(self.mask_img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pl.osd_img.draw_string_advanced((self.display_size[0]//2),(self.display_size[1]//2),32,&quot;请保证一只手入镜!&quot;,color=(255,0,0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__==&quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 显示模式，默认&quot;hdmi&quot;,可以选择&quot;hdmi&quot;和&quot;lcd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    display_mode=&quot;hdmi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if display_mode==&quot;hdmi&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        display_size=[800,480]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 手掌检测模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_det_kmodel_path=&quot;/sdcard/app/tests/kmodel/hand_det.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 手掌关键点模型路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_kp_kmodel_path=&quot;/sdcard/app/tests/kmodel/handkp_det.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors_path=&quot;/sdcard/app/tests/utils/prior_data_320.bin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb888p_size=[1920,1080]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_det_input_size=[512,512]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hand_kp_input_size=[256,256]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    confidence_threshold=0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_threshold=0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels=[&quot;hand&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    anchors = [26,27, 53,52, 75,71, 80,99, 106,82, 99,134, 140,113, 161,172, 245,276]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化PipeLine，只关注传给AI的图像分辨率，显示的分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl=PipeLine(rgb888p_size=rgb888p_size,display_size=display_size,display_mode=display_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pl.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sr=SpaceResize(hand_det_kmodel_path,hand_kp_kmodel_path,det_input_size=hand_det_input_size,kp_input_size=hand_kp_input_size,labels=labels,anchors=anchors,confidence_threshold=confidence_threshold,nms_threshold=nms_threshold,nms_option=False,strides=[8,16,32],rgb888p_size=rgb888p_size,display_size=display_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            os.exitpoint()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                img=pl.get_frame()          # 获取当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                det_res=sr.run(img)         # 推理当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sr.draw_result(pl,det_res)  # 绘制当前帧推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pl.show_image()             # 展示当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sr.hand_det.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sr.hand_kp.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pl.destroy()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="229-文本转语音中文">2.29. 文本转语音（中文）<a href="#229-文本转语音中文" class="hash-link" aria-label="Direct link to 2.29. 文本转语音（中文）" title="Direct link to 2.29. 文本转语音（中文）">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from libs.PipeLine import ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AIBase import AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from libs.AI2D import Ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.pyaudio import *                     # 音频模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import *                       # 软件抽象模块，主要封装媒体数据链路以及媒体缓冲区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import media.wave as wave                       # wav音频处理模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn                     # nncase运行模块，封装了kpu（kmodel推理）和ai2d（图片预处理加速）操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np                         # 类似python numpy操作，但也会有一些接口不同</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import aidemo                                   # aidemo模块，封装ai demo相关前处理、后处理等操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time                                     # 时间统计</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import struct                                   # 字节字符转换模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc                                       # 垃圾回收模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os,sys                                   # 操作系统接口模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义TTS中文编码器类，继承自AIBase基类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class EncoderApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, kmodel_path,dict_path,phase_path,mapfile,debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path)  # 调用基类的构造函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path = kmodel_path  # 模型文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode = debug_mode  # 是否开启调试模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.ttszh=aidemo.tts_zh_create(dict_path,phase_path,mapfile)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.data=None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.data_len=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.durition_sum=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义编码器预处理，返回模型输入tensor列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def preprocess(self,text):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;encoder preprocess&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preprocess_data=aidemo.tts_zh_preprocess(self.ttszh,text)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.data=preprocess_data[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.data_len=preprocess_data[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 创建编码器模型输入并和模型绑定，编码器包含两个输入，一个是文字预处理的序列数据，一个是speaker数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 编码器序列数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            enc_seq_input_tensor = nn.from_numpy(np.array(self.data))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 编码器speaker数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            enc_speaker_input_tensor=nn.from_numpy(np.array([0.0]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return [enc_speaker_input_tensor,enc_seq_input_tensor]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义编码器的后处理，results是模型输出ndarray列表,编码器后处理也可以视为解码器的前处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self, results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;encoder postprocess&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            enc_output_0_np=results[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            enc_output_1_np=results[1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 给编码结果添加持续时间属性，每个音素编码向量按照持续时间重复</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            duritions=enc_output_1_np[0][:int(self.data_len[0])]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.durition_sum=int(np.sum(duritions))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 解码器输入维度为（1,600,256）,不足部分需要padding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            max_value=13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while self.durition_sum&gt;600:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for i in range(len(duritions)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if duritions[i]&gt;max_value:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        duritions[i]=max_value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                max_value=max_value-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.durition_sum=np.sum(duritions)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dec_input=np.zeros((1,600,256),dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            m_pad=600-self.durition_sum</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            k=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for i in range(len(duritions)):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for j in range(int(duritions[i])):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    dec_input[0][k]=enc_output_0_np[0][i]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    k+=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return dec_input,self.durition_sum</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义TTS中文解码器类，继承自AIBase基类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class DecoderApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, kmodel_path, debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path)  # 调用基类的构造函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path = kmodel_path  # 模型文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode = debug_mode  # 是否开启调试模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义解码器预处理，返回模型输入tensor列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def preprocess(self,dec_input):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;decoder preprocess&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dec_input_tensor=nn.from_numpy(dec_input)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return [dec_input_tensor]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义解码器后处理，results是模型输出ndarray列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self, results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;decoder postprocess&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return results[0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 自定义HifiGan声码器类，继承自AIBase基类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class HifiGanApp(AIBase):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self, kmodel_path, debug_mode=0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super().__init__(kmodel_path)  # 调用基类的构造函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.kmodel_path = kmodel_path  # 模型文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode = debug_mode  # 是否开启调试模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.mel_data=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.subvector_num=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hifi_input=None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义声码器预处理，返回模型输入tensor列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def preprocess(self,dec_output_np,durition_sum):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;hifigan preprocess&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.subvector_num=durition_sum//100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            remaining=durition_sum%100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if remaining&gt;0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.subvector_num+=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.hifi_input=np.zeros((1,80,self.subvector_num*100),dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for i in range(durition_sum):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.hifi_input[:,:,i]=dec_output_np[:,:,i]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,dec_output_np,durition_sum):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.preprocess(dec_output_np,durition_sum)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 依次对每一个子向量进行声码器推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for i in range(self.subvector_num):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            hifi_input_tmp=np.zeros((1,80,100),dtype=np.float)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for j in range(80):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for k in range(i*100,(i+1)*100):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    hifi_input_tmp[0][j][k-i*100]=self.hifi_input[0][j][k]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 设置模型输入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            hifigan_input_tensor=nn.from_numpy(hifi_input_tmp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results=self.inference([hifigan_input_tensor])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.postprocess(results)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return self.mel_data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 自定义当前任务的后处理，results是模型输出ndarray列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def postprocess(self, results):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;hifigan postprocess&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 汇总输出数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for j in range(25600):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self.mel_data.append(results[0][0][0][j])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#自定义中文TTS任务类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class TTSZH:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def __init__(self,encoder_kmodel_path,decoder_kmodel_path,hifigan_kmodel_path,dict_path,phase_path,mapfile,save_wav_file,debug_mode):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.save_wav_file=save_wav_file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.debug_mode=debug_mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.encoder=EncoderApp(encoder_kmodel_path,dict_path,phase_path,mapfile,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.decoder=DecoderApp(decoder_kmodel_path,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.hifigan=HifiGanApp(hifigan_kmodel_path,debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def run(self,text):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        encoder_output_0,encoder_output_1=self.encoder.run(text)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        decoder_output_0=self.decoder.run(encoder_output_0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hifigan_output=self.hifigan.run(decoder_output_0,encoder_output_1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 将生成的音频数据保存为wav文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        save_data=hifigan_output[:encoder_output_1*256]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        save_len=len(save_data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        aidemo.save_wav(save_data,save_len,self.save_wav_file,24000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.play_audio()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def play_audio(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;play audio&quot;, self.debug_mode &gt; 0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 有关音频流的宏变量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            SAMPLE_RATE = 24000         # 采样率24000Hz,即每秒采样24000次</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            CHANNELS = 1                # 通道数 1为单声道，2为立体声</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            FORMAT = paInt16            # 音频输入输出格式 paInt16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            CHUNK = int(0.3 * 24000)    # 每次读取音频数据的帧数，设置为0.3s的帧数24000*0.3=7200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 初始化音频流</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            p = PyAudio()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            p.initialize(CHUNK)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = MediaManager.init()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ret:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                print(&quot;record_audio, buffer_init failed&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # 用于播放音频</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            output_stream = p.open(format=FORMAT,channels=CHANNELS,rate=SAMPLE_RATE,output=True,frames_per_buffer=CHUNK)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            wf = wave.open(self.save_wav_file, &quot;rb&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            wav_data = wf.read_frames(CHUNK)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while wav_data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                output_stream.write(wav_data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                wav_data = wf.read_frames(CHUNK)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            time.sleep(2) # 时间缓冲，用于播放声音</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            wf.close()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            output_stream.stop_stream()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            output_stream.close()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            p.terminate()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MediaManager.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def deinit(self):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        aidemo.tts_zh_destroy(self.encoder.ttszh)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tts_zh.encoder.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tts_zh.decoder.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tts_zh.hifigan.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if __name__ == &quot;__main__&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    os.exitpoint(os.EXITPOINT_ENABLE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nn.shrink_memory_pool()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置模型路径和其他参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 中文tts encoder模型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    encoder_kmodel_path = &quot;/sdcard/app/tests/kmodel/zh_fastspeech_1_f32.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 中文tts decoder模型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    decoder_kmodel_path = &quot;/sdcard/app/tests/kmodel/zh_fastspeech_2.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 中文tts 声码器模型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hifigan_kmodel_path=&quot;/sdcard/app/tests/kmodel/hifigan.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 拼音字典</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dict_path=&quot;/sdcard/app/tests/utils/pinyin.txt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 汉字转拼音字典文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    phase_path=&quot;/sdcard/app/tests/utils/small_pinyin.txt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 拼音转音素映射文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mapfile=&quot;/sdcard/app/tests/utils/phone_map.txt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 输入中文语句</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    text=&quot;嘉楠科技研发了最新款的芯片&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 生成音频存储路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    save_wav_file = &quot;/sdcard/app/tests/test.wav&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化自定义中文tts实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tts_zh = TTSZH(encoder_kmodel_path,decoder_kmodel_path,hifigan_kmodel_path,dict_path,phase_path,mapfile,save_wav_file,debug_mode=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        with ScopedTiming(&quot;total&quot;,1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tts_zh.run(text)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            gc.collect()                        # 垃圾回收</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sys.print_exception(e)                  # 打印异常信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tts_zh.deinit()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/CanaanK230/part5/06_AIDemodocumentation.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/CanaanK230/part5/ramdiskinstructionsforuse"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">4.ramdisk使用说明</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/CanaanK230/part5/Facedetection"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">2.人脸检测</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-ai-demo开发框架介绍" class="table-of-contents__link toc-highlight">1. AI Demo开发框架介绍</a><ul><li><a href="#11-ai-demo开发框架" class="table-of-contents__link toc-highlight">1.1. AI Demo开发框架</a></li><li><a href="#12-接口介绍" class="table-of-contents__link toc-highlight">1.2. 接口介绍</a></li><li><a href="#13-应用方法和示例" class="table-of-contents__link toc-highlight">1.3. 应用方法和示例</a></li><li><a href="#14-参考文档" class="table-of-contents__link toc-highlight">1.4. 参考文档</a></li></ul></li><li><a href="#2-ai-demo" class="table-of-contents__link toc-highlight">2. AI Demo</a><ul><li><a href="#21-动态手势识别" class="table-of-contents__link toc-highlight">2.1. 动态手势识别</a></li><li><a href="#22-注视估计" class="table-of-contents__link toc-highlight">2.2. 注视估计</a></li><li><a href="#23-人脸检测" class="table-of-contents__link toc-highlight">2.3. 人脸检测</a></li><li><a href="#24-人脸关键部位" class="table-of-contents__link toc-highlight">2.4. 人脸关键部位</a></li><li><a href="#25-人脸3d网络" class="table-of-contents__link toc-highlight">2.5. 人脸3D网络</a></li><li><a href="#26-人脸解析" class="table-of-contents__link toc-highlight">2.6. 人脸解析</a></li><li><a href="#27-人脸姿态" class="table-of-contents__link toc-highlight">2.7. 人脸姿态</a></li><li><a href="#28-人脸识别" class="table-of-contents__link toc-highlight">2.8. 人脸识别</a></li><li><a href="#29-人脸注册" class="table-of-contents__link toc-highlight">2.9. 人脸注册</a></li><li><a href="#210-跌倒检测" class="table-of-contents__link toc-highlight">2.10. 跌倒检测</a></li><li><a href="#211-猜拳游戏" class="table-of-contents__link toc-highlight">2.11. 猜拳游戏</a></li><li><a href="#212-手掌检测" class="table-of-contents__link toc-highlight">2.12. 手掌检测</a></li><li><a href="#213-手掌关键点分类" class="table-of-contents__link toc-highlight">2.13. 手掌关键点分类</a></li><li><a href="#214-手掌关键点检测" class="table-of-contents__link toc-highlight">2.14. 手掌关键点检测</a></li><li><a href="#215-手势识别" class="table-of-contents__link toc-highlight">2.15. 手势识别</a></li><li><a href="#216-关键词唤醒" class="table-of-contents__link toc-highlight">2.16 关键词唤醒</a></li><li><a href="#217-车牌检测" class="table-of-contents__link toc-highlight">2.17. 车牌检测</a></li><li><a href="#218-车牌识别" class="table-of-contents__link toc-highlight">2.18. 车牌识别</a></li><li><a href="#219-单目标跟踪" class="table-of-contents__link toc-highlight">2.19. 单目标跟踪</a></li><li><a href="#220-yolov8n目标检测" class="table-of-contents__link toc-highlight">2.20. yolov8n目标检测</a></li><li><a href="#221-ocr检测" class="table-of-contents__link toc-highlight">2.21. OCR检测</a></li><li><a href="#222-ocr识别" class="table-of-contents__link toc-highlight">2.22. OCR识别</a></li><li><a href="#223-人体检测" class="table-of-contents__link toc-highlight">2.23. 人体检测</a></li><li><a href="#224-人体关键点检测" class="table-of-contents__link toc-highlight">2.24. 人体关键点检测</a></li><li><a href="#225-拼图游戏" class="table-of-contents__link toc-highlight">2.25. 拼图游戏</a></li><li><a href="#226-yolov8分割" class="table-of-contents__link toc-highlight">2.26. yolov8分割</a></li><li><a href="#227-自学习" class="table-of-contents__link toc-highlight">2.27. 自学习</a></li><li><a href="#228-局部放大器" class="table-of-contents__link toc-highlight">2.28. 局部放大器</a></li><li><a href="#229-文本转语音中文" class="table-of-contents__link toc-highlight">2.29. 文本转语音（中文）</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://dongshanpi.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">DongshanPI<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://canaan-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Canaan-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://renesas-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Renesas-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://rtos.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">RTOS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://tina.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">TinaSDK-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://allwinner-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Allwinner-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://aw-r128.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">R128-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://space.bilibili.com/275908810" target="_blank" rel="noopener noreferrer" class="footer__link-item">BiliBili<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forums.100ask.net" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://video.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VideoCenter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/dongshanpi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://weidongshan.coding.net/public/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Coding<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/100askTeam" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gitee.com/weidongshan" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>