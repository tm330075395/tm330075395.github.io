<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-CanaanK230/part4/Getstartedquicklyk230AIInferenceflow" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">5. 快速入门k230 AI推理流程 | 正点原子</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://tm330075395.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://tm330075395.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://tm330075395.github.io/docs/CanaanK230/part4/Getstartedquicklyk230AIInferenceflow"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="5. 快速入门k230 AI推理流程 | 正点原子"><meta data-rh="true" name="description" content="本章教学视频：勘智K230开发板使用教程-快速入门AI推理流程哔哩哔哩bilibili"><meta data-rh="true" property="og:description" content="本章教学视频：勘智K230开发板使用教程-快速入门AI推理流程哔哩哔哩bilibili"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://tm330075395.github.io/docs/CanaanK230/part4/Getstartedquicklyk230AIInferenceflow"><link data-rh="true" rel="alternate" href="https://tm330075395.github.io/docs/CanaanK230/part4/Getstartedquicklyk230AIInferenceflow" hreflang="en"><link data-rh="true" rel="alternate" href="https://tm330075395.github.io/docs/CanaanK230/part4/Getstartedquicklyk230AIInferenceflow" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="正点原子 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="正点原子 Atom Feed"><link rel="stylesheet" href="/assets/css/styles.ce37c9a8.css">
<script src="/assets/js/runtime~main.fcaa3de9.js" defer="defer"></script>
<script src="/assets/js/main.252b8acf.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">My Site</b></a><a class="navbar__item navbar__link" href="/docs/intro">Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/CanaanK230/Userdoc">CanMV-K230教程</a><a href="http://www.alientek.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">正点原子官网<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="http://www.openedv.com/forum.php" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">论坛<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tm330075395/tm330075395.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/CanaanK230/Userdoc">文档阅读指南</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/1开发板上手指南-1">1.开发板上手指南</a><button aria-label="Expand sidebar category &#x27;1.开发板上手指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/2开发环境搭建指南-1">2.开发环境搭建指南</a><button aria-label="Expand sidebar category &#x27;2.开发环境搭建指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/3嵌入式应用开发指南-1">3.嵌入式应用开发指南</a><button aria-label="Expand sidebar category &#x27;3.嵌入式应用开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/4ai应用开发指南-1">4.AI应用开发指南</a><button aria-label="Collapse sidebar category &#x27;4.AI应用开发指南&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/Introduction">1. 介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/K230Development">2 开发基础</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/K230AIDemoOverview">3. K230 AI Demo 概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/K230FancyPOCOverview">4. K230 Fancy POC 概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/CanaanK230/part4/Getstartedquicklyk230AIInferenceflow">5. 快速入门k230 AI推理流程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/In-depthanalysisoftheAIdevelopmentprocess">6.深入解析AI开发流程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/Introductiontodevelopmenttools">7. 开发工具简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/Developedusinganonlinecloudtrainingplatform">8. 使用在线云训练平台开发</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/DevelopedwithAICube">9. 使用AI Cube开发</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/Source-levelapplicationdevelopment">10. 源码级应用开发</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/CanCollectorPlus">11. CanCollectorPlus</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/SDKcorrespondstotheNNCASEversion">12. SDK和nncase版本对应</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/reference">13. 参考</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/5micropython应用开发指南-1">5.MicroPython应用开发指南</a><button aria-label="Expand sidebar category &#x27;5.MicroPython应用开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/6系统开发指南-1">6.系统开发指南</a><button aria-label="Expand sidebar category &#x27;6.系统开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/7sdk-api参考指南-1">7.SDK API参考指南</a><button aria-label="Expand sidebar category &#x27;7.SDK API参考指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/8常见问题-1">8.常见问题</a><button aria-label="Expand sidebar category &#x27;8.常见问题&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/4ai应用开发指南-1"><span itemprop="name">4.AI应用开发指南</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">5. 快速入门k230 AI推理流程</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>5. 快速入门k230 AI推理流程</h1></header>
<blockquote>
<p>本章教学视频：<a href="https://www.bilibili.com/video/BV1tD421777Y/?spm_id_from=333.999.0.0" target="_blank" rel="noopener noreferrer">勘智K230开发板使用教程-快速入门AI推理流程_哔哩哔哩_bilibili</a></p>
</blockquote>
<p>本章介绍了K230 AI推理的完整流程，让大家对基于K230的AI推理过程有个大概印象，它包括视频采集，图像预处理，模型推理、后处理、显示等过程。</p>
<ul>
<li>视频输入：VI（Video Input），视频采集</li>
<li>视频输出：VO（Video Output），显示</li>
</ul>
<p>本章包含了K230 AI推理流程的两种实现：基于OpenCV(c++)的AI推理、基于ulab(MicroPython)的AI推理，分别对应两个子章节，具体实现详子章节介绍。</p>
<p><strong>详细代码实现</strong>：<a href="https://github.com/JayL323/k230_AI_Demo_Code_Flow_Introduction" target="_blank" rel="noopener noreferrer">k230_AI_Demo_Code_Flow_Introduction</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="51-基于opencvc的ai推理流程">5.1 基于OpenCV(C++)的AI推理流程<a href="#51-基于opencvc的ai推理流程" class="hash-link" aria-label="Direct link to 5.1 基于OpenCV(C++)的AI推理流程" title="Direct link to 5.1 基于OpenCV(C++)的AI推理流程">​</a></h2>
<p>基于OpenCV(C++)的K230 AI推理，简要介绍了使用c++语言实现的视频采集，图像预处理（OpenCV），模型推理、后处理、显示等过程。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="511-视频采集">5.1.1 视频采集<a href="#511-视频采集" class="hash-link" aria-label="Direct link to 5.1.1 视频采集" title="Direct link to 5.1.1 视频采集">​</a></h3>
<p><strong>视频采集</strong>：（视频输入，VI）与摄像头相关，本小节简要介绍基于c++的摄像头设置、摄像头启动、从摄像头中获取一帧数据、摄像头停止的整体流程；详细介绍见<a href="https://github.com/kendryte/k230_docs/blob/main/zh/01_software/board/mpp/K230_VICAP_API%E5%8F%82%E8%80%83.md" target="_blank" rel="noopener noreferrer">K230_VICAP_API参考.md</a>、<a href="https://github.com/kendryte/k230_docs/blob/main/zh/01_software/board/mpp/K230_VICAP_SENSOR_%E5%8F%82%E6%95%B0%E5%88%86%E5%8C%BA%E5%8F%82%E8%80%83.md" target="_blank" rel="noopener noreferrer">K230_VICAP_SENSOR_参数分区参考.md</a>、<a href="https://github.com/kendryte/k230_docs/blob/main/zh/01_software/board/mpp/K230_Camera_Sensor%E9%80%82%E9%85%8D%E6%8C%87%E5%8D%97.md" target="_blank" rel="noopener noreferrer">K230_Camera_Sensor适配指南.md</a>。</p>
<p><strong>1. 设置摄像头属性</strong>：</p>
<ul>
<li>设置的sensor两路输出；</li>
<li>一路输出用于显示，输出大小设置1080p，图像格式为PIXEL_FORMAT_YVU_PLANAR_420，直接绑定到vo；</li>
<li>另一路输出  用于AI计算，输出大小720p，图像格式为PIXEL_FORMAT_BGR_888_PLANAR（实际为rgb,chw,uint8）；</li>
</ul>
<p><strong>创建摄像头（sensor）输出缓存（VB）</strong>：用于存放摄像头两路输出</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//vi_vo.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/***************************unfixed：不同AI Demo可能需要修改***********************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define SENSOR_CHANNEL (3)     // 通道数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define SENSOR_HEIGHT (720)    // sensor ch1输出高度，AI输入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define SENSOR_WIDTH (1280)    // sensor ch1输出宽度，AI输入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define ISP_CHN0_WIDTH  (1920) // sensor ch0输出宽度，vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define ISP_CHN0_HEIGHT (1080) // sensor ch0输出高度，vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*****************************************************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">memset(&amp;config, 0, sizeof(config));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config.max_pool_cnt = 64;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//VB for YUV420SP output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config.comm_pool[0].blk_cnt = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config.comm_pool[0].mode = VB_REMAP_MODE_NOCACHE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config.comm_pool[0].blk_size = VICAP_ALIGN_UP((ISP_CHN0_WIDTH * ISP_CHN0_HEIGHT * 3 / 2), VICAP_ALIGN_1K);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//VB for RGB888 output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config.comm_pool[1].blk_cnt = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config.comm_pool[1].mode = VB_REMAP_MODE_NOCACHE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config.comm_pool[1].blk_size = VICAP_ALIGN_UP((SENSOR_HEIGHT * SENSOR_WIDTH * 3 ), VICAP_ALIGN_1K);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ret = kd_mpi_vb_set_config(&amp;config);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;vb_set_config failed ret:%d\n&quot;, ret);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*****************************************************************************/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>设置摄像头属性</strong>：设置sensor_type；一般无需换摄像头，无需修改。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//vi_vo.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vicap_dev = VICAP_DEV_ID_0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ret = kd_mpi_vicap_get_sensor_info(sensor_type, &amp;sensor_info);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;sample_vicap, the sensor type not supported!\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dev_attr.cpature_frame = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">memcpy(&amp;dev_attr.sensor_info, &amp;sensor_info, sizeof(k_vicap_sensor_info));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ret = kd_mpi_vicap_set_dev_attr(vicap_dev, dev_attr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;sample_vicap, kd_mpi_vicap_set_dev_attr failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*****************************************************************************/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>设置摄像头通道0属性</strong>：设置摄像头通道0分辨率为1080p，格式为PIXEL_FORMAT_YVU_PLANAR_420；并将摄像头通道0绑定到显示；一般只需要关注<code>chn_attr.out_win.width</code>、<code>chn_attr.out_win.height</code>、<code>chn_attr.pix_format</code>即可，其它不用修改。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//vi_vo.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/***************************unfixed：不同AI Demo可能需要修改***********************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define ISP_CHN0_WIDTH  (1920) // sensor ch0输出宽度，vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define ISP_CHN0_HEIGHT (1080) // sensor ch0输出高度，vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*****************************************************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/***************************unfixed：不同AI Demo可能需要修改******************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//set chn0 output yuv420sp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chn_attr.out_win.width = ISP_CHN0_WIDTH;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chn_attr.out_win.height = ISP_CHN0_HEIGHT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chn_attr.chn_enable = K_TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chn_attr.pix_format = PIXEL_FORMAT_YVU_PLANAR_420;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*****************************************************************************/ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chn_attr.buffer_num = VICAP_MAX_FRAME_COUNT;        //at least 3 buffers for isp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chn_attr.buffer_size = config.comm_pool[0].blk_size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vicap_chn = VICAP_CHN_ID_0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;sample_vicap ...kd_mpi_vicap_set_chn_attr, buffer_size[%d]\n&quot;, chn_attr.buffer_size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ret = kd_mpi_vicap_set_chn_attr(vicap_dev, vicap_chn, chn_attr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;sample_vicap, kd_mpi_vicap_set_chn_attr failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//bind vicap chn 0 to vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vicap_mpp_chn.mod_id = K_ID_VI;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vicap_mpp_chn.dev_id = vicap_dev;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vicap_mpp_chn.chn_id = vicap_chn;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vo_mpp_chn.mod_id = K_ID_VO;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vo_mpp_chn.dev_id = K_VO_DISPLAY_DEV_ID;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vo_mpp_chn.chn_id = K_VO_DISPLAY_CHN_ID1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sample_vicap_bind_vo(vicap_mpp_chn, vo_mpp_chn);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;sample_vicap ...dwc_dsi_init\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*****************************************************************************/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>**设置摄像头通道1属性：**设置通道1分辨率为720p，格式为PIXEL_FORMAT_BGR_888_PLANAR。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//vi_vo.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/***************************unfixed：不同AI Demo可能需要修改***********************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define SENSOR_CHANNEL (3)     // 通道数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define SENSOR_HEIGHT (720)    // sensor ch1输出高度，AI输入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define SENSOR_WIDTH (1280)    // sensor ch1输出宽度，AI输入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*****************************************************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/***************************unfixed：不同AI Demo可能需要修改******************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//set chn1 output rgb888p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chn_attr.out_win.width = SENSOR_WIDTH ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chn_attr.out_win.height = SENSOR_HEIGHT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chn_attr.chn_enable = K_TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chn_attr.pix_format = PIXEL_FORMAT_BGR_888_PLANAR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*****************************************************************************/ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chn_attr.buffer_num = VICAP_MAX_FRAME_COUNT;//at least 3 buffers for isp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chn_attr.buffer_size = config.comm_pool[1].blk_size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;sample_vicap ...kd_mpi_vicap_set_chn_attr, buffer_size[%d]\n&quot;, chn_attr.buffer_size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ret = kd_mpi_vicap_set_chn_attr(vicap_dev, VICAP_CHN_ID_1, chn_attr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;sample_vicap, kd_mpi_vicap_set_chn_attr failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*****************************************************************************/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>设置初始化、并启动摄像头：</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//vi_vo.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ret = kd_mpi_vicap_init(vicap_dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;sample_vicap, kd_mpi_vicap_init failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // goto err_exit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;sample_vicap ...kd_mpi_vicap_start_stream\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ret = kd_mpi_vicap_start_stream(vicap_dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;sample_vicap, kd_mpi_vicap_init failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // goto err_exit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*****************************************************************************/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>使用示例</strong>：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//main.cc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vivcap_start();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>2. 获取摄像头图像</strong>：</p>
<p><strong>摄像头数据临时地址</strong>：创建vaddr，临时存放摄像头最新数据，  它与摄像头通道1大小相同。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// main.cc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// alloc memory for sensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">size_t paddr = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void *vaddr = nullptr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">size_t size = SENSOR_CHANNEL * SENSOR_HEIGHT * SENSOR_WIDTH;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int ret = kd_mpi_sys_mmz_alloc_cached(&amp;paddr, &amp;vaddr, &quot;allocate&quot;, &quot;anonymous&quot;, size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (ret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::cerr &lt;&lt; &quot;physical_memory_block::allocate failed: ret = &quot; &lt;&lt; ret &lt;&lt; &quot;, errno = &quot; &lt;&lt; strerror(errno) &lt;&lt; std::endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::abort();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*****************************************************************************/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>读取最新帧</strong>：</p>
<ul>
<li><strong>dump</strong>：从摄像头通道1读取一帧图像,即从VB中dump一帧数据到dump_info</li>
<li><strong>映射</strong>：将dump_info对应DDR地址（物理地址）映射到当前系统地址（虚拟地址）进行访问</li>
<li><strong>转cv::Mat</strong>：将摄像头数据转换为cv::Mat，sensor（rgb,chw）-&gt;cv::Mat（bgr，hwc）；将摄像头数据转换为为cv::Mat不是必须的，这里只是为了以大家比较熟悉的方式（cv::Mat）进行讲解。</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//vi_vo.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//VB for RGB888 output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config.comm_pool[1].blk_cnt = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config.comm_pool[1].mode = VB_REMAP_MODE_NOCACHE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config.comm_pool[1].blk_size = VICAP_ALIGN_UP((SENSOR_HEIGHT * SENSOR_WIDTH * 3 ), VICAP_ALIGN_1K);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*****************************************************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//main.cc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while (!isp_stop)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::Mat ori_img;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //sensor to cv::Mat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //从摄像头通道1读取一帧图像,即从VB中dump一帧数据到dump_info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        memset(&amp;dump_info, 0 , sizeof(k_video_frame_info));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = kd_mpi_vicap_dump_frame(vicap_dev, VICAP_CHN_ID_1, VICAP_DUMP_YUV, &amp;dump_info, 1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            printf(&quot;sample_vicap...kd_mpi_vicap_dump_frame failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //将dump_info对应DDR地址（物理地址）映射到当前系统（虚拟地址）进行访问</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //vbvaddr是实时改变的，因此我们最好把最新数据拷贝到【固定地址】vaddr，以便其它部分进行访问</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto vbvaddr = kd_mpi_sys_mmap_cached(dump_info.v_frame.phys_addr[0], size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        memcpy(vaddr, (void *)vbvaddr, SENSOR_HEIGHT * SENSOR_WIDTH * 3); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kd_mpi_sys_munmap(vbvaddr, size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /*****************************************************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //将摄像头数据转换为为cv::Mat,sensor（rgb,chw）-&gt;cv::Mat（bgr，hwc）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cv::Mat image_r = cv::Mat(SENSOR_HEIGHT,SENSOR_WIDTH, CV_8UC1, vaddr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cv::Mat image_g = cv::Mat(SENSOR_HEIGHT,SENSOR_WIDTH, CV_8UC1, vaddr+SENSOR_HEIGHT*SENSOR_WIDTH);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cv::Mat image_b = cv::Mat(SENSOR_HEIGHT,SENSOR_WIDTH, CV_8UC1, vaddr+2*SENSOR_HEIGHT*SENSOR_WIDTH);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std::vector&lt;cv::Mat&gt; color_vec(3);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        color_vec.clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        color_vec.push_back(image_b);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        color_vec.push_back(image_g);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        color_vec.push_back(image_r);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cv::merge(color_vec, ori_img);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //使用当前帧数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 释放sensor当  前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = kd_mpi_vicap_dump_release(vicap_dev, VICAP_CHN_ID_1, &amp;dump_info);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            printf(&quot;sample_vicap...kd_mpi_vicap_dump_release failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /*****************************************************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>3. 停止摄像头</strong>：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//vi_vo.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int vivcap_stop()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 摄像头停止</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;sample_vicap ...kd_mpi_vicap_stop_stream\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ret = kd_mpi_vicap_stop_stream(vicap_dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;sample_vicap, kd_mpi_vicap_init failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 摄像头资源释放</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = kd_mpi_vicap_deinit(vicap_dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;sample_vicap, kd_mpi_vicap_deinit failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kd_mpi_vo_disable_video_layer(K_VO_LAYER1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vicap_mpp_chn.mod_id = K_ID_VI;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vicap_mpp_chn.dev_id = vicap_dev;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vicap_mpp_chn.chn_id = vicap_chn;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vo_mpp_chn.mod_id = K_ID_VO;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vo_mpp_chn.dev_id = K_VO_DISPLAY_DEV_ID;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vo_mpp_chn.chn_id = K_VO_DISPLAY_CHN_ID1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // vi vo解绑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sample_vicap_unbind_vo(vicap_mpp_chn, vo_mpp_chn);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /*Allow one frame time for the VO to release the VB block*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_u32 display_ms = 1000 / 33;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    usleep(1000 * display_ms);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 退出vb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = kd_mpi_vb_exit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;sample_vicap, kd_mpi_vb_exit failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*****************************************************************************/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>只需在main.cc中调用：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//main.cc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vivcap_start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vivcap_stop();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="512-预处理">5.1.2 预处理<a href="#512-预处理" class="hash-link" aria-label="Direct link to 5.1.2 预处理" title="Direct link to 5.1.2 预处理">​</a></h3>
<p>对当前帧数据进行resize处理。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//main.cc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while (!isp_stop)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::Mat ori_img;        //ori：uint8,chw,rgb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //sensor to cv::Mat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /***************************unfixed：不同AI Demo可能需要修改******************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // pre_process，cv::Mat((1280,720),bgr,hwc)-&gt;kmodel((224,224),rgb,hwc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::Mat pre_process_img;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cv::Mat rgb_img;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cv::cvtColor(ori_img, rgb_img, cv::COLOR_BGR2RGB);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cv::resize(rgb_img, pre_process_img, cv::Size(kmodel_input_width, kmodel_input_height), cv::INTER_LINEAR);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /*****************************************************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //已在ai_base.cc中给出通用实现，并且将在第6章给出开源代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // set kmodel input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        runtime_tensor tensor0 = kmodel_interp.input_tensor(0).expect(&quot;cannot get input tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto in_buf = tensor0.impl()-&gt;to_host().unwrap()-&gt;buffer().as_host().unwrap().map(map_access_::map_write).unwrap().buffer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        memcpy(reinterpret_cast&lt;unsigned char *&gt;(in_buf.data()), pre_process_img.data,sizeof(uint8_t)* kmodel_input_height * kmodel_input_width * 3);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hrt::sync(tensor0, sync_op_t::sync_write_back, true).expect(&quot;sync write_back failed&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /*****************************************************************************/ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="513-模型推理">5.1.3 模型推理<a href="#513-模型推理" class="hash-link" aria-label="Direct link to 5.1.3 模型推理" title="Direct link to 5.1.3 模型推理">​</a></h3>
<p>设置好模型输入后，进行模型推理，得到模型推理结果。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//main.cc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">string kmodel_path = argv[1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cout&lt;&lt;kmodel_path&lt;&lt;endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">float cls_thresh=0.5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//已在ai_base.cc中给出通用实现，并且将在第6章给出开源代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// kmodel解释器，从kmodel文件构建，负责模型的加载、输入输出设置和推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">interpreter kmodel_interp;        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// load model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">std::ifstream ifs(kmodel_path, std::ios::binary);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kmodel_interp.load_model(ifs).expect(&quot;Invalid kmodel&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// inputs init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for (size_t i = 0; i &lt; kmodel_interp.inputs_size(); i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auto desc = kmodel_interp.input_desc(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auto shape = kmodel_interp.input_shape(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auto tensor = host_runtime_tensor::create(desc.datatype, shape, hrt::pool_shared).expect(&quot;cannot create input tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_interp.input_tensor(i, tensor).expect(&quot;cannot set input tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auto shape0 = kmodel_interp.input_shape(0);      //nhwc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int kmodel_input_height = shape0[1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int kmodel_input_width = shape0[2];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// outputs init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for (size_t i = 0; i &lt; kmodel_interp.outputs_size(); i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auto desc = kmodel_interp.output_desc(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auto shape = kmodel_interp.output_shape(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auto tensor = host_runtime_tensor::create(desc.datatype, shape, hrt::pool_shared).expect(&quot;cannot create output tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_interp.output_tensor(i, tensor).expect(&quot;cannot set output tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*****************************************************************************/ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while (!isp_stop)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::Mat ori_img;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //sensor to cv::Mat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // pre_process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::Mat pre_process_img;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // set kmodel input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //已在ai_base.cc中给出通用实现，并且将在第6章给出开源代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // kmodel run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_interp.run().expect(&quot;error occurred in running model&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // get kmodel output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;float *&gt; k_outputs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; kmodel_interp.outputs_size(); i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            auto out = kmodel_interp.output_tensor(i).expect(&quot;cannot get output tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            auto buf = out.impl()-&gt;to_host().unwrap()-&gt;buffer().as_host().unwrap().map(map_access_::map_read).unwrap().buffer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            float *p_out = reinterpret_cast&lt;float *&gt;(buf.data());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            k_outputs.push_back(p_out);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /*****************************************************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="514-后处理">5.1.4 后处理<a href="#514-后处理" class="hash-link" aria-label="Direct link to 5.1.4 后处理" title="Direct link to 5.1.4 后处理">​</a></h3>
<p>对模型结果进行后处理，并结果放到results中。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//main.cc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vector&lt;cls_res&gt; results;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while (!isp_stop)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::Mat ori_img;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //sensor to cv::Mat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // pre_process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::Mat pre_process_img;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // set kmodel input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // kmodel run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // get kmodel output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;float *&gt; k_outputs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //post process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    results.clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /***************************unfixed：不同AI Demo可能需要修改******************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        float* output0 = k_outputs[0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //softmax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        float sum = 0.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; labels.size(); i++){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum += exp(output0[i]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int max_index;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; labels.size(); i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            output0[i] = exp(output0[i]) / sum;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        max_index = std::max_element(output0,output0+labels.size()) - output0; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cls_res b;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (output0[max_index] &gt;= cls_thresh)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            b.label = labels[max_index];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            b.score = output0[max_index];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results.push_back(b);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /*****************************************************************************/   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="515-显示">5.1.5 显示<a href="#515-显示" class="hash-link" aria-label="Direct link to 5.1.5 显示" title="Direct link to 5.1.5 显示">​</a></h3>
<p>显示（视频输出，VO）与display相关，本小节简要介绍基于c++的显示设置、显示叠加的整体流程；详细介绍参见<a href="https://github.com/kendryte/k230_docs/blob/main/zh/01_software/board/mpp/K230_%E8%A7%86%E9%A2%91%E8%BE%93%E5%87%BA_API%E5%8F%82%E8%80%83.md" target="_blank" rel="noopener noreferrer">K230_视频输出_API参考.md</a></p>
<ul>
<li>显示设置：设置显示大小，格式</li>
<li>显示叠加：显示由2个图层构成，其中下边的图层（原图图层）直接显示摄像头输出，上边的图层（osd图层）用于画框、画点，写文字等。</li>
</ul>
<p><strong>1. 显示设置</strong>：设置显示大小，格式。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//vi_vo.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/***************************fixed：无需修 改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static k_s32 sample_connector_init(void)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_connector_type connector_type = LT9611_MIPI_4LAN_1920X1080_30FPS;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static k_s32 vo_layer_vdss_bind_vo_config(void)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sample_connector_init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // config lyaer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    info.act_size.width = ISP_CHN0_WIDTH;//ISP_CHN0_HEIGHT;//1080;//640;//1080;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    info.act_size.height = ISP_CHN0_HEIGHT;//ISP_CHN0_WIDTH;//1920;//480;//1920;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    info.format = PIXEL_FORMAT_YVU_PLANAR_420;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*****************************************************************************/ </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>2. 显示叠加</strong>：由于摄像头和显示的通道进行了绑定，我们无法对vo进行直接操作，因此采用叠加的方式进行显示。</p>
<p><strong>原图图层</strong>：由于摄像头（vi）通道0绑定了显示（vo）的通道1；随着摄像头的启动，摄像头通道0的数据会自动流到vo的通道1。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//vi_vo.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//bind vicap chn 0 to vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vicap_mpp_chn.mod_id = K_ID_VI;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vicap_mpp_chn.dev_id = vicap_dev;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vicap_mpp_chn.chn_id = vicap_chn;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vo_mpp_chn.mod_id = K_ID_VO;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vo_mpp_chn.dev_id = K_VO_DISPLAY_DEV_ID;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vo_mpp_chn.chn_id = K_VO_DISPLAY_CHN_ID1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sample_vicap_bind_vo(vicap_mpp_chn, vo_mpp_chn);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;sample_vicap ...dwc_dsi_init\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*****************************************************************************/ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">......</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>osd图层</strong>：cv::Mat上画框、画点、写文字之后，将数据插入vo对应通道。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// vi_vo.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define osd_id                              K_VO_OSD3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/***************************unfixed：不同AI Demo可能需要修改******************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define ISP_CHN0_WIDTH                      (1920) // sensor ch0输出宽度，vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define ISP_CHN0_HEIGHT                     (1080) // sensor ch0输出高度，vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define osd_width                           (1920)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define osd_height                          (1080)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*****************************************************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k_vb_blk_handle vo_insert_frame(k_video_frame_info *vf_info, void **pic_vaddr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_u64 phys_addr = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_u32 *virt_addr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_vb_blk_handle handle;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_s32 size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (vf_info == NULL)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return K_FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_ABGR_8888 || vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_ARGB_8888)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size = vf_info-&gt;v_frame.height * vf_info-&gt;v_frame.width * 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if (vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_RGB_565 || vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_BGR_565)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size = vf_info-&gt;v_frame.height * vf_info-&gt;v_frame.width * 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if (vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_ABGR_4444 || vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_ARGB_4444)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size = vf_info-&gt;v_frame.height * vf_info-&gt;v_frame.width * 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if (vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_RGB_888 || vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_BGR_888)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size = vf_info-&gt;v_frame.height * vf_info-&gt;v_frame.width * 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if (vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_ARGB_1555 || vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_ABGR_1555)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size = vf_info-&gt;v_frame.height * vf_info-&gt;v_frame.width * 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if (vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_YVU_PLANAR_420)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size = vf_info-&gt;v_frame.height * vf_info-&gt;v_frame.width * 3 / 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size = size + 4096;         // 强制4K ，后边得删了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;vb block size is %x \n&quot;, size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    handle = kd_mpi_vb_get_block(g_pool_id, size, NULL);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (handle == VB_INVALID_HANDLE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;%s get vb block error\n&quot;, __func__);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return K_FAILED;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    phys_addr = kd_mpi_vb_handle_to_phyaddr(handle);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (phys_addr == 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;%s get phys addr error\n&quot;, __func__);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return K_FAILED;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    virt_addr = (k_u32 *)kd_mpi_sys_mmap(phys_addr, size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // virt_addr = (k_u32 *)kd_mpi_sys_mmap_cached(phys_addr, size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (virt_addr == NULL)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;%s mmap error\n&quot;, __func__);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return K_FAILED;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vf_info-&gt;mod_id = K_ID_VO;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vf_info-&gt;pool_id = g_pool_id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vf_info-&gt;v_frame.phys_addr[0] = phys_addr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_YVU_PLANAR_420)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vf_info-&gt;v_frame.phys_addr[1] = phys_addr + (vf_info-&gt;v_frame.height * vf_info-&gt;v_frame.stride[0]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    *pic_vaddr = virt_addr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;phys_addr is %lx g_pool_id is %d \n&quot;, phys_addr, g_pool_id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return handle;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*****************************************************************************/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>使用示例</strong>：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// main.cc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// osd create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k_video_frame_info vf_info;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void *pic_vaddr = NULL;       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">memset(&amp;vf_info, 0, sizeof(vf_info));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vf_info.v_frame.width = osd_width;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vf_info.v_frame.height = osd_height;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vf_info.v_frame.stride[0] = osd_width;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vf_info.v_frame.pixel_format = PIXEL_FORMAT_ARGB_8888;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">block = vo_insert_frame(&amp;vf_info, &amp;pic_vaddr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*****************************************************************************/ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while (!isp_stop)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::Mat ori_img;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // sensor to cv::Mat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // pre_process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // set kmodel input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // kmodel run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // get kmodel output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // post process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    results.clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // draw result to vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // draw osd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cv::Mat osd_frame(osd_height, osd_width, CV_8UC4, cv::Scalar(0, 0, 0, 0));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            /***************************unfixed：不同AI Demo可能需要修改******************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //draw cls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                double fontsize = (osd_frame.cols * osd_frame.rows * 1.0) / (1100 * 1200);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for(int i = 0; i &lt; results.size(); i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    std::string text = &quot;class: &quot; + results[i].label + &quot;, score: &quot; + std::to_string(round(results[i].score * 100) / 100.0).substr(0, 4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    cv::putText(osd_frame, text, cv::Point(1, 40), cv::FONT_HERSHEY_SIMPLEX, 0.8, cv::Scalar(255, 255, 255, 0), 2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    std::cout &lt;&lt; text &lt;&lt; std::endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            /*************************************************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            /***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memcpy(pic_vaddr, osd_frame.data, osd_width * osd_height * 4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // insert osd to vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            kd_mpi_vo_chn_insert_frame(osd_id+3, &amp;vf_info);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            printf(&quot;kd_mpi_vo_chn_insert_frame success \n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /*****************************************************************************/ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="516-完整代码">5.1.6 完整代码<a href="#516-完整代码" class="hash-link" aria-label="Direct link to 5.1.6 完整代码" title="Direct link to 5.1.6 完整代码">​</a></h3>
<p>具体怎么操作运行，请参考第6章，这里着重  介绍代码流程。</p>
<p>vi_vo.h</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/* Copyright (c) 2023, Canaan Bright Sight Co., Ltd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Redistribution and use in source and binary forms, with or without</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * modification, are permitted provided that the following conditions are met:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 1. Redistributions of source code must retain the above copyright</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * notice, this list of conditions and the following disclaimer.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 2. Redistributions in binary form must reproduce the above copyright</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * notice, this list of conditions and the following disclaimer in the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * documentation and/or other materials provided with the distribution.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;chrono&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;fstream&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;iostream&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;thread&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;atomic&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;mpi_sys_api.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* vicap */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;stdio.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;stdlib.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;unistd.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;string.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;sys/mman.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;k_module.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;k_type.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;k_vb_comm.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;k_video_comm.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;k_sys_comm.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;mpi_vb_api.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;mpi_vicap_api.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;mpi_isp_api.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;mpi_sys_api.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;k_vo_comm.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;mpi_vo_api.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;vo_test_case.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;k_connector_comm.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;mpi_connector_api.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;k_autoconf_comm.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/***************************unfixed：不同AI Demo可能需要修改*******************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#if defined(CONFIG_BOARD_K230_CANMV)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define SENSOR_CHANNEL (3)                // 通道数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define SENSOR_HEIGHT (720)               // sensor ch1输出高度，AI输入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define SENSOR_WIDTH (1280)               // sensor ch1输出宽度，AI输入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define ISP_CHN0_WIDTH  (1920)            // sensor ch0输出宽度，vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define ISP_CHN0_HEIGHT (1080)            // sensor ch0输出高度，vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define vicap_install_osd                   (1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define osd_id                              K_VO_OSD3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define osd_width                           (1920)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define osd_height                          (1080)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define SENSOR_CHANNEL (3)                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define SENSOR_HEIGHT (1280)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define SENSOR_WIDTH (720)   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define ISP_CHN0_WIDTH  (1088)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define ISP_CHN0_HEIGHT (1920)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define vicap_install_osd                   (1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define osd_id                              K_VO_OSD3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define osd_width                           (1080)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define osd_height                          (1920)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*****************************************************************************/    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k_vb_config config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k_vicap_dev vicap_dev;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k_vicap_chn vicap_chn;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k_vicap_dev_attr dev_attr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k_vicap_chn_attr chn_attr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k_vicap_sensor_info sensor_info;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k_vicap_sensor_type sensor_type;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k_mpp_chn vicap_mpp_chn;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k_mpp_chn vo_mpp_chn;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k_video_frame_info dump_info;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k_vo_draw_frame vo_frame = (k_vo_draw_frame) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    16,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    16,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    128,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    128,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static k_vb_blk_handle block;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k_u32 g_pool_id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int vo_creat_layer_test(k_vo_layer chn_id, layer_info *info)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_vo_video_layer_attr attr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // check layer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if ((chn_id &gt;= K_MAX_VO_LAYER_NUM) || ((info-&gt;func &amp; K_VO_SCALER_ENABLE) &amp;&amp; (chn_id != K_VO_LAYER0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            || ((info-&gt;func != 0) &amp;&amp; (chn_id == K_VO_LAYER2)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;input layer num failed \n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1 ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // check scaler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // set offset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attr.display_rect = info-&gt;offset;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // set act</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attr.img_size = info-&gt;act_size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // sget size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    info-&gt;size = info-&gt;act_size.height * info-&gt;act_size.width * 3 / 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //set pixel format</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attr.pixel_format = info-&gt;format;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (info-&gt;format != PIXEL_FORMAT_YVU_PLANAR_420)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;input pix format failed \n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // set stride</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attr.stride = (info-&gt;act_size.width / 8 - 1) + ((info-&gt;act_size.height - 1) &lt;&lt; 16);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // set function</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attr.func = info-&gt;func;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // set scaler attr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attr.scaler_attr = info-&gt;attr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // set video layer atrr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kd_mpi_vo_set_video_layer_attr(chn_id, &amp;attr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // enable layer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kd_mpi_vo_enable_video_layer(chn_id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k_vb_blk_handle vo_insert_frame(k_video_frame_info *vf_info, void **pic_vaddr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_u64 phys_addr = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_u32 *virt_addr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_vb_blk_handle handle;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_s32 size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (vf_info == NULL)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return K_FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_ABGR_8888 || vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_ARGB_8888)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size = vf_info-&gt;v_frame.height * vf_info-&gt;v_frame.width * 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if (vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_RGB_565 || vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_BGR_565)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size = vf_info-&gt;v_frame.height * vf_info-&gt;v_frame.width * 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if (vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_ABGR_4444 || vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_ARGB_4444)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size = vf_info-&gt;v_frame.height * vf_info-&gt;v_frame.width * 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if (vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_RGB_888 || vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_BGR_888)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size = vf_info-&gt;v_frame.height * vf_info-&gt;v_frame.width * 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if (vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_ARGB_1555 || vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_ABGR_1555)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size = vf_info-&gt;v_frame.height * vf_info-&gt;v_frame.width * 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if (vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_YVU_PLANAR_420)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size = vf_info-&gt;v_frame.height * vf_info-&gt;v_frame.width * 3 / 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size = size + 4096;         // 强制4K ，后边得删了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;vb block size is %x \n&quot;, size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    handle = kd_mpi_vb_get_block(g_pool_id, size, NULL);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (handle == VB_INVALID_HANDLE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;%s get vb block error\n&quot;, __func__);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return K_FAILED;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    phys_addr = kd_mpi_vb_handle_to_phyaddr(handle);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (phys_addr == 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;%s get phys addr error\n&quot;, __func__);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return K_FAILED;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    virt_addr = (k_u32 *)kd_mpi_sys_mmap(phys_addr, size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // virt_addr = (k_u32 *)kd_mpi_sys_mmap_cached(phys_addr, size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (virt_addr == NULL)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;%s mmap error\n&quot;, __func__);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return K_FAILED;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vf_info-&gt;mod_id = K_ID_VO;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vf_info-&gt;pool_id = g_pool_id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vf_info-&gt;v_frame.phys_addr[0] = phys_addr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (vf_info-&gt;v_frame.pixel_format == PIXEL_FORMAT_YVU_PLANAR_420)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vf_info-&gt;v_frame.phys_addr[1] = phys_addr + (vf_info-&gt;v_frame.height * vf_info-&gt;v_frame.stride[0]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    *pic_vaddr = virt_addr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;phys_addr is %lx g_pool_id is %d \n&quot;, phys_addr, g_pool_id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return handle;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k_u32 vo_creat_osd_test(k_vo_osd osd, osd_info *info)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_vo_video_osd_attr attr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // set attr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attr.global_alptha = info-&gt;global_alptha;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (info-&gt;format == PIXEL_FORMAT_ABGR_8888 || info-&gt;format == PIXEL_FORMAT_ARGB_8888)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        info-&gt;size = info-&gt;act_size.width  * info-&gt;act_size.height * 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        info-&gt;stride  = info-&gt;act_size.width * 4 / 8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if (info-&gt;format == PIXEL_FORMAT_RGB_565 || info-&gt;format == PIXEL_FORMAT_BGR_565)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        info-&gt;size = info-&gt;act_size.width  * info-&gt;act_size.height * 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        info-&gt;stride  = info-&gt;act_size.width * 2 / 8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if (info-&gt;format == PIXEL_FORMAT_RGB_888 || info-&gt;format == PIXEL_FORMAT_BGR_888)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        info-&gt;size = info-&gt;act_size.width  * info-&gt;act_size.height * 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        info-&gt;stride  = info-&gt;act_size.width * 3 / 8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if(info-&gt;format == PIXEL_FORMAT_ARGB_4444 || info-&gt;format == PIXEL_FORMAT_ABGR_4444)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        info-&gt;size = info-&gt;act_size.width  * info-&gt;act_size.height * 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        info-&gt;stride  = info-&gt;act_size.width * 2 / 8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if(info-&gt;format == PIXEL_FORMAT_ARGB_1555 || info-&gt;format == PIXEL_FORMAT_ABGR_1555)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        info-&gt;size = info-&gt;act_size.width  * info-&gt;act_size.height * 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        info-&gt;stride  = info-&gt;act_size.width * 2 / 8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;set osd pixel format failed  \n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attr.stride = info-&gt;stride;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attr.pixel_format = info-&gt;format;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attr.display_rect = info-&gt;offset;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attr.img_size = info-&gt;act_size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kd_mpi_vo_set_video_osd_attr(osd, &amp;attr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kd_mpi_vo_osd_enable(osd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void sample_vicap_install_osd(void)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    osd_info osd;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    osd.act_size.width = osd_width ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    osd.act_size.height = osd_height;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    osd.offset.x = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    osd.offset.y = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    osd.global_alptha = 0xff;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // osd.global_alptha = 0x32;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    osd.format = PIXEL_FORMAT_ARGB_8888;//PIXEL_FORMAT_ARGB_4444; //PIXEL_FORMAT_ARGB_1555;//PIXEL_FORMAT_ARGB_8888;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vo_creat_osd_test(osd_id, &amp;osd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void vo_osd_release_block(void)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if(vicap_install_osd == 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kd_mpi_vo_osd_disable(osd_id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kd_mpi_vb_release_block(block);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static k_s32 sample_connector_init(void)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_u32 ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_s32 connector_fd;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#if defined(CONFIG_BOARD_K230_CANMV)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_connector_type connector_type = LT9611_MIPI_4LAN_1920X1080_30FPS;// HX8377_V2_MIPI_4LAN_1080X1920_30FPS;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_connector_type connector_type = HX8377_V2_MIPI_4LAN_1080X1920_30FPS;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_connector_info connector_info;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;connector_info, 0, sizeof(k_connector_info));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //connector get sensor info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = kd_mpi_get_connector_info(connector_type, &amp;connector_info);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;sample_vicap, the sensor type not supported!\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connector_fd = kd_mpi_connector_open(connector_info.connector_name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (connector_fd &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;%s, connector open failed.\n&quot;, __func__);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return K_ERR_VO_NOTREADY;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // set connect power</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kd_mpi_connector_power_set(connector_fd, K_TRUE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // connector init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kd_mpi_connector_init(connector_fd, connector_info);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static k_s32 vo_layer_vdss_bind_vo_config(void)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    layer_info info;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_vo_layer chn_id = K_VO_LAYER1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;info, 0, sizeof(info));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sample_connector_init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // config lyaer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    info.act_size.width = ISP_CHN0_WIDTH;//ISP_CHN0_HEIGHT;//1080;//640;//1080;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    info.act_size.height = ISP_CHN0_HEIGHT;//ISP_CHN0_WIDTH;//1920;//480;//1920;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    info.format = PIXEL_FORMAT_YVU_PLANAR_420;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    info.func = 0;//K_ROTATION_180;////K_ROTATION_90;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    info.global_alptha = 0xff;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    info.offset.x = 0;//(1080-w)/2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    info.offset.y = 0;//(1920-h)/2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vo_creat_layer_test(chn_id, &amp;info);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if(vicap_install_osd == 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sample_vicap_install_osd();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //exit ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static void sample_vicap_bind_vo(k_mpp_chn vicap_mpp_chn, k_mpp_chn vo_mpp_chn)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_s32 ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = kd_mpi_sys_bind(&amp;vicap_mpp_chn, &amp;vo_mpp_chn);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;kd_mpi_sys_unbind failed:0x%x\n&quot;, ret);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static void sample_vicap_unbind_vo(k_mpp_chn vicap_mpp_chn, k_mpp_chn vo_mpp_chn)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_s32 ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = kd_mpi_sys_unbind(&amp;vicap_mpp_chn, &amp;vo_mpp_chn);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;kd_mpi_sys_unbind failed:0x%x\n&quot;, ret);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int vivcap_start()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_s32 ret = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_u32 pool_id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_vb_pool_config pool_config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;sample_vicap ...\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#if defined(CONFIG_BOARD_K230_CANMV)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor_type = OV_OV5647_MIPI_CSI0_1920X1080_30FPS_10BIT_LINEAR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kd_mpi_vicap_set_mclk(VICAP_MCLK0, VICAP_PLL0_CLK_DIV4, 16, 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor_type = IMX335_MIPI_2LANE_RAW12_2592X1944_30FPS_LINEAR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vicap_dev = VICAP_DEV_ID_0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;config, 0, sizeof(config));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config.max_pool_cnt = 64;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //VB for YUV420SP output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config.comm_pool[0].blk_cnt = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config.comm_pool[0].mode = VB_REMAP_MODE_NOCACHE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config.comm_pool[0].blk_size = VICAP_ALIGN_UP((ISP_CHN0_WIDTH * ISP_CHN0_HEIGHT * 3 / 2), VICAP_ALIGN_1K);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //VB for RGB888 output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config.comm_pool[1].blk_cnt = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config.comm_pool[1].mode = VB_REMAP_MODE_NOCACHE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config.comm_pool[1].blk_size = VICAP_ALIGN_UP((SENSOR_HEIGHT * SENSOR_WIDTH * 3 ), VICAP_ALIGN_1K);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = kd_mpi_vb_set_config(&amp;config);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;vb_set_config failed ret:%d\n&quot;, ret);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_vb_supplement_config supplement_config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;supplement_config, 0, sizeof(supplement_config));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    supplement_config.supplement_config |= VB_SUPPLEMENT_JPEG_MASK;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = kd_mpi_vb_set_supplement_config(&amp;supplement_config);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;vb_set_supplement_config failed ret:%d\n&quot;, ret);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = kd_mpi_vb_init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;vb_init failed ret:%d\n&quot;, ret);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;sample_vicap ...kd_mpi_vicap_get_sensor_info\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // dwc_dsi_init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vo_layer_vdss_bind_vo_config();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if(vicap_install_osd == 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        memset(&amp;pool_config, 0, sizeof(pool_config));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pool_config.blk_size = VICAP_ALIGN_UP((osd_width * osd_height * 4 * 2), VICAP_ALIGN_1K);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pool_config.blk_cnt = 4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pool_config.mode = VB_REMAP_MODE_NOCACHE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pool_id = kd_mpi_vb_create_pool(&amp;pool_config);      // osd0 - 3 argb 320 x 240</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        g_pool_id = pool_id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;--------aa--------------g_pool_id is %d pool_id is %d \n&quot;,g_pool_id, pool_id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;sensor_info, 0, sizeof(k_vicap_sensor_info));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = kd_mpi_vicap_get_sensor_info(sensor_type, &amp;sensor_info);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;sample_vicap, the sensor type not supported!\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;dev_attr, 0, sizeof(k_vicap_dev_attr));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dev_attr.acq_win.h_start = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dev_attr.acq_win.v_start = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#if defined (CONFIG_BOARD_K230_CANMV)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dev_attr.acq_win.width = ISP_CHN0_WIDTH;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dev_attr.acq_win.height = ISP_CHN0_HEIGHT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dev_attr.acq_win.width = 2592;//SENSOR_HEIGHT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dev_attr.acq_win.height = 1944;//SENSOR_WIDTH;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dev_attr.mode = VICAP_WORK_ONLINE_MODE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dev_attr.pipe_ctrl.data = 0xFFFFFFFF;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dev_attr.pipe_ctrl.bits.af_enable = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dev_attr.pipe_ctrl.bits.ahdr_enable = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dev_attr.cpature_frame = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memcpy(&amp;dev_attr.sensor_info, &amp;sensor_info, sizeof(k_vicap_sensor_info));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = kd_mpi_vicap_set_dev_attr(vicap_dev, dev_attr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;sample_vicap, kd_mpi_vicap_set_dev_attr failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;chn_attr, 0, sizeof(k_vicap_chn_attr));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //set chn0 output yuv420sp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.out_win.h_start = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.out_win.v_start = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.out_win.width = ISP_CHN0_WIDTH;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.out_win.height = ISP_CHN0_HEIGHT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#if defined(CONFIG_BOARD_K230_CANMV)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.crop_win = dev_attr.acq_win;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // chn_attr.crop_win = dev_attr.acq_win;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.crop_win.h_start = 768;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.crop_win.v_start = 16;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.crop_win.width = ISP_CHN0_WIDTH;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.crop_win.height = ISP_CHN0_HEIGHT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.scale_win = chn_attr.out_win;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.crop_enable = K_FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.scale_enable = K_FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // chn_attr.dw_enable = K_FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.chn_enable = K_TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.pix_format = PIXEL_FORMAT_YVU_PLANAR_420;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.buffer_num = VICAP_MAX_FRAME_COUNT;//at least 3 buffers for isp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.buffer_size = config.comm_pool[0].blk_size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vicap_chn = VICAP_CHN_ID_0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;sample_vicap ...kd_mpi_vicap_set_chn_attr, buffer_size[%d]\n&quot;, chn_attr.buffer_size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = kd_mpi_vicap_set_chn_attr(vicap_dev, vicap_chn, chn_attr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;sample_vicap, kd_mpi_vicap_set_chn_attr failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //bind vicap chn 0 to vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vicap_mpp_chn.mod_id = K_ID_VI;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vicap_mpp_chn.dev_id = vicap_dev;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vicap_mpp_chn.chn_id = vicap_chn;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vo_mpp_chn.mod_id = K_ID_VO;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vo_mpp_chn.dev_id = K_VO_DISPLAY_DEV_ID;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vo_mpp_chn.chn_id = K_VO_DISPLAY_CHN_ID1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sample_vicap_bind_vo(vicap_mpp_chn, vo_mpp_chn);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;sample_vicap ...dwc_dsi_init\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //set chn1 output rgb888p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.out_win.h_start = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.out_win.v_start = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.out_win.width = SENSOR_WIDTH ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.out_win.height = SENSOR_HEIGHT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // chn_attr.crop_win = dev_attr.acq_win;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#if defined(CONFIG_BOARD_K230_CANMV)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.crop_win = dev_attr.acq_win;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#else   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.crop_win.h_start = 768;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.crop_win.v_start = 16;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.crop_win.width = ISP_CHN0_WIDTH;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.crop_win.height = ISP_CHN0_HEIGHT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.scale_win = chn_attr.out_win;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.crop_enable = K_FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.scale_enable = K_FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // chn_attr.dw_enable = K_FALSE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.chn_enable = K_TRUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.pix_format = PIXEL_FORMAT_BGR_888_PLANAR;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.buffer_num = VICAP_MAX_FRAME_COUNT;//at least 3 buffers for isp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chn_attr.buffer_size = config.comm_pool[1].blk_size;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;sample_vicap ...kd_mpi_vicap_set_chn_attr, buffer_size[%d]\n&quot;, chn_attr.buffer_size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = kd_mpi_vicap_set_chn_attr(vicap_dev, VICAP_CHN_ID_1, chn_attr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;sample_vicap, kd_mpi_vicap_set_chn_attr failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;sample_vicap ...kd_mpi_vicap_init\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = kd_mpi_vicap_init(vicap_dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;sample_vicap, kd_mpi_vicap_init failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // goto err_exit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;sample_vicap ...kd_mpi_vicap_start_stream\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = kd_mpi_vicap_start_stream(vicap_dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;sample_vicap, kd_mpi_vicap_init failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // goto err_exit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int vivcap_stop()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;sample_vicap ...kd_mpi_vicap_stop_stream\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ret = kd_mpi_vicap_stop_stream(vicap_dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;sample_vicap, kd_mpi_vicap_init failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = kd_mpi_vicap_deinit(vicap_dev);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;sample_vicap, kd_mpi_vicap_deinit failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kd_mpi_vo_disable_video_layer(K_VO_LAYER1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vicap_mpp_chn.mod_id = K_ID_VI;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vicap_mpp_chn.dev_id = vicap_dev;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vicap_mpp_chn.chn_id = vicap_chn;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vo_mpp_chn.mod_id = K_ID_VO;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vo_mpp_chn.dev_id = K_VO_DISPLAY_DEV_ID;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vo_mpp_chn.chn_id = K_VO_DISPLAY_CHN_ID1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sample_vicap_unbind_vo(vicap_mpp_chn, vo_mpp_chn);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /*Allow one frame time for the VO to release the VB block*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_u32 display_ms = 1000 / 33;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    usleep(1000 * display_ms);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = kd_mpi_vb_exit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        printf(&quot;sample_vicap, kd_mpi_vb_exit failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void yuv_rotate_90(char *des, char *src,int width,int height)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int n = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int hw = width&gt;&gt;1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int hh = height&gt;&gt;1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int size = width * height;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int hsize = size&gt;&gt;2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int pos = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for(int i = width-1;i &gt;= 0;i--)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pos = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for(int j= 0;j &lt; height;j++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            des[n++]= src[pos+i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pos += width;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/****************************************************************************/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>main.cc</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/* Copyright (c) 2023, Canaan Bright Sight Co., Ltd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Redistribution and use in source and binary forms, with or without</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * modification, are permitted provided that the following conditions are met:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 1. Redistributions of source code must retain the above copyright</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * notice, this list of conditions and the following disclaimer.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 2. Redistributions in binary form must reproduce the above copyright</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * notice, this list of conditions and the following disclaimer in the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * documentation and/or other materials provided with the distribution.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;iostream&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;thread&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;map&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;nncase/runtime/runtime_tensor.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;nncase/runtime/interpreter.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;nncase/runtime/runtime_op_utility.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;opencv2/highgui.hpp&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;opencv2/imgcodecs.hpp&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;opencv2/imgproc.hpp&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;vi_vo.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using namespace nncase;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using namespace nncase::runtime;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using cv::Mat;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using std::cerr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using std::cout;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using std::endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using namespace std;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auto cache = cv::Mat::zeros(1, 1, CV_32FC1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @brief 分类结果结构</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct cls_res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float score;//分类分数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string label;//分类标签结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}cls_res;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">std::atomic&lt;bool&gt; isp_stop(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void video_proc_cls(char *argv[])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vivcap_start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // osd set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_video_frame_info vf_info;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void *pic_vaddr = NULL;       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;vf_info, 0, sizeof(vf_info));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vf_info.v_frame.width = osd_width;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vf_info.v_frame.height = osd_height;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vf_info.v_frame.stride[0] = osd_width;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vf_info.v_frame.pixel_format = PIXEL_FORMAT_ARGB_8888;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    block = vo_insert_frame(&amp;vf_info, &amp;pic_vaddr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // alloc memory for sensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t paddr = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void *vaddr = nullptr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t size = SENSOR_CHANNEL * SENSOR_HEIGHT * SENSOR_WIDTH;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ret = kd_mpi_sys_mmz_alloc_cached(&amp;paddr, &amp;vaddr, &quot;allocate&quot;, &quot;anonymous&quot;, size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std::cerr &lt;&lt; &quot;physical_memory_block::allocate failed: ret = &quot; &lt;&lt; ret &lt;&lt; &quot;, errno = &quot; &lt;&lt; strerror(errno) &lt;&lt; std::endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std::abort();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /*****************************************************************************/ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string kmodel_path = argv[1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cout&lt;&lt;&quot;kmodel_path : &quot;&lt;&lt;kmodel_path&lt;&lt;endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float cls_thresh=0.5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 我们已经把相关实现封装到ai_base.cc，这里只是为了介绍起来比较简单</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interpreter kmodel_interp;        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // load model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::ifstream ifs(kmodel_path, std::ios::binary);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_interp.load_model(ifs).expect(&quot;Invalid kmodel&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // inputs init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (size_t i = 0; i &lt; kmodel_interp.inputs_size(); i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto desc = kmodel_interp.input_desc(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto shape = kmodel_interp.input_shape(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto tensor = host_runtime_tensor::create(desc.datatype, shape, hrt::pool_shared).expect(&quot;cannot create input tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kmodel_interp.input_tensor(i, tensor).expect(&quot;cannot set input tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auto shape0 = kmodel_interp.input_shape(0);      //nhwc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int kmodel_input_height = shape0[1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int kmodel_input_width = shape0[2];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // outputs init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (size_t i = 0; i &lt; kmodel_interp.outputs_size(); i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto desc = kmodel_interp.output_desc(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto shape = kmodel_interp.output_shape(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto tensor = host_runtime_tensor::create(desc.datatype, shape, hrt::pool_shared).expect(&quot;cannot create output tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kmodel_interp.output_tensor(i, tensor).expect(&quot;cannot set output tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /*****************************************************************************/ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;cls_res&gt; results;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::vector&lt;std::string&gt; labels = {&quot;bocai&quot;,&quot;changqiezi&quot;,&quot;huluobo&quot;,&quot;xihongshi&quot;,&quot;xilanhua&quot;};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (!isp_stop)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cv::Mat ori_img;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //sensor to cv::Mat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            /***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //从摄像头读取一帧图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memset(&amp;dump_info, 0 , sizeof(k_video_frame_info));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = kd_mpi_vicap_dump_frame(vicap_dev, VICAP_CHN_ID_1, VICAP_DUMP_YUV, &amp;dump_info, 1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;sample_vicap...kd_mpi_vicap_dump_frame failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //将摄像头当前帧对应DDR地址映射到当前系统进行访问</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            auto vbvaddr = kd_mpi_sys_mmap_cached(dump_info.v_frame.phys_addr[0], size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memcpy(vaddr, (void *)vbvaddr, SENSOR_HEIGHT * SENSOR_WIDTH * 3); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            kd_mpi_sys_munmap(vbvaddr, size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                /*****************************************************************************/ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //将摄像头数据转换为为cv::Mat,sensor（rgb,chw）-&gt;cv::Mat（bgr，hwc）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cv::Mat image_r = cv::Mat(SENSOR_HEIGHT,SENSOR_WIDTH, CV_8UC1, vaddr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cv::Mat image_g = cv::Mat(SENSOR_HEIGHT,SENSOR_WIDTH, CV_8UC1, vaddr+SENSOR_HEIGHT*SENSOR_WIDTH);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cv::Mat image_b = cv::Mat(SENSOR_HEIGHT,SENSOR_WIDTH, CV_8UC1, vaddr+2*SENSOR_HEIGHT*SENSOR_WIDTH);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            std::vector&lt;cv::Mat&gt; color_vec(3);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            color_vec.clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            color_vec.push_back(image_b);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            color_vec.push_back(image_g);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            color_vec.push_back(image_r);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cv::merge(color_vec, ori_img);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /***************************unfixed：不同AI Demo可能需要修改******************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // pre_process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cv::Mat pre_process_img;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cv::Mat rgb_img;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cv::cvtColor(ori_img, rgb_img, cv::COLOR_BGR2RGB);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cv::resize(rgb_img, pre_process_img, cv::Size(kmodel_input_width, kmodel_input_height), cv::INTER_LINEAR);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /*****************************************************************************/  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set kmodel input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            runtime_tensor tensor0 = kmodel_interp.input_tensor(0).expect(&quot;cannot get input tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            auto in_buf = tensor0.impl()-&gt;to_host().unwrap()-&gt;buffer().as_host().unwrap().map(map_access_::map_write).unwrap().buffer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memcpy(reinterpret_cast&lt;unsigned char *&gt;(in_buf.data()), pre_process_img.data,sizeof(uint8_t)* kmodel_input_height * kmodel_input_width * 3);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            hrt::sync(tensor0, sync_op_t::sync_write_back, true).expect(&quot;sync write_back failed&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // kmodel run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kmodel_interp.run().expect(&quot;error occurred in running model&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // get kmodel output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vector&lt;float *&gt; k_outputs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int i = 0; i &lt; kmodel_interp.outputs_size(); i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                auto out = kmodel_interp.output_tensor(i).expect(&quot;cannot get output tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                auto buf = out.impl()-&gt;to_host().unwrap()-&gt;buffer().as_host().unwrap().map(map_access_::map_read).unwrap().buffer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                float *p_out = reinterpret_cast&lt;float *&gt;(buf.data());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                k_outputs.push_back(p_out);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /***************************unfixed：不同AI Demo可能需要修改******************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //post process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        results.clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            float* output0 = k_outputs[0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            float sum = 0.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int i = 0; i &lt; labels.size(); i++){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sum += exp(output0[i]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int max_index;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int i = 0; i &lt; labels.size(); i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                output0[i] = exp(output0[i]) / sum;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            max_index = std::max_element(output0,output0+labels.size()) - output0; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cls_res b;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (output0[max_index] &gt;= cls_thresh)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                b.label = labels[max_index];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                b.score = output0[max_index];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                results.push_back(b);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /*****************************************************************************/    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // draw result to vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                cv::Mat osd_frame(osd_height, osd_width, CV_8UC4, cv::Scalar(0, 0, 0, 0));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         /***************************unfixed：不同AI Demo可能需要修改******************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //draw cls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    double fontsize = (osd_frame.cols * osd_frame.rows * 1.0) / (1100 * 1200);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    for(int i = 0; i &lt; results.size(); i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    {   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        std::string text = &quot;class: &quot; + results[i].label + &quot;, score: &quot; + std::to_string(round(results[i].score * 100) / 100.0).substr(0, 4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        cv::putText(osd_frame, text, cv::Point(1, 40), cv::FONT_HERSHEY_SIMPLEX, 0.8, cv::Scalar(255, 255, 255, 0), 2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        std::cout &lt;&lt; text &lt;&lt; std::endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    /*****************************************************************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           /***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                memcpy(pic_vaddr, osd_frame.data, osd_width * osd_height * 4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // insert osd to vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                kd_mpi_vo_chn_insert_frame(osd_id+3, &amp;vf_info);  //K_VO_OSD0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;kd_mpi_vo_chn_insert_frame success \n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 释放sensor当前帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = kd_mpi_vicap_dump_release(vicap_dev, VICAP_CHN_ID_1, &amp;dump_info);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;sample_vicap...kd_mpi_vicap_dump_release failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /*****************************************************************************/ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vo_osd_release_block();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vivcap_stop();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // free memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = kd_mpi_sys_mmz_free(paddr, vaddr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std::cerr &lt;&lt; &quot;free failed: ret = &quot; &lt;&lt; ret &lt;&lt; &quot;, errno = &quot; &lt;&lt; strerror(errno) &lt;&lt; std::endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std::abort();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /*****************************************************************************/ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main(int argc, char *argv[])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     std::cout &lt;&lt; &quot;case &quot; &lt;&lt; argv[0] &lt;&lt; &quot; built at &quot; &lt;&lt; __DATE__ &lt;&lt; &quot; &quot; &lt;&lt; __TIME__ &lt;&lt; std::endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (argc != 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cout &lt;&lt; &quot;模型推理时传参说明：&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         &lt;&lt; &quot;&lt;kmodel_path&gt;&quot; &lt;&lt; endl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         &lt;&lt; &quot;Options:&quot; &lt;&lt; endl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         &lt;&lt; &quot;  kmodel_path     Kmodel的路径\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         &lt;&lt; &quot;\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         &lt;&lt; endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /***************************fixed：无需修改***********************************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::thread thread_isp(video_proc_cls, argv);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (getchar() != &#x27;q&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        usleep(10000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    isp_stop = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    thread_isp.join();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /*****************************************************************************/ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="52-基于ulabmicropython的ai推理流程">5.2 基于ulab(MicroPython)的AI推理流程<a href="#52-基于ulabmicropython的ai推理流程" class="hash-link" aria-label="Direct link to 5.2 基于ulab(MicroPython)的AI推理流程" title="Direct link to 5.2 基于ulab(MicroPython)的AI推理流程">​</a></h2>
<p>基于ulab（MicroPython）的K230 AI推理，简要介绍了使用MicroPython语言实现的视频采集，图像预处理（ulab），模型推理、后处理（ulab）、显示等过程。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="521-视频采集">5.2.1 视频采集<a href="#521-视频采集" class="hash-link" aria-label="Direct link to 5.2.1 视频采集" title="Direct link to 5.2.1 视频采集">​</a></h3>
<p><strong>视频采集</strong>：（视频输入，VI）与摄像头相关，本小节简要介绍基于Micropython的摄像头设置、摄像头启动、从摄像头中获取一帧数据、摄像头停止的整体流程。</p>
<p><strong>创建摄像头sensor对象，并设置多路输出格式和大小</strong>：</p>
<ul>
<li>设置的sensor两路输出；</li>
<li>一路输出用于显示，输出大小设置1080p，图像格式为PIXEL_FORMAT_YVU_PLANAR_420，直接绑定到vo；</li>
<li>另一路输出用于AI计算，输出大小（1280,720）,图像格式为PIXEL_FORMAT_RGB_888_PLANAR；</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.sensor import * #导入sensor模块，使用sensor相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.display import * #导入display模块，使用display相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import * #导入media模块，使用meida相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 显示输出大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DISPLAY_WIDTH = ALIGN_UP(1920, 16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DISPLAY_HEIGHT = 1080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># AI获取的RGB888P的图像大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OUT_RGB888P_WIDTH = ALIGN_UP(1280, 16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OUT_RGB888P_HEIGH = 720</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def sensor_init():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化并配置sensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor = Sensor()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.reset()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_hmirror(False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置翻转</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_vflip(False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 通道0直接给到显示VO，格式为YUV420</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_framesize(width = DISPLAY_WIDTH, height = DISPLAY_HEIGHT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_pixformat(PIXEL_FORMAT_YUV_SEMIPLANAR_420)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 通道2给到AI做算法处理，格式为RGB888</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_framesize(width = OUT_RGB888P_WIDTH , height = OUT_RGB888P_HEIGH, chn=CAM_CHN_ID_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_pixformat(PIXEL_FORMAT_RGB_888_PLANAR, chn=CAM_CHN_ID_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# 绑定通道0的输出到vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor_bind_info = sensor.bind_info(x = 0, y = 0, chn = CAM_CHN_ID_0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Display.bind_layer(**sensor_bind_info, layer = Display.LAYER_VIDEO1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置为LT9611显示，默认1920x1080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Display.init(Display.LT9611, to_ide = True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # media初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MediaManager.init()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 启动sensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sensor.run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rgb888p_img = None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while  True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            #捕获摄像头数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            rgb888p_img = sensor.snapshot(chn=CAM_CHN_ID_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            #************拿到一帧图像后可以进行后续AI过程************</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            #                      ......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            #***************************************************</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print(f&quot;An error occurred during running: {e}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        os.exitpoint(os.EXITPOINT_ENABLE_SLEEP)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #停止摄像头输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sensor.stop()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #去初始化显示设备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Display.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #释放媒体缓冲区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MediaManager.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nn.shrink_memory_pool()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sensor_init()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="522-预处理">5.2.2 预处理<a href="#522-预处理" class="hash-link" aria-label="Direct link to 5.2.2 预处理" title="Direct link to 5.2.2 预处理">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.sensor import * #导入camera模块，使用camera相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.display import * #导入display模块，使用display相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import * #导入media模块，使用meida相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn #导入nn模块，使用nn相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np #导入np模块，使用np相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 显示输出大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DISPLAY_WIDTH = ALIGN_UP(1920, 16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DISPLAY_HEIGHT = 1080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># AI获取的RGB888P的图像大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OUT_RGB888P_WIDTH = ALIGN_UP(1280, 16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OUT_RGB888P_HEIGH = 720</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def cls_test():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;cls_test start&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #初始化AI2D</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d = nn.ai2d()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置ai2d的输入输出数据格式和数据类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d.set_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置resize预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d.set_resize_param(True, nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 构建预处理,参数为输入输出tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_builder = ai2d.build([1,3,OUT_RGB888P_HEIGH,OUT_RGB888P_WIDTH], [1,3,224,224])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化并配置sensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor = Sensor()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.reset()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_hmirror(False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置翻转</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_vflip(False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 通道0直接给到显示VO，格式为YUV420</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_framesize(width = DISPLAY_WIDTH, height = DISPLAY_HEIGHT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_pixformat(PIXEL_FORMAT_YUV_SEMIPLANAR_420)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 通道2给到AI做算法处理，格式为RGB888</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_framesize(width = OUT_RGB888P_WIDTH , height = OUT_RGB888P_HEIGH, chn=CAM_CHN_ID_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_pixformat(PIXEL_FORMAT_RGB_888_PLANAR, chn=CAM_CHN_ID_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# 绑定通道0的输出到vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor_bind_info = sensor.bind_info(x = 0, y = 0, chn = CAM_CHN_ID_0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Display.bind_layer(**sensor_bind_info, layer = Display.LAYER_VIDEO1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置为LT9611显示，默认1920x1080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Display.init(Display.LT9611, to_ide = True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # media初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MediaManager.init()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 启动sensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sensor.run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rgb888p_img = None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while  True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            #捕获摄像头数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            rgb888p_img = sensor.snapshot(chn=CAM_CHN_ID_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # for rgb888planar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if rgb888p_img.format() == image.RGBP888:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # image转numpy.ndarray</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ai2d_input = rgb888p_img.to_numpy_ref()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 从numpy.ndarray创建tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ai2d_input_tensor = nn.from_numpy(ai2d_input)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 初始化预处理输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                data = np.ones((1,3,224,224),dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # numpy.ndarray转tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ai2d_out = nn.from_numpy(data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 执行预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ai2d_builder.run(ai2d_input_tensor, ai2d_out)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # tensor转numpy.ndarray</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ai2d_out_np=ai2d_out.to_numpy()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 打印预处理形状</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                print(ai2d_out_np.shape)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print(f&quot;An error occurred during running: {e}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        os.exitpoint(os.EXITPOINT_ENABLE_SLEEP)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #停止摄像头输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sensor.stop()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #去初始化显示设备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Display.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #释放媒体缓冲区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MediaManager.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        time.sleep(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nn.shrink_memory_pool()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;cls_test end&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cls_test()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>注</strong>：对于该分类模型来说，需要先拿到原图，再将原图resize到（224,224）大小，之后再喂给模型；对于micropython开发，resize可以使用ai2d模块实现。</p>
<p>我们也可以将喂给AI的摄像头数据分辨率直接设置为（224,224），代码如下：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.sensor import * #导入camera模块，使用camera相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.display import * #导入display模块，使用display相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import * #导入media模块，使用meida相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn #导入nn模块，使用nn相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np #导入np模块，使用np相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DISPLAY_WIDTH = ALIGN_UP(1920, 16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DISPLAY_HEIGHT = 1080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OUT_RGB888P_WIDTH = ALIGN_UP(224, 16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OUT_RGB888P_HEIGH = 224</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def cls_test():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;cls_test start&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化并配置sensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor = Sensor()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.reset()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_hmirror(False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置翻转</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_vflip(False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 通道0直接给到显示VO，格式为YUV420</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_framesize(width = DISPLAY_WIDTH, height = DISPLAY_HEIGHT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_pixformat(PIXEL_FORMAT_YUV_SEMIPLANAR_420)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 通道2给到AI做算法处理，格式为RGB888</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_framesize(width = OUT_RGB888P_WIDTH , height = OUT_RGB888P_HEIGH, chn=CAM_CHN_ID_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_pixformat(PIXEL_FORMAT_RGB_888_PLANAR, chn=CAM_CHN_ID_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# 绑定通道0的输出到vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor_bind_info = sensor.bind_info(x = 0, y = 0, chn = CAM_CHN_ID_0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Display.bind_layer(**sensor_bind_info, layer = Display.LAYER_VIDEO1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置为LT9611 显示，默认1920x1080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Display.init(Display.LT9611, to_ide = True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # media初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MediaManager.init()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 启动sensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sensor.run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rgb888p_img = None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while  True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            #捕获摄像头数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            rgb888p_img = sensor.snapshot(chn=CAM_CHN_ID_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # for rgb888planar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if rgb888p_img.format() == image.RGBP888:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                input_img=rgb888p_img.to_numpy_ref()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 打印形状</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                print(input_img.shape)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print(f&quot;An error occurred during running: {e}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        os.exitpoint(os.EXITPOINT_ENABLE_SLEEP)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #停止摄像头输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sensor.stop()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #去初始化显示设备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Display.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #释放媒体缓冲区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MediaManager.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        time.sleep(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nn.shrink_memory_pool()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;cls_test end&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cls_test()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="523-模型推理">5.2.3 模型推理<a href="#523-模型推理" class="hash-link" aria-label="Direct link to 5.2.3 模型推理" title="Direct link to 5.2.3 模型推理">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.sensor import * #导入camera模块，使用camera相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.display import * #导入display模块，使用display相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import * #导入media模块，使用meida相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn #导入nn模 块，使用nn相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np #导入np模块，使用np相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 显示输出大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DISPLAY_WIDTH = ALIGN_UP(1920, 16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DISPLAY_HEIGHT = 1080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># AI获取的RGB888P的图像大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OUT_RGB888P_WIDTH = ALIGN_UP(1280, 16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OUT_RGB888P_HEIGH = 720</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kmodel_path=&quot;/sdcard/app/tests/ai_test_kmodel/veg_cls.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def cls_test():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;cls_test start&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #初始化AI2D</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d = nn.ai2d()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置ai2d的输入输出数据格式和数据类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d.set_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置resize预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d.set_resize_param(True, nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 构建预处理,参数为输入输出tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_builder = ai2d.build([1,3,OUT_RGB888P_HEIGH,OUT_RGB888P_WIDTH], [1,3,224,224])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化kpu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kpu=nn.kpu()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 加载模型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kpu.load_kmodel(kmodel_path)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化并配置sensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor = Sensor()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.reset()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_hmirror(False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置翻转</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_vflip(False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 通道0直接给到显示VO，格式为YUV420</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_framesize(width = DISPLAY_WIDTH, height = DISPLAY_HEIGHT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_pixformat(PIXEL_FORMAT_YUV_SEMIPLANAR_420)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 通道2给到AI做算法处理，格式为RGB888</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_framesize(width = OUT_RGB888P_WIDTH , height = OUT_RGB888P_HEIGH, chn=CAM_CHN_ID_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_pixformat(PIXEL_FORMAT_RGB_888_PLANAR, chn=CAM_CHN_ID_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# 绑定通道0的输出到vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor_bind_info = sensor.bind_info(x = 0, y = 0, chn = CAM_CHN_ID_0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Display.bind_layer(**sensor_bind_info, layer = Display.LAYER_VIDEO1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置为LT9611显示，默认1920x1080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Display.init(Display.LT9611, to_ide = True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # media初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MediaManager.init()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 启动sensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sensor.run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rgb888p_img = None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 初始化预处理输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data = np.ones((1,3,224,224),dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # numpy.ndarray转tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ai2d_out = nn.from_numpy(data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 将ai2d预处理的输出绑定到kmodel的输入上，即ai2d预处理输出和kpu的输出共用一个tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kpu.set_input_tensor(0,ai2d_out)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while  True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            #捕获摄像头数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            rgb888p_img = sensor.snapshot(chn=CAM_CHN_ID_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # for rgb888planar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if rgb888p_img.format() == image.RGBP888:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # image转numpy.ndarray</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ai2d_input = rgb888p_img.to_numpy_ref()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 从numpy.ndarray创建tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ai2d_input_tensor = nn.from_numpy(ai2d_input)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 执行预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ai2d_builder.run(ai2d_input_tensor, ai2d_out)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # kpu推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                kpu.run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 获取kmodel的推理输出tensor,输出可能为多个，因此返回的是一个列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                results=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for i in range(kpu.outputs_size()):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # 获取kmodel的第i个输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    output_data = kpu.get_output_tensor(i)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # tensor转numpy.ndarray</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    result = output_data.to_numpy()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # 打印形状</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    print(result.shape)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # 加入列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    results.append(result)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    del output_data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print(f&quot;An error occurred during running: {e}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        os.exitpoint(os.EXITPOINT_ENABLE_SLEEP)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        del ai2d_input_tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        del ai2d_out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #停止摄像头输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sensor.stop()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #去初始化显示设备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Display.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #释放媒体缓冲区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MediaManager.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        time.sleep(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nn.shrink_memory_pool()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;cls_test end&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cls_test()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>注意：对于tensor类型的数据，申请后请手动释放。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="524-后处理">5.2.4 后处理<a href="#524-后处理" class="hash-link" aria-label="Direct link to 5.2.4 后处理" title="Direct link to 5.2.4 后处理">​</a></h3>
<p>对模型结果进行后处理，这里以分类为例，即对输出先做softmax再做argmax得到类别索引。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.sensor import * #导入camera模块，使用camera相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.display import * #导入display模块，使用display相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import * #导入media模块，使用meida相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn #导入nn模块，使用nn相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np #导入np模块，使用np相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 显示输出大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DISPLAY_WIDTH = ALIGN_UP(1920, 16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DISPLAY_HEIGHT = 1080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># AI获取的RGB888P的图像大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OUT_RGB888P_WIDTH = ALIGN_UP(1280, 16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OUT_RGB888P_HEIGH = 720</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kmodel_path=&quot;/sdcard/app/tests/ai_test_kmodel/veg_cls.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># softmax函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def softmax(x):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exp_x = np.exp(x - np.max(x))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return exp_x / np.sum(exp_x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def cls_test():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;cls_test start&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #初始化AI2D</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d = nn.ai2d()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置ai2d的输入输出数据格式和数据类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d.set_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置resize预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d.set_resize_param(True, nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 构建预处理,参数为输入输出tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_builder = ai2d.build([1,3,OUT_RGB888P_HEIGH,OUT_RGB888P_WIDTH], [1,3,224,224])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化kpu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kpu=nn.kpu()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 加载模型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kpu.load_kmodel(kmodel_path)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化并配置sensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor = Sensor()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.reset()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_hmirror(False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置翻转</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_vflip(False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 通道0直接给到显示VO，格式为YUV420</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_framesize(width = DISPLAY_WIDTH, height = DISPLAY_HEIGHT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_pixformat(PIXEL_FORMAT_YUV_SEMIPLANAR_420)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 通道2给到AI做算法处理，格式为RGB888</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_framesize(width = OUT_RGB888P_WIDTH , height = OUT_RGB888P_HEIGH, chn=CAM_CHN_ID_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_pixformat(PIXEL_FORMAT_RGB_888_PLANAR, chn=CAM_CHN_ID_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# 绑定通道0的输出到vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor_bind_info = sensor.bind_info(x = 0, y = 0, chn = CAM_CHN_ID_0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Display.bind_layer(**sensor_bind_info, layer = Display.LAYER_VIDEO1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置为LT9611显示，默认1920x1080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Display.init(Display.LT9611, to_ide = True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # media初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MediaManager.init()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 启动sensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sensor.run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rgb888p_img = None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 初始化预处理输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data = np.ones((1,3,224,224),dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # numpy.ndarray转tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ai2d_out = nn.from_numpy(data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 将ai2d预处理的输出绑定到kmodel的输入上，即ai2d预处理输出和kpu的输出共用一个tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kpu.set_input_tensor(0,ai2d_out)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while  True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            #捕获摄像头数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            rgb888p_img = sensor.snapshot(chn=CAM_CHN_ID_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # for rgb888planar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if rgb888p_img.format() == image.RGBP888:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # image转numpy.ndarray</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ai2d_input = rgb888p_img.to_numpy_ref()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 从numpy.ndarray创建tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ai2d_input_tensor = nn.from_numpy(ai2d_input)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 执行预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ai2d_builder.run(ai2d_input_tensor, ai2d_out)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # kpu推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                kpu.run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 获取kmodel的推理输出tensor,输出可能为多个，因此返回的是一个列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                results=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for i in range(kpu.outputs_size()):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # 获取kmodel的第i个输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    output_data = kpu.get_output_tensor(i)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # tensor转numpy.ndarray</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    result = output_data.to_numpy()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # 加入列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    results.append(result)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    del output_data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                #******************后处理********************</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # softmax+argmax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                softmax_res=softmax(results[0][0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                res_idx=np.argmax(softmax_res)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 打印类别索引</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                print(res_idx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print(f&quot;An error occurred during running: {e}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        os.exitpoint(os.EXITPOINT_ENABLE_SLEEP)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        del ai2d_input_tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        del ai2d_out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #停止摄像头输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sensor.stop()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #去初始化显示设备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Display.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #释放媒体缓冲区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MediaManager.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        time.sleep(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nn.shrink_memory_pool()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;cls_test end&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cls_test()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="525-显示">5.2.5 显示<a href="#525-显示" class="hash-link" aria-label="Direct link to 5.2.5 显示" title="Direct link to 5.2.5 显示">​</a></h3>
<p>显示（视频输出，VO）与display相关，本小节简要介绍基于Micropython的显示设置、资源释放、显示叠加的整体流程。</p>
<ul>
<li>显示设置：设置显示大小，格式</li>
<li>显示叠加：显示由2个图层构成，其中下边的图层（原图图层）直接显示摄像头输出，上边的图层（osd图层）用于画框、画点，写文字等。</li>
<li>资源释放：释放显示相关资源</li>
</ul>
<p><strong>显示示例</strong>：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.sensor import * #导入camera模块，使用camera相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.display import * #导入display模块，使用display相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import * # 导入media模块，使用meida相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn #导入nn模块，使用nn相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np #导入np模块，使用np相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 显示输出大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DISPLAY_WIDTH = ALIGN_UP(1920, 16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DISPLAY_HEIGHT = 1080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># AI获取的RGB888P的图像大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OUT_RGB888P_WIDTH = ALIGN_UP(1280, 16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OUT_RGB888P_HEIGH = 720</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kmodel_path=&quot;/sdcard/app/tests/ai_test_kmodel/veg_cls.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">labels=[&quot;菠菜&quot;,&quot;长茄子&quot;,&quot;红苋菜&quot;,&quot;胡萝卜&quot;,&quot;西红柿&quot;,&quot;西蓝花&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># softmax函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def softmax(x):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exp_x = np.exp(x - np.max(x))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return exp_x / np.sum(exp_x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def cls_test():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;cls_test start&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #初始化AI2D</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d = nn.ai2d()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置ai2d的输入输出数据格式和数据类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d.set_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置resize预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d.set_resize_param(True, nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 构建预处理,参数为输入输出tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_builder = ai2d.build([1,3,OUT_RGB888P_HEIGH,OUT_RGB888P_WIDTH], [1,3,224,224])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化kpu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kpu=nn.kpu()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 加载模型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kpu.load_kmodel(kmodel_path)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化并配置sensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor = Sensor()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.reset()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_hmirror(False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置翻转</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_vflip(False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 通道0直接给到显示VO，格式为YUV420</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_framesize(width = DISPLAY_WIDTH, height = DISPLAY_HEIGHT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_pixformat(PIXEL_FORMAT_YUV_SEMIPLANAR_420)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 通道2给到AI做算法处理，格式为RGB888</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_framesize(width = OUT_RGB888P_WIDTH , height = OUT_RGB888P_HEIGH, chn=CAM_CHN_ID_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_pixformat(PIXEL_FORMAT_RGB_888_PLANAR, chn=CAM_CHN_ID_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# 绑定通道0的输出到vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor_bind_info = sensor.bind_info(x = 0, y = 0, chn = CAM_CHN_ID_0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Display.bind_layer(**sensor_bind_info, layer = Display.LAYER_VIDEO1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置为LT9611显示，默认1920x1080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Display.init(Display.LT9611, to_ide = True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #创建OSD图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    osd_img = image.Image(DISPLAY_WIDTH, DISPLAY_HEIGHT, image.ARGB8888)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # media初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MediaManager.init()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 启动sensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sensor.run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rgb888p_img = None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 初始化预处理输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data = np.ones((1,3,224,224),dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # numpy.ndarray转tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ai2d_out = nn.from_numpy(data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 将ai2d预处理的输出绑定到kmodel的输入上，即ai2d预处理输出和kpu的输出共用一个tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kpu.set_input_tensor(0,ai2d_out)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while  True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            #捕获摄像头数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            rgb888p_img = sensor.snapshot(chn=CAM_CHN_ID_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # for rgb888planar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if rgb888p_img.format() == image.RGBP888:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                #*************************预处理***********************</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # image转numpy.ndarray</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ai2d_input = rgb888p_img.to_numpy_ref()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 从numpy.ndarray创建tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ai2d_input_tensor = nn.from_numpy(ai2d_input)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 执行预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ai2d_builder.run(ai2d_input_tensor, ai2d_out)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                #************************模型推理**********************</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # kpu推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                kpu.run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 获取kmodel的推理输出tensor,输出可能为多个，因此返回的是一个列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                results=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for i in range(kpu.outputs_size()):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # 获取kmodel的第i个输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    output_data = kpu.get_output_tensor(i)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # tensor转numpy.ndarray</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    result = output_data.to_numpy()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # 加入列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    results.append(result)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    del output_data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                #******************后处理********************</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # softmax+argmax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                softmax_res=softmax(results[0][0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                res_idx=np.argmax(softmax_res)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                #******************显示*********************</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 类别名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                label=labels[res_idx]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 类别分数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                score=softmax_res[res_idx]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 绘制文字</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                text=label+&quot; &quot;+str(score)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 清理osd_img</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 调用draw_string_advanced()在(5,5)位置，绘制text，文字大小为32，颜色为(0,255,0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                osd_img.draw_string_advanced(5,5,32,text,color=(0,255,0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Display.show_image(osd_img, 0, 0, Display.LAYER_OSD3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print(f&quot;An error occurred during running: {e}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        os.exitpoint(os.EXITPOINT_ENABLE_SLEEP)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        del ai2d_input_tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        del ai2d_out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        del kpu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #停止摄像头输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sensor.stop()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #去初始化显示设备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Display.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #释放媒体缓冲区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MediaManager.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        time.sleep(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nn.shrink_memory_pool()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;cls_test end&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cls_test()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="526-资源释放">5.2.6 资源释放<a href="#526-资源释放" class="hash-link" aria-label="Direct link to 5.2.6 资源释放" title="Direct link to 5.2.6 资源释放">​</a></h3>
<p>大核内存包括两个部分，一个是系统内存，一个是 GC 内存，前者主要用来给模型还有系统内的一些功能使用，包括摄像头和屏幕的缓冲区、kmodel及其输入输出都来自这里（mmz，用del释放）；后者是解析器层面申请的内存，可以给代码的变量使用（用gc.collect()释放）。</p>
<p><strong>1. gc资源释放</strong>：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#classification.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def func_a():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    a = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for i in range(10000):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        a.append(i)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func_a()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print(gc.mem_free() / 1024 / 1024) #stack mem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print(gc.mem_alloc() / 1024 / 1024)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print(gc.mem_alloc() / 1024 / 1024)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>2.系统内存释放</strong>：</p>
<p>kmodel模块部分，kmodel的input_tensor、output_tensor，及其本身都是mmz申请的内存，需要手动释放</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">del ai2d_input_tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">del ai2d_out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">del kpu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nn.shrink_memory_pool()       #以免漏掉某个del,遍历所有kmodel相关内存，并释放</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>摄像头、显示及其media缓冲区释放：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#停止摄像头输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sensor.stop()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#去初始化显示设备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Display.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#释放媒体缓冲区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MediaManager.deinit()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="527-完整代码">5.2.7 完整代码<a href="#527-完整代码" class="hash-link" aria-label="Direct link to 5.2.7 完整代码" title="Direct link to 5.2.7 完整代码">​</a></h3>
<p>这里给出完整代码，请参考上述每一步代码之间的变化。对于AI开发的步骤我们进行了封装，相关类在/sdcard/app/libs下面，开发步骤请参考：<a href="https://developer.canaan-creative.com/k230_canmv/main/zh/example/AI_Demo%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3.html" target="_blank" rel="noopener noreferrer">AI Demo说明文档 — K230 CanMV 文档 (canaan-creative.com)</a></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.sensor import * #导入camera模块，使用camera相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.display import * #导入display模块，使用display相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from media.media import * #导入media模块，使用meida相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from time import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import nncase_runtime as nn #导入nn模块，使用nn相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import ulab.numpy as np #导入np模块，使用np相关接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 显示输出大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DISPLAY_WIDTH = ALIGN_UP(1920, 16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DISPLAY_HEIGHT = 1080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># AI获取的RGB888P的图像大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OUT_RGB888P_WIDTH = ALIGN_UP(1280, 16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OUT_RGB888P_HEIGH = 720</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kmodel_path=&quot;/sdcard/app/tests/ai_test_kmodel/veg_cls.kmodel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">labels=[&quot;菠菜&quot;,&quot;长茄子&quot;,&quot;红苋菜&quot;,&quot;胡萝卜&quot;,&quot;西红柿&quot;,&quot;西蓝花&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># softmax函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def softmax(x):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exp_x = np.exp(x - np.max(x))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return exp_x / np.sum(exp_x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def cls_test():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;cls_test start&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #初始化AI2D</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d = nn.ai2d()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置ai2d的输入输出数据格式和数据类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d.set_dtype(nn.ai2d_format.NCHW_FMT,nn.ai2d_format.NCHW_FMT,np.uint8, np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置resize预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d.set_resize_param(True, nn.interp_method.tf_bilinear, nn.interp_mode.half_pixel )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 构建预处理,参数为输入输出tensor的shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_builder = ai2d.build([1,3,OUT_RGB888P_HEIGH,OUT_RGB888P_WIDTH], [1,3,224,224])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化kpu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kpu=nn.kpu()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 加载模型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kpu.load_kmodel(kmodel_path)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 初始化并配置sensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor = Sensor()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.reset()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_hmirror(False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置翻转</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_vflip(False)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 通道0直接给到显示VO，格式为YUV420</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_framesize(width = DISPLAY_WIDTH, height = DISPLAY_HEIGHT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_pixformat(PIXEL_FORMAT_YUV_SEMIPLANAR_420)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 通道2给到AI做算法处理，格式为RGB888</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_framesize(width = OUT_RGB888P_WIDTH , height = OUT_RGB888P_HEIGH, chn=CAM_CHN_ID_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor.set_pixformat(PIXEL_FORMAT_RGB_888_PLANAR, chn=CAM_CHN_ID_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# 绑定通道0的输出到vo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sensor_bind_info = sensor.bind_info(x = 0, y = 0, chn = CAM_CHN_ID_0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Display.bind_layer(**sensor_bind_info, layer = Display.LAYER_VIDEO1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 设置为LT9611显示，默认1920x1080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Display.init(Display.LT9611, to_ide = True)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #创建OSD图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    osd_img = image.Image(DISPLAY_WIDTH, DISPLAY_HEIGHT, image.ARGB8888)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # media初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MediaManager.init()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 启动sensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sensor.run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rgb888p_img = None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 初始化预处理输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data = np.ones((1,3,224,224),dtype=np.uint8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # numpy.ndarray转tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ai2d_out = nn.from_numpy(data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 将ai2d预处理的输出绑定到kmodel的输入上，即ai2d预处理输出和kpu的输出共用一个tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kpu.set_input_tensor(0,ai2d_out)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while  True:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            #捕获摄像头数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            rgb888p_img = sensor.snapshot(chn=CAM_CHN_ID_2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            # for rgb888planar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if rgb888p_img.format() == image.RGBP888:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                #*************************预处理***********************</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # image转numpy.ndarray</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ai2d_input = rgb888p_img.to_numpy_ref()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 从numpy.ndarray创建tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ai2d_input_tensor = nn.from_numpy(ai2d_input)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 执行预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ai2d_builder.run(ai2d_input_tensor, ai2d_out)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                #************************模型推理**********************</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # kpu推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                kpu.run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 获取kmodel的推理输出tensor,输出可能为多个，因此返回的是一个列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                results=[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for i in range(kpu.outputs_size()):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # 获取kmodel的第i个输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    output_data = kpu.get_output_tensor(i)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # tensor转numpy.ndarray</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    result = output_data.to_numpy()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    # 加入列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    results.append(result)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    del output_data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                #******************后处理********************</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # softmax+argmax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                softmax_res=softmax(results[0][0])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                res_idx=np.argmax(softmax_res)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                #******************显示*********************</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 类别名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                label=labels[res_idx]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 类别分数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                score=softmax_res[res_idx]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 绘制文字</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                text=label+&quot; &quot;+str(score)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 清理osd_img</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                osd_img.clear()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                # 调用draw_string_advanced()在(5,5)位置，绘制text，文字大小为32，颜色为(0,255,0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                osd_img.draw_string_advanced(5,5,32,text,color=(0,255,0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Display.show_image(osd_img, 0, 0, Display.LAYER_OSD3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        print(f&quot;An error occurred during running: {e}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        os.exitpoint(os.EXITPOINT_ENABLE_SLEEP)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        del ai2d_input_tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        del ai2d_out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #停止摄像头输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sensor.stop()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #去初始化显示设备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Display.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #释放媒体缓冲区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MediaManager.deinit()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gc.collect()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        time.sleep(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;cls_test end&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cls_test()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/CanaanK230/part4/05-Getstartedquicklyk230AIInferenceflow.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/CanaanK230/part4/K230FancyPOCOverview"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">4. K230 Fancy POC 概述</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/CanaanK230/part4/In-depthanalysisoftheAIdevelopmentprocess"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">6.深入解析AI开发流程</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#51-基于opencvc的ai推理流程" class="table-of-contents__link toc-highlight">5.1 基于OpenCV(C++)的AI推理流程</a><ul><li><a href="#511-视频采集" class="table-of-contents__link toc-highlight">5.1.1 视频采集</a></li><li><a href="#512-预处理" class="table-of-contents__link toc-highlight">5.1.2 预处理</a></li><li><a href="#513-模型推理" class="table-of-contents__link toc-highlight">5.1.3 模型推理</a></li><li><a href="#514-后处理" class="table-of-contents__link toc-highlight">5.1.4 后处理</a></li><li><a href="#515-显示" class="table-of-contents__link toc-highlight">5.1.5 显示</a></li><li><a href="#516-完整代码" class="table-of-contents__link toc-highlight">5.1.6 完整代码</a></li></ul></li><li><a href="#52-基于ulabmicropython的ai推理流程" class="table-of-contents__link toc-highlight">5.2 基于ulab(MicroPython)的AI推理流程</a><ul><li><a href="#521-视频采集" class="table-of-contents__link toc-highlight">5.2.1 视频采集</a></li><li><a href="#522-预处理" class="table-of-contents__link toc-highlight">5.2.2 预处理</a></li><li><a href="#523-模型推理" class="table-of-contents__link toc-highlight">5.2.3 模型推理</a></li><li><a href="#524-后处理" class="table-of-contents__link toc-highlight">5.2.4 后处理</a></li><li><a href="#525-显示" class="table-of-contents__link toc-highlight">5.2.5 显示</a></li><li><a href="#526-资源释放" class="table-of-contents__link toc-highlight">5.2.6 资源释放</a></li><li><a href="#527-完整代码" class="table-of-contents__link toc-highlight">5.2.7 完整代码</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://dongshanpi.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">DongshanPI<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://canaan-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Canaan-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://renesas-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Renesas-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://rtos.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">RTOS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://tina.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">TinaSDK-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://allwinner-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Allwinner-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://aw-r128.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">R128-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://space.bilibili.com/275908810" target="_blank" rel="noopener noreferrer" class="footer__link-item">BiliBili<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forums.100ask.net" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://video.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VideoCenter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/dongshanpi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://weidongshan.coding.net/public/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Coding<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/100askTeam" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gitee.com/weidongshan" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>