<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-CanaanK230/part4/Source-levelapplicationdevelopment" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">10. 源码级应用开发 | 正点原子</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://tm330075395.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://tm330075395.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://tm330075395.github.io/docs/CanaanK230/part4/Source-levelapplicationdevelopment"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="10. 源码级应用开发 | 正点原子"><meta data-rh="true" name="description" content="注："><meta data-rh="true" property="og:description" content="注："><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://tm330075395.github.io/docs/CanaanK230/part4/Source-levelapplicationdevelopment"><link data-rh="true" rel="alternate" href="https://tm330075395.github.io/docs/CanaanK230/part4/Source-levelapplicationdevelopment" hreflang="en"><link data-rh="true" rel="alternate" href="https://tm330075395.github.io/docs/CanaanK230/part4/Source-levelapplicationdevelopment" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="正点原子 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="正点原子 Atom Feed"><link rel="stylesheet" href="/assets/css/styles.ce37c9a8.css">
<script src="/assets/js/runtime~main.fcaa3de9.js" defer="defer"></script>
<script src="/assets/js/main.252b8acf.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">My Site</b></a><a class="navbar__item navbar__link" href="/docs/intro">Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/CanaanK230/Userdoc">CanMV-K230教程</a><a href="http://www.alientek.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">正点原子官网<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="http://www.openedv.com/forum.php" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">论坛<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tm330075395/tm330075395.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/CanaanK230/Userdoc">文档阅读指南</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/1开发板上手指南-1">1.开发板上手指南</a><button aria-label="Expand sidebar category &#x27;1.开发板上手指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/2开发环境搭建指南-1">2.开发环境搭建指南</a><button aria-label="Expand sidebar category &#x27;2.开发环境搭建指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/3嵌入式应用开发指南-1">3.嵌入式应用开发指南</a><button aria-label="Expand sidebar category &#x27;3.嵌入式应用开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/4ai应用开发指南-1">4.AI应用开发指南</a><button aria-label="Collapse sidebar category &#x27;4.AI应用开发指南&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/Introduction">1. 介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/K230Development">2 开发基础</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/K230AIDemoOverview">3. K230 AI Demo 概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/K230FancyPOCOverview">4. K230 Fancy POC 概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/Getstartedquicklyk230AIInferenceflow">5. 快速入门k230 AI推理流程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/In-depthanalysisoftheAIdevelopmentprocess">6.深入解析AI开发流程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/Introductiontodevelopmenttools">7. 开发工具简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/Developedusinganonlinecloudtrainingplatform">8. 使用在线云训练平台开发</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/DevelopedwithAICube">9. 使用AI Cube开发</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/CanaanK230/part4/Source-levelapplicationdevelopment">10. 源码级应用开发</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/CanCollectorPlus">11. CanCollectorPlus</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/SDKcorrespondstotheNNCASEversion">12. SDK和nncase版本对应</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/CanaanK230/part4/reference">13. 参考</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/5micropython应用开发指南-1">5.MicroPython应用开发指南</a><button aria-label="Expand sidebar category &#x27;5.MicroPython应用开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/6系统开发指南-1">6.系统开发指南</a><button aria-label="Expand sidebar category &#x27;6.系统开发指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/7sdk-api参考指南-1">7.SDK API参考指南</a><button aria-label="Expand sidebar category &#x27;7.SDK API参考指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/8常见问题-1">8.常见问题</a><button aria-label="Expand sidebar category &#x27;8.常见问题&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/4ai应用开发指南-1"><span itemprop="name">4.AI应用开发指南</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">10. 源码级应用开发</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>10. 源码级应用开发</h1></header>
<blockquote>
<p><strong>注：</strong></p>
<ul>
<li><strong>本章节使用SDK1.1.0版本和nncase2.4.0版本实现，后续更改请参考: <a href="https://github.com/kendryte/K230_training_scripts" target="_blank" rel="noopener noreferrer">kendryte/K230_training_scripts (github.com)</a></strong>。</li>
<li><strong>开发时需要注意版本对应，k230_sdk版本和nncase版本对应关系参考链接：<a href="https://developer.canaan-creative.com/k230/dev/zh/03_other/K230_SDK_nncase%E7%89%88%E6%9C%AC%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB.html" target="_blank" rel="noopener noreferrer">K230 SDK nncase版本对应关系 — K230 文档 (canaan-creative.com)</a>。</strong></li>
<li><strong>相关教学视频，见参考章节链接。</strong></li>
</ul>
</blockquote>
<p>本章节介绍了KTS(k230_training_scripts)工具的使用方法和模型上板部署过程。KTS提供了分类、检测、翻译、关键词唤醒共四个任务从训练到部署的源码，覆盖cv、nlp、语音等多个模态。用户对源码可见，感兴趣的用户可以对源码进行修改，实现更换数据集、更换模型等部分。本工具适合对深度学习的不同模态的任务有比较成熟的了解，并希望使用k230开发板完成部署的用户。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="101-使用kts实现图像分类任务">10.1 使用KTS实现图像分类任务<a href="#101-使用kts实现图像分类任务" class="hash-link" aria-label="Direct link to 10.1 使用KTS实现图像分类任务" title="Direct link to 10.1 使用KTS实现图像分类任务">​</a></h2>
<p>k230_training_scripts(KTS)提供了源码级的详细的k230开发案例，覆盖cv、nlp和audio相关的AI任务。KTS的github地址：<a href="https://github.com/kendryte/K230_training_scripts" target="_blank" rel="noopener noreferrer">kendryte/K230_training_scripts (github.com)</a>。KTS相比于上面的两个工具更为灵活，对用户的代码能力要求也更高，用户可以自行修改配置对应步骤，用户可以更换模型，调整参数，从源码实现k230应用的快速开发和部署。</p>
<p>使用KTS进行AI开发需要实现环境搭建、数据准备、模型训练和测试、CANMV k230镜像编译和烧录、C++代码编译、网络配置和文件传输、k230端部署等环节。以蔬菜分类场景为例，代码参见:<a href="https://github.com/kendryte/K230_training_scripts/tree/main/end2end_cls_doc" target="_blank" rel="noopener noreferrer">kendryte/K230_training_scripts</a>。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1011-环境搭建">10.1.1 环境搭建<a href="#1011-环境搭建" class="hash-link" aria-label="Direct link to 10.1.1 环境搭建" title="Direct link to 10.1.1 环境搭建">​</a></h3>
<p>（1）Linux系统；</p>
<p>（2）安装显卡驱动；</p>
<p>（3）安  装Anaconda，用于创建模型训练环境；</p>
<p>（4）安装Docker，用于创建SDK镜像编译环境；</p>
<p>（5）安装dotnet SDK;</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1012-数据准备">10.1.2 数据准备<a href="#1012-数据准备" class="hash-link" aria-label="Direct link to 10.1.2 数据准备" title="Direct link to 10.1.2 数据准备">​</a></h3>
<p>图像分类任务自定义数据集按照如下图格式组织：</p>
<p><img decoding="async" loading="lazy" alt="dataset_frame" src="/assets/images/dataset_frame-da8b29f1ce77dcb1aa7a936f132b7e4c.png" width="1214" height="729" class="img_ev3q"></p>
<p>注意：图像分类必须按照上述格式进行组织。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1013-模型训练和测试">10.1.3 模型训练和测试<a href="#1013-模型训练和测试" class="hash-link" aria-label="Direct link to 10.1.3 模型训练和测试" title="Direct link to 10.1.3 模型训练和测试">​</a></h3>
<p>本节内容在训练环境中实现。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10131-创建虚拟环境">10.1.3.1 创建虚拟环境<a href="#10131-创建虚拟环境" class="hash-link" aria-label="Direct link to 10.1.3.1 创建虚拟环境" title="Direct link to 10.1.3.1 创建虚拟环境">​</a></h4>
<p>开启命令终端：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">conda create -n myenv python=3.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">conda activate myenv</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10132-安装python依赖库">10.1.3.2 安装python依赖库<a href="#10132-安装python依赖库" class="hash-link" aria-label="Direct link to 10.1.3.2 安装python依赖库" title="Direct link to 10.1.3.2 安装python依赖库">​</a></h4>
<p>按照项目内的requriements.txt安装训练所用的python库,等待安装：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pip install -r requriements.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在requriments.txt中会安装模型转换的包nncase和nncase-kpu，nncase 是一个为 AI 加速器设计的神经网络编译器。</p>
<p>编译镜像和使用nncase转  换kmodel时请注意版本对应关系，k230_sdk版本和nncase版本对应关系参考下述链接：</p>
<p><strong><a href="https://developer.canaan-creative.com/k230/dev/zh/03_other/K230_SDK_nncase%E7%89%88%E6%9C%AC%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB.html" target="_blank" rel="noopener noreferrer">K230 SDK nncase版本对应关系 — K230 文档 (canaan-creative.com)</a></strong></p>
<p>您可以按照对应版本更换nncase和nncase-kpu的版本，比如更换nncase版本为2.7.0：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pip install nncase==2.7.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install nncase-kpu==2.7.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10133-配置训练参数">10.1.3.3 配置训练参数<a href="#10133-配置训练参数" class="hash-link" aria-label="Direct link to 10.1.3.3 配置训练参数" title="Direct link to 10.1.3.3 配置训练参数">​</a></h4>
<p>给出的训练脚本中配置文件yaml/config.yaml设置如下：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dataset:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  root_folder: ../data/veg_cls # 分类数据集路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  split: true # 是否重新执行拆分，第一次执行必须为true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  train_ratio: 0.7 # 训练集比例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val_ratio: 0.15 # 验证集比例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  test_ratio: 0.15 # 测试集比例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">train:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  device: cuda</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  txt_path: ../gen # 拆分过程生成的训练集、验证集、测试集txt文件，标签名称文件、校正集文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  image_size: [ 224,224 ] # 分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mean: [ 0.485, 0.456, 0.406 ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  std: [ 0.229, 0.224, 0.225 ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  epochs: 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  batchsize: 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  learningrate: 0.001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  save_path: ../checkpoints # 模型保存路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">inference:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mode: image # 推理模式，分为image和video; image模式下可推理单张图片和目录下所有图片，video调用摄像头实现推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  inference_model: best # 分为best和last，分别调用checkpoints下的best.pth和last.pth进行推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  images_path: ../data/veg_cls/bocai # 如果该路径为图片路径，则进行单张图片推理；如果该路径为目录，则对目录下所有图片进行推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deploy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  chip: k230 # 芯片类型，分为“k230”和“cpu”两种</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ptq_option: 0 # 量化类型，0为uint8，1，2，3，4为uint16的不同形式</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10134-模型训练">10.1.3.4 模型训练<a href="#10134-模型训练" class="hash-link" aria-label="Direct link to 10.1.3.4 模型训练" title="Direct link to 10.1.3.4 模型训练">​</a></h4>
<p>进入到工程的scripts目录，执行训练代码：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">python3 main.py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果训练成功，在配置文件的model_save_dir目录下可以找到训练好的last.pth、best.pth、best.onnx、best.kmodel。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10135-模型测试">10.1.3.5 模型测试<a href="#10135-模型测试" class="hash-link" aria-label="Direct link to 10.1.3.5 模型测试" title="Direct link to 10.1.3.5 模型测试">​</a></h4>
<p>设置配置文件中的inference部分，设置测试配置，执行测试代码：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">python3 inference.py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10136-准备文件">10.1.3.6 准备文件<a href="#10136-准备文件" class="hash-link" aria-label="Direct link to 10.1.3.6 准备文件" title="Direct link to 10.1.3.6 准备文件">​</a></h4>
<p>后面部署步骤需要用到的文件包括：</p>
<p>（1）checkpoints/best.kmodel;</p>
<p>（2）gen/labels.txt;</p>
<p>（3）待测试图片test.jpg;</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1014-k230_sdk镜像编译和烧录">10.1.4 K230_SDK镜像编译和烧录<a href="#1014-k230_sdk镜像编译和烧录" class="hash-link" aria-label="Direct link to 10.1.4 K230_SDK镜像编译和烧录" title="Direct link to 10.1.4 K230_SDK镜像编译和烧录">​</a></h3>
<p>编译镜像和使用nncase转换kmodel时请注意版本对应关系，k230_sdk版本和nncase版本对 应关系参考下述链接：</p>
<p><strong><a href="https://developer.canaan-creative.com/k230/dev/zh/03_other/K230_SDK_nncase%E7%89%88%E6%9C%AC%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB.html" target="_blank" rel="noopener noreferrer">K230 SDK nncase版本对应关系 — K230 文档 (canaan-creative.com)</a></strong></p>
<p>如果您选择使用<a href="https://developer.canaan-creative.com/resource" target="_blank" rel="noopener noreferrer">嘉楠开发者社区 (canaan-creative.com)</a>资料下载-&gt;K230-&gt;Images部分提供的镜像，请您注意版本对应关系下载烧录。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10141-docker环境搭建">10.1.4.1 Docker环境搭建<a href="#10141-docker环境搭建" class="hash-link" aria-label="Direct link to 10.1.4.1 Docker环境搭建" title="Direct link to 10.1.4.1 Docker环境搭建">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 下载docker编译镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull ghcr.io/kendryte/k230_sdk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 可以使用以下命令确认docker镜像是否拉取成功</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker images | grep ghcr.io/kendryte/k230_sdk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 下载sdk源码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/kendryte/k230_sdk.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd k230_sdk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 下载工具链Linux和RT-Smart toolchain, buildroot package, AI package等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make prepare_sourcecode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建docker容器，$(pwd):$(pwd)表示系统当前目录映射到docker容器内部的相同目录下，将系统下的工具链目录映射到docker容器内部的/opt/toolchain目录下</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -u root -it -v $(pwd):$(pwd) -v $(pwd)/toolchain:/opt/toolchain -w $(pwd) ghcr.io/kendryte/k230_sdk /bin/bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10142-镜像编译">10.1.4.2 镜像编译<a href="#10142-镜像编译" class="hash-link" aria-label="Direct link to 10.1.4.2 镜像编译" title="Direct link to 10.1.4.2 镜像编译">​</a></h4>
<p>如果您使用开发者社区下载的镜像，请在k230_sdk根目录下执行：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">make mpp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>该步骤相比于编译镜像耗时较短。</p>
<p>如果您不使用开发者社区的镜像，想体验镜像编译的完整过程，请在k230_sdk根目录下执行下述命令：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 在docker容器中编译镜像耗时较长，请耐心等待完成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make CONF=k230_canmv_defconfig</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10143-镜像烧录">10.1.4.3 镜像烧录<a href="#10143-镜像烧录" class="hash-link" aria-label="Direct link to 10.1.4.3 镜像烧录" title="Direct link to 10.1.4.3 镜像烧录">​</a></h4>
<p>编译结束后在output/k230_canmv_defconfig/images目录下可以找到编译好的镜像文件：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">k230_canmv_defconfig/images</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ├── big-core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ├── little-core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ├── sysimage-sdcard.img    # SD卡启动镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> └── sysimage-sdcard.img.gz # SD卡启动镜像压缩包</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>CANMV K230 支持SDCard启动方式。为方便开发，建议您准备一张TF卡(Micro SD卡)。</p>
<p><strong>Linux:</strong></p>
<p>在SD卡插到宿主机之前，输入：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ls -l /dev/sd\*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>查看当前的存储设备。</p>
<p>将TF卡插入宿主机后，再次输入：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ls -l /dev/sd\*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>查看此时的存储设备，新增加的就是TF卡设备节点。</p>
<p>假设/dev/sdc就是TF卡设备节点，执行如下命令烧录TF卡：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo dd if=sysimage-sdcard.img of=/dev/sdc bs=1M oflag=sync</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Windows:</strong></p>
<p>Windows下可通过rufus工具对TF卡进行烧录，<a href="http://rufus.ie/downloads/" target="_blank" rel="noopener noreferrer">rufus工具下载地址</a>。</p>
<p>1）将SD卡插入PC，然后启动rufus工具，点击工具界面的”选择”按钮，选择待烧写的固件。</p>
<p><img decoding="async" loading="lazy" alt="rufus-flash-from-file" src="/assets/images/rufus_select-d7997d7eaf258b707f384880887bda39.png" width="1533" height="806" class="img_ev3q"></p>
<p>2）点击“开始”按钮开始烧写，烧写过程有进度条展示，烧写结束后会提示“准备就绪”。</p>
<p><img decoding="async" loading="lazy" alt="rufus-flash" src="/assets/images/rufus_start-0365da8e19357ce420c4bd9ce05c93ba.png" width="591" height="792" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="rufus-sure" src="data:image/png;base64,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" width="682" height="259" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="rufus-warning" src="/assets/images/rufus_warning-02b4676d68826fbaa6733fd16c8bb305.png" width="685" height="284" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="rufus_finish" src="/assets/images/rufus_finish-ee9f7245b8722c20d46c1dd7a35e003d.png" width="593" height="804" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10144-上电启动开发板">10.1.4.4 上电启动开发板<a href="#10144-上电启动开发板" class="hash-link" aria-label="Direct link to 10.1.4.4 上电启动开发板" title="Direct link to 10.1.4.4 上电启动开发板">​</a></h4>
<p>安装MobaXterm实现串口通信，MobaXterm下载地址:<a href="https://mobaxterm.mobatek.net/" target="_blank" rel="noopener noreferrer">https://mobaxterm.mobatek.net</a>。</p>
<p><img decoding="async" loading="lazy" alt="CanMV-K230_debug" src="/assets/images/CanMV-K230_debug-a1d8f2863ff90f28e651b1ea555acb72.png" width="738" height="531" class="img_ev3q"></p>
<p>将烧录完成的SD卡插入进开板板卡槽中，HDMI输出连显示器，百兆网口连以太网，POWER连串口并供电。系统上电后，默认会有<strong>两个串口设备</strong>，可分别用于访问小核Linux和大核RTSmart</p>
<p>小核Linux默认用户名root，密码为空。大核RTSmart系统中开机会自动启动一个应用程序，可按<code>q</code>键退出至命令提示符终端。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1015-c代码编译">10.1.5 C++代码编译<a href="#1015-c代码编译" class="hash-link" aria-label="Direct link to 10.1.5 C++代码编译" title="Direct link to 10.1.5 C++代码编译">​</a></h3>
<p>完成上述开发板的准备工作后，我们可以使用C++编写自己的代码，下面以图像分类任务为例，给出相关图像分类任务的示例代码，并进行解析。示例代码参考:<a href="https://github.com/kendryte/K230_training_scripts/tree/main/end2end_cls_doc/k230_code" target="_blank" rel="noopener noreferrer">kendryte/K230_training_scripts</a>。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10151-代码结构">10.1.5.1 代码结构<a href="#10151-代码结构" class="hash-link" aria-label="Direct link to 10.1.5.1 代码结构" title="Direct link to 10.1.5.1 代码结构">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">k230_code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── cmake</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ├── link.lds #链接脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ├── Riscv64.cmake</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── k230_deploy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ├── ai_base.cc # 模型部署基类实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ├── ai_base.h # 模型部署基类，封装了nncase加载、input设置、模型推理、获取output操作，后续具体任务开发只需关注模型的前处理、后处理即可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ├── classification.cc # 图像分类code类实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ├── classification.h # 图像分类任务类定义，继承AIBase，用于封装模型推理的前后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ├── main.cc # 主函数，参数解析，初始化Classification类示例，实现上板功能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ├── scoped_timing.hpp # 时间测试工具</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ├── utils.cc # 工具类实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ├── utils.h # 工具类, 封装了图像预处理和图像分类的常用函数，包括读取二进制文件、保存图片、图像处理、结果绘制等，用户可根据自己需求丰富该文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ├── vi_vo.h # 视频输入输出头文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ├── CMakeLists.txt # CMake脚本用于构建一个使用C/C++源文件的可执行文件，并链接到各种库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── build_app.sh # 编译脚本，使用交叉编译工具链编译k230_deploy工程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── CMakeLists.txt # CMake脚本用于构建 nncase_sdk 的项目工程</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10152-核心代码">10.1.5.2 核心代码<a href="#10152-核心代码" class="hash-link" aria-label="Direct link to 10.1.5.2 核心代码" title="Direct link to 10.1.5.2 核心代码">​</a></h4>
<p>当您得到kmodel模型之后，具体AI上板代码包括：sensor&amp;display初始化、kmodel加载、模型输入输出设置、获取图像、输入数据加载、输入数据预处理、模型推理、模型输出获取、输出后处理、OSD显示等步骤。如图所示：</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/pipeline-acbe5363152f8e5fd8cfcb62200f200a.jpg" width="1091" height="316" class="img_ev3q"></p>
<p>图中黄框部分在vi_vo.h中给出了给出了接口，下面针对红框部分，介绍如何实现AI应用开发。</p>
<p>在上述过程中，kmodel加载、模型输入设置、模型推理、模型输出获取是所有任务的共有步骤。我们对此做了封装，ai_base.h和ai_base.cc可以直接拷贝使用。</p>
<p>ai_base.h定义了AIBase基类以及共有操作的接口：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#ifndef AI_BASE_H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define AI_BASE_H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;vector&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;string&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;fstream&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;nncase/runtime/interpreter.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;scoped_timing.hpp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using std::string;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using std::vector;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using namespace nncase::runtime;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @brief AI基类，封装nncase相关操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 主要封装了nncase的加载、设置输入、运行、获取输出操作，后续开发demo只需要关注模型的前处理、后处理即可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief AI基类构造函数，加载kmodel,并初始化kmodel输入、输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param kmodel_file kmodel文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param debug_mode  0（不调试）、 1（只显示时间）、2（显示所有打印信息）None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AIBase(const char *kmodel_file,const string model_name, const int debug_mode = 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief AI基类析构函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ~AIBase();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief 设置kmodel输入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param buf 输入数据指针</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param size 输入数据大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void set_input(const unsigned char *buf, size_t size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief 根据索引获取kmodel输入tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param idx 输入数据索引</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    runtime_tensor get_input_tensor(size_t idx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief 设置模型的输入tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param idx 输入数据索引</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param tensor 输入tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void set_input_tensor(size_t idx, runtime_tensor &amp;tensor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief 初始化kmodel输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void set_output();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief 推理kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void run();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief 获取kmodel输出，结果保存在对应的类属性中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void get_output();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string model_name_;                    // 模型名字</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int debug_mode_;                       // 调试模型，0（不打印），1（打印时间），2（打印所有）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;float *&gt; p_outputs_;            // kmodel输出对应的指针列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;vector&lt;int&gt;&gt; input_shapes_;     //{{N,C,H,W},{N,C,H,W}...}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;vector&lt;int&gt;&gt; output_shapes_;    //{{N,C,H,W},{N,C,H,W}...}} 或 {{N,C},{N,C}...}}等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;int&gt; each_input_size_by_byte_;  //{0,layer1_length,layer1_length+layer2_length,...}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;int&gt; each_output_size_by_byte_; //{0,layer1_length,layer1_length+layer2_length,...}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief 首次初始化kmodel输入，并获取输入shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void set_input_init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief 首次初始化kmodel输出，并获取输出shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void set_output_init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;unsigned char&gt; kmodel_vec_; // 通过读取kmodel文件得到整个kmodel数据，用于传给kmodel解释器加载kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interpreter kmodel_interp_; // kmodel解释器，从kmodel文件构建，负责模型的加载、输入输出设置和推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ai_base.cc是ai_base.h中定义所有接口的具体实现。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ai_base.h中AIBase类定义接口的具体实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;ai_base.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;iostream&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;cassert&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;utils.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using std::cout;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using std::endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using namespace nncase;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using namespace nncase::runtime::detail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*AIBase构造函数*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AIBase::AIBase(const char *kmodel_file,const string model_name, const int debug_mode) : debug_mode_(debug_mode),model_name_(model_name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (debug_mode &gt; 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cout &lt;&lt; &quot;kmodel_file:&quot; &lt;&lt; kmodel_file &lt;&lt; endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::ifstream ifs(kmodel_file, std::ios::binary);//读入kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_interp_.load_model(ifs).expect(&quot;Invalid kmodel&quot;);//kmodel解释器加载kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    set_input_init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    set_output_init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*析构函数*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AIBase::~AIBase()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">首次初始化kmodel输入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void AIBase::set_input_init()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScopedTiming st(model_name_ + &quot; set_input init&quot;, debug_mode_);//计时</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int input_total_size = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    each_input_size_by_byte_.push_back(0); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; kmodel_interp_.inputs_size(); ++i)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto desc = kmodel_interp_.input_desc(i);//索引为i的输入描述</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto shape = kmodel_interp_.input_shape(i);//索引为i的输入shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto tensor = host_runtime_tensor::create(desc.datatype, shape, hrt::pool_shared).expect(&quot;cannot create input tensor&quot;);//创建输入tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kmodel_interp_.input_tensor(i, tensor).expect(&quot;cannot set input tensor&quot;);//绑定tensor到模型输入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vector&lt;int&gt; in_shape = {shape[0], shape[1], shape[2], shape[3]};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_shapes_.push_back(in_shape);//存储输入shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int dsize = shape[0] * shape[1] * shape[2] * shape[3];//输入总字节数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (debug_mode_ &gt; 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cout &lt;&lt; &quot;input shape:&quot; &lt;&lt; shape[0] &lt;&lt; &quot; &quot; &lt;&lt; shape[1] &lt;&lt; &quot; &quot; &lt;&lt; shape[2] &lt;&lt; &quot; &quot; &lt;&lt; shape[3] &lt;&lt; endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (desc.datatype == 0x06)//输入数据为uint8类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            input_total_size += dsize;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            each_input_size_by_byte_.push_back(input_total_size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else if (desc.datatype == 0x0B)//输入数据为float32类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            input_total_size += (dsize * 4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            each_input_size_by_byte_.push_back(input_total_size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            assert((&quot;kmodel input data type supports only uint8, float32&quot;, 0));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    each_input_size_by_byte_.push_back(input_total_size); // 最后一个保存总大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">设置模型的输入数据,加载模型输入的具体数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void AIBase::set_input(const unsigned char *buf, size_t size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //检查输入数据大小是否和模型要求大小相匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (*each_input_size_by_byte_.rbegin() != size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cout &lt;&lt; &quot;set_input:the actual input size{&quot; + std::to_string(size) + &quot;} is different from the model&#x27;s required input size{&quot; + std::to_string(*each_input_size_by_byte_.rbegin()) + &quot;}&quot; &lt;&lt; endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assert((*each_input_size_by_byte_.rbegin() == size));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //计时</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScopedTiming st(model_name_ + &quot; set_input&quot;, debug_mode_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //循环遍历模型输入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (size_t i = 0; i &lt; kmodel_interp_.inputs_size(); ++i)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //获取模型的输入描述和形状</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto desc = kmodel_interp_.input_desc(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto shape = kmodel_interp_.input_shape(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //创建tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto tensor = host_runtime_tensor::create(desc.datatype, shape, hrt::pool_shared).expect(&quot;cannot create input tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //将输入tensor映射到可写区域</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto mapped_buf = std::move(hrt::map(tensor, map_access_::map_write).unwrap()); // mapped_buf实际是有缓存数据的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //拷贝数据到tensor的缓冲区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        memcpy(reinterpret_cast&lt;void *&gt;(mapped_buf.buffer().data()), buf, each_input_size_by_byte_[i + 1] - each_input_size_by_byte_[i]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //解除映射</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto ret = mapped_buf.unmap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hrt::sync(tensor, sync_op_t::sync_write_back, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!ret.is_ok())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            std::cerr &lt;&lt; &quot;hrt::sync failed&quot; &lt;&lt; std::endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            std::abort();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //将tensor和模型的输入绑定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kmodel_interp_.input_tensor(i, tensor).expect(&quot;cannot set input tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">按照索引获取模型的输入tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runtime_tensor AIBase::get_input_tensor(size_t idx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return kmodel_interp_.input_tensor(idx).expect(&quot;cannot get input tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">按照索引设置模型的输入tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void AIBase::set_input_tensor(size_t idx, runtime_tensor &amp;tensor)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScopedTiming st(model_name_ + &quot; set_input_tensor&quot;, debug_mode_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_interp_.input_tensor(idx, tensor).expect(&quot;cannot set input tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">首次初始化kmodel输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void AIBase::set_output_init()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //计时</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScopedTiming st(model_name_ + &quot; set_output_init&quot;, debug_mode_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    each_output_size_by_byte_.clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int output_total_size = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    each_output_size_by_byte_.push_back(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //循环遍历模型的输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (size_t i = 0; i &lt; kmodel_interp_.outputs_size(); i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //获取输出描述和形状</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto desc = kmodel_interp_.output_desc(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto shape = kmodel_interp_.output_shape(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vector&lt;int&gt; out_shape;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int dsize = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int j = 0; j &lt; shape.size(); ++j)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            out_shape.push_back(shape[j]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dsize *= shape[j];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (debug_mode_ &gt; 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                cout &lt;&lt; shape[j] &lt;&lt; &quot;,&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (debug_mode_ &gt; 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cout &lt;&lt; endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        output_shapes_.push_back(out_shape);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //获取数据的总大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (desc.datatype == 0x0B)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            output_total_size += (dsize * 4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            each_output_size_by_byte_.push_back(output_total_size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            assert((&quot;kmodel output data type supports only float32&quot;, 0));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //创建tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto tensor = host_runtime_tensor::create(desc.datatype, shape, hrt::pool_shared).expect(&quot;cannot create output tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //将tensor和模型的输出绑定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kmodel_interp_.output_tensor(i, tensor).expect(&quot;cannot set output tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">设置kmodel模型的输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void AIBase::set_output()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScopedTiming st(model_name_ + &quot; set_output&quot;, debug_mode_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //循环将输出tensor和模型的输出绑定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (size_t i = 0; i &lt; kmodel_interp_.outputs_size(); i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto desc = kmodel_interp_.output_desc(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto shape = kmodel_interp_.output_shape(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto tensor = host_runtime_tensor::create(desc.datatype, shape, hrt::pool_shared).expect(&quot;cannot create output tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kmodel_interp_.output_tensor(i, tensor).expect(&quot;cannot set output tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">调用kmodel_interp_.run()实现模型推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void AIBase::run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScopedTiming st(model_name_ + &quot; run&quot;, debug_mode_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_interp_.run().expect(&quot;error occurred in running model&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">获取模型的输出(float指针形式，后处理时由后处理的具体要求取出)，为后续后处理做准备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void AIBase::get_output()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScopedTiming st(model_name_ + &quot; get_output&quot;, debug_mode_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //p_outputs_存储模型的输出的指针，可以有多个输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    p_outputs_.clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; kmodel_interp_.outputs_size(); i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //获取输出tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto out = kmodel_interp_.output_tensor(i).expect(&quot;cannot get output tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //将输出tensor映射到主机内存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto buf = out.impl()-&gt;to_host().unwrap()-&gt;buffer().as_host().unwrap().map(map_access_::map_read).unwrap().buffer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //将映射后的数据转换为float指针</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        float *p_out = reinterpret_cast&lt;float *&gt;(buf.data());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        p_outputs_.push_back(p_out);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>不同任务场景的前处理和后处理有所不同，比如分类使用softmax计算类别概率，目标检测要做nms；因此您可以定义您的任务场景类继承AIBase类，将针对该任务的前处理和后处理代码进行封装。以图像分类为例：</p>
<p>classification.h中的Classification类继承自AIBase类，实现了图像分类任务的类定义，主要定义了图像分类模型的前处理、推 理、后处理接口。初始化ai2d构建器实现图像预处理。还定义了一些图像分类任务的变量，比如分类阈值、类别名称、类别数等。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#ifndef _CLASSIFICATION_H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define _CLASSIFICATION_H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;utils.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;ai_base.h&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @brief 分类任务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 主要封装了对于每一帧图片，从预处理、运行到后处理给出结果的过程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class Classification : public AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @brief Classification构造函数，加载kmodel,并初始化kmodel输入、输出分类阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param kmodel_path kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param image_path 推理图片路径（静态图使用）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param labels 类别名称列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param cls_thresh 分类阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param debug_mode  0（不调试）、 1（只显示时间）、2（显示所有打印信息）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Classification(string &amp;kmodel_path, string &amp;image_path,std::vector&lt;std::string&gt; labels, float cls_thresh,const int debug_mode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @brief Classification构造函数，加载kmodel,并初始化kmodel输入、输出分类阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param kmodel_path kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param image_path  推理图片路径（静态图使用）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param labels      类别名称列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param cls_thresh  分类阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param isp_shape   isp输入大小（chw）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param vaddr       isp对应虚拟地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param paddr       isp对应物理地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param debug_mode  0（不调试）、 1（只显示时间）、2（显示所有打印信息）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Classification(string &amp;kmodel_path, string &amp;image_path,std::vector&lt;std::string&gt; labels,float cls_thresh, FrameCHWSize isp_shape, uintptr_t vaddr, uintptr_t paddr,const int debug_mode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @brief Classification析构函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ~Classification();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @brief 静态图片预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param ori_img 原始图片</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void pre_process(cv::Mat ori_img);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @brief 视频流预处理（ai2d for isp）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void pre_process();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @brief kmodel推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void inference();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @brief kmodel推理结果后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param results 后处理之后的基于原始图像的分类结果集合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void post_process(vector&lt;cls_res&gt; &amp;results);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @brief 计算exp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param x 自变量值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @return 返回计算exp后的结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float fast_exp(float x);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @brief 计算sigmoid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param x 自变量值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @return 返回计算sigmoid后的结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float sigmoid(float x);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::unique_ptr&lt;ai2d_builder&gt; ai2d_builder_; // ai2d构建器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    runtime_tensor ai2d_in_tensor_;              // ai2d输入tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    runtime_tensor ai2d_out_tensor_;             // ai2d输出tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uintptr_t vaddr_;                            // isp的虚拟地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FrameCHWSize isp_shape_;                     // isp对应的地址大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float cls_thresh;      //分类阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;string&gt; labels; //类别名字</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int num_class;         //类别数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float* output;         //读取kmodel输出，float指针类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在classification.cc中实现上述接口：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;classification.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">静态图推理，构造函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Classification::Classification(std::string &amp;kmodel_path, std::string &amp;image_path,std::vector&lt;std::string&gt; labels_,float cls_thresh_,const int debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">:AIBase(kmodel_path.c_str(),&quot;Classification&quot;, debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cls_thresh=cls_thresh_;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels=labels_;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_class = labels.size();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_out_tensor_ = this -&gt; get_input_tensor(0);//继承自AIBase的接口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">视频流推理，构造函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Classification::Classification(std::string &amp;kmodel_path, std::string &amp;image_path,std::vector&lt;std::string&gt; labels_,float cls_thresh_, FrameCHWSize isp_shape, uintptr_t vaddr, uintptr_t paddr,const int debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">:AIBase(kmodel_path.c_str(),&quot;Classification&quot;, debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cls_thresh=cls_thresh_;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    labels=labels_;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_class = labels.size();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vaddr_ = vaddr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    isp_shape_ = isp_shape;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dims_t in_shape{1, isp_shape.channel, isp_shape.height, isp_shape.width};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_in_tensor_ = hrt::create(typecode_t::dt_uint8, in_shape, hrt::pool_shared).expect(&quot;create ai2d input tensor failed&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_out_tensor_ = this -&gt; get_input_tensor(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Utils::resize(ai2d_builder_, ai2d_in_tensor_, ai2d_out_tensor_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">析构函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Classification::~Classification()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">静态图预处理函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void Classification::pre_process(cv::Mat ori_img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //计时</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScopedTiming st(model_name_ + &quot; pre_process image&quot;, debug_mode_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::vector&lt;uint8_t&gt; chw_vec;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //bgr转rgb,hwc转chw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Utils::bgr2rgb_and_hwc2chw(ori_img, chw_vec);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //resize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Utils::resize({ori_img.channels(), ori_img.rows, ori_img.cols}, chw_vec, ai2d_out_tensor_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">视频流预处理，具体参见ai2d应用部分</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void Classification::pre_process()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScopedTiming st(model_name_ + &quot; pre_process video&quot;, debug_mode_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t isp_size = isp_shape_.channel * isp_shape_.height * isp_shape_.width;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auto buf = ai2d_in_tensor_.impl()-&gt;to_host().unwrap()-&gt;buffer().as_host().unwrap().map(map_access_::map_write).unwrap().buffer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memcpy(reinterpret_cast&lt;char *&gt;(buf.data()), (void *)vaddr_, isp_size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hrt::sync(ai2d_in_tensor_, sync_op_t::sync_write_back, true).expect(&quot;sync write_back failed&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_builder_-&gt;invoke(ai2d_in_tensor_, ai2d_out_tensor_).expect(&quot;error occurred in ai2d running&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">推理函数，run()和get_output()继承自AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void Classification::inference()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this-&gt;run();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this-&gt;get_output();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">后处理计算 exp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">float Classification::fast_exp(float x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    union {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint32_t i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        float f;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } v{};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v.i = (1 &lt;&lt; 23) * (1.4426950409 * x + 126.93490512f);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return v.f;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">后处理计算 sigmoid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">float Classification::sigmoid(float x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 1.0f / (1.0f + fast_exp(-x));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">后处理函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void Classification::post_process(vector&lt;cls_res&gt; &amp;results)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScopedTiming st(model_name_ + &quot; post_process&quot;, debug_mode_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //p_outputs_中存放的是float类型指针，指向输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output = p_outputs_[0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cls_res b;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //如果是多分类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if(num_class &gt; 2){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        float sum = 0.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; num_class; i++){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum += exp(output[i]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        b.score = cls_thresh;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int max_index;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //softmax处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; num_class; i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            output[i] = exp(output[i]) / sum;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        max_index = max_element(output,output+num_class) - output; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (output[max_index] &gt;= b.score)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            b.label = labels[max_index];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            b.score = output[max_index];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results.push_back(b);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else// 2分类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        float pre = sigmoid(output[0]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (pre &gt; cls_thresh)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            b.label = labels[0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            b.score = pre;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            b.label = labels[1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            b.score = 1 - pre;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        results.push_back(b);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在上述代码中的预处理部分，使用了一些工具函数，我们将其封装在utils.h中：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#ifndef UTILS_H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define UTILS_H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;algorithm&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;vector&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;iostream&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;fstream&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;opencv2/core.hpp&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;opencv2/highgui.hpp&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;opencv2/imgcodecs.hpp&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;opencv2/imgproc.hpp&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;nncase/functional/ai2d/ai2d_builder.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;string&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;string.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;cmath&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;stdio.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;stdlib.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;sys/types.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;sys/stat.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;fcntl.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;sys/ioctl.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;unistd.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;stdint.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;random&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using namespace nncase;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using namespace nncase::runtime;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using namespace nncase::runtime::k230;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using namespace nncase::F::k230;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using namespace std;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using namespace cv;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using cv::Mat;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using std::cout;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using std::endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using std::ifstream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using std::vector;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define STAGE_NUM 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define STRIDE_NUM 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define LABELS_NUM 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @brief 分类结果结构</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct cls_res</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float score;//分类分数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string label;//分类标签结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}cls_res;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @brief 单张/帧图片大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct FrameSize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t width;  // 宽</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t height; // 高</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} FrameSize;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @brief 单张/帧图片大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct FrameCHWSize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t channel; // 通道</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t height;  // 高</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t width;   // 宽</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} FrameCHWSize;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @brief AI工具类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 封装AI常用的函数，包括二进制文件读取、文件保存、图片预处理等操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class Utils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief 对图片resize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ori_img             原始图片</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param frame_size      需要resize图像的宽高</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param padding         需要padding的像素，默认是cv::Scalar(104, 117, 123),BGR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return                处理后图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static cv::Mat resize(const cv::Mat ori_img, const FrameSize &amp;frame_size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief 将BGR图片从hwc转为chw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ori_img          原始图片</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param chw_vec          转为chw后的数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static void bgr2rgb_and_hwc2chw(cv::Mat &amp;ori_img, std::vector&lt;uint8_t&gt; &amp;chw_vec);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /*************************for ai2d ori_img process********************/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // resize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief resize函数，对chw数据进行resize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ori_shape        原始数据chw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param chw_vec          原始数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ai2d_out_tensor  ai2d输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static void resize(FrameCHWSize ori_shape, std::vector&lt;uint8_t&gt; &amp;chw_vec, runtime_tensor &amp;ai2d_out_tensor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief resize函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param builder          ai2d构建器，用于运行ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ai2d_in_tensor   ai2d输入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ai2d_out_tensor  ai2d输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static void resize(std::unique_ptr&lt;ai2d_builder&gt; &amp;builder, runtime_tensor &amp;ai2d_in_tensor, runtime_tensor &amp;ai2d_out_tensor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief 将分类任务的结果绘制到图像上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param frame         原始图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param results       分类的结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static void draw_cls_res(cv::Mat&amp; frame, vector&lt;cls_res&gt;&amp; results);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief 将分类任务的结果绘制到屏幕的osd中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param frame                 原始图像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param results               分类的结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param osd_frame_size        osd的宽高</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param sensor_frame_size     sensor的宽高</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static void draw_cls_res(cv::Mat&amp; frame, vector&lt;cls_res&gt;&amp; results, FrameSize osd_frame_size, FrameSize sensor_frame_size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果您有需要还可以添加其他的工具函数。下面是utils.cc文件，完成工具类接口的实现：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;iostream&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;utils.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using std::ofstream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using std::vector;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auto cache = cv::Mat::zeros(1, 1, CV_32FC1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cv::Mat Utils::resize(const cv::Mat img, const FrameSize &amp;frame_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::Mat cropped_img;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::resize(img, cropped_img, cv::Size(frame_size.width, frame_size.height), cv::INTER_LINEAR);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return cropped_img;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void Utils::bgr2rgb_and_hwc2chw(cv::Mat &amp;ori_img, std::vector&lt;uint8_t&gt; &amp;chw_vec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // for bgr format</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::vector&lt;cv::Mat&gt; bgrChannels(3);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::split(ori_img, bgrChannels);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (auto i = 2; i &gt; -1; i--)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std::vector&lt;uint8_t&gt; data = std::vector&lt;uint8_t&gt;(bgrChannels[i].reshape(1, 1));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        chw_vec.insert(chw_vec.end(), data.begin(), data.end());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void Utils::resize(FrameCHWSize ori_shape, std::vector&lt;uint8_t&gt; &amp;chw_vec, runtime_tensor &amp;ai2d_out_tensor)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // build ai2d_in_tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dims_t in_shape{1, ori_shape.channel, ori_shape.height, ori_shape.width};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    runtime_tensor ai2d_in_tensor = host_runtime_tensor::create(typecode_t::dt_uint8, in_shape, hrt::pool_shared).expect(&quot;cannot create input tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auto input_buf = ai2d_in_tensor.impl()-&gt;to_host().unwrap()-&gt;buffer().as_host().unwrap().map(map_access_::map_write).unwrap().buffer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memcpy(reinterpret_cast&lt;char *&gt;(input_buf.data()), chw_vec.data(), chw_vec.size());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hrt::sync(ai2d_in_tensor, sync_op_t::sync_write_back, true).expect(&quot;write back input failed&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // run ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ai2d_datatype_t ai2d_dtype{ai2d_format::NCHW_FMT, ai2d_format::NCHW_FMT, typecode_t::dt_uint8, typecode_t::dt_uint8};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_datatype_t ai2d_dtype{ai2d_format::NCHW_FMT, ai2d_format::NCHW_FMT, ai2d_in_tensor.datatype(), ai2d_out_tensor.datatype()};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_crop_param_t crop_param { false, 30, 20, 400, 600 };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_shift_param_t shift_param{false, 0};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_pad_param_t pad_param{false, {{0, 0}, {0, 0}, {0, 0}, {0, 0}}, ai2d_pad_mode::constant, {114, 114, 114}};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_resize_param_t resize_param{true, ai2d_interp_method::tf_bilinear, ai2d_interp_mode::half_pixel};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_affine_param_t affine_param{false, ai2d_interp_method::cv2_bilinear, 0, 0, 127, 1, {0.5, 0.1, 0.0, 0.1, 0.5, 0.0}};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dims_t out_shape = ai2d_out_tensor.shape();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_builder builder { in_shape, out_shape, ai2d_dtype, crop_param, shift_param, pad_param, resize_param, affine_param };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder.build_schedule();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder.invoke(ai2d_in_tensor,ai2d_out_tensor).expect(&quot;error occurred in ai2d running&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void Utils::resize(std::unique_ptr&lt;ai2d_builder&gt; &amp;builder, runtime_tensor &amp;ai2d_in_tensor, runtime_tensor &amp;ai2d_out_tensor)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // run ai2d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_datatype_t ai2d_dtype{ai2d_format::NCHW_FMT, ai2d_format::NCHW_FMT, ai2d_in_tensor.datatype(), ai2d_out_tensor.datatype()};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_crop_param_t crop_param { false, 30, 20, 400, 600 };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_shift_param_t shift_param{false, 0};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_pad_param_t pad_param{false, {{0, 0}, {0, 0}, {0, 0}, {0, 0}}, ai2d_pad_mode::constant, {114, 114, 114}};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_resize_param_t resize_param{true, ai2d_interp_method::tf_bilinear, ai2d_interp_mode::half_pixel};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_affine_param_t affine_param{false, ai2d_interp_method::cv2_bilinear, 0, 0, 127, 1, {0.5, 0.1, 0.0, 0.1, 0.5, 0.0}};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dims_t in_shape = ai2d_in_tensor.shape();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dims_t out_shape = ai2d_out_tensor.shape();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder.reset(new ai2d_builder(in_shape, out_shape, ai2d_dtype, crop_param, shift_param, pad_param, resize_param, affine_param));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder-&gt;build_schedule();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder-&gt;invoke(ai2d_in_tensor,ai2d_out_tensor).expect(&quot;error occurred in ai2d running&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void Utils::draw_cls_res(cv::Mat&amp; frame, vector&lt;cls_res&gt;&amp; results)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    double fontsize = (frame.cols * frame.rows * 1.0) / (300 * 250);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (fontsize &gt; 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fontsize = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for(int i = 0; i &lt; results.size(); i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std::string text = &quot;class: &quot; + results[i].label + &quot;, score: &quot; + std::to_string(round(results[i].score * 100) / 100.0).substr(0, 4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cv::putText(frame, text, cv::Point(1, 40), cv::FONT_HERSHEY_SIMPLEX, 0.8, cv::Scalar(255, 255, 0), 2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std::cout &lt;&lt; text &lt;&lt; std::endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void Utils::draw_cls_res(cv::Mat&amp; frame, vector&lt;cls_res&gt;&amp; results, FrameSize osd_frame_size, FrameSize sensor_frame_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    double fontsize = (frame.cols * frame.rows * 1.0) / (1100 * 1200);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for(int i = 0; i &lt; results.size(); i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std::string text = &quot;class: &quot; + results[i].label + &quot;, score: &quot; + std::to_string(round(results[i].score * 100) / 100.0).substr(0, 4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cv::putText(frame, text, cv::Point(1, 40), cv::FONT_HERSHEY_SIMPLEX, 0.8, cv::Scalar(255, 255, 255, 0), 2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std::cout &lt;&lt; text &lt;&lt; std::endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>为了便于调试，我们在scoped_timing.hpp中封装了计时类ScopedTiming，用于统计在该类实例生命周期内的耗时。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;chrono&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;string&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;iostream&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @brief 计时类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 统计在该类实例生命周期内的耗时</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ScopedTiming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief ScopedTiming 构造函数,初始化计时对象名称并开始计时</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param info 计时对象名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param enable_profile 是否开始计时</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScopedTiming(std::string info = &quot;ScopedTiming&quot;, int enable_profile = 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    : m_info(info), enable_profile(enable_profile)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (enable_profile)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            m_start = std::chrono::steady_clock::now();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief ScopedTiming析构,结束计时，并打印耗时</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ~ScopedTiming()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (enable_profile)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            m_stop = std::chrono::steady_clock::now();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            double elapsed_ms = std::chrono::duration&lt;double, std::milli&gt;(m_stop - m_start).count();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            std::cout &lt;&lt; m_info &lt;&lt; &quot; took &quot; &lt;&lt; elapsed_ms &lt;&lt; &quot; ms&quot; &lt;&lt; std::endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int enable_profile;                            // 是否统计时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::string m_info;                            // 计时对象名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::chrono::steady_clock::time_point m_start; // 计时开始时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::chrono::steady_clock::time_point m_stop;  // 计时结束时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>main.cc是实现板端推理的主要代码，主要实现解析传入参数，打印使用说明，实现两个不同分支的推理。如果输入的第二个参数是推理图像路径，则调用image_proc函数进行图像推理；如果传入的是None，则调用video_proc函数进行视频流推理。</p>
<ul>
<li>静态图推理代码</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">void image_proc_cls(string &amp;kmodel_path, string &amp;image_path,vector&lt;string&gt; labels,float cls_thresh ,int debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::Mat ori_img = cv::imread(image_path);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ori_w = ori_img.cols;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ori_h = ori_img.rows;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //创建任务类实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Classification cls(kmodel_path,image_path,labels,cls_thresh,debug_mode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //前处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cls.pre_process(ori_img);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cls.inference();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;cls_res&gt; results;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cls.post_process(results);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Utils::draw_cls_res(ori_img,results);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::imwrite(&quot;result_cls.jpg&quot;, ori_img);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上述代码是main.cc中的静态图像推理代码部分，首先从图片路径初始化cv::Mat对象ori_img，然后初始化Classification实例cls，调用cls预处理函数pre_process，推理函数reference，后处理函数post_process，最后调用utils.h中的draw_cls_res将结果绘制在图片上并保存为result_cls.jpg。如您需要修改前后处理部分，可在Classification.cc中进行修改，如您想添加其他工具方法，可在utils中定义，并在utils.cc中实现。</p>
<ul>
<li>视频流推理代码可以参考<strong>SDK编译章节</strong>的示例2部分代码。其中AI开发的核心代码为：</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">void video_proc_cls(string &amp;kmodel_path, string &amp;image_path,vector&lt;string&gt; labels,float cls_thresh , int debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 启动video capture</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vivcap_start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 创建一帧数据对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_video_frame_info vf_info;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // osd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void *pic_vaddr = NULL;       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;vf_info, 0, sizeof(vf_info));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vf_info.v_frame.width = osd_width;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vf_info.v_frame.height = osd_height;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vf_info.v_frame.stride[0] = osd_width;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vf_info.v_frame.pixel_format = PIXEL_FORMAT_ARGB_8888;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    block = vo_insert_frame(&amp;vf_info, &amp;pic_vaddr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // alloc memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t paddr = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void *vaddr = nullptr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t size = SENSOR_CHANNEL * SENSOR_HEIGHT * SENSOR_WIDTH;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ret = kd_mpi_sys_mmz_alloc_cached(&amp;paddr, &amp;vaddr, &quot;allocate&quot;, &quot;anonymous&quot;, size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std::cerr &lt;&lt; &quot;physical_memory_block::allocate failed: ret = &quot; &lt;&lt; ret &lt;&lt; &quot;, errno = &quot; &lt;&lt; strerror(errno) &lt;&lt; std::endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std::abort();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 初始化图像分类任务任务实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Classification cls(kmodel_path,image_path,labels,cls_thresh, {SENSOR_CHANNEL, SENSOR_HEIGHT, SENSOR_WIDTH}, reinterpret_cast&lt;uintptr_t&gt;(vaddr), reinterpret_cast&lt;uintptr_t&gt;(paddr), debug_mode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> // 分类结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;cls_res&gt; results;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 当没有停止时，对每一帧图像进行推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (!isp_stop)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ScopedTiming st(&quot;total time&quot;, debug_mode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ScopedTiming st(&quot;read capture&quot;, debug_mode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // VICAP_CHN_ID_1 out rgb888p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memset(&amp;dump_info, 0 , sizeof(k_video_frame_info));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // dump一帧图像到dump_info</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = kd_mpi_vicap_dump_frame(vicap_dev, VICAP_CHN_ID_1, VICAP_DUMP_YUV, &amp;dump_info, 1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;sample_vicap...kd_mpi_vicap_dump_frame failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ScopedTiming st(&quot;isp copy&quot;, debug_mode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            auto vbvaddr = kd_mpi_sys_mmap_cached(dump_info.v_frame.phys_addr[0], size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memcpy(vaddr, (void *)vbvaddr, SENSOR_HEIGHT * SENSOR_WIDTH * 3); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            kd_mpi_sys_munmap(vbvaddr, size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // results清空，准备保存推理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        results.clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cls.pre_process();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cls.inference();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cls.post_process(results);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 创建osd帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cv::Mat osd_frame(osd_height, osd_width, CV_8UC4, cv::Scalar(0, 0, 0, 0));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  //在osd上绘制结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ScopedTiming st(&quot;osd draw&quot;, debug_mode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Utils::draw_cls_res(osd_frame, results, {osd_width, osd_height}, {SENSOR_WIDTH, SENSOR_HEIGHT});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 将绘制的osd帧插入输出显示通道</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ScopedTiming st(&quot;osd copy&quot;, debug_mode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memcpy(pic_vaddr, osd_frame.data, osd_width * osd_height * 4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //显示通道插入帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            kd_mpi_vo_chn_insert_frame(osd_id+3, &amp;vf_info);  //K_VO_OSD0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            printf(&quot;kd_mpi_vo_chn_insert_frame success \n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = kd_mpi_vicap_dump_release(vicap_dev, VICAP_CHN_ID_1, &amp;dump_info);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;sample_vicap...kd_mpi_vicap_dump_release failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 终止</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vo_osd_release_block();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vivcap_stop();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // free memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = kd_mpi_sys_mmz_free(paddr, vaddr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std::cerr &lt;&lt; &quot;free failed: ret = &quot; &lt;&lt; ret &lt;&lt; &quot;, errno = &quot; &lt;&lt; strerror(errno) &lt;&lt; std::endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std::abort();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>为了使用方便，我们对视频流处理部分做了封装，您可以参考示例代码：<a href="https://github.com/kendryte/K230_training_scripts/tree/main/end2end_cls_doc" target="_blank" rel="noopener noreferrer">K230_training_scripts/end2end_cls_doc at main · kendryte/K230_training_scripts (github.com)</a>中k230_code中的vi_vo.h文件和main.cc中的具体实现。</p>
<ul>
<li>k230_code/k230_deploy/CMakeLists.txt说明</li>
</ul>
<p>这是k230_code/k230_deploy目录下的CMakeLists.txt脚本，设置编译的C++文件和生成的elf可执行文件名称，由下面：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">set(src main.cc utils.cc ai_base.cc classification.cc) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(bin main.elf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#添加项目的根目录到头文件搜索路径中。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include_directories(${PROJECT_SOURCE_DIR})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#添加 nncase RISC-V 向量库的头文件目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include_directories(${nncase_sdk_root}/riscv64/rvvlib/include)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#添加 k230 SDK 中的用户应用程序 API 头文件目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include_directories(${k230_sdk}/src/big/mpp/userapps/api/)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#添加 k230 SDK 的mpp(Media Process Platform)头文件目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include_directories(${k230_sdk}/src/big/mpp/include)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 添加与mpp相关的头文件目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include_directories(${k230_sdk}/src/big/mpp/include/comm)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#添加示例 VO（视频输出）应用程序头文件目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include_directories(${k230_sdk}/src/big/mpp/userapps/sample/sample_vo)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#添加链接器搜索路径，指向 nncase RISC-V 向量库的目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">link_directories(${nncase_sdk_root}/riscv64/rvvlib/)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#创建一个可执行文件，将之前设置的源文件列表作为输入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add_executable(${bin} ${src})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#设置可执行文件需要链接的库。列表中列出了各种库，包括 nncase 相关的库、k230 SDK 的库，以及其他一些库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">target_link_libraries(${bin} ...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#将一些 OpenCV相关的库和其他一些第三方库链接到可执行文件中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">target_link_libraries(${bin} opencv_imgproc opencv_imgcodecs opencv_core zlib libjpeg-turbo libopenjp2 libpng libtiff libwebp csi_cv)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 安装生成的可执行文件到指定的目标路径（bin 目录）中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">install(TARGETS ${bin} DESTINATION bin)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>k230_code/CMakeLists.txt说明</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cmake_minimum_required(VERSION 3.2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">project(nncase_sdk C CXX)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 设置nncase的根目录，在src/big/nncase目录下，您也可设置为绝对路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(nncase_sdk_root &quot;${PROJECT_SOURCE_DIR}/../../nncase/&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 设置k230_sdk的根目录，当前是从nncase目录的三级父目录得到，您也可设置为绝对路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(k230_sdk ${nncase_sdk_root}/../../../)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#设置链接脚本路径，链接脚本放于k230_code/cmake下</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(CMAKE_EXE_LINKER_FLAGS &quot;-T ${PROJECT_SOURCE_DIR}/cmake/link.lds --static&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># set opencv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(k230_opencv ${k230_sdk}/src/big/utils/lib/opencv)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include_directories(${k230_opencv}/include/opencv4/)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">link_directories(${k230_opencv}/lib ${k230_opencv}/lib/opencv4/3rdparty)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># set mmz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">link_directories(${k230_sdk}/src/big/mpp/userapps/lib)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># set nncase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include_directories(${nncase_sdk_root}/riscv64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include_directories(${nncase_sdk_root}/riscv64/nncase/include)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include_directories(${nncase_sdk_root}/riscv64/nncase/include/nncase/runtime)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">link_directories(${nncase_sdk_root}/riscv64/nncase/lib/)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 添加待编译子项目</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add_subdirectory(k230_deploy)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>k230_code/build_app.sh说明</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># set cross build toolchain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 将交叉编译工具链的路径添加到系统的 PATH 环境变量中，以便在后续的命令中使用。该工具链是使用的大核编译工具链。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export PATH=$PATH:/opt/toolchain/riscv64-linux-musleabi_for_x86_64-pc-linux-gnu/bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clear</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm -rf out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pushd out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cmake -DCMAKE_BUILD_TYPE=Release                 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      -DCMAKE_INSTALL_PREFIX=`pwd`               \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      -DCMAKE_TOOLCHAIN_FILE=cmake/Riscv64.cmake \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make -j &amp;&amp; make install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">popd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 生成的main.elf可以在k230_code目录下的k230_bin文件夹下找到</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k230_bin=`pwd`/k230_bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm -rf ${k230_bin}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p ${k230_bin}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [ -f out/bin/main.elf ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      cp out/bin/main.elf ${k230_bin}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10153-代码编译">10.1.5.3 代码编译<a href="#10153-代码编译" class="hash-link" aria-label="Direct link to 10.1.5.3 代码编译" title="Direct link to 10.1.5.3 代码编译">​</a></h4>
<p>将项目中的k230_code文件夹拷贝到k230_sdk目录下的src/big/nncase下，执行编译脚本，将C++代码编译成main.elf可执行文件。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 在k230_SDK根目录下执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make CONF=k230_canmv_defconfig prepare_memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 回到当前项目目录，赋予权限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chmod +x build_app.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./build_app.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10154-准备elf文件">10.1.5.4 准备ELF文件<a href="#10154-准备elf文件" class="hash-link" aria-label="Direct link to 10.1.5.4 准备ELF文件" title="Direct link to 10.1.5.4 准备ELF文件">​</a></h4>
<p>后面部署步骤需要用到的文件包括：</p>
<ol>
<li>k230_code/k230_bin/main.elf;</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1016-网络配置与文件拷贝">10.1.6 网络配置与文件拷贝<a href="#1016-网络配置与文件拷贝" class="hash-link" aria-label="Direct link to 10.1.6 网络配置与文件拷贝" title="Direct link to 10.1.6 网络配置与文件拷贝">​</a></h3>
<p>将待使用文件拷贝到开发板上有三种方式可供选择。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10161-离线文件拷贝">10.1.6.1 离线文件拷贝<a href="#10161-离线文件拷贝" class="hash-link" aria-label="Direct link to 10.1.6.1 离线文件拷贝" title="Direct link to 10.1.6.1 离线文件拷贝">​</a></h4>
<p>通过插拔SD卡，将所需文件拷贝到相应位置，SD卡根目录映射到大小核的/sharefs目录下。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10162-tftp文件传输">10.1.6.2 tftp文件传输<a href="#10162-tftp文件传输" class="hash-link" aria-label="Direct link to 10.1.6.2 tftp文件传输" title="Direct link to 10.1.6.2 tftp文件传输">​</a></h4>
<ul>
<li>Windows系统PC端网络配置</li>
</ul>
<p>控制面板-&gt;网络和共享中心-&gt;更改适配器设置-&gt;以太网网卡-&gt;右键属性-&gt;选中(TCP/IPv4)-&gt;属性</p>
<p>配置IP地址、掩码、网关，配置DNS服务器地址：</p>
<p><img decoding="async" loading="lazy" alt="net_config_0" src="/assets/images/net_config_0-739747cdb23dc4f8fd9624817b73cc15.png" width="695" height="871" class="img_ev3q"></p>
<ul>
<li>开发板网络 配置</li>
</ul>
<p>进入小核命令行，执行：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 查看是否有eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ifconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 配置开发板IP，和PC在同一网段下</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ifconfig eth0 192.168.1.22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看IP配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ifconfig</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>工具：tftpd64</li>
</ul>
<p>安装tftp通信工具，下载地址：<a href="https://bitbucket.org/phjounin/tftpd64/downloads/" target="_blank" rel="noopener noreferrer">https://bitbucket.org/phjounin/tftpd64/downloads/</a></p>
<p>启动tftpd64，配置待传输文件存放目录和服务网卡</p>
<p><img decoding="async" loading="lazy" alt="net_config_1" src="/assets/images/net_config_1-2fd22db8d543e85fae1a8aeace246465.png" width="1012" height="502" class="img_ev3q"></p>
<ul>
<li>sharefs说明</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 进入小核根目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># sharefs目录是大小核共用目录，因此从小核拷贝到sharefs目录下的文件对大核也可见</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>文件传输</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 以下代码在小核串口执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 将PC上tftpd64配置文件存放目录中的文件传输至开发板的当前目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tftp -g -r your_file 192.168.1.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 将开发板当前目录下的文件传输至tftpd64配置文件存放目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tftp -p -r board_file 192.168.1.2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10162-scp文件传输">10.1.6.2 scp文件传输<a href="#10162-scp文件传输" class="hash-link" aria-label="Direct link to 10.1.6.2 scp文件传输" title="Direct link to 10.1.6.2 scp文件传输">​</a></h4>
<p>在Linux系统中，PC正常连接网络，开发板可以通过网线连接PC所在网关下其他网口，通过scp命令实现文件传输。</p>
<p>开发板上电，进入大小核COM界面，在小核执行scp传输命令：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 从PC拷贝文件至开发板</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scp 用户名@域名或IP:文件所在目录 开发板目的目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#拷贝文件夹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scp -r 用户名@域名或IP:文件所在目录 开发板目的目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 从开发板拷贝文件至PC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scp 开发板待拷贝目录 用户名@域名或IP:PC目的目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 拷贝文件夹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scp -r 开发板待拷贝目录 用户名@域名或IP:PC目的目录</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1017-k230端部署">10.1.7 K230端部署<a href="#1017-k230端部署" class="hash-link" aria-label="Direct link to 10.1.7 K230端部署" title="Direct link to 10.1.7 K230端部署">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10171-板端部署过程">10.1.7.1 板端部署过程<a href="#10171-板端部署过程" class="hash-link" aria-label="Direct link to 10.1.7.1 板端部署过程" title="Direct link to 10.1.7.1 板端部署过程">​</a></h4>
<p>按照上节配置好的文件传输过程，在MobaXterm上的小核界面进入/sharefs，创建测试文件夹：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd /sharefs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir test_cls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd test_cls</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>将模型训练和测试部分准备好的文件和C++代码编译部分准备好的elf文件拷贝到开发板。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">test_cls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ├──best.kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ├──labels.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ├──main.elf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ├──test.jpg</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在大核COM口进入到/sharefs/test_cls目录下，</p>
<p>执行静态图推理，执行下述代码(注意：代码需在大核下执行，文件拷贝需在小核下完成)：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># &quot;模型推理时传参说明：&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># &quot;&lt;kmodel_path&gt; &lt;image_path&gt; &lt;labels_txt&gt; &lt;debug_mode&gt;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># &quot;Options:&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># &quot;  kmodel_path     Kmodel的路径\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># &quot;  image_path      待推理图片路径/摄像头(None)\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># &quot;  labels_txt      类别标签文件路径\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># &quot;  debug_mode      是否需要调试，0、1、2分别表示不调试、简单调试、详细调试\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main.elf best.kmodel test.jpg labels.txt 2 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如执行摄像头视频流推理，执行下述代码：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">main.elf best.kmodel None labels.txt 2 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10172-上板部署效果">10.1.7.2 上板部署效果<a href="#10172-上板部署效果" class="hash-link" aria-label="Direct link to 10.1.7.2 上板部署效果" title="Direct link to 10.1.7.2 上板部署效果">​</a></h4>
<p>静态图推理图示：</p>
<p><img decoding="async" loading="lazy" alt="image_inference" src="/assets/images/cls_image_inference-f2a9856dc00c9349e0ae4edf227c1c84.jpg" width="846" height="246" class="img_ev3q"></p>
<p>视频流推理图示：</p>
<p><img decoding="async" loading="lazy" alt="video_inference" src="/assets/images/cls_video_inference-aeff10943b4e97eccc7de2366463714a.jpg" width="1047" height="640" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="102-使用kts实现目标检测任务">10.2 使用KTS实现目标检测任务<a href="#102-使用kts实现目标检测任务" class="hash-link" aria-label="Direct link to 10.2 使用KTS实现目标检测任务" title="Direct link to 10.2 使用KTS实现目标检测任务">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1021-环境搭建">10.2.1 环境搭建<a href="#1021-环境搭建" class="hash-link" aria-label="Direct link to 10.2.1 环境搭建" title="Direct link to 10.2.1 环境搭建">​</a></h3>
<p>（1）Linux系统；</p>
<p>（2）安装显卡驱动；</p>
<p>（3）安装Anaconda，用于创建模型训练环境；</p>
<p>（4）安装Docker，用于创建SDK镜像编译环境；</p>
<p>（5）安装dotnet SDK;</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1022-数据准备">10.2.2 数据准备<a href="#1022-数据准备" class="hash-link" aria-label="Direct link to 10.2.2 数据准备" title="Direct link to 10.2.2 数据准备">​</a></h3>
<p>目标检测任务自定义数据集按照如下格式组织，根目录下包括：以类别名称命名的子目录，子目录中是其类别的所有图像样本。</p>
<p><img decoding="async" loading="lazy" alt="目标检测数据结构" src="/assets/images/det_dataset-242e07a2d45e1827f4e93a35181f86a5.png" width="1280" height="720" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1023-模型训练和测试">10.2.3 模型训练和测试<a href="#1023-模型训练和测试" class="hash-link" aria-label="Direct link to 10.2.3 模型训练和测试" title="Direct link to 10.2.3 模型训练和测试">​</a></h3>
<p>本节内容在训练环境中实现。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10231-创建虚拟环境">10.2.3.1 创建虚拟环境<a href="#10231-创建虚拟环境" class="hash-link" aria-label="Direct link to 10.2.3.1 创建虚拟环境" title="Direct link to 10.2.3.1 创建虚拟环境">​</a></h4>
<p>开启命令终端：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">conda create -n myenv python=3.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">conda activate myenv</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10232-安装python依赖库">10.2.3.2 安装python依赖库<a href="#10232-安装python依赖库" class="hash-link" aria-label="Direct link to 10.2.3.2 安装python依赖库" title="Direct link to 10.2.3.2 安装python依赖库">​</a></h4>
<p>按照项目内的requriements.txt安装训练所用的python库,等待安装：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pip install -r requriements.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在requriments.txt中会安装模型转换的包nncase和nncase-kpu，nncase 是一个为 AI 加速器设计的神经网络编译器。</p>
<p>编译镜像和使用nncase转换kmodel时请注意版本对应关系，k230_sdk版本和nncase版本对应关系参考下述链接：</p>
<p><strong><a href="https://developer.canaan-creative.com/k230/dev/zh/03_other/K230_SDK_nncase%E7%89%88%E6%9C%AC%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB.html" target="_blank" rel="noopener noreferrer">K230 SDK nncase版本对应关系 — K230 文档 (canaan-creative.com)</a></strong></p>
<p>您可以按照对应版本更换nncase和nncase-kpu的版本，比如更换nncase版本为2.7.0：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pip install nncase==2.7.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install nncase-kpu==2.7.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10233-配置训练参数">10.2.3.3 配置训练参数<a href="#10233-配置训练参数" class="hash-link" aria-label="Direct link to 10.2.3.3 配置训练参数" title="Direct link to 10.2.3.3 配置训练参数">​</a></h4>
<p>给出的训练脚本中配置文件yaml/config.yaml设置如下：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dataset:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  root_folder: ../data/fruit # 目标检测数据集路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  origion_json: labels.json # 目标检测数据集标注json文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  split: true # 是否重新执行拆分，第一次执行必须为true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val_ratio: 0.1 # 验证集比例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  test_ratio: 0.1 # 测试集比例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">train_val_test:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  json_dir: ../gen # 拆分过程生成的训练集、验证集、测试集json文件，标签名称文件、校正集文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  model_save_dir: ../checkpoints # 模型保存路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gpu_index: 0 # 调用的gpu索引，如果gpu不可用，会使用cpu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  img_size: 640 # 分辨率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  learningrate: 0.001 #学习率</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mean: [ 0.485, 0.456, 0.406 ] # 图像标准化均值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  std: [ 0.229, 0.224, 0.225 ] # 图像标准化标准差</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  epochs: 300 # 训练迭代次数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nms_option: false #类内或者类间做nms false代表类内</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pre_train_dir: pre_pth # 预训练模型存放路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  train_batch_size: 32 # 训练迭代batch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val_batch_size: 8 # 验证迭代batch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  test_batch_size: 8 # 测试迭代batch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">inference:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mode: image # 推理模式，分为image和video; image模式下可推理单张图片和目录下所有图片，video调用摄像头实现推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  inference_model: best # 分为best和last，分别调用checkpoints下的best.pth和last.pth进行推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  image_path: ../data/fruit/test.jpg # 如果该路径为图片路径，则进行单张图片推理；如果该路径为目录，则对目录下所有图片进行推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  deploy_json: deploy.json # 后续kmodel需要读取的参数文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  confidence_threshold: 0.55 # 检测框阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nms_threshold: 0.2 # 最大值抑制阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deploy:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  onnx_img_size: [640,640] # 转onnx输入分辨率 [w , h]  必须是32的倍数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  chip: k230 # 芯片类型，分为“k230”和“cpu”两种</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ptq_option: 0 # 量化类型，0为uint8，1，2，3，4为uint16的不同形式</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10234-模型训练">10.2.3.4 模型训练<a href="#10234-模型训练" class="hash-link" aria-label="Direct link to 10.2.3.4 模型训练" title="Direct link to 10.2.3.4 模型训练">​</a></h4>
<p>进入到工程的scripts目录，执行训练代码：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">python3 main.py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果训练成功，在配置文件的model_save_dir目录下可以找到训练好的last.pth、best.pth、best.onnx、best.kmodel。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10235-模型测试">10.2.3.5 模型测试<a href="#10235-模型测试" class="hash-link" aria-label="Direct link to 10.2.3.5 模型测试" title="Direct link to 10.2.3.5 模型测试">​</a></h4>
<p>设置配置文件中的inference部分，设置测试配置，执行测试代码：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">python3 inference.py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10236-准备文件">10.2.3.6 准备文件<a href="#10236-准备文件" class="hash-link" aria-label="Direct link to 10.2.3.6 准备文件" title="Direct link to 10.2.3.6 准备文件">​</a></h4>
<p>后面部署步骤需要用到的文件包括：</p>
<p>（1）checkpoints/best.kmodel;</p>
<p>（2）gen/deploy.json</p>
<p>（3）待测试图片test.jpg;</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1024-k230_sdk镜像编译和烧录">10.2.4 K230_SDK镜像编译和烧录<a href="#1024-k230_sdk镜像编译和烧录" class="hash-link" aria-label="Direct link to 10.2.4 K230_SDK镜像编译和烧录" title="Direct link to 10.2.4 K230_SDK镜像编译和烧录">​</a></h3>
<p>编译镜像和使用nncase转换kmodel时请注意版本对应关系，k230_sdk版本和nncase版本对应关系参考下述链接：</p>
<p><strong><a href="https://developer.canaan-creative.com/k230/dev/zh/03_other/K230_SDK_nncase%E7%89%88%E6%9C%AC%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB.html" target="_blank" rel="noopener noreferrer">K230 SDK nncase版本对应关系 — K230 文档 (canaan-creative.com)</a></strong></p>
<p>如果您选择使用<a href="https://developer.canaan-creative.com/resource" target="_blank" rel="noopener noreferrer">嘉楠开发者社区 (canaan-creative.com)</a>资料下载-&gt;K230-&gt;Images部分提供的镜像，请您注意版本对应关系下载烧录。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10241-docker环境搭建">10.2.4.1 Docker环境搭建<a href="#10241-docker环境搭建" class="hash-link" aria-label="Direct link to 10.2.4.1 Docker环境搭建" title="Direct link to 10.2.4.1 Docker环境搭建">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 下载docker编译镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull ghcr.io/kendryte/k230_sdk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 可以使用以下命令确认docker镜像是否拉取成功</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker images | grep ghcr.io/kendryte/k230_sdk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 下载sdk源码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/kendryte/k230_sdk.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd k230_sdk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 下载工具链Linux和RT-Smart toolchain, buildroot package, AI package等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make prepare_sourcecode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建docker容器，$(pwd):$(pwd)表示系统当前目录映射到docker容器内部的相同目录下，将系统下的工具链目录映射到docker容器内部的/opt/toolchain目录下</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -u root -it -v $(pwd):$(pwd) -v $(pwd)/toolchain:/opt/toolchain -w $(pwd) ghcr.io/kendryte/k230_sdk /bin/bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10242-镜像编译">10.2.4.2 镜像编译<a href="#10242-镜像编译" class="hash-link" aria-label="Direct link to 10.2.4.2 镜像编译" title="Direct link to 10.2.4.2 镜像编译">​</a></h4>
<p>如果您使用开发者社区下载的镜像，请在k230_sdk根目录下执行：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">make mpp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>该步骤相比于编译镜像耗时较短。</p>
<p>如果您不使用开发者社区的镜像，想体验镜像编译的完整过程，请在k230_sdk根目录下执行下述命令：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 在docker容器中编译镜像耗时较长，请耐心等待完成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make CONF=k230_canmv_defconfig</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10243-镜像烧录">10.2.4.3 镜像烧录<a href="#10243-镜像烧录" class="hash-link" aria-label="Direct link to 10.2.4.3 镜像烧录" title="Direct link to 10.2.4.3 镜像烧录">​</a></h4>
<p>编译结束后在output/k230_canmv_defconfig/images目录下可以找到编译好的镜像文件：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">k230_canmv_defconfig/images</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ├── big-core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ├── little-core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ├── sysimage-sdcard.img    # SD卡启动镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> └── sysimage-sdcard.img.gz # SD卡启动镜像压缩包</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>CANMV K230 支持SDCard启动方式。为方便开发，建议您准备一张TF卡(Micro SD卡)。</p>
<p><strong>Linux:</strong></p>
<p>在SD卡插到宿主机之前，输入：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ls -l /dev/sd\*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>查看当前的存储设备。</p>
<p>将TF卡插入宿主机后，再次输入：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ls -l /dev/sd\*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>查看此时的存储设备，新增加的就是TF卡设备节点。</p>
<p>假设/dev/sdc就是TF卡设备节点，执行如下命令烧录TF卡：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo dd if=sysimage-sdcard.img of=/dev/sdc bs=1M oflag=sync</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Windows:</strong></p>
<p>Windows下可通过rufus工具对TF卡进行烧录，<a href="http://rufus.ie/downloads/" target="_blank" rel="noopener noreferrer">rufus工具下载地址</a>。</p>
<p>1）将SD卡插入PC，然后启动rufus工具，点击工具界面的”选择”按钮，选择待烧写的固件。</p>
<p><img decoding="async" loading="lazy" alt="rufus-flash-from-file" src="/assets/images/rufus_select-1721612823975-27-d7997d7eaf258b707f384880887bda39.png" width="1533" height="806" class="img_ev3q"></p>
<p>2）点击“开始”按钮开始烧写，烧写过程有进度条展示，烧写结束后会提示“准备就绪”。</p>
<p><img decoding="async" loading="lazy" alt="rufus-flash" src="/assets/images/rufus_start-1721612826112-30-0365da8e19357ce420c4bd9ce05c93ba.png" width="591" height="792" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="rufus-sure" src="data:image/png;base64,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" width="682" height="259" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="rufus-warning" src="/assets/images/rufus_warning-1721612830017-36-02b4676d68826fbaa6733fd16c8bb305.png" width="685" height="284" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="rufus_finish" src="/assets/images/rufus_finish-1721612832001-39-ee9f7245b8722c20d46c1dd7a35e003d.png" width="593" height="804" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10244-上电启动开发板">10.2.4.4 上电启动开发板<a href="#10244-上电启动开发板" class="hash-link" aria-label="Direct link to 10.2.4.4 上电启动开发板" title="Direct link to 10.2.4.4 上电启动开发板">​</a></h4>
<p>安装MobaXterm实现串口通信，MobaXterm下载地址:<a href="https://mobaxterm.mobatek.net/" target="_blank" rel="noopener noreferrer">https://mobaxterm.mobatek.net</a>。</p>
<p><img decoding="async" loading="lazy" alt="CanMV-K230_debug" src="/assets/images/CanMV-K230_debug-1721612834786-42-a1d8f2863ff90f28e651b1ea555acb72.png" width="738" height="531" class="img_ev3q"></p>
<p>将烧录完成的SD卡插入进开板板卡槽中，HDMI输出连显示器，百兆网口连以太网，POWER连串口并供电。系统上电后，默认会有<strong>两个串口设备</strong>，可分别用于访问小核Linux和大核RTSmart</p>
<p>小核Linux默认用户名root，密码为空。大核RTSmart系统中开机会自动启动一个应用程序，可按<code>q</code>键退出至命令提示符终端。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1025-c代码编译">10.2.5 C++代码编译<a href="#1025-c代码编译" class="hash-link" aria-label="Direct link to 10.2.5 C++代码编译" title="Direct link to 10.2.5 C++代码编译">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10251-代码结构">10.2.5.1 代码结构<a href="#10251-代码结构" class="hash-link" aria-label="Direct link to 10.2.5.1 代码结构" title="Direct link to 10.2.5.1 代码结构">​</a></h4>
<p>完成上述开发板的准备工作后，我们可以使用C++编写自己的代码，下面就目标检测任务的示例代码进行解析。本教程给出相关目标检测任务的示例代码，并进行解析。示例代码参考:<a href="https://github.com/kendryte/K230_training_scripts/tree/main/end2end_det_doc/k230_code" target="_blank" rel="noopener noreferrer">kendryte/K230_training_scripts</a></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">k230_code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──cmake</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ├──link.lds #链接脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ├──Riscv64.cmake</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──k230_deploy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ├──ai_base.cc # 模型部署基类实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ├──ai_base.h # 模型部署基类，封装了nncase加载、input设置、模型推理、获取output操作，后续具体任务开发只需关注模型的前处理、后处理即可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ├──anchorbase_det.cc # 目标检测code类实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ├──anchorbase_det.h # 目标检测类定义，继承AIBase，用于加载kmodel实现目标检  测任务,封装模型推理的前后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ├──main.cc # 主函数，参数解析，初始化AnchorBaseDet类示例，实现上板功能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ├──scoped_timing.hpp # 时间测试工具</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ├──utils.cc # 工具类实现 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ├──utils.h # 工具类, 封装了图像预处理和目标检测任务的常用函数，包括读取二进制文件、保存图片、图像处理、结果绘制等，用户可根据自己需求丰富该文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ├──vi_vo.h # 视频输入输出头文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ├──json.h # json文件解析头文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ├──json.cpp # json文件解析接口实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ├──CMakeLists.txt # CMake脚本用于构建一个使用C/C++源文件的可执行文件，并链接到各种库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──build_app.sh # 编译脚本，使用交叉编译工具链编译k230_deploy工程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──CMakeLists.txt # CMake脚本用于构建 nncase_sdk 的项目工程</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10252-核心代码">10.2.5.2 核心代码<a href="#10252-核心代码" class="hash-link" aria-label="Direct link to 10.2.5.2 核心代码" title="Direct link to 10.2.5.2 核心代码">​</a></h4>
<p>当您得到kmodel模型之后，具体AI上板代码包括：sensor&amp;display初始化、kmodel加载、模型输入输出设置、获取图像、输入数据加载、输入数据预处理、模型推理、模型输出获取、输出后处理、OSD显示等步骤。如图所示：</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/pipeline-1721612838571-45-acbe5363152f8e5fd8cfcb62200f200a.jpg" width="1091" height="316" class="img_ev3q"></p>
<p>图中黄框部分在vi_vo.h中给出了给出了接口，下面针对红框部分，介绍如何实现AI应用开发。</p>
<p>在上述过程中，kmodel加载、模型输入设置、模型推理、模型输出获取是所有任务的共有步骤。我们对此做了封装，ai_base.h和ai_base.cc可以直接拷贝使用。</p>
<p>ai_base.h定义了AIBase基类以及共有操作的接口：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#ifndef AI_BASE_H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define AI_BASE_H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;vector&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;string&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;fstream&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;nncase/runtime/interpreter.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;scoped_timing.hpp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using std::string;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using std::vector;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using namespace nncase::runtime;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @brief AI基类，封装nncase相关操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 主要封装了nncase的加载、设置输入、运行、获取输出操作，后续开发demo只需要关注模型的前处理、后处理即可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief AI基类构造函数，加载kmodel,并初始化kmodel输入、输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param kmodel_file kmodel文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param debug_mode  0（不调试）、 1（只显示时间）、2（显示所有打印信息）None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AIBase(const char *kmodel_file,const string model_name, const int debug_mode = 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief AI基类析构函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ~AIBase();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief 设置kmodel输入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param buf 输入数据指针</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param size 输入数据大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void set_input(const unsigned char *buf, size_t size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief 根据索引获取kmodel输入tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param idx 输入数据索引</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    runtime_tensor get_input_tensor(size_t idx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief 设置模型的输入tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param idx 输入数据索引</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param tensor 输入tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void set_input_tensor(size_t idx, runtime_tensor &amp;tensor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief 初始化kmodel输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void set_output();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief 推理kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void run();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief 获取kmodel输出，结果保存在对应的类属性中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void get_output();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string model_name_;                    // 模型名字</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int debug_mode_;                       // 调试模型，0（不打印），1（打印时间），2（打印所有）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;float *&gt; p_outputs_;            // kmodel输出对应的指针列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;vector&lt;int&gt;&gt; input_shapes_;     //{{N,C,H,W},{N,C,H,W}...}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;vector&lt;int&gt;&gt; output_shapes_;    //{{N,C,H,W},{N,C,H,W}...}} 或 {{N,C},{N,C}...}}等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;int&gt; each_input_size_by_byte_;  //{0,layer1_length,layer1_length+layer2_length,...}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;int&gt; each_output_size_by_byte_; //{0,layer1_length,layer1_length+layer2_length,...}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief 首次初始化kmodel输入，并获取输入shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void set_input_init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @brief 首次初始化kmodel输出，并获取输出shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void set_output_init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;unsigned char&gt; kmodel_vec_; // 通过读取kmodel文件得到整个kmodel数据，用于传给kmodel解释器加载kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interpreter kmodel_interp_; // kmodel解释器，从kmodel文件构建，负责模型的加载、输入输出设置和推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ai_base.cc是ai_base.h中定义所有接口的具体实现。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ai_base.h中AIBase类定义接口的具体实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;ai_base.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;iostream&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;cassert&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;utils.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using std::cout;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using std::endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using namespace nncase;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using namespace nncase::runtime::detail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*AIBase构造函数*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AIBase::AIBase(const char *kmodel_file,const string model_name, const int debug_mode) : debug_mode_(debug_mode),model_name_(model_name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (debug_mode &gt; 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cout &lt;&lt; &quot;kmodel_file:&quot; &lt;&lt; kmodel_file &lt;&lt; endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::ifstream ifs(kmodel_file, std::ios::binary);//读入kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_interp_.load_model(ifs).expect(&quot;Invalid kmodel&quot;);//kmodel解释器加载kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    set_input_init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    set_output_init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*析构函数*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AIBase::~AIBase()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">首次初始化kmodel输入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void AIBase::set_input_init()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScopedTiming st(model_name_ + &quot; set_input init&quot;, debug_mode_);//计时</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int input_total_size = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    each_input_size_by_byte_.push_back(0); // 先补0,为之后做准备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; kmodel_interp_.inputs_size(); ++i)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto desc = kmodel_interp_.input_desc(i);//索引为i的输入描述</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto shape = kmodel_interp_.input_shape(i);//索引为i的输入shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto tensor = host_runtime_tensor::create(desc.datatype, shape, hrt::pool_shared).expect(&quot;cannot create input tensor&quot;);//创建输入tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kmodel_interp_.input_tensor(i, tensor).expect(&quot;cannot set input tensor&quot;);//绑定tensor到模型输入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vector&lt;int&gt; in_shape = {shape[0], shape[1], shape[2], shape[3]};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_shapes_.push_back(in_shape);//存储输入shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int dsize = shape[0] * shape[1] * shape[2] * shape[3];//输入总字节数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (debug_mode_ &gt; 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cout &lt;&lt; &quot;input shape:&quot; &lt;&lt; shape[0] &lt;&lt; &quot; &quot; &lt;&lt; shape[1] &lt;&lt; &quot; &quot; &lt;&lt; shape[2] &lt;&lt; &quot; &quot; &lt;&lt; shape[3] &lt;&lt; endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (desc.datatype == 0x06)//输入数据为uint8类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            input_total_size += dsize;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            each_input_size_by_byte_.push_back(input_total_size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else if (desc.datatype == 0x0B)//输入数据为float32类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            input_total_size += (dsize * 4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            each_input_size_by_byte_.push_back(input_total_size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            assert((&quot;kmodel input data type supports only uint8, float32&quot;, 0));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    each_input_size_by_byte_.push_back(input_total_size); // 最后一个保存总大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">设置模型的输入数据,加载模型输入的具体数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void AIBase::set_input(const unsigned char *buf, size_t size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //检查输入数据大小 是否和模型要求大小相匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (*each_input_size_by_byte_.rbegin() != size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cout &lt;&lt; &quot;set_input:the actual input size{&quot; + std::to_string(size) + &quot;} is different from the model&#x27;s required input size{&quot; + std::to_string(*each_input_size_by_byte_.rbegin()) + &quot;}&quot; &lt;&lt; endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assert((*each_input_size_by_byte_.rbegin() == size));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //计时</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScopedTiming st(model_name_ + &quot; set_input&quot;, debug_mode_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //循环遍历模型输入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (size_t i = 0; i &lt; kmodel_interp_.inputs_size(); ++i)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //获取模型的输入描述和形状</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto desc = kmodel_interp_.input_desc(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto shape = kmodel_interp_.input_shape(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //创建tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto tensor = host_runtime_tensor::create(desc.datatype, shape, hrt::pool_shared).expect(&quot;cannot create input tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //将输入tensor映射到可写区域</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto mapped_buf = std::move(hrt::map(tensor, map_access_::map_write).unwrap()); // mapped_buf实际是有缓存数据的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //拷贝数据到tensor的缓冲区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        memcpy(reinterpret_cast&lt;void *&gt;(mapped_buf.buffer().data()), buf, each_input_size_by_byte_[i + 1] - each_input_size_by_byte_[i]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //解除映射</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto ret = mapped_buf.unmap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret = hrt::sync(tensor, sync_op_t::sync_write_back, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!ret.is_ok())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            std::cerr &lt;&lt; &quot;hrt::sync failed&quot; &lt;&lt; std::endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            std::abort();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //将tensor和模型的输入绑定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kmodel_interp_.input_tensor(i, tensor).expect(&quot;cannot set input tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">按照索引获取模型的输入tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runtime_tensor AIBase::get_input_tensor(size_t idx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return kmodel_interp_.input_tensor(idx).expect(&quot;cannot get input tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">按照索引设置模型的输入tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void AIBase::set_input_tensor(size_t idx, runtime_tensor &amp;tensor)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScopedTiming st(model_name_ + &quot; set_input_tensor&quot;, debug_mode_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_interp_.input_tensor(idx, tensor).expect(&quot;cannot set input tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">首次初始化kmodel输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void AIBase::set_output_init()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //计时</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScopedTiming st(model_name_ + &quot; set_output_init&quot;, debug_mode_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    each_output_size_by_byte_.clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int output_total_size = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    each_output_size_by_byte_.push_back(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //循环遍历模型的输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (size_t i = 0; i &lt; kmodel_interp_.outputs_size(); i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //获 取输出描述和形状</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto desc = kmodel_interp_.output_desc(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto shape = kmodel_interp_.output_shape(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vector&lt;int&gt; out_shape;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int dsize = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int j = 0; j &lt; shape.size(); ++j)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            out_shape.push_back(shape[j]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dsize *= shape[j];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (debug_mode_ &gt; 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                cout &lt;&lt; shape[j] &lt;&lt; &quot;,&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (debug_mode_ &gt; 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cout &lt;&lt; endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        output_shapes_.push_back(out_shape);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //获取数据的总大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (desc.datatype == 0x0B)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            output_total_size += (dsize * 4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            each_output_size_by_byte_.push_back(output_total_size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            assert((&quot;kmodel output data type supports only float32&quot;, 0));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //创建tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto tensor = host_runtime_tensor::create(desc.datatype, shape, hrt::pool_shared).expect(&quot;cannot create output tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //将tensor和模型的输出绑定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kmodel_interp_.output_tensor(i, tensor).expect(&quot;cannot set output tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">设置kmodel模型的输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void AIBase::set_output()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScopedTiming st(model_name_ + &quot; set_output&quot;, debug_mode_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //循环将输出tensor和模型的输出绑定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (size_t i = 0; i &lt; kmodel_interp_.outputs_size(); i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto desc = kmodel_interp_.output_desc(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto shape = kmodel_interp_.output_shape(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto tensor = host_runtime_tensor::create(desc.datatype, shape, hrt::pool_shared).expect(&quot;cannot create output tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kmodel_interp_.output_tensor(i, tensor).expect(&quot;cannot set output tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">调用kmodel_interp_.run()实现模型推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void AIBase::run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScopedTiming st(model_name_ + &quot; run&quot;, debug_mode_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kmodel_interp_.run().expect(&quot;error occurred in running model&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">获取模型的输出(float指针形式，后处理时由后处理的具体要求取出)，为后续后处理做准备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void AIBase::get_output()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScopedTiming st(model_name_ + &quot; get_output&quot;, debug_mode_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //p_outputs_存储模型的输出的指针，可以有多个输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    p_outputs_.clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; kmodel_interp_.outputs_size(); i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //获取输出tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto out = kmodel_interp_.output_tensor(i).expect(&quot;cannot get output tensor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //将输出tensor映射到主机内存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        auto buf = out.impl()-&gt;to_host().unwrap()-&gt;buffer().as_host().unwrap().map(map_access_::map_read).unwrap().buffer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //将映射后的数据转换为float指针</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        float *p_out = reinterpret_cast&lt;float *&gt;(buf.data());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        p_outputs_.push_back(p_out);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>不同任务场景的前处理和后处理有所不同  ，比如分类使用softmax计算类别概率，目标检测要做nms；因此您可以定义您的任务场景类继承AIBase类，将针对该任务的前处理和后处理代码进行封装。</p>
<p>anchorbase_det.h定义了和目标检测任务相关的模型前处理、后处理接口，在anchorbase_det.cc中实现了接口。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#ifndef _ANCHORBASE_DET_H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define _ANCHORBASE_DET_H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;utils.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;ai_base.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define STRIDE_NUM 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @brief 多目标检测</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 主要封装了对于每一帧图片，从预处理、运行到后处理给出结果的过程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class AnchorBaseDet : public AIBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @brief AnchorBaseDet构造函数，加载kmodel,并初始化kmodel输入、输出和多目标检测阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param args        构建对象需要的参数，config.json文件（包含检测阈值等）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param kmodel_file  kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param debug_mode  0（不调试）、 1（只显示时间）、2（显示所有打印信息）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AnchorBaseDet(config_args args, const char *kmodel_file, const int debug_mode = 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @brief AnchorBaseDet构造函数，加载kmodel, 并初始化kmodel输入、输出和多目标检测阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param args        构建对象需要的参数，config.json文件（包含检测阈值，kmodel路径等）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param kmodel_file  kmodel路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param isp_shape   isp输入大小（chw）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param vaddr       isp对应虚拟地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param paddr       isp对应物理地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param debug_mode  0（不调试）、 1（只显示时间）、2（显示所有打印信息）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AnchorBaseDet(config_args args, const char *kmodel_file, FrameCHWSize isp_shape, uintptr_t vaddr, uintptr_t paddr,const int debug_mode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @brief AnchorBaseDet析构函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ~AnchorBaseDet();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @brief 图片预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param ori_img 原始图片</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void pre_process(cv::Mat ori_img);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @brief 视频流预处理（ai2d for isp）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void pre_process();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @brief kmodel推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void inference();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @brief kmodel推理结果后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param frame_size 原始图像/帧宽高，用于将结果放到原始图像大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param results 后处理之后的基于原始图像的检测结果集合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void post_process(FrameSize frame_size, vector&lt;ob_det_res&gt; &amp;results);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @brief 检查结果的初步处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param data 模型输出一层的头指针</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param frame_size 原始图像/帧宽高，用于将结果放到原始图像大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param k 模型的第k层索引</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @return 处理后的检测框集合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;ob_det_res&gt; decode_infer(float* data, FrameSize frame_size, int k);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @brief 检查结果的初步处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param data 模型输出一层的头指针</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param frame_size 原始图像/帧宽高，用于将结果放到原始图像大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param k 模型的第k层索引</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @return 处理后的检测框集合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;vector&lt;ob_det_res&gt;&gt; decode_infer_class(float* data, FrameSize frame_size, int k);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @brief 对检测结果进行非最大值抑制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @param input_boxes 检测框集合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * @return None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> void nms(vector&lt;ob_det_res&gt;&amp; input_boxes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::unique_ptr&lt;ai2d_builder&gt; ai2d_builder_; // ai2d构建器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    runtime_tensor ai2d_in_tensor_;              // ai2d输入tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    runtime_tensor ai2d_out_tensor_;             // ai2d输出tensor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uintptr_t vaddr_;                            // isp的虚拟地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FrameCHWSize isp_shape_;                     // isp对应的地址大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float ob_det_thresh;   //检测框分数阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float ob_nms_thresh;   //nms阈值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;string&gt; labels; //类别名字</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int num_class;         //类别数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> int strides[STRIDE_NUM]; //每层检测结果的分辨率缩减被数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> float anchors[3][3][2];  //检测的预设anchor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bool nms_option;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int input_height;      //模型输入高</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int input_width;       //模型输入宽</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float *output_0;    //读取kmodel输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float *output_1;    //读取kmodel输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float *output_2;    //读取kmodel输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>anchorbase_det.cc是anchorbase_det.h中目标检测相关前后处理接口的具体实现。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;anchorbase_det.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*静态图推理构造函数，继承AIBase，参数初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AnchorBaseDet::AnchorBaseDet(config_args args, const char *kmodel_file, const int debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">:ob_det_thresh(args.obj_thresh),ob_nms_thresh(args.nms_thresh),labels(args.labels), AIBase(kmodel_file,&quot;AnchorBaseDet&quot;, debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_option = args.nms_option;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_class = labels.size();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memcpy(this-&gt;strides, args.strides, sizeof(args.strides));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memcpy(this-&gt;anchors, args.anchors, sizeof(args.anchors));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_width = input_shapes_[0][3];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_height = input_shapes_[0][2];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_out_tensor_ = this -&gt; get_input_tensor(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*视频流推理的构造函数，继承自AIBase,参数初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AnchorBaseDet::AnchorBaseDet(config_args args, const char *kmodel_file, FrameCHWSize isp_shape, uintptr_t vaddr, uintptr_t paddr,const int debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">:ob_det_thresh(args.obj_thresh),ob_nms_thresh(args.nms_thresh),labels(args.labels), AIBase(kmodel_file,&quot;AnchorBaseDet&quot;, debug_mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nms_option = args.nms_option;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_class = labels.size();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memcpy(this-&gt;strides, args.strides, sizeof(args.strides));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memcpy(this-&gt;anchors, args.anchors, sizeof(args.anchors));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_width = input_shapes_[0][3];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_height = input_shapes_[0][2];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vaddr_ = vaddr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    isp_shape_ = isp_shape;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dims_t in_shape{1, isp_shape.channel, isp_shape.height, isp_shape.width};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_in_tensor_ = hrt::create(typecode_t::dt_uint8, in_shape, hrt::pool_shared).expect(&quot;create ai2d input tensor failed&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_out_tensor_ = this -&gt; get_input_tensor(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Utils::padding_resize(isp_shape, {input_shapes_[0][3], input_shapes_[0][2]}, ai2d_builder_, ai2d_in_tensor_, ai2d_out_tensor_, cv::Scalar(114, 114, 114));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*析构函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AnchorBaseDet::~AnchorBaseDet()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 目标检测任务的单图推理预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void AnchorBaseDet::pre_process(cv::Mat ori_img)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScopedTiming st(model_name_ + &quot; pre_process image&quot;, debug_mode_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::vector&lt;uint8_t&gt; chw_vec;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Utils::bgr2rgb_and_hwc2chw(ori_img, chw_vec);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Utils::padding_resize({ori_img.channels(), ori_img.rows, ori_img.cols}, chw_vec, {input_shapes_[0][3], input_shapes_[0][2]}, ai2d_out_tensor_, cv::Scalar(114, 114, 114));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 使用ai2d实现目标检测任务的视频流推理预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void AnchorBaseDet::pre_process()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScopedTiming st(model_name_ + &quot; pre_process video&quot;, debug_mode_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t isp_size = isp_shape_.channel * isp_shape_.height * isp_shape_.width;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auto buf = ai2d_in_tensor_.impl()-&gt;to_host().unwrap()-&gt;buffer().as_host().unwrap().map(map_access_::map_write).unwrap().buffer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memcpy(reinterpret_cast&lt;char *&gt;(buf.data()), (void *)vaddr_, isp_size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hrt::sync(ai2d_in_tensor_, sync_op_t::sync_write_back, true).expect(&quot;sync write_back failed&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ai2d_builder_-&gt;invoke(ai2d_in_tensor_, ai2d_out_tensor_).expect(&quot;error occurred in ai2d running&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void AnchorBaseDet::inference()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this-&gt;run();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this-&gt;get_output();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 目标检测任务的后处理，包括从模型输出解析位置，解析类别，做NMS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void AnchorBaseDet::post_process(FrameSize frame_size, vector&lt;ob_det_res&gt; &amp;results)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScopedTiming st(model_name_ + &quot; post_process&quot;, debug_mode_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output_0 = p_outputs_[0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output_1 = p_outputs_[1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output_2 = p_outputs_[2];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (nms_option)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vector&lt;ob_det_res&gt; box0, box1, box2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        box0 = decode_infer(output_0, frame_size, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        box1 = decode_infer(output_1, frame_size, 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        box2 = decode_infer(output_2, frame_size, 2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        results.insert(results.begin(), box0.begin(), box0.end());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        results.insert(results.begin(), box1.begin(), box1.end());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        results.insert(results.begin(), box2.begin(), box2.end());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nms(results);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vector&lt;vector&lt;ob_det_res&gt;&gt; box0, box1, box2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        box0 = decode_infer_class(output_0, frame_size, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        box1 = decode_infer_class(output_1, frame_size, 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        box2 = decode_infer_class(output_2, frame_size, 2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for(int i = 0; i &lt; num_class; i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            box0[i].insert(box0[i].begin(), box1[i].begin(), box1[i].end());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            box0[i].insert(box0[i].begin(), box2[i].begin(), box2[i].end());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nms(box0[i]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            results.insert(results.begin(), box0[i].begin(), box0[i].end());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vector&lt;ob_det_res&gt; AnchorBaseDet::decode_infer(float* data, FrameSize frame_size, int k)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int stride = strides[k];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float ratiow = (float)input_width / frame_size.width;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float ratioh = (float)input_height / frame_size.height;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float gain = ratiow &lt; ratioh ? ratiow : ratioh;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::vector&lt;ob_det_res&gt; result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int grid_size_w = input_width / stride;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int grid_size_h = input_height / stride;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int one_rsize = num_class + 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float cx, cy, w, h;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int shift_y = 0; shift_y &lt; grid_size_h; shift_y++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int shift_x = 0; shift_x &lt; grid_size_w; shift_x++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int loc = shift_x + shift_y * grid_size_w;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int i = 0; i &lt; 3; i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                float* record = data + (loc * 3 + i) * one_rsize;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                float* cls_ptr = record + 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (int cls = 0; cls &lt; num_class; cls++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    float score = (cls_ptr[cls]) * (record[4]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (score &gt; ob_det_thresh)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        cx = ((record[0]) * 2.f - 0.5f + (float)shift_x) * (float)stride;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        cy = ((record[1]) * 2.f - 0.5f + (float)shift_y) * (float)stride;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        w = pow((record[2]) * 2.f, 2) * anchors[k][i][0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        h = pow((record[3]) * 2.f, 2) * anchors[k][i][1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        cx -= ((input_width - frame_size.width * gain) / 2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        cy -= ((input_height - frame_size.height * gain) / 2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        cx /= gain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        cy /= gain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        w /= gain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        h /= gain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ob_det_res box;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        box.x1 = std::max(0, std::min(int(frame_size.width), int(cx - w / 2.f)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        box.y1 = std::max(0, std::min(int(frame_size.height), int(cy - h / 2.f)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        box.x2 = std::max(0, std::min(int(frame_size.width), int(cx + w / 2.f)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        box.y2 = std::max(0, std::min(int(frame_size.height), int(cy + h / 2.f)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        box.score = score;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        box.label_index = cls;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        box.label = labels[cls];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        result.push_back(box);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vector&lt;vector&lt;ob_det_res&gt;&gt; AnchorBaseDet::decode_infer_class(float* data, FrameSize frame_size, int k)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int stride = strides[k];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float ratiow = (float)input_width / frame_size.width;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float ratioh = (float)input_height / frame_size.height;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float gain = ratiow &lt; ratioh ? ratiow : ratioh;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::vector&lt;std::vector&lt;ob_det_res&gt;&gt; result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; num_class; i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result.push_back(vector&lt;ob_det_res&gt;());//不断往v2d里加行 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int grid_size_w = input_width / stride;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int grid_size_h = input_height / stride;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int one_rsize = num_class + 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    float cx, cy, w, h;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int shift_y = 0; shift_y &lt; grid_size_h; shift_y++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int shift_x = 0; shift_x &lt; grid_size_w; shift_x++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int loc = shift_x + shift_y * grid_size_w;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int i = 0; i &lt; 3; i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                float* record = data + (loc * 3 + i) * one_rsize;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                float* cls_ptr = record + 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (int cls = 0; cls &lt; num_class; cls++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    float score = (cls_ptr[cls]) * (record[4]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (score &gt; ob_det_thresh)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        cx = ((record[0]) * 2.f - 0.5f + (float)shift_x) * (float)stride;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        cy = ((record[1]) * 2.f - 0.5f + (float)shift_y) * (float)stride;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        w = pow((record[2]) * 2.f, 2) * anchors[k][i][0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        h = pow((record[3]) * 2.f, 2) * anchors[k][i][1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        cx -= ((input_width - frame_size.width * gain) / 2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        cy -= ((input_height - frame_size.height * gain) / 2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        cx /= gain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        cy /= gain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        w /= gain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        h /= gain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ob_det_res box;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        box.x1 = std::max(0, std::min(int(frame_size.width), int(cx - w / 2.f)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        box.y1 = std::max(0, std::min(int(frame_size.height), int(cy - h / 2.f)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        box.x2 = std::max(0, std::min(int(frame_size.width), int(cx + w / 2.f)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        box.y2 = std::max(0, std::min(int(frame_size.height), int(cy + h / 2.f)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        box.score = score;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        box.label_index = cls;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        box.label = labels[cls];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        result[cls].push_back(box);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void AnchorBaseDet::nms(vector&lt;ob_det_res&gt;&amp; input_boxes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::sort(input_boxes.begin(), input_boxes.end(), [](ob_det_res a, ob_det_res b) { return a.score &gt; b.score; });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std::vector&lt;float&gt; vArea(input_boxes.size());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; int(input_boxes.size()); ++i)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vArea[i] = (input_boxes.at(i).x2 - input_boxes.at(i).x1 + 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * (input_boxes.at(i).y2 - input_boxes.at(i).y1 + 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; int(input_boxes.size()); ++i)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int j = i + 1; j &lt; int(input_boxes.size());)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            float xx1 = std::max(input_boxes[i].x1, input_boxes[j].x1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            float yy1 = std::max(input_boxes[i].y1, input_boxes[j].y1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            float xx2 = std::min(input_boxes[i].x2, input_boxes[j].x2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            float yy2 = std::min(input_boxes[i].y2, input_boxes[j].y2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            float w = std::max(float(0), xx2 - xx1 + 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            float h = std::max(float(0), yy2 - yy1 + 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            float inter = w * h;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            float ovr = inter / (vArea[i] + vArea[j] - inter);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ovr &gt;= ob_nms_thresh)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                input_boxes.erase(input_boxes.begin() + j);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                vArea.erase(vArea.begin() + j);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                j++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其他文件中，utils.h是工具结构体和函数的声明头文件，utils.cc是工具函数的具体实现；vi_vo.h是实现视频输入输出的头文  件；json.h是json文件解析的头文件，程序运行的时候需要实现解析部署配置文件deploy.json，json.cpp是其接口的实现；scoped_timing.hpp是计时工具，用于统计运行时间。</p>
<p>main.cc是主函数，实现启动命令参数解析和静态图、视频流的推理。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*实现静态图推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void image_proc_ob_det(config_args args, char *argv[])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //从参数中的静态图路径读取图片，创建cv::Mat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::Mat ori_img = cv::imread(argv[3]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ori_w = ori_img.cols;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ori_h = ori_img.rows;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;ob_det_res&gt; results;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 实例初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AnchorBaseDet ob_det(args, argv[2], atoi(argv[4]));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ob_det.pre_process(ori_img);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ob_det.inference();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ob_det.post_process({ori_w, ori_h}, results);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //在结果上绘制检测框和类别</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Utils::draw_ob_det_res(ori_img,results);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //保存检测结果图片</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv::imwrite(&quot;result_ob_det.jpg&quot;, ori_img);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>下述代码是视频流推理的过程。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*视频流推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void video_proc_ob_det(config_args args, char *argv[])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //启动video capture</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vivcap_start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> //创建一帧的数据结构实例用于osd显示</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k_video_frame_info vf_info;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void *pic_vaddr = NULL;       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    memset(&amp;vf_info, 0, sizeof(vf_info));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> //数据初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vf_info.v_frame.width = osd_width;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vf_info.v_frame.height = osd_height;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vf_info.v_frame.stride[0] = osd_width;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vf_info.v_frame.pixel_format = PIXEL_FORMAT_ARGB_8888;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    block = vo_insert_frame(&amp;vf_info, &amp;pic_vaddr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // alloc memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t paddr = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void *vaddr = nullptr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    size_t size = SENSOR_CHANNEL * SENSOR_HEIGHT * SENSOR_WIDTH;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int ret = kd_mpi_sys_mmz_alloc_cached(&amp;paddr, &amp;vaddr, &quot;allocate&quot;, &quot;anonymous&quot;, size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std::cerr &lt;&lt; &quot;physical_memory_block::allocate failed: ret = &quot; &lt;&lt; ret &lt;&lt; &quot;, errno = &quot; &lt;&lt; strerror(errno) &lt;&lt; std::endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std::abort();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> //声明检测结果变量results,用于存放检测结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector&lt;ob_det_res&gt; results;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> //实例初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AnchorBaseDet ob_det(args, argv[2], {SENSOR_CHANNEL, SENSOR_HEIGHT, SENSOR_WIDTH}, reinterpret_cast&lt;uintptr_t&gt;(vaddr), reinterpret_cast&lt;uintptr_t&gt;(paddr), atoi(argv[4]));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //while循环内依次获取一帧图像，经过AI模型推理过程输出并后处理，在OSD帧上绘制结果并插入到显示</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (!isp_stop)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ScopedTiming st(&quot;total time&quot;, 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ScopedTiming st(&quot;read capture&quot;, atoi(argv[4]));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // VICAP_CHN_ID_1 out rgb888p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memset(&amp;dump_info, 0 , sizeof(k_video_frame_info));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 将camera的当前帧dump到dump_info中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = kd_mpi_vicap_dump_frame(vicap_dev, VICAP_CHN_ID_1, VICAP_DUMP_YUV, &amp;dump_info, 1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;sample_vicap...kd_mpi_vicap_dump_frame failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //将dump_info内的数据拷贝到AnchorBaseDet实例化时用到的地址vaddr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ScopedTiming st(&quot;isp copy&quot;, atoi(argv[4]));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            auto vbvaddr = kd_mpi_sys_mmap_cached(dump_info.v_frame.phys_addr[0], size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memcpy(vaddr, (void *)vbvaddr, SENSOR_HEIGHT * SENSOR_WIDTH * 3); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            kd_mpi_sys_munmap(vbvaddr, size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //检测结果清空</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        results.clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  //预处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ob_det.pre_process();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ob_det.inference();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  //模型输出后处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ob_det.post_process({SENSOR_WIDTH, SENSOR_HEIGHT},results);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  //创建osd帧数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cv::Mat osd_frame(osd_height, osd_width, CV_8UC4, cv::Scalar(0, 0, 0, 0));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //在osd的一帧上绘制检测框和检测类别</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ScopedTiming st(&quot;osd draw&quot;, atoi(argv[4]));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Utils::draw_ob_det_res(osd_frame, results, {osd_width, osd_height}, {SENSOR_WIDTH, SENSOR_HEIGHT});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //将osd_frame中的数据拷贝到pic_vaddr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ScopedTiming st(&quot;osd copy&quot;, atoi(argv[4]));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            memcpy(pic_vaddr, osd_frame.data, osd_width * osd_height * 4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //显示通道插入帧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            kd_mpi_vo_chn_insert_frame(osd_id+3, &amp;vf_info);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            printf(&quot;kd_mpi_vo_chn_insert_frame success \n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret = kd_mpi_vicap_dump_release(vicap_dev, VICAP_CHN_ID_1, &amp;dump_info);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                printf(&quot;sample_vicap...kd_mpi_vicap_dump_release failed.\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //释放句柄</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vo_osd_release_block();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //停止video capture</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vivcap_stop();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // free memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret = kd_mpi_sys_mmz_free(paddr, vaddr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std::cerr &lt;&lt; &quot;free failed: ret = &quot; &lt;&lt; ret &lt;&lt; &quot;, errno = &quot; &lt;&lt; strerror(errno) &lt;&lt; std::endl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std::abort();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>k230_code/k230_deploy/CMakeLists.txt说明</li>
</ul>
<p>这是k230_code/k230_deploy目录下的CMakeLists.txt脚本，设置编译的C++文件和生成的elf可执行文件名称，由下面：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">set(src main.cc utils.cc ai_base.cc json.cpp anchorbase_det.cc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(bin main.elf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#添加项目的根目录到头文件搜索路径中。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include_directories(${PROJECT_SOURCE_DIR})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#添加 nncase RISC-V 向量库的头文件目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include_directories(${nncase_sdk_root}/riscv64/rvvlib/include)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#添加 k230 SDK 中的用户应用程序 API 头文件目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include_directories(${k230_sdk}/src/big/mpp/userapps/api/)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#添加 k230 SDK 的mpp(Media Process Platform)头文件目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include_directories(${k230_sdk}/src/big/mpp/include)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 添加与mpp相关的头 文件目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include_directories(${k230_sdk}/src/big/mpp/include/comm)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#添加示例 VO（视频输出）应用程序头文件目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include_directories(${k230_sdk}/src/big/mpp/userapps/sample/sample_vo)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#添加链接器搜索路径，指向 nncase RISC-V 向量库的目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">link_directories(${nncase_sdk_root}/riscv64/rvvlib/)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#创建一个可执行文件，将之前设置的源文件列表作为输入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add_executable(${bin} ${src})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#设置可执行文件需要链接的库。列表中列出了各种库，包括 nncase 相关的库、k230 SDK 的库，以及其他一些库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">target_link_libraries(${bin} ...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#将一些 OpenCV相关的库和其他一些第三方库链接到可执行文件中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">target_link_libraries(${bin} opencv_imgproc opencv_imgcodecs opencv_core zlib libjpeg-turbo libopenjp2 libpng libtiff libwebp csi_cv)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 安装生成的可执行文件到指定的目标路径（bin 目录）中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">install(TARGETS ${bin} DESTINATION bin)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>k230_code/CMakeLists.txt说明</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cmake_minimum_required(VERSION 3.2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">project(nncase_sdk C CXX)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 设置nncase的根目录，在src/big/nncase目录下，您也可设置为绝对路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(nncase_sdk_root &quot;${PROJECT_SOURCE_DIR}/../../nncase/&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 设置k230_sdk的根目录，当前是从nncase目录的三级父目录得到，您也可设置为绝对路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(k230_sdk ${nncase_sdk_root}/../../../)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#设置链接脚本路径，链接脚本放于k230_code/cmake下</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(CMAKE_EXE_LINKER_FLAGS &quot;-T ${PROJECT_SOURCE_DIR}/cmake/link.lds --static&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># set opencv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set(k230_opencv ${k230_sdk}/src/big/utils/lib/opencv)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include_directories(${k230_opencv}/include/opencv4/)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">link_directories(${k230_opencv}/lib ${k230_opencv}/lib/opencv4/3rdparty)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># set mmz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">link_directories(${k230_sdk}/src/big/mpp/userapps/lib)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># set nncase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include_directories(${nncase_sdk_root}/riscv64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include_directories(${nncase_sdk_root}/riscv64/nncase/include)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include_directories(${nncase_sdk_root}/riscv64/nncase/include/nncase/runtime)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">link_directories(${nncase_sdk_root}/riscv64/nncase/lib/)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 添加待编译子项目</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add_subdirectory(k230_deploy)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>k230_code/build_app.sh说明</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># set cross build toolchain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 将交叉编译工具链的路径添加到系统的 PATH 环境变量中，以便在后续的命令中使用。该工具链是使用的大核编译工具链。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export PATH=$PATH:/opt/toolchain/riscv64-linux-musleabi_for_x86_64-pc-linux-gnu/bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clear</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm -rf out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pushd out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cmake -DCMAKE_BUILD_TYPE=Release                 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      -DCMAKE_INSTALL_PREFIX=`pwd`               \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      -DCMAKE_TOOLCHAIN_FILE=cmake/Riscv64.cmake \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make -j &amp;&amp; make install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">popd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 生成的main.elf可以在k230_code目录下的k230_bin文件夹下找到</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k230_bin=`pwd`/k230_bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm -rf ${k230_bin}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p ${k230_bin}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [ -f out/bin/main.elf ]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      cp out/bin/main.elf ${k230_bin}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10253-代码编译">10.2.5.3 代码编译<a href="#10253-代码编译" class="hash-link" aria-label="Direct link to 10.2.5.3 代码编译" title="Direct link to 10.2.5.3 代码编译">​</a></h4>
<p>将项目中的k230_code文件夹拷贝到k230_sdk目录下的src/big/nncase下，执行编译脚本，将C++代码编译成main.elf可执行文件。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 在k230_SDK根目录下执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make CONF=k230_canmv_defconfig prepare_memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 回到当前项目目录，赋予权限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chmod +x build_app.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./build_app.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10254-准备elf文件">10.2.5.4 准备ELF文件<a href="#10254-准备elf文件" class="hash-link" aria-label="Direct link to 10.2.5.4 准备ELF文件" title="Direct link to 10.2.5.4 准备ELF文件">​</a></h4>
<p>后面部署步骤需要用到的文件包括：</p>
<ol>
<li>k230_code/k230_bin/main.elf;</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1026-网络配置与文件拷贝">10.2.6 网络配置与文件拷贝<a href="#1026-网络配置与文件拷贝" class="hash-link" aria-label="Direct link to 10.2.6 网络配置与文件拷贝" title="Direct link to 10.2.6 网络配置与文件拷贝">​</a></h3>
<p>将待使用文件拷贝到开发板上有三种方式可供选择。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10261-离线文件拷贝">10.2.6.1 离线文件拷贝<a href="#10261-离线文件拷贝" class="hash-link" aria-label="Direct link to 10.2.6.1 离线文件拷贝" title="Direct link to 10.2.6.1 离线文件拷贝">​</a></h4>
<p>通过插拔SD卡，将所需文件拷贝到相应位置，SD卡根目录映射到大小核的/sharefs目录下。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10262-tftp文件传输">10.2.6.2 tftp文件传输<a href="#10262-tftp文件传输" class="hash-link" aria-label="Direct link to 10.2.6.2 tftp文件传输" title="Direct link to 10.2.6.2 tftp文件传输">​</a></h4>
<ul>
<li>Windows系统PC端网络配置</li>
</ul>
<p>控制面板-&gt;网络和共享中心-&gt;更改适配器设置-&gt;以太网网卡-&gt;右键属性-&gt;选中(TCP/IPv4)-&gt;属性</p>
<p>配置IP地址、掩码、网关，配置DNS服务器地址：</p>
<p><img decoding="async" loading="lazy" alt="net_config_0" src="/assets/images/net_config_0-1721612853487-48-739747cdb23dc4f8fd9624817b73cc15.png" width="695" height="871" class="img_ev3q"></p>
<ul>
<li>开发板网络配置</li>
</ul>
<p>进入小核命令行，执行：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 查看是否有eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ifconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 配置开发板IP，和PC在同一网段下</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ifconfig eth0 192.168.1.22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看IP配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ifconfig</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>工具：tftpd64</li>
</ul>
<p>安装tftp通信工具，下载地址：<a href="https://bitbucket.org/phjounin/tftpd64/downloads/" target="_blank" rel="noopener noreferrer">https://bitbucket.org/phjounin/tftpd64/downloads/</a></p>
<p>启动tftpd64，配置待传输文件存放目录和服务网卡</p>
<p><img decoding="async" loading="lazy" alt="net_config_1" src="/assets/images/net_config_1-1721612860558-51-2fd22db8d543e85fae1a8aeace246465.png" width="1012" height="502" class="img_ev3q"></p>
<ul>
<li>sharefs说明</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 进入小核根目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># sharefs目录是大小核共用目录，因此从小核拷贝到sharefs目录下的文件对大核也可见</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>文件传输</li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 以下代码在小核串口执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 将PC上tftpd64配置文件存放目录中的文件传输至开发板的当前目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tftp -g -r your_file 192.168.1.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 将开发板当前目录下的文件传输至tftpd64配置文件存放目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tftp -p -r board_file 192.168.1.2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10262-scp文件传输">10.2.6.2 scp文件传输<a href="#10262-scp文件传输" class="hash-link" aria-label="Direct link to 10.2.6.2 scp文件传输" title="Direct link to 10.2.6.2 scp文件传输">​</a></h4>
<p>在Linux系统中，PC正常连接网络，开发板可以通过网线连接PC所在网关下其他网口，通过scp命令实现文件传输。</p>
<p>开发板上电，进入大小核COM界面，在小核执行scp传输命令：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 从PC拷贝文件至开发板</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scp 用户名@域名或IP:文件所在目录 开发板目的目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#拷贝文件夹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scp -r 用户名@域名或IP:文件所在目录 开发板目的目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 从开发板拷贝文件至PC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scp 开发板待拷贝目录 用户名@域名或IP:PC目的目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 拷贝文件夹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scp -r 开发板待拷贝目录 用户名@域名或IP:PC目的目录</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1027-k230端部署">10.2.7 K230端部署<a href="#1027-k230端部署" class="hash-link" aria-label="Direct link to 10.2.7 K230端部署" title="Direct link to 10.2.7 K230端部署">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10271-板端部署过程">10.2.7.1 板端部署过程<a href="#10271-板端部署过程" class="hash-link" aria-label="Direct link to 10.2.7.1 板端部署过程" title="Direct link to 10.2.7.1 板端部署过程">​</a></h4>
<p>按照上节配置好的文件传输过程，在MobaXterm上的小核界面进入/sharefs，创建测试文件夹：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd /sharefs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir test_det</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd test_det</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>将模型训练和测试部分准备好的文件和C++代码编译部分准备好的elf文件拷贝到开发板。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">test_cls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ├──best.kmodel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ├──deploy.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ├──main.elf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ├──test.jpg</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在大核COM口进入到/sharefs/test_det目录下，</p>
<p>执行静态图推理，执行下述代码(注意：代码需在大核下执行，文件拷贝需在小核下完成)：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&quot;模型推理时传参说明：&lt;config_file&gt; &lt;kmodel_det&gt; &lt;input_mode&gt; &lt;debug_mode&gt;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;Options:&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;  config_file     部署所用json配置文件,默认为 deploy_config.json&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;  kmodel_det      kmodel路径&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;  input_mode      本地图片(图片路径)/ 摄像头(None)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;  debug_mode      是否需要调试，0、1、2分别表示不调试、简单调试、详细调试&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main.elf deploy.json best.kmodel test.jpg 2 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如执行摄像头视频流推理，执行下述代码：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">main.elf deploy.json best.kmodel None 2 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="10272-上板部署效果">10.2.7.2 上板部署效果<a href="#10272-上板部署效果" class="hash-link" aria-label="Direct link to 10.2.7.2 上板部署效果" title="Direct link to 10.2.7.2 上板部署效果">​</a></h4>
<p>静态图推理图示：</p>
<p><img decoding="async" loading="lazy" alt="静态图检测推理" src="/assets/images/det_image_inference-fbe71d83ef7794c7e6beea7e4ddd7052.jpg" width="349" height="349" class="img_ev3q"></p>
<p>视频流推理图示：</p>
<p><img decoding="async" loading="lazy" alt="视频流目标检测图示" src="/assets/images/det_video_inference-1ebf2a9feb8c4563e11a5f80c973d27e.jpg" width="4032" height="3024" class="img_ev3q"></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/CanaanK230/part4/10-Source-levelapplicationdevelopment.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/CanaanK230/part4/DevelopedwithAICube"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">9. 使用AI Cube开发</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/CanaanK230/part4/CanCollectorPlus"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">11. CanCollectorPlus</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#101-使用kts实现图像分类任务" class="table-of-contents__link toc-highlight">10.1 使用KTS实现图像分类任务</a><ul><li><a href="#1011-环境搭建" class="table-of-contents__link toc-highlight">10.1.1 环境搭建</a></li><li><a href="#1012-数据准备" class="table-of-contents__link toc-highlight">10.1.2 数据准备</a></li><li><a href="#1013-模型训练和测试" class="table-of-contents__link toc-highlight">10.1.3 模型训练和测试</a></li><li><a href="#1014-k230_sdk镜像编译和烧录" class="table-of-contents__link toc-highlight">10.1.4 K230_SDK镜像编译和烧录</a></li><li><a href="#1015-c代码编译" class="table-of-contents__link toc-highlight">10.1.5 C++代码编译</a></li><li><a href="#1016-网络配置与文件拷贝" class="table-of-contents__link toc-highlight">10.1.6 网络配置与文件拷贝</a></li><li><a href="#1017-k230端部署" class="table-of-contents__link toc-highlight">10.1.7 K230端部署</a></li></ul></li><li><a href="#102-使用kts实现目标检测任务" class="table-of-contents__link toc-highlight">10.2 使用KTS实现目标检测任务</a><ul><li><a href="#1021-环境搭建" class="table-of-contents__link toc-highlight">10.2.1 环境搭建</a></li><li><a href="#1022-数据准备" class="table-of-contents__link toc-highlight">10.2.2 数据准备</a></li><li><a href="#1023-模型训练和测试" class="table-of-contents__link toc-highlight">10.2.3 模型训练和测试</a></li><li><a href="#1024-k230_sdk镜像编译和烧录" class="table-of-contents__link toc-highlight">10.2.4 K230_SDK镜像编译和烧录</a></li><li><a href="#1025-c代码编译" class="table-of-contents__link toc-highlight">10.2.5 C++代码编译</a></li><li><a href="#1026-网络配置与文件拷贝" class="table-of-contents__link toc-highlight">10.2.6 网络配置与文件拷贝</a></li><li><a href="#1027-k230端部署" class="table-of-contents__link toc-highlight">10.2.7 K230端部署</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://dongshanpi.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">DongshanPI<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://canaan-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Canaan-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://renesas-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Renesas-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://rtos.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">RTOS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://tina.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">TinaSDK-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://allwinner-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Allwinner-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://aw-r128.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">R128-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://space.bilibili.com/275908810" target="_blank" rel="noopener noreferrer" class="footer__link-item">BiliBili<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forums.100ask.net" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://video.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VideoCenter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/dongshanpi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://weidongshan.coding.net/public/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Coding<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/100askTeam" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gitee.com/weidongshan" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>